(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8971],{13304:function(e,n,t){"use strict";var i=t(64836);n.Z=void 0;var r=i(t(64938)),o=t(85893);n.Z=(0,r.default)((0,o.jsx)("path",{d:"M18 16v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1zm-5 0h-2v-2h2zm0-4h-2V8h2zm-1 10c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2"}),"NotificationImportant")},6054:function(e,n,t){"use strict";var i=t(67294),r=function(e){var n=(0,i.useRef)();return(0,i.useEffect)(function(){n.current=e}),n.current};n.Z=r},11082:function(e,n){"use strict";var t=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GBP";return new Intl.NumberFormat(["en-GB"],{currency:n,currencyDisplay:"symbol",style:"currency"}).format(e)};n.Z=t},24262:function(e,n,t){"use strict";function i(e){var n=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return n.setUTCFullYear(e.getFullYear()),e.getTime()-n.getTime()}t.d(n,{Z:function(){return i}})},83946:function(e,n,t){"use strict";function i(e){if(null===e||!0===e||!1===e)return NaN;var n=Number(e);return isNaN(n)?n:n<0?Math.ceil(n):Math.floor(n)}t.d(n,{Z:function(){return i}})},11640:function(e,n,t){"use strict";t.d(n,{Z:function(){return a}});var i=t(83946),r=t(19013),o=t(13882);function a(e,n){(0,o.Z)(2,arguments);var t=(0,r.Z)(e),a=(0,i.Z)(n);if(isNaN(a))return new Date(NaN);if(!a)return t;var s=t.getDate(),c=new Date(t.getTime());return(c.setMonth(t.getMonth()+a+1,0),s>=c.getDate())?c:(t.setFullYear(c.getFullYear(),c.getMonth(),s),t)}},83894:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var i=t(19013),r=t(13882);function o(e){(0,r.Z)(1,arguments);var n=(0,i.Z)(e);return n.setHours(23,59,59,999),n}},23855:function(e,n,t){"use strict";t.d(n,{Z:function(){return d}});var i=t(83946),r=t(13882),o={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},a=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,s=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,c=/^([+-])(\d{2})(?::?(\d{2}))?$/;function d(e,n){(0,r.Z)(1,arguments);var t,d,p=n||{},v=null==p.additionalDigits?2:(0,i.Z)(p.additionalDigits);if(2!==v&&1!==v&&0!==v)throw RangeError("additionalDigits must be 0, 1 or 2");if(!("string"==typeof e||"[object String]"===Object.prototype.toString.call(e)))return new Date(NaN);var h=function(e){var n,t={},i=e.split(o.dateTimeDelimiter);if(i.length>2)return t;if(/:/.test(i[0])?(t.date=null,n=i[0]):(t.date=i[0],n=i[1],o.timeZoneDelimiter.test(t.date)&&(t.date=e.split(o.timeZoneDelimiter)[0],n=e.substr(t.date.length,e.length))),n){var r=o.timezone.exec(n);r?(t.time=n.replace(r[1],""),t.timezone=r[1]):t.time=n}return t}(e);if(h.date){var g=function(e,n){var t=RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+n)+"})|(\\d{2}|[+-]\\d{"+(2+n)+"})$)"),i=e.match(t);if(!i)return{year:null};var r=i[1]&&parseInt(i[1]),o=i[2]&&parseInt(i[2]);return{year:null==o?r:100*o,restDateString:e.slice((i[1]||i[2]).length)}}(h.date,v);t=function(e,n){if(null===n)return null;var t=e.match(a);if(!t)return null;var i=!!t[4],r=u(t[1]),o=u(t[2])-1,s=u(t[3]),c=u(t[4]),d=u(t[5])-1;if(i){return(l=n,p=c,v=d,p>=1&&p<=53&&v>=0&&v<=6)?(h=n,g=c,x=d,b=new Date(0),b.setUTCFullYear(h,0,4),y=b.getUTCDay()||7,b.setUTCDate(b.getUTCDate()+((g-1)*7+x+1-y)),b):new Date(NaN)}var l,p,v,h,g,x,b,y,Z,j,I,C,_,A=new Date(0);return(Z=n,j=o,I=s,j>=0&&j<=11&&I>=1&&I<=(m[j]||(f(Z)?29:28))&&(C=n,_=r,_>=1&&_<=(f(C)?366:365)))?(A.setUTCFullYear(n,o,Math.max(r,s)),A):new Date(NaN)}(g.restDateString,g.year)}if(isNaN(t)||!t)return new Date(NaN);var x=t.getTime(),b=0;if(h.time&&(isNaN(b=function(e){var n=e.match(s);if(!n)return null;var t,i,r,o=l(n[1]),a=l(n[2]),c=l(n[3]);return(t=o,i=a,r=c,24===t?0===i&&0===r:r>=0&&r<60&&i>=0&&i<60&&t>=0&&t<25)?36e5*o+6e4*a+1e3*c:NaN}(h.time))||null===b))return new Date(NaN);if(h.timezone){if(d=function(e){if("Z"===e)return 0;var n=e.match(c);if(!n)return 0;var t,i,r="+"===n[1]?-1:1,o=parseInt(n[2]),a=n[3]&&parseInt(n[3])||0;return(t=o,i=a,i>=0&&i<=59)?r*(36e5*o+6e4*a):NaN}(h.timezone),isNaN(d))return new Date(NaN)}else{var y=new Date(x+b),Z=new Date(0);return Z.setFullYear(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate()),Z.setHours(y.getUTCHours(),y.getUTCMinutes(),y.getUTCSeconds(),y.getUTCMilliseconds()),Z}return new Date(x+b+d)}function u(e){return e?parseInt(e):1}function l(e){return e&&parseFloat(e.replace(",","."))||0}var m=[31,null,31,30,31,30,31,31,30,31,30,31];function f(e){return e%400==0||e%4==0&&e%100}},43703:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var i=t(19013),r=t(13882);function o(e){(0,r.Z)(1,arguments);var n=(0,i.Z)(e);return n.setDate(1),n.setHours(0,0,0,0),n}},38148:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var i=t(19013),r=t(13882);function o(e){(0,r.Z)(1,arguments);var n=(0,i.Z)(e),t=new Date(0);return t.setFullYear(n.getFullYear(),0,1),t.setHours(0,0,0,0),t}},55328:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/customers/view",function(){return t(24056)}])},70692:function(e,n,t){"use strict";t.d(n,{N:function(){return s}});var i=t(85893),r=t(45697),o=t(58594),a=[{id:"assignedToMe",label:"Assigned to me",value:"assignedToMe"}],s=function(e){var n=e.data,t=e.errors,r=e.name,s=e.onChange,c=e.register;return(0,i.jsx)(o.Z,{errors:t,data:n||a,legend:"",name:r,onChange:s,register:c})};s.propTypes={data:r.object,errors:r.object.isRequired,name:r.string,onChange:r.func,register:r.func.isRequired},s.defaultProps={name:"assignedToMe"}},22595:function(e,n,t){"use strict";t.d(n,{E:function(){return i}});var i=function(e,n){if(Array.isArray(n)){var t,i=null;return n.forEach(function(n){var t,r=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});i=(null==r?void 0:r.createdAt)||i}),i}var r=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});return(null==r?void 0:r.createdAt)||null}},71306:function(e,n,t){"use strict";t.d(n,{V:function(){return G}});var i=t(26042),r=t(828),o=t(85893),a=t(67294),s=t(45697),c=t(30381),d=t.n(c),u=t(11163),l=t.n(u),m=t(57460),f=t.n(m),p=t(6388),v=t(73359),h=t(7297),g=t(75063);function x(){var e=(0,h.Z)(['\n  query GetLocations(\n    $accountId: Int\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Location_order_by!\n  ) {\n    properties: Location(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      id\n      access\n      contactUserId\n      createdAt\n      name\n      status\n      addresses: Addresses(where: { entity: { _eq: "Location" }, registered: { _eq: true } }) {\n        id\n        status\n        address: Address {\n          id\n          name\n          addressLine1\n          postCode\n        }\n      }\n      customer: Account_Locations {\n        id\n        account: Account {\n          id\n          name\n        }\n      }\n      compliances: Compliances(\n        where: { entity: { _eq: "Location" } }\n        order_by: { expiryAt: asc }\n      ) {\n        id\n        expiryAt\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n      bookings: Jobs(\n        where: { Invoices: { invoiceType: { _in: ["customerVat", "ProformaInvoiceCustomer"] } } }\n      ) {\n        id\n      }\n      user: User {\n        id\n        fullName\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return x=function(){return e},e}var b=(0,g.Ps)(x()),y=t(12547),Z=t(90629),j=t(15861),I=t(98456),C=t(51233),_=t(11057),A=t(93946),w=t(5616),N=t(61730),S=t(2548),T=t(81261),L=t(25993),q=t(15033),k=t(69396),D=t(42283),M=t(11994),$=t(90948),F=t(50135),P=t(48580),E=t(59938),R=t(4972),H=function(e){var n=e.initialFilters,t=e.filters,s=e.setFilters,c=e.open,d=e.onClose,l=(0,u.useRouter)().query,m=(0,N.Z)("(max-width: 400px)"),f=(0,a.useMemo)(function(){return(null==l?void 0:l.tab)==="locations"},[l]),p=(0,r.Z)((0,E.X)("form_data_".concat(n.filterType).concat(f?"_".concat(n.accountId):""),n),2),h=p[0],g=p[1],x=(0,a.useState)(),b=x[0],y=x[1],j=(0,D.cI)({defaultValues:h}),I=j.control,A=j.handleSubmit,w=j.register,S=j.reset,T=j.errors,L=(0,r.Z)((0,v.t)(R.SW,{variables:{where:{name:{_ilike:""!==b?"%".concat(b,"%"):null}}}}),2),q=L[0],M=L[1],$=M.loading,H=M.data,U=(void 0===H?{items:[]}:H).items,W=function(){s(n),S(),d(),g((0,k.Z)((0,i.Z)({},n),{filterType:n.filterType}))},V=function(e){var r,o=(0,k.Z)((0,i.Z)({},t,e),{accountId:f?n.accountId:null===(r=e.customer)||void 0===r?void 0:r.value,q:e.q});s((0,k.Z)((0,i.Z)({},o),{q:e.q?"%".concat(e.q,"%"):null})),g((0,k.Z)((0,i.Z)({},o),{customer:f?null:e.customer,filterType:n.filterType})),S(),d()};return(0,o.jsx)(O,{open:c,onClose:d,children:(0,o.jsx)(Z.Z,{sx:{minWidth:m?"300px":"400px",padding:"20px 40px"},children:(0,o.jsxs)("form",{onSubmit:A(V),children:[(0,o.jsxs)(C.Z,{spacing:f?8:4,children:[(0,o.jsx)(F.Z,{fullWidth:!0,variant:"standard",color:"secondary",label:"Search...",name:"q",inputRef:w}),!f&&(0,o.jsx)(D.Qr,{name:"customer",control:I,render:function(e){var n,t=e.value,i=e.onChange;return(0,o.jsx)(P.q,{limitTags:6,color:"secondary",value:t,onChange:function(e,n){return i(n)},label:"Select customer",loading:$,onOpen:function(){return q()},options:U,setSearch:y,textFieldProps:{label:"Select customer",variant:"standard",color:"secondary",error:T.customer,helperText:null===(n=T.customer)||void 0===n?void 0:n.message}})}})]}),(0,o.jsxs)(C.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,sx:{margin:"20px 0"},children:[(0,o.jsx)(_.Z,{variant:"contained",color:"danger",onClick:function(){return W()},children:"Cancel"}),(0,o.jsx)(_.Z,{variant:"contained",color:"secondary",type:"submit",children:"Search"})]})]})})})},O=(0,$.ZP)(M.Z)(function(){return{display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}});H.propTypes={open:s.bool,onClose:s.func,initialFilters:s.object,setFilters:s.func.isRequired};var U=t(75832),W=t(20705),V=t(9492),B=t(63139),z=t(93884),Y=t(64872),J=function(e){return d()(e).format("YYYY-MM-DD")},G=function(e){var n,t=e.accountId,s=e.accountName,c=e.initialFilters,d=e.columnVisibilityModel,u=e.tableContainerHeight,m=(0,a.useState)(!1),h=m[0],g=m[1],x=(0,a.useState)(!1),k=x[0],D=x[1],M=(0,a.useState)((0,i.Z)({},c)),$=M[0],F=M[1],P=(0,W.x)({filters:$}),E=P.initialData,R=P.ref,O=(0,Y.a)(),G=(0,N.Z)("(max-width: 400px)"),Q=(0,B.s)(),X=(0,p.aM)(b,{variables:E}),K=X.data,ee=void 0===K?{properties:[],meta:{aggregate:{totalCount:0}}}:K,en=ee.properties,et=ee.meta,ei=X.loading,er=X.refetch,eo=(0,r.Z)((0,v.t)(b,{fetchPolicy:"no-cache",variables:{accountId:E.accountId,q:E.q,orderBy:E.orderBy},onCompleted:function(e){try{var n=f().unparse(ed(e.properties)),t="data:application/octet-stream,"+encodeURIComponent(n);(0,V.S)(t,"locations.csv")}finally{D(!1)}}}),1)[0],ea=function(e){e.stopPropagation(),D(!0),eo()},es=(0,a.useCallback)(function(e,n){e.stopPropagation(),O.show({content:(0,o.jsx)(L.V,{accountId:t,accountName:s,data:null==n?void 0:n.data,entity:"Location",refetch:er}),title:(null==n?void 0:n.data)?"Edit location":"Create location"})},[O,t,s,er]),ec=function(e){var n=e.row;l().push("".concat("/dashboard/properties/","view?id=").concat(n.data.id,"&tab=details"))},ed=function(e){return e.map(function(e){var n,t,i=null===(n=null==e?void 0:e.addresses[0])||void 0===n?void 0:n.address;return{name:e.name||"Not Specified",customer:e.customer[0].account.name,address:i?"".concat(i.addressLine1," - ").concat(i.postCode):"",bookings:null===(t=e.bookings)||void 0===t?void 0:t.length,totalSpent:(0,U.T)(0),createdAt:J(e.createdAt)}})},eu=(0,a.useCallback)(function(){return en.map(function(e){var n,t,i,r;return{id:e.id,data:e,name:e.name||"Not Specified",address:(null===(n=e.addresses[0])||void 0===n?void 0:n.address)?"\n            ".concat(null===(t=e.addresses[0])||void 0===t?void 0:t.address.addressLine1," -\n            ").concat(null===(i=e.addresses[0])||void 0===i?void 0:i.address.postCode):"Please Add",customer:e.customer[0].account.name,customerId:e.customer[0].account.id,workOrders:null===(r=e.bookings)||void 0===r?void 0:r.length,totalSpent:(0,U.T)(0),compliancesList:e.compliances,createdAt:J(e.createdAt),status:e.status,actions:""}})},[en]),el=(0,a.useMemo)(function(){var e={};return!eu().length&&(null==E?void 0:E.q)?{title:"No results",subtitleFirstLine:"The filters you have applied have returned no results",subtitleSecondLine:"Please amend and try again if necessary."}:{title:"No locations",subtitleFirstLine:"You currently have no locations set up in the system",subtitleSecondLine:"Click\xa0create location\xa0to get started building.",buttonText:"Create location",onAction:es}},[es,null==E?void 0:E.q,eu]),em=(0,i.Z)({},d);return(0,o.jsxs)(o.Fragment,{children:[h&&(0,o.jsx)(H,{initialFilters:c,open:h,filters:$,setFilters:F,onClose:function(){return g(!1)}}),(0,o.jsxs)(C.Z,{width:"100%",spacing:2,sx:{height:"100%"},children:[(0,o.jsxs)(C.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,o.jsx)(_.Z,{variant:"contained",startIcon:(0,o.jsx)(T.Z,{}),onClick:function(){return g(!0)},children:"Filters"}),(0,o.jsxs)(C.Z,{direction:"row",spacing:2,children:[(0,o.jsx)(_.Z,{variant:"contained",color:"secondary",onClick:es,children:"Create Location"}),!Q&&(0,o.jsx)(_.Z,{startIcon:!k&&(0,o.jsx)("img",{src:"/static/icons/csv.svg"}),disabled:k,variant:"contained",color:"success",onClick:ea,children:k?(0,o.jsx)(I.Z,{size:20,color:"secondary"}):"Export"})]})]}),(0,o.jsxs)(Z.Z,{sx:{padding:"16px 0px",height:u},children:[(0,o.jsx)(j.Z,{ml:2,variant:"h5",sx:{fontWeight:600,marginBottom:"15px"},children:"Locations"}),(null===(n=eu())||void 0===n?void 0:n.length)?(0,o.jsx)(q.i,{ref:R,loading:ei,columns:[{headerName:"Name",field:"name",minWidth:370,flex:1},{headerName:"Address",field:"address",minWidth:300,flex:1,sortable:!1},{headerName:"Customer",field:"customer",sortable:!1,flex:1,minWidth:G?100:"auto",renderCell:function(e){var n=e.row,t=n.customer,i=n.customerId;return(0,o.jsx)(y.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(i),children:t})}},{headerName:"Work Orders",field:"workOrders",sortable:!1,minWidth:G?100:"auto",renderCell:function(e){var n=e.row.workOrders;return(0,o.jsx)(w.Z,{sx:{marginLeft:"3em"},children:n})},flex:1},{headerName:"Total Spent",field:"totalSpent",sortable:!1,minWidth:G?140:"auto",renderCell:function(e){var n=e.row.totalSpent;return(0,o.jsx)(w.Z,{sx:{marginLeft:"1.5em"},children:n})},flex:1},{field:"createdAt",headerName:"Created At",minWidth:G?200:"auto",flex:1,sortable:!0},{field:"actions",headerName:"Actions",sortable:!1,minWidth:G?80:"auto",renderCell:function(e){var n=e.row;return(0,o.jsx)(A.Z,{sx:{marginLeft:"1em"},onClick:function(){return ec({row:n})},children:(0,o.jsx)(S.Z,{})})},flex:1}],rows:eu(),columnVisibilityModel:em,meta:et,refetch:er,autoHeight:!1,containerHeight:"calc(100% - 52px)",onRowClick:ec}):!ei&&(0,o.jsx)(z.C,(0,i.Z)({imageSrc:"/static/icons/no_locations_found.svg"},el))]})]})]})};G.propTypes={accountId:s.number,accountName:s.string,initialFilters:s.object,columnVisibilityModel:s.object,tableContainerHeight:s.string},G.defaultProps={columnVisibilityModel:{},tableContainerHeight:"calc(100% - 52px)"}},51809:function(e,n,t){"use strict";t.d(n,{$A:function(){return v},$E:function(){return h},A1:function(){return p},Un:function(){return f},yf:function(){return x},zg:function(){return g}});var i=t(7297),r=t(75063);function o(){var e=(0,i.Z)(["\n  query GetProperty($id: Int!) {\n    location: Location_by_pk(id: $id) {\n      id\n      contactUserId\n      name\n      access\n      contactUser: User {\n        id\n        nameFirst\n        nameLast\n      }\n      propertyOwner: Account_Locations {\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"]);return o=function(){return e},e}function a(){var e=(0,i.Z)(['\n  query GetMapProperties {\n    properties: Location {\n      id\n      access\n      createdAt\n      name\n      contactUserId\n      addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      bookings: Jobs {\n        id\n        title\n        createdAt\n        customerId\n        amount\n        locationId\n        managerId\n        quoteNumber\n        reference\n        status\n        serviceId\n        meta\n        customer: Customer {\n          id\n          name\n        }\n        location: Location {\n          id\n          name\n          addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n            id\n            registered\n            operating\n            trading\n            invoice\n            status\n            createdAt\n            address: Address {\n              id\n              name\n              addressLine1\n              addressLine2\n              addressLine3\n              city\n              county\n              geo\n              postCode\n              country: Country {\n                id\n                name\n              }\n            }\n          }\n        }\n        manager: Manager {\n          id\n          nameFirst\n          nameLast\n        }\n        sla: SLA {\n          id\n          name\n          notes\n        }\n        supplier: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n          media: Media {\n            id\n            medium: Medium {\n              id\n              category\n              filename\n              meta\n              type\n            }\n          }\n          manager: Manager {\n            id\n            fullName\n          }\n        }\n        supplierOffers: SupplierOffers {\n          status\n          rate\n          supplier: Supplier {\n            id\n            companyNumber\n            createdAt\n            name\n            status\n            type\n            updatedAt\n            website\n            clientType\n            managerId\n            vatId\n            meta\n            media: Media {\n              id\n              medium: Medium {\n                id\n                category\n                filename\n                meta\n                type\n              }\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n          }\n        }\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n']);return a=function(){return e},e}function s(){var e=(0,i.Z)(["\n  mutation AddLocation($objects: [Location_insert_input!]!) {\n    insert_Location(objects: $objects) {\n      returning {\n        id\n        name\n      }\n    }\n  }\n"]);return s=function(){return e},e}function c(){var e=(0,i.Z)(["\n  mutation UpdateAccountLocation(\n    $location: Location_set_input\n    $locationId: Int!\n    $accountId: Int!\n    $newAccountId: Int!\n    $hasChanged: Boolean!\n  ) {\n    update_Account_Location(\n      where: { Account: { id: { _eq: $accountId } }, id: { _eq: $locationId } }\n      _set: { accountId: $newAccountId }\n    ) @include(if: $hasChanged) {\n      returning {\n        id\n      }\n    }\n    update_Location_by_pk(pk_columns: { id: $locationId }, _set: $location) {\n      id\n    }\n  }\n"]);return c=function(){return e},e}function d(){var e=(0,i.Z)(["\n  mutation UpdateAccount($id: Int!, $changes: Account_set_input) {\n    update_Account_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return d=function(){return e},e}function u(){var e=(0,i.Z)(["\n  mutation UpdateLocation($id: Int!, $changes: Location_set_input) {\n    update_Location_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return u=function(){return e},e}function l(){var e=(0,i.Z)(["\n  query GetAccountName($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n    }\n  }\n"]);return l=function(){return e},e}function m(){var e=(0,i.Z)(["\n  query GetPropertiesJob($id: Int!) {\n    property: Location_by_pk(id: $id) {\n      id\n      jobs: Jobs {\n        id\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n"]);return m=function(){return e},e}(0,r.Ps)(o());var f=(0,r.Ps)(a()),p=(0,r.Ps)(s()),v=(0,r.Ps)(c()),h=(0,r.Ps)(d()),g=(0,r.Ps)(u());(0,r.Ps)(l());var x=(0,r.Ps)(m())},24056:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return nd}});var i=t(85893),r=t(58849),o=t(9270),a=t(62140),s=t(67294),c=t(11163),d=t.n(c),u=t(6388),l=t(66779),m=t(41085),f=t(55862),p=t(26042),v=t(7297),h=t(45697),g=t.n(h),x=t(75063);function b(){var e=(0,v.Z)(['\n  query GetPropertiesCompliance(\n    $accountId: Int\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Location_order_by!\n    $now: date\n    $nextMonth: date\n  ) {\n    properties: Location(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      id\n      access\n      contactUserId\n      createdAt\n      name\n\n      jobs: Jobs(where: { Compliances: { id: { _is_null: false }, entity: { _eq: "Job" } } }) {\n        id\n        number\n        amount\n        timingStart\n        scheduledAt\n      }\n      upComing: Compliances_aggregate(\n        where: {\n          entity: { _eq: "Location" }\n          _and: [{ expiryAt: { _gt: $now } }, { expiryAt: { _lt: $nextMonth } }]\n        }\n      ) {\n        aggregate {\n          count\n        }\n      }\n      overdue: Compliances_aggregate(\n        where: { expiryAt: { _lt: $now }, entity: { _eq: "Location" } }\n      ) {\n        aggregate {\n          count\n        }\n      }\n\n      compliances: Compliances(\n        where: { entity: { _eq: "Location" } }\n        order_by: { expiryAt: asc }\n      ) {\n        id\n        expiryAt\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return b=function(){return e},e}var y=(0,x.Ps)(b()),Z=t(11640),j=t(10367),I=t(11082),C=t(26186),_=t(11585),A=t(91272),w=t(36769),N=t(51466),S=t(11587),T=t(43235),L=t(5054);function q(){var e=(0,v.Z)(["\n  margin: 0;\n"]);return q=function(){return e},e}function k(){var e=(0,v.Z)(["\n  align-items: center;\n  display: flex;\n"]);return k=function(){return e},e}function D(){var e=(0,v.Z)(["\n  flex-direction: column;\n  margin-left: 1rem;\n"]);return D=function(){return e},e}var M=function(e){var n=(0,L.O)();return parseInt(e.filter(function(e){return(0,L.O)(e.expiryAt)>=n}).length/e.length*100)},$=function(e){var n=e.row.compliancesList;if(!n||0===n.length)return null;var t=M(n);return(0,i.jsxs)(E,{children:[(0,i.jsx)(P,{content:"".concat(n.length," : ").concat(t.toString(),"%"),context:H(t),size:"sm"}),F(n)]})},F=function(e){var n=e.find(function(e){var n=(0,T.r)(e.expiryAt);return e});return n&&(0,i.jsxs)(R,{children:[(0,i.jsx)(N.Z,{content:(0,C.Z)(n.expiryAt),context:O(n.expiryAt),size:"sm"}),(0,i.jsx)(N.Z,{content:n.compliance.name,size:"sm"})]})},P=(0,j.ZP)(S.Z).withConfig({displayName:"helper__StyledBadge",componentId:"sc-7f3be2d3-0"})(q()),E=j.ZP.div.withConfig({displayName:"helper__Wrapper",componentId:"sc-7f3be2d3-1"})(k()),R=j.ZP.div.withConfig({displayName:"helper__Next",componentId:"sc-7f3be2d3-2"})(D()),H=function(e){return e>79?"success":e>49?"info":"danger"},O=function(e){var n=(0,T.r)(e);return n>14?"success":n>=0?"info":"danger"},U=t(20705),W=t(73303),V=t.n(W),B=t(2845),z=t(18586);function Y(){var e=(0,v.Z)(["\n  display: block;\n  cursor: pointer;\n  color: ",";\n  &:hover {\n    background: rgb(221, 221, 221);\n  }\n"]);return Y=function(){return e},e}var J="/dashboard/properties/",G=new Date,Q=(0,Z.Z)(G,1),X=(0,Z.Z)(G,-12),K=function(e){var n=e.accountId,t=(e.accountName,e.filters);e.showAddButton;var r=(0,B.x)().hasRole,o=(0,z.q)().hasUserModule,a=r("customer_user"),s=o("finances"),c=(0,U.x)({filters:t}),l=c.initialData,m=c.ref,f=(0,u.aM)(y,{variables:(0,p.Z)({accountId:n,now:G,nextMonth:Q},l)}),v=f.data,h=void 0===v?{properties:[],meta:{aggregate:{totalCount:0}}}:v,g=h.properties,x=h.meta,b=f.loading,Z=f.refetch,j=function(e){return V()(null==e?void 0:e.filter(function(e){return new Date(e.timingStart)>X&&new Date(e.timingStart)<G}),function(e){return Number(e.amount)})},N=function(e){return null==e?void 0:e.find(function(e){return new Date(null==e?void 0:e.timingStart)>G})},S=function(e){d().push("".concat(J,"view?id=").concat(e.data.id,"&tab=compliance"))},T=function(e){var n=e.e,t=e.id,i=e.item;n.stopPropagation(),d().push("".concat(J,"view?id=").concat(t,"&tab=compliance&").concat(i,"=1"))},L=function(e,n){return(0,i.jsx)(ee,{onClick:function(t){return T({e:t,id:e.data.id,item:n})},children:e[n]})};return(0,i.jsxs)(_.Z,{fitParentHeight:!0,open:!0,title:"Locations Compliance",children:[(0,i.jsx)(w.p,{customerId:n,hideFinance:!s&a}),(0,i.jsx)(A.t,{columns:[{hidden:!0},{hidden:!0},{text:"Name"},{text:"Overdue",formatter:function(e){return L(e.row,"overdue")}},{text:"Upcoming",formatter:function(e){return L(e.row,"upcoming")}},{text:"Unconfirmed"},{text:"Next Visit"},{text:"Work orders"},{hidden:a&&!s,text:"Total Spent",formatter:function(e){var n=e.row;return(0,I.Z)(j(n.data.jobs))}},{formatter:$,text:"Compliance"},{text:"Created"}],loading:b,meta:x,ref:m,refetch:Z,rowClick:S,rows:g.map(function(e){var n,t,i,r,o,a;return{data:e,locationId:e.id,location:e.name||"Not Specified",overdue:null===(n=e.overdue)||void 0===n?void 0:n.aggregate.count,upcoming:null===(t=e.upComing)||void 0===t?void 0:t.aggregate.count,unconfirmed:e.jobs.filter(function(e){return!e.scheduledAt}).length,nextVisit:(null===(r=N(null===(i=e.data)||void 0===i?void 0:i.jobs))||void 0===r?void 0:r.timingStart)?(0,C.Z)(null===(o=N(e.data.jobs))||void 0===o?void 0:o.timingStart):"-",jobs:null===(a=e.jobs)||void 0===a?void 0:a.length,totalSpent:(0,I.Z)(j),compliancesList:e.compliances,createdAt:(0,C.Z)(e.createdAt)}})})]})},ee=j.ZP.a.withConfig({displayName:"table__StyledLink",componentId:"sc-4f12bd14-0"})(Y(),function(e){return e.theme.COLOUR.secondary});K.propTypes={accountId:h.number,accountName:h.string,filters:h.object,showAddButton:h.bool},K.defaultProps={hiddenColumns:[],isCompliance:!1,showAddButton:!1,showMediaButton:!1,showOverallRating:!1};var en=t(8500),et=t(1306),ei=t(71225);function er(){var e=(0,v.Z)(["\n  query GetComplianceRating($accountId: Int!) {\n    properties: Account_Location_aggregate(where: { accountId: { _eq: $accountId } }) {\n      nodes {\n        location: Location {\n          compliances: Compliances_aggregate {\n            aggregate {\n              count\n            }\n          }\n          compliance: Compliances {\n            id\n            expiryAt\n          }\n        }\n      }\n    }\n  }\n"]);return er=function(){return e},e}var eo=(0,x.Ps)(er()),ea=t(30430);function es(){var e=(0,v.Z)(["\n  cursor: pointer;\n  text-decoration: none;\n"]);return es=function(){return e},e}var ec=function(e){var n=e.customerId,t=(0,u.aM)(eo,{variables:{accountId:n}}).data,r=(void 0===t?{properties:[]}:t).properties,o=function(){d().push("/dashboard/customers/view?id=".concat(n,"&tab=compliance"))};return(0,i.jsx)(_.Z,{open:!0,title:"Compliance Score",children:(0,i.jsx)(ed,{onClick:o,children:(0,i.jsx)(N.Z,(0,p.Z)({},(0,ea.Bo)(r)))})})},ed=j.ZP.a.withConfig({displayName:"rating__Link",componentId:"sc-b882f7fa-0"})(es());ec.propTypes={customerId:h.number.isRequired};var eu=t(41890),el=t(30381),em=t.n(el),ef=t(36641),ep=t(85113),ev=function(e){var n,t,r,o,a,s,c,u,l,m,f,p,v=e.customer,h=e.offCanvas,g=e.refetch,x=(0,ep.WE)(v,"registered"),b=(0,ep.WE)(v,"trading"),y=(0,ep.WE)(v,"invoice"),Z=function(e){e&&g()};return[{id:1,label:"Create account",date:v.createdAt},{id:2,label:"Complete profile",info:"",date:(null==x?void 0:x.createdAt)||null,actions:[{id:1,active:!0,content:"Registered address",context:"secondary",handleClick:function(){var e;h.show({content:(0,i.jsx)(ef.H,{addressId:(null==x?void 0:null===(e=x.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:v.id,id:(null==x?void 0:x.id)||null,onSubmit:Z,type:"registered"}),submit:!1,title:"Manage addresses"})},type:"button"},{id:2,active:!0,content:"Trading address",context:"secondary",handleClick:function(){var e;h.show({content:(0,i.jsx)(ef.H,{addressId:(null==b?void 0:null===(e=b.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:v.id,id:(null==b?void 0:b.id)||null,onSubmit:Z,type:"trading"}),submit:!1,title:"Manage addresses"})},type:"button"},{id:3,active:!0,content:"Invoice address",context:"secondary",handleClick:function(){var e;h.show({content:(0,i.jsx)(ef.H,{addressId:(null==y?void 0:null===(e=y.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:v.id,id:(null==y?void 0:y.id)||null,onSubmit:Z,type:"invoice"}),submit:!1,title:"Manage addresses",width:"50%"})},type:"button"}]},{id:3,label:"Add location",info:"",date:(null===(n=v.propertiesMeta)||void 0===n?void 0:null===(t=n.aggregate)||void 0===t?void 0:t.count)?v.createdAt:null,content:[{id:1,active:(null===(r=v.propertiesMeta)||void 0===r?void 0:null===(o=r.aggregate)||void 0===o?void 0:o.count)>0,data:"".concat(null===(a=v.propertiesMeta)||void 0===a?void 0:null===(s=a.aggregate)||void 0===s?void 0:s.count," properties added")}],actions:[{id:1,active:!0,content:"Submit location",context:"secondary",handleClick:function(){d().push("".concat("/dashboard/customers/","view?id=").concat(v.id,"&tab=locations"))},type:"button"}]},{id:6,label:"Start issuing work orders",info:"submit work orders",date:(null===(c=v.jobsMeta)||void 0===c?void 0:null===(u=c.aggregate)||void 0===u?void 0:u.count)?v.createdAt:null,content:[{id:1,active:(null===(l=v.jobsMeta)||void 0===l?void 0:null===(m=l.aggregate)||void 0===m?void 0:m.count)>0,data:"".concat(null===(f=v.jobsMeta)||void 0===f?void 0:null===(p=f.aggregate)||void 0===p?void 0:p.count," jobs created")}]}]},eh=function(e,n,t){var i=ev({customer:e,offCanvas:n,refetch:t});return i.forEach(function(e){e.date&&(e.date=em()(e.date).format("D MMM YYYY HH:mm"))}),i},eg=t(64872),ex=function(e){var n,t=e.customer,r=e.refetch,o=(0,eg.a)();return(0,i.jsx)(_.Z,{open:!0,title:"Profile",children:(0,i.jsx)(eu.Z,{items:eh(t,o,r),summary:(n=t,[{label:"Account manager: ",value:n.manager?"".concat(n.manager.nameFirst," ").concat(n.manager.nameLast," "):"Unassigned"},{label:"Users: ",value:n.usersMeta?n.usersMeta.aggregate.count:0},{label:"Status: ",value:n.status||""}])},"stepper-".concat(t.id))})},eb=t(35418),ey=t(30016),eZ=t(4380),ej=t(20402),eI=function(e){var n,t=e.customer,r=e.hasRole,s=e.refetch,c=(0,ep.WE)(t,"registered"),d=(0,ep.WE)(t,"trading"),u=[{key:"Company Number",value:t.companyNumber},{key:"VAT",value:t.vatId}];return t.clientType&&u.push({key:"Customer Type",value:t.clientType.name}),(null===(n=t.meta)||void 0===n?void 0:n.xeroContactId)&&u.push({key:"Xero Contact ID",value:t.meta.xeroContactId}),(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(o.Z,{children:[(0,i.jsxs)(a.Z,{md:4,children:[(0,i.jsx)(eZ.g,{avatar:(0,ei.Q)(t.media),editable:r("admin"),entity:t,entityName:"Account",icons:r("admin")?(0,ej.Y)(t):[]}),t.contactUsers&&(0,i.jsx)(_.Z,{title:"Contact",children:t.contactUsers.map(function(e){var n;return(0,i.jsxs)("div",{children:[(0,i.jsx)(en.Z,{rows:[{key:"Name",value:"".concat(e.user.nameFirst," ").concat(e.user.nameLast)},{key:"Phone",value:e.user.phone},{key:"Email",value:e.user.email}]}),(0,i.jsx)("br",{})]},e.userId)})}),(0,i.jsx)(_.Z,{title:"Company",children:(0,i.jsx)(en.Z,{rows:u})}),c&&(0,i.jsx)(et.f,{address:c.address,entity:"Account",entityId:t.id,id:c.id,refetch:s,title:"Registered Address",type:"registered"}),d&&(0,i.jsx)(et.f,{address:d.address,entity:"Account",entityId:t.id,id:d.id,refetch:s,title:"Trading Address",type:"trading"}),r("admin")&&(0,i.jsx)(ey.E,{entity:"Account",entityId:t.id,open:!0,title:"Notes"})]}),(0,i.jsx)(a.Z,{md:4,children:(0,i.jsx)(ex,{refetch:s,customer:t})}),(0,i.jsxs)(a.Z,{md:4,children:[(0,i.jsx)(eb.G,{details:!0,entity:"Account",entityId:t.id}),(0,i.jsx)(ec,{customerId:t.id})]})]})})};eI.propTypes={customer:h.object.isRequired};var eC=t(55185),e_=t(69396),eA=t(828),ew=t(73359),eN=t(57460),eS=t.n(eN),eT=t(77439),eL=t(40826),eq=t(62466),ek=t(68956),eD=t(9492),eM=t(50459),e$=t(45154),eF=t(13077),eP=t(45416),eE=t(63139),eR=function(e){var n,t,r,o=e.filters,a=e.workorderVisibility,s=(0,B.x)(),c=s.hasRole,m=s.user,f=(0,z.q)(),v=f.admin,h=f.hasUserModule,g=null===(n=v.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,x=null===(t=v.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,b=c("customer_user"),y=h("finances"),Z=(0,U.x)({filters:o}),j=Z.initialData,w=Z.ref,S=(0,u.aM)(l.G5,{variables:(0,e_.Z)((0,p.Z)({},j),{number:j.id?String(j.id):null,startDate:j.startDate,endDate:j.endDate,adminId:m.adminId})}),T=S.data,L=void 0===T?{jobs:[],meta:{aggregate:{totalCount:0}}}:T,q=L.jobs,k=L.meta,D=S.loading,M=S.refetch,$=function(){var e=(0,B.x)().user,n=j.customerId,t=j.endDate,r=j.locationId,o=j.orderBy,s=j.startDate,c=j.status,d=j.supplierId,u=(0,eA.Z)((0,ew.t)(l.G5,{variables:{adminId:e.adminId,customerId:n,endDate:t,locationId:r,orderBy:o,startDate:s,status:c,supplierId:d},onCompleted:function(n){var t,i,r=(0,e$.c)(n.jobs,e.accountType,{numberPrefix:g,numberSuffix:x}),o=(null===(t=n.jobs[0])||void 0===t?void 0:null===(i=t.customer)||void 0===i?void 0:i.name)||"Customer",a=eS().unparse(r),s="data:application/octet-stream,"+encodeURIComponent(a);(0,eD.S)(s,"".concat(o,"-BookingData.csv"))}}),1)[0];return(0,i.jsxs)(i.Fragment,{children:[!(0,eE.s)()&&(0,i.jsx)(eT.Z,{context:"light",onClick:function(e){e.stopPropagation(),u()},title:"Export to CSV",size:"md",children:(0,i.jsx)(eL.Z,{context:"secondary",icon:"file-csv",size:"lg"})}),a&&(0,i.jsx)(eT.Z,{content:"Create Work Order",context:"secondary",size:"sm",onClick:E})]})},F=function(e){d().push("".concat("/dashboard/issues/","manage?id=").concat(e.number))},P=[{hidden:!0},{hidden:!0},{hidden:!0},{text:"ID",formatter:function(e){var n=e.row;return(0,i.jsx)(eP.D,{id:n.id,invoiceNumber:n.invoiceNumber,number:n.number,numberPrefix:g,numberSuffix:x,openCanvas:!0,type:n.type})}},{text:"Reference"},{text:"Description"},{sortable:!0,sortName:'{"Job": { "Service": {"name": "ORDER"} }}',text:"Service"},{sortable:!0,sortName:'{"Job": { "SLA": {"name": "ORDER"} }}',text:"Priority"},{formatter:(0,eq.Z)("/dashboard/properties/view","propertyId","location"),sortable:!0,sortName:'{"Job":{"Location": {"name": "ORDER"}}}',text:"Location"},{hidden:b&&!y,text:"Total \xa3",formatter:function(e){var n,t,r=e.row;return n=r.customerVatTotal,t=r.customerExpensesTotal,(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(N.Z,{size:"xs",children:["Job total ",(0,I.Z)(n)]}),(0,i.jsxs)(N.Z,{size:"xs",children:["Expense customer ",(0,I.Z)(t)]})]})}},{hidden:!0},{hidden:!c("admin"),text:"Supplier \xa3",formatter:function(e){var n,t,r=e.row;return n=r.supplierVatTotal,t=r.supplierExpensesTotal,(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(N.Z,{size:"xs",children:["Amount ",(0,I.Z)(n)]}),(0,i.jsxs)(N.Z,{size:"xs",children:["Expense amount ",(0,I.Z)(t)]})]})}},{hidden:!0},{hidden:!c("admin"),text:"Revenue",formatter:function(e){var n=e.row;return(0,I.Z)(n.revenue)}},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Scheduled"},{sortable:!0,sortName:"createdAt",text:"Created"},{sortable:!0,sortName:"status",formatter:function(e){var n=e.row;return(0,eF.B)({value:n.status})},text:"Status"},{hidden:!c("admin"),formatter:ek.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,n){return F(n)},tooltip:"Edit"},{context:"secondary",icon:["fas","receipt"],onClick:function(e,n){return d().push("/dashboard/issues/view?id=".concat(n.number))},tooltip:"info"}],text:"Actions"}],E=function(e){e.stopPropagation();var n=(0,eM.Uu)(o);d().push("/dashboard/issues/manage".concat(n))};return(0,i.jsx)(_.Z,{fitParentHeight:!0,open:!0,title:"Work Orders",toolbar:(0,i.jsx)($,{}),children:(0,i.jsx)(A.t,{columns:P,loading:D,meta:k,ref:w,refetch:M,rows:null==q?void 0:q.map(function(e){var n,t,i,r,o,a,s,c,d,u=e.scheduledAt?(0,C.Z)(e.scheduledAt,!0):e.timingStart?(0,C.Z)(e.timingStart,!0):"-",l=e.customerRebateAmount>0?e.customerVatTotal-e.customerRebateAmount-e.supplierTotal:e.customerTotal-e.supplierTotal;return{id:e.id,type:e.type,number:e.number,invoiceNumber:null===(n=e.invoices)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:t.invoiceNumber,ref:e.reference||"-",description:e.description||"-",service:(null===(i=e.service)||void 0===i?void 0:i.name)||"-",priority:(null===(r=e.sla)||void 0===r?void 0:r.name)||"-",location:(null===(o=e.location)||void 0===o?void 0:o.name)||"-",customerVatTotal:e.customerVatTotal||0,customerExpensesTotal:e.customerExpensesTotal||0,supplierVatTotal:e.supplierVatTotal||0,supplierExpensesTotal:e.supplierExpensesTotal||0,revenue:l||0,propertyId:null===(a=e.location)||void 0===a?void 0:a.id,managerId:null===(s=e.manager)||void 0===s?void 0:s.id,customerId:null===(c=e.customer)||void 0===c?void 0:c.id,supplierId:(null===(d=e.supplier)||void 0===d?void 0:d.id)||"",scheduleDate:u,date:(0,C.Z)(e.createdAt),status:e.status,actions:""}})})})};eR.propTypes={filters:h.object},eR.defaultProps={filters:{assetId:null,managerId:null}};var eH=t(29815),eO=t(52019),eU=t(49501),eW=t(84043),eV=t(83894),eB=t(70692),ez=t(21300),eY=t(66812),eJ=t(92148),eG=function(e){var n=e.initialValues,t=e.control,r=e.errors,c=e.register,d=e.setFilters,u=e.watch,l=e.setValue,m=e.show,f=e.reset,v=(0,s.useContext)(eO.Z).hasRole,h={control:t,errors:r,register:c},g=u("customerId"),x=u("locationId"),b=u("supplierId"),y=u("userId"),Z=function(e){var n=e.map(function(e){return e.value});d(function(e){return(0,e_.Z)((0,p.Z)({},e),{status:n.length>0?n:null})}),d(function(e){return(0,e_.Z)((0,p.Z)({},e),{isChangedStatusSelect:!0})}),l("status",e),e.length||d(function(e){return(0,e_.Z)((0,p.Z)({},e),{isChangedStatusSelect:!1})})};return(0,s.useEffect)(function(){n.customerId||d(function(e){return(0,e_.Z)((0,p.Z)({},e),{customerId:"number"==typeof g?g:(null==g?void 0:g.value)||null})})},[g]),(0,s.useEffect)(function(){d(function(e){return(0,e_.Z)((0,p.Z)({},e),{locationId:"number"==typeof x?x:(null==x?void 0:x.value)||null})})},[x]),(0,s.useEffect)(function(){d(function(e){return(0,e_.Z)((0,p.Z)({},e),{supplierId:"number"==typeof b?b:(null==b?void 0:b.value)||null})})},[b]),(0,s.useEffect)(function(){d(function(e){return(0,e_.Z)((0,p.Z)({},e),{userId:"number"==typeof y?y:(null==y?void 0:y.value)||null})})},[y]),(0,s.useEffect)(function(){return function(){d(n),f(n)}},[m]),(0,i.jsxs)(o.Z,{children:[(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(eU.Z,{label:null,children:(0,i.jsx)(eW.Z,(0,e_.Z)((0,p.Z)({},h),{placeholder:"Select status",name:"status",isMulti:!0,onChange:Z,options:(0,eM.lR)(m)}))})}),v(["supplier"].concat((0,eH.Z)(eJ.n)))&&(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(eY.P,(0,e_.Z)((0,p.Z)({},h),{errors:(0,p.Z)({},r),label:"",userId:n.userId,name:"userId",placeholder:"Select user",type:"user"}))}),!n.customerId&&v("admin")&&(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(eY.P,(0,e_.Z)((0,p.Z)({},h),{errors:(0,p.Z)({},r),label:"",name:"customerId",placeholder:"Select customer",type:"customer"}))}),v("admin")&&(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(eY.P,(0,e_.Z)((0,p.Z)({},h),{errors:(0,p.Z)({},r),label:"",accountId:n.customerId,name:"locationId",placeholder:"Select location",type:"property"}))}),v("admin")&&(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(eY.P,(0,e_.Z)((0,p.Z)({},h),{errors:(0,p.Z)({},r),label:"",name:"supplierId",placeholder:"Select supplier",type:"supplier"}))}),(0,i.jsx)(a.Z,{md:12,children:(0,i.jsxs)(o.Z,{children:[(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(ez.M,(0,e_.Z)((0,p.Z)({},h),{name:"startDate",onChange:function(e){d(function(n){return(0,e_.Z)((0,p.Z)({},n),{startDate:e||null})}),l("startDate",e)},placeholder:"Start date"}))}),(0,i.jsx)(a.Z,{md:6,children:(0,i.jsx)(ez.M,(0,e_.Z)((0,p.Z)({},h),{name:"endDate",onChange:function(e){var n=e?(0,eV.Z)(e):e;d(function(e){return(0,e_.Z)((0,p.Z)({},e),{endDate:n})}),l("endDate",n)},placeholder:"End date"}))})]})}),!n.noAssignToMeFilter&&v((0,eH.Z)(eJ.SA).concat((0,eH.Z)(eJ.n),(0,eH.Z)(eJ.nx)))&&(0,i.jsx)(a.Z,{md:12,children:(0,i.jsx)(eB.N,(0,e_.Z)((0,p.Z)({},h),{name:"managerId",onChange:function(e){return d(function(n){return(0,e_.Z)((0,p.Z)({},n),{managerId:e.target.checked})})}}))})]})};eG.propTypes={control:h.object.isRequired,errors:h.object.isRequired,register:h.func.isRequired,setFilters:h.func.isRequired};var eQ=t(67259),eX=t(71306),eK=t(6924),e0=t(93243),e1=t(1589),e2=t(10925),e3=t(11057),e6=t(87918),e5=t(90629),e4=t(51233),e8=t(15861),e9=t(15033),e7=t(32784),ne=t(62551),nn=t(5336),nt=t(33214),ni=t(36663),nr=t(15843),no=function(e){var n=e.editable,t=e.initialFilters,r=e.parentEntity,o=e.entity,a=e.entityId,c=e.tableHeight,d=e.paperHeight,l=(0,eA.Z)((0,ne.d)(),2),m=l[0],f=l[1],v=(0,s.useState)({}),h=v[0],g=v[1],x=(0,s.useState)(!1),b=x[0],y=x[1],Z=(0,U.x)({filters:h}),j=Z.ref,I=Z.initialData,C=(0,u.aM)(e7.MD,{variables:(0,e_.Z)((0,p.Z)({},I),{entity:r,childEntityId:a,childEntity:o,includeLocations:"Customer"===o})}),_=C.data,A=void 0===_?{schedules:[],meta:{aggregate:{totalCount:0}}}:_,w=A.schedules,N=A.meta,S=C.loading,T=C.refetch,L=(0,s.useCallback)(function(e){n&&f({content:function(n){var t=n.onClose;return(0,i.jsx)(nt.t,{isEdit:e.isChild,scheduleId:e.id,entity:o,entityId:a,close:t})}})},[o,a,n,f]),q=(0,s.useCallback)(function(e){return[{icon:"edit",onClick:function(n){n.stopPropagation(),L(e)},tooltip:"Edit Schedule"}]},[L]),k=(0,s.useMemo)(function(){return[{sortable:!1,flex:1,minWidth:180,field:"serviceLine",headerName:"Service line"},{sortable:!1,flex:1,minWidth:180,field:"schedule",headerName:"Schedule"},{sortable:!1,flex:1,minWidth:180,field:"rate",headerName:"\xa3/H",renderCell:function(e){var n=e.row;return(0,i.jsxs)(e4.Z,{children:[(0,i.jsxs)(e8.Z,{children:["First hour: \xa3 ",n.rate.firstHour]}),(0,i.jsxs)(e8.Z,{children:["Subsequent hours: \xa3 ",n.rate.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:180,field:"rateOOH",headerName:"\xa3/H OOH",renderCell:function(e){var n=e.row;return(0,i.jsxs)(e4.Z,{children:[(0,i.jsxs)(e8.Z,{children:["First hour: \xa3 ",n.rateOOH.firstHour]}),(0,i.jsxs)(e8.Z,{children:["Subsequent hours: \xa3 ",n.rateOOH.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:180,field:"ratePremium",headerName:"\xa3/H Premium",renderCell:function(e){var n=e.row;return(0,i.jsxs)(e4.Z,{children:[(0,i.jsxs)(e8.Z,{children:["First hour: \xa3 ",n.ratePremium.firstHour]}),(0,i.jsxs)(e8.Z,{children:["Subsequent hours: \xa3 ",n.ratePremium.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:150,field:"locations",headerName:"Locations"},{sortable:!1,flex:1,minWidth:150,field:"coverageArea",headerName:"Coverage area"},{sortable:!1,flex:1,field:"minimumDuration",headerName:"Min duration"},{sortable:!1,flex:1,field:"minimumIncrement",headerName:"Min increment"},{sortable:!1,flex:1,minWidth:100,field:"status",headerName:"Status",renderCell:function(e){var n=e.row;return(0,i.jsx)(e6.Z,{label:"active"===n.status?"Active":"Inactive",color:"active"===n.status?"success":"danger",size:"small"})}},{sortable:!1,width:100,field:"actions",headerName:"Actions",renderCell:function(e){var n=e.row;return(0,i.jsx)(nn.C,{row:n,actionsData:q})}}]},[q]),D=(0,s.useMemo)(function(){return w.map(function(e){var n,t,i=null===(n=e.childSchedules)||void 0===n?void 0:n[0];return i?{id:i.id,serviceLine:e.service.name,schedule:i.name,rate:i.normal,rateOOH:i.ooh,ratePremium:i.premium,locations:(null===(t=i.locations)||void 0===t?void 0:t.map(function(e){return e.location.name}).join(", "))||"-",coverageArea:e.postcodeAreas.map(function(e){return e.postcode.area}).join(", "),minimumDuration:i.minimumDuration,minimumIncrement:i.minimumIncrement,status:i.status,serviceId:i.serviceId,isChild:!0}:{id:e.id,serviceLine:e.service.name,schedule:e.name,rate:e.normal,rateOOH:e.ooh,ratePremium:e.premium,locations:"-",coverageArea:e.postcodeAreas.map(function(e){return e.postcode.area}).join(", "),minimumDuration:e.minimumDuration,minimumIncrement:e.minimumIncrement,status:e.status,serviceId:e.serviceId}})},[w]);return(0,i.jsxs)(i.Fragment,{children:[m,(0,i.jsx)(ni.X,{open:b,close:function(){return y(!1)},initialFilters:t,setFilters:g}),(0,i.jsx)(e4.Z,{width:"100%",spacing:2,children:(0,i.jsxs)(e5.Z,{sx:{paddingTop:"16px",paddingBottom:"16px",height:d},children:[(0,i.jsxs)(e4.Z,{direction:"row",justifyContent:"space-between",pl:2,pr:2,children:[(0,i.jsx)(e8.Z,{variant:"h5",sx:{fontWeight:600},children:"Services"}),(0,i.jsx)(e3.Z,{startIcon:(0,i.jsx)(nr.Z,{}),variant:"contained",onClick:function(){return y(!0)},children:"Filters"})]}),(0,i.jsx)(e9.i,{autoHeight:!1,loading:S,ref:j,columns:k,rows:D,meta:N,refetch:T,containerHeight:c,columnVisibilityModel:{locations:"Customer"===o,actions:n},onRowClick:function(e){return L(e.row)}})]})})]})};no.propTypes={editable:g().bool,initialFilters:g().object,parentEntity:g().oneOf(["System-Customer"]).isRequired,entity:g().oneOf(["Customer","Location"]).isRequired,entityId:g().string,tableHeight:g().string,paperHeight:g().string},no.defaultProps={editable:!1,tableHeight:"calc(100% - 42px)",paperHeight:"calc(100% - 32px)"};var na=function(){var e,n=(0,B.x)(),t=n.hasRole,r=n.user,o=(0,z.q)(),a=o.hasUserModule,d=o.admin,p=(0,c.useRouter)().query,v=(0,s.useMemo)(function(){return p.tab||"details"},[p.tab]),h=(null==d?void 0:null===(e=d.modules)||void 0===e?void 0:e.sageIntegration)||!1,g="customer"===r.accountType?r.accountId:p.id,x=t("admin"),b=t("customer_user"),y=a("finances"),Z=a("quotes"),j=(0,u.aM)(l.UB,{fetchPolicy:"no-cache",variables:{id:g}}),I=j.loading,C=j.data,_=(void 0===C?{customer:{}}:C).customer,A=j.error,w=j.refetch;if(A)return"Error! ".concat(A);var N={accountId:_.id,q:null,filterType:"customer_locations_tab"},S=[(0,i.jsx)("div",{active:"details"===v||!v,label:"Details",children:(0,i.jsx)(eI,{customer:_,hasRole:t,refetch:w})}),(0,i.jsx)("div",{hide:b&&!y,active:"finance"===v,label:"Finance",children:(0,i.jsx)(eC.b,{type:"customer",accountId:_.id,accountName:_.name,accountRefetch:w,meta:_.meta,hasSageIntegration:h})}),(0,i.jsx)("div",{active:"users"===v,label:"Users",children:(0,i.jsx)(e1.q,{accountType:"customer",filters:{accountId:_.id}})}),(0,i.jsx)("div",{active:"locations"===v,label:"Locations",children:(0,i.jsx)(eX.V,{accountId:_.id,accountName:_.name,columnVisibilityModel:{customer:!1,totalSpent:!b||y},initialFilters:N,tableContainerHeight:"calc(80vh - 22px)"})}),(0,i.jsxs)("div",{active:"compliance"===v,label:"Compliance",children:[(0,i.jsx)(K,{accountId:_.id,filters:{accountId:_.id},hiddenColumns:["Address","Customer"],initialFilters:{accountId:_.id,filterType:"customer_compliance_tab"},showMediaButton:!0,showOverallRating:!0,sortOrder:{item:"expiryAt",order:"desc"}}),(0,i.jsx)(f.J,{FiltersComp:eG,initialFilters:{customerId:_.id,startDate:null,endDate:null,status:null,locationId:null,supplierId:null,noAssignToMeFilter:!0,id:null,filterType:"customer_bookings_quotes_tab"},TableComp:eR,workorderVisibility:!0})]}),(0,i.jsx)("div",{active:"work-orders"===v,label:"Work Orders",children:(0,i.jsx)(eQ.A,{filtersVisibilityModel:{customer:!1,user:t("customer"),location:t(["admin","customer"]),accountManager:!1,manager:!1,customerManager:!1},entityRelationToFetch:{customerId:_.id},initialFilters:{startDate:null,endDate:null,status:null,customerId:_.id,locationId:null,supplierId:null,noAssignToMeFilter:!0,id:null,filterType:"locations_work_orders_tab"},columnVisibilityModel:{customerNet:Boolean(!b||y),amountOutstanding:Boolean(!b||y)}})}),(0,i.jsx)("div",{active:"slas"===v,label:"SLAs",children:(0,i.jsxs)(m.Z,{handleChange:!1,children:[(0,i.jsx)("div",{active:!0,label:"Work Order SLAs",children:(0,i.jsx)(e2.H,{title:"Work Order SLAs",subtype:"reactive",isEntity:!0,entity:"Account",entityId:_.id})}),(0,i.jsx)("div",{label:"Quote SLAs",children:(0,i.jsx)(e2.H,{title:"Quote SLAs",subtype:"quote",isEntity:!0,entity:"Account",entityId:_.id})})]})}),(0,i.jsx)("div",{hide:b&&!y,active:"services"===v,label:"Services",children:(0,i.jsx)(no,{editable:x,initialFilters:{filterType:"customer"},parentEntity:"System-Customer",entity:"Customer",entityId:_.id,paperHeight:"calc(100vh - 90px)"})}),(0,i.jsx)("div",{hide:b&&!Z,active:"quotes"===v,label:"Quotes",children:(0,i.jsx)(f.J,{FiltersComp:eK.r,initialFilters:{customerId:_.id,supplierId:null,status:null,id:null,filterType:"customer_quote_tab"},TableComp:e0.v})})];return!I&&(0,i.jsx)(m.Z,{children:S.filter(function(e){return!e.props.hide})},v)},ns=function(){return(0,i.jsx)(o.Z,{children:(0,i.jsx)(a.Z,{md:12,children:(0,i.jsx)(na,{})})})},nc=function(){return(0,i.jsx)(ns,{})};nc.getLayout=function(e){return(0,i.jsx)(r.Z,{children:e})};var nd=nc}},function(e){e.O(0,[3662,367,2283,212,8890,619,2583,4135,8579,6043,1838,4244,3911,1417,3776,1564,3054,2329,8500,778,4046,1023,7454,1870,2797,1047,4043,8062,3058,6313,597,3754,4061,5447,9528,964,8849,8344,6733,6096,7305,1514,2982,5185,5469,6625,5463,1105,1,1302,6148,9774,2888,179],function(){return e(e.s=55328)}),_N_E=e.O()}]);