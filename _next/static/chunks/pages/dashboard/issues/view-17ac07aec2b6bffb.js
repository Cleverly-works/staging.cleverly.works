(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9312],{39647:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/issues/view",function(){return t(87189)}])},45815:function(e,n,t){"use strict";t.d(n,{z:function(){return a}});var i=t(7297),r=t(75063);function o(){var e=(0,i.Z)(["\n  fragment AccountFields on Account {\n    id\n    type\n    name\n    status\n    vatId\n  }\n"]);return o=function(){return e},e}var a=(0,r.Ps)(o())},78232:function(e,n,t){"use strict";t.d(n,{F:function(){return R}});var i=t(14924),r=t(26042),o=t(69396),a=t(85893),s=t(45697),u=t.n(s),l=t(10166),c=t(80482),d=t(23776),p=t(98456),m=t(16143),f=t(50135),v=t(99534),h=t(29815),b=t(74061),x=t(6498),g=t(75438),j=t(15861),y=t(61730),Z=t(67294),I=(0,Z.createContext)({}),S=(0,Z.forwardRef)(function(e,n){var t=(0,Z.useContext)(I);return(0,a.jsx)("div",(0,r.Z)({ref:n},e,t))}),w=(0,Z.forwardRef)(function(e,n){var t=e.children,i=(0,v.Z)(e,["children"]),r=[];t.forEach(function(e){r.push(e),r.push.apply(r,(0,h.Z)(e.children||[]))});var o,s,u=(0,x.u)(),l=(0,y.Z)(u.breakpoints.up("sm"),{noSsr:!0}),c=r.length,d=l?36:48,p=function(e){return e.hasOwnProperty("group")?48:d},m=(s=(0,Z.useRef)(null),(0,Z.useEffect)(function(){null!=s.current&&s.current.resetAfterIndex(0,!0)},[c]),s);return(0,a.jsx)("div",{ref:n,children:(0,a.jsx)(I.Provider,{value:i,children:(0,a.jsx)(b.S_,{itemData:r,height:(c>8?8*d:r.map(p).reduce(function(e,n){return e+n},0))+16,width:"100%",ref:m,outerElementType:S,innerElementType:"ul",itemSize:function(e){return p(r[e])},overscanCount:5,itemCount:c,children:C})})})});function C(e){var n=e.data,t=e.index,i=e.style,s=n[t],u=(0,o.Z)((0,r.Z)({},i),{top:i.top+8});return s.hasOwnProperty("group")?(0,a.jsx)(g.Z,{component:"div",style:u,children:s.group},s.key):(0,a.jsx)(j.Z,(0,o.Z)((0,r.Z)({component:"li"},s[0]),{noWrap:!0,style:u,children:s[1].label}))}var R=function(e){var n=e.label,t=e.loading,i=e.placeholder,s=e.error,u=e.helperText,l=e.inputProps;return(0,a.jsx)(_,(0,o.Z)((0,r.Z)({},e),{disableListWrap:!0,PopperComponent:q,ListboxComponent:w,renderInput:function(e){return(0,a.jsx)(f.Z,(0,o.Z)((0,r.Z)({},e,l),{error:s,helperText:u,label:n,placeholder:i,color:"secondary",variant:"standard",InputProps:(0,o.Z)((0,r.Z)({},e.InputProps,(null==l?void 0:l.InputProps)||{}),{endAdornment:(0,a.jsxs)(a.Fragment,{children:[t?(0,a.jsx)(p.Z,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})})}))},renderOption:function(e,n,t){return[e,n,t.index]},renderGroup:function(e){return e}}))};R.defaultProps={value:null,onChange:function(){},label:"",loading:!1,error:!1,onOpen:function(){},options:[],inputProps:{},withoutSelectIcon:!1},R.propTypes={value:u().shape({value:u().any,label:u().string}),onChange:u().func,label:u().string,loading:u().bool,onOpen:u().func,options:u().arrayOf(u().shape({value:u().any,label:u().string})),inputProps:u().object,withoutSelectIcon:u().bool,inputValue:u().string,onInputChange:u().func};var q=(0,l.Z)(m.Z)((0,i.Z)({zIndex:"12000 !important"},"& .".concat(c.Z.listbox),{boxSizing:"border-box","& ul":{padding:0,margin:0}})),_=(0,l.Z)(d.Z)(function(e){var n=e.withoutSelectIcon;return{"& .MuiAutocomplete-root":{cursor:"pointer"},"& .MuiAutocomplete-popper":{zIndex:"12000 "},"& .MuiAutocomplete-endAdornment":{"& .MuiButtonBase-root.MuiIconButton-root.MuiAutocomplete-popupIndicator":{"& .MuiSvgIcon-root":(0,r.Z)({},n&&{display:"none"})}}}})},44123:function(e,n,t){"use strict";t.d(n,{z:function(){return et}});var i=t(47568),r=t(26042),o=t(69396),a=t(828),s=t(97582),u=t(85893),l=t(67294),c=t(45697),d=t(66252),p=t(6388),m=t(50319),f=t(7297),v=t(75063);function h(){var e=(0,f.Z)(["\n  mutation InsertExpense($objects: [Expense_insert_input!]!) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return h=function(){return e},e}function b(){var e=(0,f.Z)(["\n  mutation UpdateExpense($id: Int!, $changes: Expense_set_input) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return b=function(){return e},e}function x(){var e=(0,f.Z)(["\n  mutation UpdateExpense($parentId: Int!, $changes: Expense_set_input) {\n    parentExspense: update_Expense(where: { id: { _eq: $parentId } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n    childExpenses: update_Expense(where: { parentId: { _eq: $parentId } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return x=function(){return e},e}function g(){var e=(0,f.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']);return g=function(){return e},e}function j(){var e=(0,f.Z)(["\n  mutation DeleteExpense($id: Int!) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n  }\n"]);return j=function(){return e},e}var y=(0,v.Ps)(h()),Z=(0,v.Ps)(b()),I=(0,v.Ps)(x()),S=(0,v.Ps)(g()),w=(0,v.Ps)(j()),C=t(52019),R=t(11082),q=t(68956),_=t(16551),T=t(77439),A=t(33006),E=t(9270),D=t(62140),P=t(86036),k=t(8500),$=t(11585),O=t(22595),N=t(35418),H=t(42283),F=t(79665),M=t(76600),L=t(90951),J=t(28497),U=t(49501),V=t(55563),Q=t(32979),z=t(6710),Y=t(66812),B=t(74231),W=(0,B.Ry)().shape({amount:(0,B.Rx)().required(),unit:(0,B.Rx)().required(),categoryId:(0,B.Ry)().required(),description:(0,B.Z_)().required(),markup:(0,B.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),paid:(0,B.Z_)().oneOf(["admin","supplier"]).required(),vatMarkup:(0,B.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable()}),G=function(e){e.categories,e.currency;var n=e.defaultValues,t=e.submit,i=e.serviceRateExpenses,a=e.showRecurring;(null==n?void 0:n.vat)&&(null==n?void 0:n.vat)!=="20"&&(n.vatMarkup=n.vat,n.vat="custom");var s=(0,H.cI)({defaultValues:(0,r.Z)({vat:"20"},n),resolver:(0,F.S)(W)}),l=s.control,c=s.errors,d=s.handleSubmit,p=s.register,m=(0,s.watch)("vat"),f={control:l,errors:c,register:p};return(0,u.jsxs)(M.Z,{id:"offCanvasForm",handleSubmit:d(t),children:[(0,u.jsx)(L.Z,(0,o.Z)((0,r.Z)({},f),{name:"paid",data:[{id:"admin",label:"Admin",value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],legend:"Paid by"})),(0,u.jsx)(J.Z,(0,o.Z)((0,r.Z)({},f),{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,u.jsx)(U.Z,{label:"Units",children:(0,u.jsx)(V.Z,(0,o.Z)((0,r.Z)({},f),{name:"unit"}))}),(0,u.jsx)(L.Z,(0,o.Z)((0,r.Z)({},f),{name:"vat",data:[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],legend:"VAT"})),"custom"===m&&(0,u.jsx)(Q.Z,(0,o.Z)((0,r.Z)({},f),{label:"Custom VAT",name:"vatMarkup"})),i?(0,u.jsx)(V.Z,(0,o.Z)((0,r.Z)({},f),{name:"markup",type:"hidden"})):(0,u.jsx)(Q.Z,(0,o.Z)((0,r.Z)({},f),{label:"Markup ".concat(i?"(Service Rate Expenses and Materials : ".concat(i,"%)"):""),name:"markup"})),(0,u.jsx)(Y.P,(0,o.Z)((0,r.Z)({},f),{errors:(0,r.Z)({},c),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,u.jsx)(U.Z,{label:"Description",children:(0,u.jsx)(z.Z,(0,o.Z)((0,r.Z)({},f),{name:"description",rows:2}))}),a&&(0,u.jsx)(L.Z,(0,o.Z)((0,r.Z)({},f),{name:"recurring",data:[{id:"recurring",label:"Recurring",value:"recurring"},{id:"nextInvoice",label:"Only for next invoice",value:"nextInvoice"}]})),n.id&&(0,u.jsx)(V.Z,(0,o.Z)((0,r.Z)({},f),{name:"id",type:"hidden"}))]})};G.propTypes={currency:c.string,defaultValues:c.object,serviceRateExpenses:c.number,submit:c.func.isRequired},G.defaultProps={currency:"GBP",serviceRateExpenses:0,showRecurring:!1};var K=t(46169),X=t(8732),ee=t(9928),en=t(64872),et=function(e){var n,t,c,f,v,h,b=e.currency,x=e.enableUpdate,g=e.entity,j=e.entityId,H=e.job,F=e.jobs,M=e.refetchParent,L=e.tab,J=e.withDetails,U=e.showRecurring,V=(0,d.x)(),Q=(0,l.useContext)(C.Z).hasRole,z=(0,en.a)(),Y=(0,O.E)(H,"invoiceSent"),B=(0,O.E)(H,"closed"),W=Q("customer")&&!Y,et=!H||!B&&(Q(["admin"])&&!(0,O.E)(H,["validated","unvalidated"])||Q(["admin","supplier"])&&!(0,O.E)(H,"reportSent")||x),ei=(0,X.B)("serviceRateExpenses",null==H?void 0:H.financeLogs,null==H?void 0:null===(n=H.customer)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:null===(c=t.finance)||void 0===c?void 0:c.serviceRateExpenses)||0,er=L||(!Q("admin")&&Q("supplier")?"supplier":"admin"),eo=(0,p.aM)(S,{variables:{entity:g,entityId:j,jobId:null==H?void 0:H.id},skip:W}),ea=eo.data,es=(void 0===ea?{expenses:[]}:ea).expenses,eu=eo.loading,el=eo.refetch,ec=(0,K.E)(es,0,er),ed=ec.preparedExpenses,ep=ec.totalExpenses,em=ec.totalExpensesExVAT,ef=(0,a.Z)((0,m.D)(w,{onCompleted:function(){H&&(0,ee.F)(V,H.id),"JobSchedule"===g&&j&&(0,ee.j)({client:V,scheduleId:j}),"Location"===g&&j&&(0,ee.j)({client:V,locationId:j}),M?M():el()}}),1)[0],ev=(0,a.Z)((0,m.D)(y,{onCompleted:function(){H&&(0,ee.F)(V,H.id),"JobSchedule"===g&&j&&(0,ee.j)({client:V,scheduleId:j}),"Location"===g&&j&&(0,ee.j)({client:V,locationId:j}),z.close(),M?M():el()}}),1)[0],eh=(0,a.Z)((0,m.D)(Z,{onCompleted:function(){H&&(0,ee.F)(V,H.id),"JobSchedule"===g&&j&&(0,ee.j)({client:V,scheduleId:j}),"Location"===g&&j&&(0,ee.j)({client:V,locationId:j}),z.close(),M?M():el()}}),1)[0],eb=(0,a.Z)((0,m.D)(I,{onCompleted:function(){H&&(0,ee.F)(V,H.id),"JobSchedule"===g&&j&&(0,ee.j)({client:V,scheduleId:j}),"Location"===g&&j&&(0,ee.j)({client:V,locationId:j}),z.close(),M?M():el()}}),1)[0],ex=(f=(0,i.Z)(function(e){var n,t;return(0,s.__generator)(this,function(i){switch(i.label){case 0:if(!e.id)return[3,2];return delete(n=(0,r.Z)({},e)).id,[4,eb({variables:{parentId:e.id,changes:n}})];case 1:return i.sent(),[3,4];case 2:return t=(0,o.Z)((0,r.Z)({},e),{entity:g,entityId:j,Expenses:{data:F.map(function(n){return(0,o.Z)((0,r.Z)({},e),{jobId:n.id})})}}),[4,ev({variables:{objects:t}})];case 3:i.sent(),i.label=4;case 4:return[2]}})}),function(e){return f.apply(this,arguments)}),eg=(v=(0,i.Z)(function(e){var n,t;return(0,s.__generator)(this,function(i){switch(i.label){case 0:if("custom"===e.vat&&(e.vat=e.vatMarkup),t=(n=e.unit*e.amount)*(e.markup/100)+n,e.total=t*(e.vat/100)+t,delete e.vatMarkup,e.categoryId=e.categoryId.value,"JobSchedule"!==g)return[3,2];return[4,ex(e)];case 1:case 3:return i.sent(),[3,6];case 2:if(!e.id)return[3,4];return[4,eh({variables:{id:e.id,changes:e}})];case 4:return[4,ev({variables:{objects:(0,o.Z)((0,r.Z)({},e),{jobId:null==H?void 0:H.id})}})];case 5:i.sent(),i.label=6;case 6:return[2]}})}),function(e){return v.apply(this,arguments)}),ej=function(e){var n=e.item?(0,r.Z)({},null==e?void 0:e.item):{markup:ei};(null==n?void 0:n.vat)&&(n.vat=String(n.vat)),z.show({content:(0,u.jsx)(G,{currency:b,defaultValues:n,entityId:j,submit:eg,serviceRateExpenses:ei,showRecurring:U}),title:"Expenses"})},ey=function(e,n){e.preventDefault(),e.stopPropagation(),ef({variables:{id:n.item.id}})},eZ=function(e){z.show({content:(0,u.jsx)(N.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})},eI=[{text:"Description"},{formatter:function(e){var n=e.row;return(0,R.Z)(n.total,b)},text:"Total"},{text:"Paid By"},{formatter:q.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,n){return ej(n)},tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],numberOverlay:"mediaCount",onClick:function(e,n){return eZ(n)},tooltip:"Media"},{context:"danger",icon:["fas","trash"],onClick:function(e,n){return ey(e,n)},tooltip:"Delete"}],hidden:!et,text:"Actions"},{hidden:!0},{hidden:!0}],eS=function(){return(0,u.jsx)(_.Z,{children:(0,u.jsx)(T.Z,{context:"secondary",content:"Add",onClick:ej,size:"sm"})})},ew=function(){return(0,u.jsxs)(u.Fragment,{children:[!J&&(0,u.jsx)(A.Z,{content:"Expenses",tag:"h3"}),(0,u.jsxs)(E.Z,{children:[(0,u.jsx)(D.Z,{md:6,children:(0,u.jsx)(P.Z,{content:"Total",text:(0,R.Z)(em,b)})}),(0,u.jsx)(D.Z,{md:6,children:(0,u.jsx)(P.Z,{content:"VAT Total",text:(0,R.Z)(ep,b)})})]}),(0,u.jsx)(k.Z,{columns:eI,loading:eu,rows:null==ed?void 0:ed.map(function(e){var n,t;return{description:e.description,total:e.total,paid:e.paid.charAt(0).toUpperCase()+e.paid.slice(1),actions:"",item:(0,r.Z)({},e,{occurredAt:new Date(e.occurredAt)},{categoryId:{label:null===(n=e.category)||void 0===n?void 0:n.name,value:e.categoryId}}),mediaCount:null===(t=e.media)||void 0===t?void 0:t.length}})}),et&&!J&&(0,u.jsx)(_.Z,{align:"flex-end",children:(0,u.jsx)(T.Z,{context:"secondary",content:"Add",onClick:ej,size:"sm"})})]})};return J?(0,u.jsx)($.Z,{toolbar:et&&(0,u.jsx)(eS,{}),open:!0,title:"Expenses",children:ew()}):ew()};et.propTypes={currency:c.string,enableUpdate:c.bool,entity:c.string,entityId:c.number,job:c.object,jobs:(0,c.arrayOf)(c.object),refetchParent:c.func,tab:c.string,withDetails:c.bool},et.defaultProps={currency:"GBP",enableUpdate:!1,withDetails:!0,showRecurring:!1}},46169:function(e,n,t){"use strict";t.d(n,{E:function(){return o}});var i=t(26042),r=t(69396),o=function(e,n,t){var o=0,a=0,s=null==e?void 0:e.filter(function(e){return"supplier"===t&&"supplier"===e.paid||"supplier"!==t});return{preparedExpenses:null==s?void 0:s.map(function(e){var s=e.amount;"supplier"!==t&&(s+=e.markup/100*s,s/=1-n/100);var u=s*(e.unit||1),l=u+u*(e.vat/100);return a+=u,o+=l,(0,r.Z)((0,i.Z)({},e),{id:e.id,name:e.description,unitCost:s,price:u,total:l,unit:e.unit||1,vatAmount:u*(e.vat/100),vatRate:e.vat/100,markup:e.markup})}),totalExpenses:o,totalExpensesExVAT:a}}},8732:function(e,n,t){"use strict";t.d(n,{B:function(){return r}});var i=t(29815),r=function(e,n,t){if(!n)return null;var r,o=null===(r=(0,i.Z)(n).sort(function(e,n){return e.createdAt-n.createdAt}).find(function(n){return n.type===e}))||void 0===r?void 0:r.value;return o||0===o?o:t||0}},48218:function(e,n,t){"use strict";t.d(n,{L:function(){return i}});var i=function(e){for(var n="",t=e.slice().sort(function(e,n){return Number(e.id)-Number(n.id)}),i=t.length-1;i>=0;i--){var r=t[i].status;if("onHold"===r||"resumed"===r||"paused"===r||"continued"===r){n=t[i].status;break}}return n}},22595:function(e,n,t){"use strict";t.d(n,{E:function(){return i}});var i=function(e,n){if(Array.isArray(n)){var t,i=null;return n.forEach(function(n){var t,r=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});i=(null==r?void 0:r.createdAt)||i}),i}var r=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});return(null==r?void 0:r.createdAt)||null}},90114:function(e,n,t){"use strict";t.d(n,{OQ:function(){return u},Pn:function(){return r},TT:function(){return o},Xd:function(){return a},aH:function(){return i},nN:function(){return s}});var i=function(e,n,t){var i,r=null===(i=null==n?void 0:n.slice())||void 0===i?void 0:i.sort(function(e,n){return n.id-e.id});return null==r?void 0:r.find(function(n){return n.status==="".concat(e,"QuoteThresholdApproval")&&t===n.quoteId})},r=function(e,n,t){var i,r=null===(i=null==n?void 0:n.slice())||void 0===i?void 0:i.sort(function(e,n){return n.id-e.id});return null==r?void 0:r.find(function(n){return n.status==="".concat(e,"QuoteThresholdApproved")&&t===n.quoteId})},o=function(e,n,t){var i,r=null===(i=null==n?void 0:n.slice())||void 0===i?void 0:i.sort(function(e,n){return n.id-e.id});return null==r?void 0:r.find(function(n){return n.status==="".concat(e,"QuoteThresholdRejected")&&t===n.quoteId})},a=function(e,n){var t,i=null===(t=null==n?void 0:n.slice())||void 0===t?void 0:t.sort(function(e,n){return n.id-e.id});return null==i?void 0:i.find(function(n){return n.status==="".concat(e,"ThresholdApproval")})},s=function(e,n){var t,i=null===(t=null==n?void 0:n.slice())||void 0===t?void 0:t.sort(function(e,n){return n.id-e.id});if(Array.isArray(e)){var r=null;return e.forEach(function(e){r=(null==i?void 0:i.find(function(n){return n.status==="".concat(e,"ThresholdApproved")}))||r}),r}return null==i?void 0:i.find(function(n){return n.status==="".concat(e,"ThresholdApproved")})},u=function(e,n){var t,i=null===(t=null==n?void 0:n.slice())||void 0===t?void 0:t.sort(function(e,n){return n.id-e.id});return null==i?void 0:i.find(function(n){return n.status==="".concat(e,"ThresholdRejected")})}},61816:function(e,n,t){"use strict";t.d(n,{n:function(){return f}});var i=t(26042),r=t(69396),o=t(85893),a=t(45697),s=t(11585),u=t(90951),l=t(28497),c=t(15214),d=t(9270),p=t(62140),m=t(44634),f=function(e){var n=e.errors,t=e.register,a=e.pricingWatch,f=e.hasServiceRate,v=e.isPPM,h={register:t,errors:n},b=m.Hu.filter(function(e){var n=e.value;return!v||"fixed"===n});return(0,o.jsxs)(s.Z,{dataSet:{"data-cy":"pricing"},open:!0,title:"Pricing",children:[(0,o.jsx)(u.Z,(0,r.Z)((0,i.Z)({},h),{data:b,legend:"Pricing",name:"pricing"})),"time-materials"===a&&(0,o.jsx)(l.Z,(0,r.Z)((0,i.Z)({},h),{label:"Spend Threshold",name:"customerSpendThreshold",vat:"Ex VAT"})),"fixed"===a&&(0,o.jsxs)(o.Fragment,{children:[f?(0,o.jsx)(c.Z,{content:"This customer has a service rate on their account. The customer amounts will be calculated using the relevant service rates.",context:"info"}):(0,o.jsx)(l.Z,(0,r.Z)((0,i.Z)({},h),{label:"Customer",name:"amount",vat:"Ex VAT"})),(0,o.jsxs)(d.Z,{children:[(0,o.jsx)(p.Z,{sm:12,md:6,children:(0,o.jsx)(l.Z,(0,r.Z)((0,i.Z)({},h),{label:"Supplier labour amount",name:"supplierLabourAmount",vat:"Ex VAT"}))}),(0,o.jsx)(p.Z,{sm:12,md:6,children:(0,o.jsx)(l.Z,(0,r.Z)((0,i.Z)({},h),{label:"Supplier materials amount",name:"supplierMaterialsAmount",vat:"Ex VAT"}))})]})]})]})};f.propTypes={errors:a.object.isRequired,pricingWatch:a.string,register:a.func.isRequired,hasServiceRate:a.bool,isPPM:a.bool}},64714:function(e,n,t){"use strict";t.d(n,{t:function(){return c}});var i=t(26042),r=t(69396),o=t(85893),a=t(45697),s=t(11585),u=t(66812),l=t(32749),c=function(e){var n=e.control,t=e.errors,a={control:n,errors:t,register:e.register};return(0,o.jsxs)(s.Z,{dataSet:{"data-cy":"taxonomy"},open:!0,title:"Service",children:[(0,o.jsx)(l.l,(0,r.Z)((0,i.Z)({},a),{label:"Cost category",name:"costCategorySelected",type:"costCategory"})),(0,o.jsx)(u.P,(0,r.Z)((0,i.Z)({},a),{errors:(0,i.Z)({},t),name:"serviceSelected",label:"Service",type:"service"}))]})};c.propTypes={control:a.object.isRequired,errors:a.object.isRequired,register:a.func.isRequired}},59983:function(e,n,t){"use strict";t.d(n,{X:function(){return R}});var i=t(82670),r=t(26042),o=t(69396),a=t(85893),s=t(67294),u=t(45697),l=t(11585),c=t(49501),d=t(95103),p=t(90951),m=t(9270),f=t(62140),v=t(58594),h=t(21300),b=t(44634),x=[{text:"Select...",value:""},{text:"Today",value:"today"},{text:"This week",value:"thisWeek"},{text:"This month",value:"thisMonth"},{text:"Next Three month",value:"nextThreeMonth"}],g=t(4135),j=t(43703),y=t(11640),Z=t(83894),I=t(69119),S=t(67090),w=function(){var e=(0,g.Z)(new Date),n=(0,j.Z)(new Date),t=(0,g.Z)((0,y.Z)(new Date(n),2)),i=(0,Z.Z)(new Date),r=(0,I.Z)(new Date),o=(0,S.Z)(new Date);return{monthEnd:e,nextThreeEnd:t,todayEnd:i,todayStart:r,weekEnd:o}},C=b.KB,R=function(e){var n=e.control,t=e.errors,u=e.hasRole,g=e.query,j=e.register,y=e.setValue,Z=e.timingWatch,I=e.watch,S={control:n,errors:t,register:j},R=u("customer")&&!u("admin"),q=I("pricing"),_=I("timingStart"),T=I("timingEnd"),A=I("multipleDays"),E=I("timeSpan"),D=I("timing");(0,s.useEffect)(function(){R&&(C=b.KB.filter(function(e){return"at"!==e.value}),y("timing","between")),E&&P({time:E,setValue:y})},[E]),(0,s.useEffect)(function(){"at"===D&&y("timeSpan","")},[D]);var P=function(e){var n,t,i=e.time,r=e.setValue,o=w(),a=o.monthEnd,s=o.todayStart,u=o.weekEnd,l=o.todayEnd,c=o.nextThreeEnd;switch(i){case"today":n=s,t=l;break;case"thisWeek":n=s,t=u;break;case"thisMonth":n=s,t=a;break;case"nextThreeMonth":n=s,t=c}r("timing","between"),r("timingStart",n),r("timingEnd",t)},k=function(e){var n=new Date,t=new Date(e);return n.getTime()<t.getTime()},$=function(e){var n=_?new Date(_):new Date,t=new Date(e);return n.getTime()<t.getTime()};return(0,a.jsxs)(l.Z,{dataSet:{"data-cy":"timing"},open:!0,title:"Timing",children:[!(null==g?void 0:g.id)&&y&&(0,a.jsx)(c.Z,{label:"Select Time span",children:(0,a.jsx)(d.Z,(0,o.Z)((0,r.Z)({},S),{name:"timeSpan",options:x}))}),(0,a.jsx)(p.Z,(0,o.Z)((0,r.Z)({},S),{data:C,legend:"Timing",name:"timing"})),(0,a.jsxs)(m.Z,{children:[(0,a.jsxs)(f.Z,{md:12,children:[(0,a.jsx)(c.Z,{label:"Start time"}),(0,a.jsx)(h.M,(0,o.Z)((0,r.Z)({},S),{dateFormat:"d MMM yyyy HH:mm",maxDate:T?new Date(T):null,minDate:new Date,filterTime:k,name:"timingStart",placeholder:"Click to select Start time",showTimeSelect:!0,todayButton:!1}))]}),"at"!==Z&&(0,a.jsxs)(f.Z,{md:12,children:[(0,a.jsx)(c.Z,{label:"End time"}),(0,a.jsx)(h.M,(0,o.Z)((0,r.Z)({},S),{dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,minDate:_?new Date(_):new Date,filterTime:$,name:"timingEnd",showTimeSelect:!0,todayButton:!1}))]})]}),(0,i.Z)(_,Date)&&"fixed"===q&&(0,a.jsx)(v.Z,(0,o.Z)((0,r.Z)({},S),{data:[{id:"multipleDays",label:"Multiple days"}],name:"multipleDays"})),A&&(0,a.jsx)(c.Z,{label:"End Date",children:(0,a.jsx)(h.M,(0,o.Z)((0,r.Z)({},S),{dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!0,filterTime:$,minDate:_?new Date(_):new Date,name:"endDate",showTimeSelect:!0,todayButton:!1}))}),u("admin")&&(0,a.jsx)(v.Z,(0,o.Z)((0,r.Z)({},S),{data:[{id:"allowTimingNormalHours",label:"Allow premium rates to be used",value:"allowTimingNormalHours"}],name:"allowTimingNormalHours"}))]})};R.propTypes={control:u.object.isRequired,errors:u.object.isRequired,query:u.object.isRequired,register:u.func.isRequired,setValue:u.func,timingWatch:u.string}},40234:function(e,n,t){"use strict";t.d(n,{I:function(){return r}});var i=t(77349),r=function(e){var n,t,r,o,a,s,u,l,c,d=e.job,p=e.type,m=e.invoiceDate,f=parseInt(null===(n=d.admin)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:null===(r=t.finance)||void 0===r?void 0:r.invoiceDueDate)||30;return"customer"===p&&(f=parseInt(null===(o=d.customer)||void 0===o?void 0:null===(a=o.meta)||void 0===a?void 0:null===(s=a.finance)||void 0===s?void 0:s.invoiceDueDate)||parseInt(null===(u=d.admin)||void 0===u?void 0:null===(l=u.meta)||void 0===l?void 0:null===(c=l.finance)||void 0===c?void 0:c.invoiceDueDate)||30),(0,i.Z)(new Date(m),f)}},35842:function(e,n,t){"use strict";t.d(n,{e:function(){return f}});var i,r=t(47568),o=t(97582),a=t(26186),s=t(85113),u=t(22595),l=t(35381),c=t(22244),d=t(13777),p=t(63139),m=t(48764).Buffer,f=(i=(0,r.Z)(function(e){var n,t,i,r,f,v,h,b,x,g,j,y,Z,I,S,w,C,R,q,_,T,A,E,D,P,k,$,O,N,H;return(0,o.__generator)(this,function(o){switch(o.label){case 0:return n=e.adminId,t=e.job,r=void 0===(i=e.openReport)||i,D=function(){return t.media.filter(function(e){var n;return"image"===e.item.type&&!(null===(n=e.item.meta)||void 0===n?void 0:n.adminOnly)}).map(function(e){var n,t;if(null===(n=e.item)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:t.thumbnails){var i=e.item.meta.thumbnails.find(function(e){return"small"===e.name});if(i)return{filename:i.relativePath}}return{filename:e.item.filename}})},P=(0,s.WE)(t.location,"registered"),k=c.hD.find(function(e){var n;return e.value===(null===(n=t.report)||void 0===n?void 0:n.completion)}),O={job:{assets:t.assets,address:null==P?void 0:P.address,sublocation:t.sublocation,contractor:null===(f=t.supplier)||void 0===f?void 0:f.name,completedAt:"incorrect"===t.timingStatus?t.correctEnd:(0,a.Z)((0,u.E)(t,"completed")),customer:null===(v=t.customer)||void 0===v?void 0:v.name,description:m.from(t.description).toString("base64"),expenses:null===(h=t.expenses)||void 0===h?void 0:h.map(function(e){return e.description}),further:(null==k?void 0:k.text)||null,id:t.id,notes:(null===(b=t.report)||void 0===b?void 0:b.notes)?m.from(null==t?void 0:null===(x=t.report)||void 0===x?void 0:x.notes).toString("base64"):"",number:t.number,raisedBy:(0,l.j$)(t,"pending"),reference:t.reference,service:null===(g=t.service)||void 0===g?void 0:g.name,dateStart:"incorrect"===t.timingStatus?t.correctStart:(0,u.E)(t,"inProgress"),dateEnd:"incorrect"===t.timingStatus?t.correctEnd:(0,u.E)(t,"completed"),priority:null===(j=t.sla)||void 0===j?void 0:j.name,passFailStatus:null===(y=t.report)||void 0===y?void 0:y.passFailStatus,customerSignature:(null===(Z=t.report)||void 0===Z?void 0:null===(I=Z.meta)||void 0===I?void 0:I.customerSignatureName)?{name:null===(S=t.report)||void 0===S?void 0:S.meta.customerSignatureName,data:null===(w=t.report)||void 0===w?void 0:w.meta.customerSignatureTime}:null,supplierSignature:(null===(C=t.report)||void 0===C?void 0:null===(R=C.meta)||void 0===R?void 0:R.supplierSignatureName)?{name:null===(q=t.report)||void 0===q?void 0:q.meta.supplierSignatureName,data:null===(_=t.report)||void 0===_?void 0:_.meta.supplierSignatureTime}:null,recommendations:(null===(T=t.report)||void 0===T?void 0:T.recommendations)?m.from(null===(A=t.report)||void 0===A?void 0:A.recommendations).toString("base64"):""},jobReportId:null!==($=null===(E=t.report)||void 0===E?void 0:E.id)&&void 0!==$?$:null,adminId:n,media:D()},!(0,p.a)()&&r&&(N=window.open("/download","_blank")),[4,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/job-report/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(O)}).then(function(e){return e.json()}).then(function(e){if(r){var n,t,i;null==N||null===(n=N.location)||void 0===n||n.assign("".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)),(null==window?void 0:null===(t=window.Capacitor)||void 0===t?void 0:null===(i=t.Plugins)||void 0===i?void 0:i.Browser)&&window.Capacitor.Plugins.Browser.open({url:"".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)})}return{blob:e,link:"".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)}}).catch(function(e){(0,d.Tb)({message:e,section:"fetch"})})];case 1:return[2,o.sent()]}})}),function(e){return i.apply(this,arguments)})},737:function(e,n,t){"use strict";t.d(n,{L:function(){return b},g:function(){return h}});var i=t(47568),r=t(7297),o=t(97582),a=t(85113),s=t(63139),u=t(13777),l=t(75063),c=t(48764).Buffer;function d(){var e=(0,r.Z)(["\n  mutation PDFQuoteCreate($data: jsonb!) {\n    pdfQuoteCreate(data: $data) {\n      success\n      key\n    }\n  }\n"]);return d=function(){return e},e}var p,m,f,v=(p=(0,i.Z)(function(e,n){var t,i,r,s,u,l,d,p,m,f,v;return(0,o.__generator)(this,function(o){return(l=[],d=[],p=null,p=n?e.quotations.find(function(e){return e.id===n}):e.quotations.find(function(e){return"supplierQuoteSent"===e.status}))?(p.lineItems.forEach(function(e){var n={name:e.description,price:e.total,vatRate:.2,qty:e.qty,unit:e.qtyUnit,rate:e.unitRate};"Materials"===e.type?d.push(n):"Labour"===e.type&&l.push(n)}),m=(0,a.WE)(null==e?void 0:e.location,"registered"),f=(null===(t=p.meta)||void 0===t?void 0:t.terms)||(null==e?void 0:null===(i=e.admin)||void 0===i?void 0:null===(r=i.meta)||void 0===r?void 0:null===(s=r.quote)||void 0===s?void 0:s.terms)||"",[2,{id:p.id,job:{currency:"\xa3",customerName:null===(u=e.customer)||void 0===u?void 0:u.name,startDate:p.startDate,description:c.from(e.description).toString("base64"),duration:p.totalDuration?1===p.totalDuration?"".concat(p.totalDuration," ").concat(p.totalDurationUnit):"".concat(p.totalDuration," ").concat(p.totalDurationUnit,"s"):"-",number:e.number,reference:(null==e?void 0:e.reference)||"",labour:l,materials:d,methodStatement:p.methodStatement,propertyAddress:null==m?void 0:m.address,sublocation:e.sublocation,terms:c.from(f).toString("base64")}}]):[2,null]})}),function(e,n){return p.apply(this,arguments)}),h=(m=(0,i.Z)(function(e){var n,t,i,r,a,l,c,d,p=arguments;return(0,o.__generator)(this,function(o){switch(o.label){case 0:n=p.length>1&&void 0!==p[1]?p[1]:null,t=p.length>2?p[2]:void 0,o.label=1;case 1:return o.trys.push([1,3,,4]),(0,s.a)()||(a=window.open("/download","_blank")),[4,b(e,n,t)];case 2:if(!(l=o.sent()))throw Error("Failed to download quote");return(null==a?void 0:a.location)&&(null==a||null===(c=a.location)||void 0===c||c.assign(l)),(null==window?void 0:null===(i=window.Capacitor)||void 0===i?void 0:null===(r=i.Plugins)||void 0===r?void 0:r.Browser)&&window.Capacitor.Plugins.Browser.open({url:l}),[3,4];case 3:return d=o.sent(),(0,u.Tb)({message:d,section:"fetch"}),[3,4];case 4:return[2]}})}),function(e){return m.apply(this,arguments)}),b=(f=(0,i.Z)(function(e){var n,t,i,r,a,s,u,l,c,d=arguments;return(0,o.__generator)(this,function(r){switch(r.label){case 0:return n=d.length>1&&void 0!==d[1]?d[1]:null,t=d.length>2?d[2]:void 0,[4,v(e,n)];case 1:if(!(i=r.sent()))return[3,3];return[4,t.mutate({mutation:x,variables:{data:i}})];case 2:if(l=(u=(void 0===(a=r.sent().data)?{pdfQuoteCreate:{}}:a).pdfQuoteCreate).success,c=u.key,!l)throw Error("Failed to create PDF");return[2,"".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(c)];case 3:return[2,null]}})}),function(e){return f.apply(this,arguments)}),x=(0,l.Ps)(d())},2388:function(e,n,t){"use strict";t.d(n,{v:function(){return Z}});var i=t(14924),r=t(85893),o=t(45697),a=t.n(o),s=t(60888),u=t(59462),l=t(5616),c=t(11057),d=t(19370),p=t(51233),m=t(44472),f=t(14621),v=t(57249),h=t(10556),b=t(70490),x=t(66647),g=t(1698),j=t(15861),y=t(90948),Z=function(e){var n=e.steps,t=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(function(e){return!!e.active})},i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(function(e){var n=e.active,t=e.data;return!!n&&!!t})};return(0,r.jsx)(l.Z,{children:(0,r.jsx)(d.Z,{orientation:"vertical",connector:(0,r.jsx)(I,{}),children:n.filter(function(e){var n=e.active;return void 0===n||n}).map(function(e,n){var o=e.id,a=e.label,d=e.info,f=e.date,v=e.content,h=e.actions,b=!!f,x=i(v),g=t(h),y=b?(0,r.jsx)(s.Z,{color:"primary"}):(0,r.jsx)(u.Z,{color:"primary"});return(0,r.jsxs)(m.Z,{completed:b,expanded:!0,children:[(0,r.jsxs)(w,{icon:y,children:[(0,r.jsx)(j.Z,{sx:{fontSize:"13px",fontWeight:600},children:a}),(0,r.jsx)(j.Z,{sx:{fontSize:"10px",fontWeight:400,ml:3,opacity:.6},children:f})]}),(0,r.jsxs)(S,{children:[(0,r.jsx)(l.Z,{children:b||(null==x?void 0:x.length)>0?x.map(function(e){return"function"==typeof e.data?e.data():(0,r.jsx)(j.Z,{sx:{fontSize:"10px"},children:e.data})}):(0,r.jsx)(j.Z,{sx:{fontSize:"10px",fontStyle:"italic"},children:d})}),(null==g?void 0:g.length)>0&&(0,r.jsx)(p.Z,{mt:.5,spacing:.5,children:g.map(function(e){return"button"!==e.type?null:(0,r.jsx)(l.Z,{children:(0,r.jsx)(c.Z,{color:e.context,variant:"contained",size:"small",onClick:e.handleClick,children:e.content})})})})]})]},"".concat(a,"-").concat(o))})})})};Z.propTypes={steps:a().arrayOf(a().shape({id:a().number,label:a().string,info:a().string,date:a().oneOfType([a().string,a().bool]),active:a().bool,content:a().arrayOf(a().shape({id:a().number,active:a().bool,data:a().oneOfType([a().string,a().element])})),actions:a().arrayOf(a().shape({id:a().number,active:a().bool,content:a().string,context:a().string,handleClick:a().func,type:"button"}))}))};var I=(0,y.ZP)(f.Z)(function(e){var n,t=e.theme;return n={},(0,i.Z)(n,"&.".concat(v.Z.active),(0,i.Z)({},"& .".concat(v.Z.line),{borderColor:t.palette.primary.main})),(0,i.Z)(n,"&.".concat(v.Z.completed),(0,i.Z)({},"& .".concat(v.Z.line),{borderColor:t.palette.primary.main})),(0,i.Z)(n,"& .".concat(v.Z.line),{borderColor:t.palette.primary.main,borderLeftWidth:4,borderRadius:1,marginLeft:"-2px"}),n}),S=(0,y.ZP)(h.Z)(function(e){var n=e.theme;return(0,i.Z)({},"&.".concat(b.Z.root),{borderColor:n.palette.primary.main,borderLeftWidth:4,marginLeft:"10px"})}),w=(0,y.ZP)(x.Z)(function(e){var n;return e.theme,n={},(0,i.Z)(n,"&.".concat(g.Z.root),{padding:0}),(0,i.Z)(n,"& .".concat(g.Z.labelContainer),{color:"inherit"}),(0,i.Z)(n,"& .".concat(g.Z.label),{display:"flex",alignItems:"center",color:"inherit"}),n})},14067:function(e,n,t){"use strict";t.d(n,{D7:function(){return j},KQ:function(){return g},R7:function(){return x},j$:function(){return Z},kx:function(){return I},l1:function(){return b},lk:function(){return y},ys:function(){return h}});var i=t(7297),r=t(75063);function o(){var e=(0,i.Z)(['\n  query GetSuppliers(\n    $limit: Int\n    $offset: Int\n    $orderBy: Account_order_by!\n    $where: Account_bool_exp\n  ) {\n    suppliers: Account(limit: $limit, offset: $offset, where: $where, order_by: [$orderBy]) {\n      id\n      createdAt\n      name\n      status\n      companyNumber\n      vatId\n      website\n      jobs: SupplierJobs_aggregate {\n        aggregate {\n          count\n          max {\n            scheduledAt\n          }\n          sum {\n            amount\n          }\n        }\n      }\n      jobList: SupplierJobs(order_by: { createdAt: desc }) {\n        id\n      }\n      services: Services(where: { entity: { _eq: "Account" } }) {\n        id\n        service: Service {\n          id\n          name\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(where: $where) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return o=function(){return e},e}function a(){var e=(0,i.Z)(['\n  query GetSupplier($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      companyNumber\n      createdAt\n      name\n      status\n      type\n      updatedAt\n      website\n      clientType\n      managerId\n      vatId\n      meta\n      statusLogs: StatusLog(where: { entity: { _eq: "Account" } }) {\n        id\n        status\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      manager: Manager {\n        id\n        fullName\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n\n      details: SupplierDetail {\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n        accountId\n      }\n\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n        }\n      }\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Account" } }, order_by: { expiryAt: asc }) {\n        id\n        createdAt\n        entity\n        entityId\n        expiryAt\n        regNum\n        insuranceAmount\n        meta\n      }\n      coverage: PostcodeAreas(where: { entity: { _eq: "Account" }, status: { _eq: "active" } }) {\n        id\n        status\n        createdAt\n        area: PostcodeArea {\n          id\n          name\n          area\n        }\n      }\n      services: Services {\n        serviceId\n        createdAt\n      }\n      references: References {\n        id\n        createdAt\n      }\n    }\n  }\n']);return a=function(){return e},e}function s(){var e=(0,i.Z)(["\n  query GetSupplierManage($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      status\n      meta\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n      supplierDetails: SupplierDetail {\n        id\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n      }\n    }\n  }\n"]);return s=function(){return e},e}function u(){var e=(0,i.Z)(["\n  mutation AddSupplier($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return u=function(){return e},e}function l(){var e=(0,i.Z)(["\n  mutation AddSupplierDetail($objects: [SupplierDetail_insert_input!]!) {\n    insert_SupplierDetail(objects: $objects) {\n      returning {\n        id\n        accountId\n      }\n    }\n  }\n"]);return l=function(){return e},e}function c(){var e=(0,i.Z)(["\n  mutation AddSupplierOffer($objects: [SupplierOffer_insert_input!]!) {\n    insert_SupplierOffer(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return c=function(){return e},e}function d(){var e=(0,i.Z)(["\n  mutation UpdateSupplier(\n    $supplierId: Int!\n    $supplier: Account_set_input\n    $supplierDetails: SupplierDetail_set_input\n  ) {\n    update_SupplierDetail(where: { accountId: { _eq: $supplierId } }, _set: $supplierDetails) {\n      returning {\n        id\n      }\n    }\n\n    update_Account_by_pk(pk_columns: { id: $supplierId }, _set: $supplier) {\n      id\n    }\n  }\n"]);return d=function(){return e},e}function p(){var e=(0,i.Z)(['\n  query GetPostCodeAreas(\n    $limit: Int\n    $offset: Int\n    $q: String\n    $supplierId: Int\n    $status: String = "active"\n  ) {\n    coverage: PostcodeArea_Entity(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n      order_by: { PostcodeArea: { name: asc } }\n      limit: $limit\n      offset: $offset\n    ) {\n      id\n      status\n      createdAt\n      area: PostcodeArea {\n        id\n        name\n        area\n      }\n    }\n    meta: PostcodeArea_Entity_aggregate(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return p=function(){return e},e}function m(){var e=(0,i.Z)(["\n  query GetPostCodeAreaForSelect($countryId: Int, $q: String) {\n    items: PostcodeArea(\n      where: { name: { _ilike: $q }, countryId: { _eq: $countryId } }\n      order_by: { name: asc }\n    ) {\n      area\n      label: name\n      value: id\n    }\n  }\n"]);return m=function(){return e},e}function f(){var e=(0,i.Z)(['\n  query GetServicesForSelect($q: String, $limit: Int, $offset: Int) {\n    items: Service(\n      where: { name: { _ilike: $q }, status: { _eq: "active" } }\n      limit: $limit\n      offset: $offset\n      order_by: { name: asc }\n    ) {\n      label: name\n      value: id\n    }\n  }\n']);return f=function(){return e},e}function v(){var e=(0,i.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n\n      slaId\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return v=function(){return e},e}var h=(0,r.Ps)(o()),b=(0,r.Ps)(a()),x=(0,r.Ps)(s()),g=(0,r.Ps)(u());(0,r.Ps)(l()),(0,r.Ps)(c());var j=(0,r.Ps)(d()),y=(0,r.Ps)(p()),Z=(0,r.Ps)(m()),I=(0,r.Ps)(f());(0,r.Ps)(v())},45795:function(e,n,t){"use strict";t.d(n,{T:function(){return u}});var i=t(85893),r=t(45697),o=t(11585),a=t(86036),s=t(32339),u=function(e){var n,t,r,u=e.open,l=e.supplier,c="";return s.E.forEach(function(e){var n;e.value===(null===(n=l.details)||void 0===n?void 0:n.typeOfOrganisation)&&(c=e.text)}),(0,i.jsxs)(o.Z,{open:u,title:"Company",children:[(0,i.jsx)(a.Z,{content:"Organization Type",text:c}),(0,i.jsx)(a.Z,{content:"Company Number",text:l.companyNumber}),(0,i.jsx)(a.Z,{content:"VAT Number",text:l.vatId}),(0,i.jsx)(a.Z,{content:"UTR Number",text:null===(n=l.details)||void 0===n?void 0:n.utrNumber}),(0,i.jsx)(a.Z,{content:"CIS registration number",text:null===(t=l.details)||void 0===t?void 0:t.cisRegistered}),(0,i.jsx)(a.Z,{content:"Website",text:l.website}),(null===(r=l.meta)||void 0===r?void 0:r.xeroContactId)&&(0,i.jsx)(a.Z,{content:"Xero Contact ID",text:l.meta.xeroContactId})]})};u.propTypes={open:r.bool,supplier:r.object.isRequired},u.defaultProps={open:!0}},8879:function(e,n,t){"use strict";t.d(n,{D:function(){return s}});var i=t(85893),r=t(11585),o=t(86036),a=t(55377),s=function(e){var n=e.supplier;return(0,i.jsx)(r.Z,{open:!0,title:"Contact",children:n.contactUsers.map(function(e){var t;return(0,i.jsxs)("div",{children:[(0,i.jsx)(o.Z,{content:"Name",text:"".concat(e.user.fullName)}),(0,i.jsx)(o.Z,{content:"Phone",text:e.user.phone}),(0,i.jsx)(o.Z,{content:"Email",text:e.user.email}),(0,i.jsx)(o.Z,{content:"Quoting Email",text:(null===(t=n.details)||void 0===t?void 0:t.quotingEmail)||"-"}),(0,i.jsx)(a.Z,{})]},e.user.id)})})}},4790:function(e,n,t){"use strict";t.d(n,{O:function(){return u}});var i=t(26042),r=t(85893),o=t(90948),a=t(40044),s=(0,o.ZP)(function(e){return(0,r.jsx)(a.Z,(0,i.Z)({disableRipple:!0},e))})(function(e){var n=e.theme;return{textTransform:"none",color:n.palette.text.primary,"&.Mui-selected":{fontWeight:600,color:n.palette.secondary.contrastText,backgroundColor:n.palette.secondary.main},"&.Mui-focusVisible":{backgroundColor:"rgba(100, 95, 228, 0.32)"}}}),u=function(e){return(0,r.jsx)(s,(0,i.Z)({},e))};u.defaultProps={},u.propTypes={}},97824:function(e,n,t){"use strict";t.d(n,{x:function(){return l}});var i=t(26042),r=t(69396),o=t(99534),a=t(85893),s=t(90948),u=t(5616),l=function(e){var n=e.children,t=e.value,s=e.index,l=e.boxProps,d=e.boxSx,p=(0,o.Z)(e,["children","value","index","boxProps","boxSx"]);return(0,a.jsx)(c,(0,r.Z)((0,i.Z)({role:"tabpanel",hidden:t!==s,id:"simple-tabpanel-".concat(s),"aria-labelledby":"simple-tab-".concat(s)},p),{children:t===s&&(0,a.jsx)(u.Z,(0,r.Z)((0,i.Z)({},l),{sx:(0,i.Z)({padding:"25px 0"},d),children:n}))}))};l.defaultProps={boxProps:{},boxSx:{}};var c=(0,s.ZP)(u.Z)(function(){return{"& .MuiTabs-root":{}}})},23914:function(e,n,t){"use strict";t.d(n,{m:function(){return f}});var i=t(26042),r=t(69396),o=t(99534),a=t(85893),s=t(45697),u=t.n(s),l=t(90948),c=t(3892),d=t(11163),p=t.n(d),m=(0,l.ZP)(function(e){return(0,a.jsx)(c.Z,(0,i.Z)({},e))})(function(e){var n=e.theme,t=e.size;return(0,r.Z)((0,i.Z)({},"small"===t&&{height:"32px",minHeight:"32px"}),{"& .MuiTabs-scroller":(0,i.Z)({overflow:"scroll !important"},"small"===t&&{height:"60px",minHeight:"60px"}),"& .MuiTabs-indicator":{display:"none"},"& .MuiTabs-flexContainer > .MuiTab-root":(0,r.Z)((0,i.Z)({},"small"===t&&{height:"32px",minHeight:"32px"}),{border:1,borderStyle:"solid",borderColor:n.palette.divider,"&:first-child":(0,i.Z)({borderTopLeftRadius:"10px",borderBottomLeftRadius:"10px"},"small"===t&&{borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}),"&:last-child":(0,i.Z)({borderTopRightRadius:"10px",borderBottomRightRadius:"10px"},"small"===t&&{borderTopRightRadius:"5px",borderBottomRightRadius:"5px"})})})}),f=function(e){var n=e.onChange,t=e.changeQuery,r=(0,o.Z)(e,["onChange","changeQuery"]),s=(0,d.useRouter)(),u=function(e,i){n(e,i),t&&l(i)},l=function(e){var n=s.query;delete n.tab,n.tab=e,p().push({pathname:s.pathname,query:n,shallow:!0})};return(0,a.jsx)(m,(0,i.Z)({onChange:u},r))};f.defaultProps={size:"small"},f.propTypes={size:u().oneOf(["small",void 0])}},14272:function(e,n,t){"use strict";t.d(n,{f:function(){return Z}});var i=t(26042),r=t(69396),o=t(85893),a=t(67294),s=t(45697),u=t(58594),l=t(28497),c=t(55563),d=t(90951),p=t(95103),m=t(6710),f=t(78289),v=t(23233),h=t(49501),b=t(77439),x=t(40826),g=t(21300),j=t(35418),y={checkbox:u.Z,currencyInput:l.Z,datepicker:g.M,input:c.Z,radio:d.Z,select:p.Z,textArea:m.Z,selectRange:p.Z},Z=function(e){var n=e.control,t=e.entity,s=e.entityId,u=e.errors,l=e.input,c=e.inputType,d=e.key,p=e.label,m=e.mediaMeta,g=e.name,Z=e.options,I=e.register,S=(0,a.useContext)(f.Z),w="select"===l&&Z.length>0,C=["checkbox","radio"].includes(l)&&Z.length>0,R=(0,r.Z)((0,i.Z)({control:n},C&&{data:Z},w&&{options:Z.map(function(e){return(0,r.Z)((0,i.Z)({},e),{text:e.label})})},"selectRange"===l&&{range:[10,0]}),{errors:u,key:d,label:v.Z.camelize(p),name:g,register:I,type:C?l:c,minDate:"2020-04-19T08:29:04.839Z"}),q=function(){S.show({content:t&&s&&(0,o.jsx)(j.G,{entity:t,entityId:s,mediaMeta:m,category:"supplierQuestion"}),submit:!1,title:p})},_=y[l];return(0,o.jsx)(o.Fragment,{children:"currencyInput"===l?(0,o.jsx)(h.Z,{label:p,children:(0,o.jsx)(_,(0,r.Z)((0,i.Z)({},R),{label:""}))}):(0,o.jsx)(o.Fragment,{children:"media"===l?(0,o.jsx)(h.Z,{label:p,children:(0,o.jsx)(b.Z,{context:"info",content:(0,o.jsx)(x.Z,{icon:"file-upload"}),onClick:q,size:"sm"})}):(0,o.jsx)(h.Z,{label:p,children:(0,o.jsx)(_,(0,i.Z)({},R))})})})};Z.propTypes={control:s.object.isRequired,entity:s.string,entityId:s.number,errors:s.object.isRequired,input:s.string,inputType:s.string,key:s.string,label:s.string.isRequired,mediaMeta:s.object,name:s.string.isRequired,options:s.array,register:s.func.isRequired},Z.defaultProps={input:"input",options:[],inputType:"text",label:"label"}},32109:function(e,n,t){"use strict";t.d(n,{y:function(){return p}});var i=t(85893),r=t(45697),o=t(55377),a=t(9270),s=t(62140),u=t(86036),l=t(16551),c=t(77439),d=t(35418),p=function(e){var n=e.answers,t=e.onEdit,r=e.entity,p=e.entityId,m=function(){t&&t(n)};return(0,i.jsxs)(i.Fragment,{children:[n&&n.length>0&&(0,i.jsx)(o.Z,{content:"Questions"}),n&&n.map(function(e){var n,t,l,c=e.meta;return(null==c?void 0:c.input)==="media"?(0,i.jsx)(a.Z,{children:(0,i.jsxs)(s.Z,{md:6,children:[(0,i.jsx)(d.G,{entity:r,entityId:p,showItemActions:!1,showActionButtons:!1,summary:null==c?void 0:c.label,category:"supplierQuestion",mediaMeta:{taxonomyId:e.id}}),(0,i.jsx)(o.Z,{})]})}):(0,i.jsx)(u.Z,{content:(null===(n=e.taxonomy)||void 0===n?void 0:n.name)||e.name,text:e.comments||(null===(t=e.taxonomy_entity)||void 0===t?void 0:null===(l=t[0])||void 0===l?void 0:l.comments)},e.id||e.taxonomyId)}),n&&n.length>0&&t&&(0,i.jsx)(l.Z,{align:"flex-end",children:(0,i.jsx)(c.Z,{content:"Edit Answers",size:"sm",context:"secondary",onClick:m})}),n&&n.length>0&&(0,i.jsx)(o.Z,{})]})};p.propTypes={answers:r.array}},87556:function(e,n,t){"use strict";t.d(n,{D:function(){return g}});var i=t(26042),r=t(69396),o=t(85893),a=t(67294),s=t(45697),u=t(42283),l=t(79665),c=t(76600),d=t(9270),p=t(62140),m=t(16551),f=t(77439),v=t(14272),h=t(74231),b=function(e,n){var t=n.object,r=n.string,o={};return null==e||e.forEach(function(e){var n;(null===(n=e.meta)||void 0===n?void 0:n.required)&&(o[e.name]=r().required())}),t().shape((0,i.Z)({},o))},x=function(e){var n=e.map(function(e){return(0,r.Z)((0,i.Z)({},e),{name:"".concat(e.name,"/id=").concat(e.taxonomyId)})}),t=(0,h.Ry)().shape({}),o=b(n,{object:h.Ry,string:h.Z_});return t.concat(o)},g=function(e){var n,t=e.entity,s=e.entityId,h=e.onSuccess,b=e.questions,g=e.hasChangeStatus,j=(0,u.cI)({defaultValues:(n={},b.forEach(function(e){var t=e.comments,i=e.taxonomyId,r=e.name;n["".concat(r,"/id=").concat(i)]=t}),n),resolver:(0,l.S)(x(b))}),y=j.control,Z=j.errors,I=j.handleSubmit,S={control:y,errors:Z,register:j.register},w=function(e,n){var i=Object.keys(e).map(function(n){return{taxonomyId:parseInt(n.split("/id=")[1]),name:n.split("/id=")[0],comments:String(e[n]),entity:t,entityId:s}});h&&h(i,n)};return(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(c.Z,{id:g?"offCanvasFormQuestions":"offCanvasForm",handleSubmit:I(function(e){return w(e,"supplierQuestionsSubmitted")}),children:(0,o.jsxs)(d.Z,{children:[b.map(function(e){var n,u,l,c;return(0,o.jsx)(p.Z,{md:12,children:(0,a.createElement)(v.f,(0,r.Z)((0,i.Z)({},S),{input:null===(n=e.meta)||void 0===n?void 0:n.input,inputType:null===(u=e.meta)||void 0===u?void 0:u.inputType,key:e.taxonomyId,label:null===(l=e.meta)||void 0===l?void 0:l.label,name:"".concat(e.name,"/id=").concat(e.taxonomyId),options:null===(c=e.meta)||void 0===c?void 0:c.options,entity:t,entityId:s,mediaMeta:{taxonomyId:e.taxonomyId}}))})}),g&&(0,o.jsx)(p.Z,{md:12,children:(0,o.jsxs)(m.Z,{align:"flex-end",children:[(0,o.jsx)(f.Z,{content:"Save",context:"success",onClick:I(function(e){return w(e,"supplierQuestionsDraft")}),size:"sm"}),(0,o.jsx)(f.Z,{content:"Submit",context:"secondary",type:"submit",size:"sm"})]})})]})})})};g.propTypes={entity:s.string.isRequired,entityId:s.number,onSuccess:s.func,hasChangeStatus:s.bool,questions:s.array.isRequired},g.defaultProps={hasChangeStatus:!1}},32320:function(e,n,t){"use strict";t.d(n,{lt:function(){return i},pv:function(){return r}});var i=function(e,n){var t=Math.pow(10,n);return Math.round(e*t)/t},r=function(e){return parseInt(e).toLocaleString("en-GB",{minimumIntegerDigits:2,useGrouping:!1})}},83395:function(e,n,t){"use strict";t.d(n,{b:function(){return i}});var i=function(e){return String(e).toLowerCase().replace("gb","").length>=9}},44634:function(e,n,t){"use strict";t.d(n,{Hu:function(){return i},KB:function(){return r},M2:function(){return o}});var i=[{id:"time-materials",label:"Time & Materials",value:"time-materials"},{id:"fixed",label:"Fixed",value:"fixed"}],r=[{id:"at",label:"At",value:"at"},{id:"between",label:"Between",value:"between"}],o=[{id:"complete",label:"Job complete",value:"complete"},{id:"completeCertificate",label:"Job complete, certificate to follow",value:"completeCertificate"},{id:"returnVisit",label:"Return visit required",value:"returnVisit"},{id:"returnVisitByAnother",label:"Visit required by another supplier",value:"returnVisitByAnother"},{id:"couldNotDo",label:"Could not do",value:"couldNotDo"}]},32339:function(e,n,t){"use strict";t.d(n,{E:function(){return i}});var i=[{text:"Select Type Of Organisation",value:""},{text:"Sole trader",value:"soleTrader"},{text:"Limited company",value:"limitedCompany"},{text:"Partnership",value:"partnership"},{text:"LLP",value:"llp"},{text:"PLC",value:"plc"}]},87189:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return uy}});var i=t(26042),r=t(85893),o=t(67294),a=t(11163),s=t.n(a),u=t(73987),l=t(29815),c=t(6388),d=t(46171),p=t(913),m=t(7297),f=t(75063),v=t(85488),h=t(45815),b=t(66312),x=t(75327);function g(){var e=(0,m.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      reportPassFail\n      reportPassFailTitle\n      requireReportRecommendations\n      estimatedDuration\n      estimatedDurationUnit\n      anyTimeOption\n      hourStart\n      hourEnd\n      meta\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      assets: Assets(where: { entity: { _eq: "Job" } }) {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      jobScheduleId\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      supplierId\n      customerId\n      customerUserId\n      locationId\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n        addresses: Addresses {\n          id\n          registered\n          operating\n          trading\n          invoice\n          status\n          createdAt\n          address: Address {\n            id\n            name\n            addressLine1\n            addressLine2\n            addressLine3\n            city\n            county\n            geo\n            postCode\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n\n      expenses: Expenses {\n        id\n        amount\n        description\n        markup\n        total\n        unit\n        vat\n        paid\n      }\n      location: Location {\n        id\n        name\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n          accountUsers: Account_Users {\n            user: User {\n              id\n              fullName\n              nameFirst\n              nameLast\n              phone\n              email\n              devices: UserDevices(where: { status: { _eq: "active" } }) {\n                id\n                playerId\n              }\n            }\n          }\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"]);return g=function(){return e},e}function j(){var e=(0,m.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      reportPassFail\n      reportPassFailTitle\n      requireReportRecommendations\n      estimatedDuration\n      estimatedDurationUnit\n      anyTimeOption\n      hourStart\n      hourEnd\n      onSiteTimingEnd\n      meta\n      permitsLinks\n      relatedLinks\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      assets: Assets(where: { entity: { _eq: "Job" } }) {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      jobScheduleId\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      supplierId\n      customerId\n      customerUserId\n      locationId\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n        addresses: Addresses {\n          id\n          registered\n          operating\n          trading\n          invoice\n          status\n          createdAt\n          address: Address {\n            id\n            name\n            addressLine1\n            addressLine2\n            addressLine3\n            city\n            county\n            geo\n            postCode\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n\n      expenses: Expenses {\n        id\n        amount\n        description\n        markup\n        total\n        unit\n        vat\n        paid\n      }\n      location: Location {\n        id\n        name\n        permitsRequired\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n          accountUsers: Account_Users {\n            user: User {\n              id\n              fullName\n              nameFirst\n              nameLast\n              phone\n              email\n              devices: UserDevices(where: { status: { _eq: "active" } }) {\n                id\n                playerId\n              }\n            }\n          }\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"]);return j=function(){return e},e}function y(){var e=(0,m.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      customerId\n      locationId\n      estimatedDuration\n      estimatedDurationUnit\n      meta\n      permitsLinks\n      relatedLinks\n      assets: Assets(where: { entity: { _eq: "Job" } }) {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      admin: Admin {\n        id\n        name\n        meta\n      }\n      customer: Customer {\n        id\n        name\n      }\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        vat\n      }\n      location: Location {\n        id\n        name\n        permitsRequired\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes(\n        where: { status: { _neq: "cancelled" } }\n        order_by: { quoteNumber: asc }\n      ) {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        recommended\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      answers: Taxonomy(\n        where: { Taxonomy: { type: { _eq: "jobQuestion" } } }\n        order_by: { taxonomyId: asc }\n      ) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      costCategoryTaxonomy: CostCategory {\n        id\n        name\n      }\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"]);return y=function(){return e},e}function Z(){var e=(0,m.Z)(["\n  mutation UpdateJob(\n    $id: Int!\n    $changes: Job_set_input\n    $_delete_key: Job_delete_key_input\n    $deleteTiming: JobTiming_bool_exp!\n    $insertTiming: [JobTiming_insert_input!]!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes, _delete_key: $_delete_key) {\n      id\n    }\n    delete_JobTiming(where: $deleteTiming) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $insertTiming) {\n      returning {\n        id\n      }\n    }\n    delete_JobFinanceLog(where: { system: { _eq: true }, jobId: { _eq: $id } }) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return Z=function(){return e},e}var I,S=(0,f.Ps)(g(),h.z,b.WW,b.MR,v.aL,v.pf,v.H_,x.Px),w=(0,f.Ps)(j(),h.z,b.WW,b.MR,v.aL,v.pf,v.H_,x.Px),C=(0,f.Ps)(y(),h.z,b.WW,b.MR,v.aL,v.pf,v.H_,x.Px),R=(0,f.Ps)(Z()),q=t(47568),_=t(828),T=t(97582),A=t(45697),E=t.n(A),D=t(66252),P=t(50319),k=t(86532),$=t(22797),O=t(38895),N=t(5616),H=t(11057),F=t(86886),M=t(51233),L=t(15861),J=t(78289),U=t(2388),V=t(77957),Q=t(91613),z=t(25213),Y=t(31181),B=t(27434),W=t(22595),G=t(30381),K=t.n(G),X=t(11082),ee=t(26186),en=t(737),et=t(69396),ei=t(42283),er=t(79665),eo=t(76600),ea=t(25742),es=t(66812),eu=t(74231),el=(0,eu.Ry)().shape({serviceSelected:(0,eu.Ry)().required()}),ec=function(e){var n,t=e.job,a=e.refetch,s=e.toggleShow,l=(0,o.useContext)(u.Z).user,c=(0,ei.cI)({defaultValues:{serviceSelected:t.serviceId},resolver:(0,er.S)(el)}),d=c.errors,p=c.handleSubmit,m=c.register,f=c.control,h=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){a&&a(),s()}}),1)[0],b=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(i){switch(i.label){case 0:return n={status:"raised",quoted:!1,type:"reactive",serviceId:e.serviceSelected.value},[4,h({variables:{id:t.id,changes:n,timing:{notes:e.comments,status:"raised",jobId:t.id,userId:l.id}}}).then(function(){return s()})];case 1:return i.sent(),[2]}})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:p(b),children:[(0,r.jsx)(es.P,(0,et.Z)((0,i.Z)({},{control:f,errors:d,register:m}),{errors:(0,i.Z)({},d),name:"serviceSelected",label:"Service",type:"service"})),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};ec.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var ed=(I=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(ec,{job:e,toggleShow:n.show,refetch:t}),submit:!1,title:"Make reactive"}),[2]})}),function(e,n,t){return I.apply(this,arguments)}),ep=t(14924),em=t(5481),ef=t(15214),ev=t(58594),eh=t(90951),eb=t(49501),ex=t(55563),eg=t(77439),ej=t(51466),ey=function(){var e,n=(e=(0,q.Z)(function(){return(0,T.__generator)(this,function(e){return[2]})}),function(){return e.apply(this,arguments)});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ej.Z,{children:"No completed quotes"}),(0,r.jsx)(eg.Z,{content:"Resend notification to selected supplier(s)",size:"sm",onClick:n})]})},eZ=t(42251),eI=t(90114),eS=t(35381),ew=function(e){var n,t=e.job,a=e.user,s=e.quotations,u=e.refetch,l=e.toggleShow,c=(0,D.x)(),d=(0,o.useContext)(J.Z),p=null==a?void 0:a.quoteThreshold,m=s.filter(function(e){return["supplierQuoteComplete","supplierQuoteSent","thresholdApproved","waitingThresholdApproval"].includes(e.status)}),f=(0,ei.cI)({defaultValues:{selectedQuotes:t.selectedQuotes||[]}}),h=f.errors,b=f.handleSubmit,x=f.register,g=f.watch,j=(0,o.useState)(0),y=j[0],Z=j[1],I=(0,o.useState)([]),S=I[0],w=I[1],C=g(),R=C.selectedQuotes,A=C.sendQuote,E=R&&R.length>0;(0,o.useEffect)(function(){w(m.filter(function(e){var n=1.2*e.lineItems.reduce(function(e,n){return e+n.total},0);return!(!R.includes("".concat(e.id))||(0,eS.il)(p,n)||(0,eI.Pn)("adminCustomer",null==t?void 0:t.timings,e.id))&&(n>y&&Z(n),!0)}))},[R]);var k,$,O=(0,_.Z)((0,P.D)(em.Dg),1)[0],N=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){u&&u(),l()}}),1)[0],H=(0,_.Z)((0,P.D)(v.yT),1)[0],F=m.map(function(e){return{id:e.id,label:e.quoteNumber,value:e.id}}),M=($=(0,q.Z)(function(e){var n,r,o;return(0,T.__generator)(this,function(s){switch(s.label){case 0:var u;return n=(0,i.Z)({},t.meta)||{},"string"==typeof e.selectedQuotes&&(e.selectedQuotes=[e.selectedQuotes]),r=[],[4,Promise.all(e.selectedQuotes.map((u=(0,q.Z)(function(e){var n,i;return(0,T.__generator)(this,function(o){switch(o.label){case 0:return n=F.find(function(n){return Number(e)===n.id}),[4,(0,en.L)(t,Number(e),c)];case 1:return i=o.sent(),r.push({label:n.label,url:i}),[2,O({variables:{id:e,changes:{status:"supplierQuoteSent"},supplierOffer:[]}})]}})}),function(e){return u.apply(this,arguments)})))];case 1:return s.sent(),o="quoteSent","sendQuote"===A&&e.sendQuote&&e.quotingEmail&&H({variables:{timing:{status:"quotePDFSent",jobId:t.id,userId:a.id,meta:{toEmail:e.quotingEmail,selectedQuotations:r}}}}),N({variables:{id:t.id,changes:{status:o,meta:n},timing:{status:o,jobId:t.id,userId:a.id},_append:{statusData:(0,ep.Z)({},o,K()().toISOString())}}}),[2]}})}),function(e){return $.apply(this,arguments)});if(0===m.length)return(0,r.jsx)(ey,{});var L={errors:h,register:x};return(0,r.jsxs)(eo.Z,{handleSubmit:b(M),children:[S.length>0&&(0,r.jsx)(ef.Z,{content:"Based on your user settings, this quote requires approval before it can be sent.\n          Please request approval by clicking the button below.",context:"warning"}),(0,r.jsx)(ev.Z,(0,et.Z)((0,i.Z)({},L),{data:F,legend:"Select quotations",name:"selectedQuotes"})),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},L),{data:[{id:"sendQuote",label:"Send quote via email",value:"sendQuote"},{id:"markAsQuoteSent",label:"Mark quote as sent",value:"markAsQuoteSent"}],name:"sendQuote",stacked:!0})),"sendQuote"===A&&(0,r.jsx)(eb.Z,{label:"Send to email address",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},L),{defaultValue:null===(n=t.supplier)||void 0===n?void 0:n.details[0].quotingEmail,name:"quotingEmail"}))}),S.length>0?(0,r.jsx)(eg.Z,{content:"Request approval",size:"md",disabled:!E,onClick:function(){return(0,eZ.I_)({type:"quote",role:"adminCustomer",quotations:S,jobId:t.id,accountId:a.accountId,amount:y,offCanvas:d})}}):(0,r.jsx)("div",{style:{marginTop:"10px"},children:(0,r.jsx)(eg.Z,{content:"Send Quotation(s)",size:"md",type:"submit",disabled:!E})})]})};ew.propTypes={job:A.object,quotations:A.array,setJob:A.func};var eC,eR=function(e,n,t,i){t.show({content:(0,r.jsx)(ew,{job:e,user:n,quotations:e.quotations,refetch:i,toggleShow:t.close}),submit:!1,title:"Send Quote"})},eq=t(6710),e_=t(9928),eT=function(e){var n,t=e.job,i=e.refetch,a=e.status,s=e.toggleShow,l=e.onClose,c=e.shouldCalculateFinance,d=(0,D.x)(),p=(0,o.useContext)(u.Z).user,m=(0,ei.cI)({defaultValues:{comments:""}}),f=m.errors,h=m.handleSubmit,b=m.register,x=(0,_.Z)((0,P.D)(v.xY,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!c)return[3,2];return[4,(0,e_.F)(d,t.id)];case 1:e.sent(),i&&i(),s(),e.label=2;case 2:return[2]}})}),refetchQueries:["GetJob"]}),1)[0],g=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return x({variables:{id:t.id,changes:{status:a},_append:{statusData:(0,ep.Z)({},a,new Date().toISOString())},timing:{notes:e.comments,status:a,jobId:t.id,userId:p.id}}}).then(function(){l()}).catch(function(e){}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:h(g),children:[(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:f,name:"comments",register:b,rows:3})}),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};eT.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var eA=(eC=(0,q.Z)(function(e,n,t,i,o){var a;return(0,T.__generator)(this,function(s){return a=(null!=o?o:{shouldCalculateFinance:!0}).shouldCalculateFinance,t.show({content:(0,r.jsx)(eT,{job:e,status:n,toggleShow:t.show,refetch:i,onClose:t.close,shouldCalculateFinance:a}),submit:!1,title:"Job status change"}),[2]})}),function(e,n,t,i,r){return eC.apply(this,arguments)}),eE=t(95103),eD=t(21300),eP=[1,2,3].map(function(e){return{text:e,value:e,disabled:!1}}),ek=function(e){var n,t=e.job,o=e.toggleShow,a=e.updateJob,s=e.addJobTiming,u=e.user,c=(0,ei.cI)(),d=c.control,p=c.errors,m=c.handleSubmit,f=c.register,v=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(n){switch(n.label){case 0:return e.status="quoteNew",e.type="quote",e.quoteDue=K()(e.quoteDue).format(),e.quoted=!0,[4,s({variables:{objects:[{notes:"Compliance to Quote",status:"quoteNew",jobId:t.id,userId:u.id}]}})];case 1:return n.sent(),[4,a({variables:{id:t.id,changes:e}}).then(function(){o()})];case 2:return n.sent(),[2]}})}),function(e){return n.apply(this,arguments)}),h={control:d,errors:p,register:f};return(0,r.jsxs)(eo.Z,{handleSubmit:m(v),children:[(0,r.jsx)(eb.Z,{label:"Number of Quotes",children:(0,r.jsx)(eE.Z,(0,et.Z)((0,i.Z)({},h),{name:"quoteNumber",options:[{text:"Select Type",value:"",disabled:!1}].concat((0,l.Z)(eP))}))}),(0,r.jsx)(eb.Z,{label:"Quote due date"}),(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},h),{name:"quoteDue"})),(0,r.jsx)(ea.H,{content:"Create quote",size:"md",type:"submit"})]})},e$=t(9270),eO=t(62140),eN=t(11585),eH=t(44123),eF=function(e){return(0,eu.Ry)().shape((0,ep.Z)({},e,(0,eu.Rx)().required()))},eM=t(9489),eL=t(26936),eJ=function(e){var n=e.defaultValue,t=e.label,i=e.name,a=e.onSubmit,s=e.rightLabel,u=e.clearLogs,l=(0,ei.cI)({resolver:(0,er.S)(eF(i))}),c=l.errors,d=l.handleSubmit,p=l.control,m=l.reset,f=l.setValue;(0,o.useEffect)(function(){isNaN(n)||f(i,n)},[n,i,f]);var v=function(e){a(i,e[i]),m()};return(0,r.jsx)("form",{onSubmit:d(v),children:(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:t&&(0,r.jsxs)(L.Z,{children:[t,":"]})}),(0,r.jsx)(F.ZP,{item:!0,xs:8,children:(0,r.jsxs)(M.Z,{direction:"row",spacing:1,children:[(0,r.jsx)(ei.Qr,{name:i,control:p,render:function(e){var n,t=e.value,o=e.onChange;return(0,r.jsx)(eM.I,{leftLabel:(0,r.jsx)(eL.Z,{sx:{height:"18px"}}),rightLabel:s,sx:{width:"80px"},type:"number",InputProps:{inputProps:{min:0,step:".01"}},value:t,onChange:o,error:c[i],helperText:null===(n=c[i])||void 0===n?void 0:n.message})}}),(0,r.jsx)(H.Z,{size:"small",variant:"contained",color:"danger",onClick:function(){u(i,m)},children:"Clear"}),(0,r.jsx)(H.Z,{size:"small",variant:"contained",type:"submit",children:"Save"})]})})]})})};eJ.defaultProps={rightLabel:"Ex Vat"},eJ.propTypes={defaultValue:A.object,label:A.string,name:A.string,onSubmit:A.func.isRequired,rightLabel:A.string,clearLogs:A.func.isRequired};var eU=t(10367),eV=t(32979),eQ=t(43916),ez=t(19639);function eY(){var e=(0,m.Z)(["\n  display: flex;\n"]);return eY=function(){return e},e}function eB(){var e=(0,m.Z)(["\n  display: flex;\n  align-items: center;\n  margin-bottom: 9px;\n"]);return eB=function(){return e},e}var eW=function(e){var n=e.defaultValue,t=e.label,i=e.name,a=e.onSubmit,s=(0,ei.cI)({resolver:(0,er.S)(eF(i))}),u=s.errors,l=s.handleSubmit,c=s.register,d=s.reset,p=s.setValue;(0,o.useEffect)(function(){n&&p(i,n)},[n]);var m=function(e){a(i,e[i]),d()};return(0,r.jsx)(eo.Z,{handleSubmit:l(m),children:(0,r.jsx)(e$.Z,{align:"center",children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(eb.Z,{label:t,children:(0,r.jsxs)(eG,{children:[(0,r.jsx)(eV.Z,{errors:u,name:i,register:c}),(0,r.jsx)(eK,{children:(0,r.jsx)(eQ.Z,{children:(0,r.jsx)(ez.Z,{addonType:"append",children:(0,r.jsx)(eg.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})})})})]})})})})})};eW.propTypes={defaultValue:A.object,label:A.string,name:A.string,onSubmit:A.func.isRequired};var eG=eU.ZP.div.withConfig({displayName:"percentInput__StyledWrapper",componentId:"sc-2bb038d5-0"})(eY()),eK=eU.ZP.div.withConfig({displayName:"percentInput__StyledInputGroup",componentId:"sc-2bb038d5-1"})(eB()),eX=t(15033),e0=function(e){var n=e.loading,t=e.logs;return(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Change Log"}),(0,r.jsx)(eX.i,{columns:[{flex:1,field:"type",headerName:"Type",sortable:!1},{flex:1,field:"value",headerName:"Value",sortable:!1},{flex:1,field:"user",headerName:"User",sortable:!1},{flex:1,field:"date",headerName:"Date",sortable:!1}],loading:n,rows:t.map(function(e){var n;return{id:e.id,type:e.type,value:e.value?"".concat(e.value," (").concat(e.difference>0?"+".concat(e.difference):e.difference||"-",")"):"clear",user:(null===(n=e.meta)||void 0===n?void 0:n.username)||"-",date:K()(e.createdAt).format("YYYY-MM-DD")}})})]})};e0.propTypes={logs:A.array.isRequired,loading:A.bool.isRequired};var e1=t(8732),e2=t(2845),e4=t(23914),e3=t(4790),e6=t(97824),e5=function(e){var n,t,i,a,s,u,l,d,m=e.job,f=e.refetchJob,v=e.activeTab,h=(0,e2.x)().user,b=(0,D.x)(),x=(0,o.useState)(0),g=x[0],j=x[1],y=(!!(null===(n=m.customer)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:null===(i=t.finance)||void 0===i?void 0:i.serviceRateLabour)||!!(null===(a=m.customer)||void 0===a?void 0:null===(s=a.meta)||void 0===s?void 0:null===(u=s.finance)||void 0===u?void 0:u.serviceRateExpenses))&&"supplier"!==v,Z=(0,c.aM)(p.bZ,{variables:{jobId:m.id}}),I=Z.loading,S=Z.data,w=(void 0===S?{logs:[]}:S).logs,C=Z.refetch,R=(0,_.Z)((0,P.D)(p.Tw,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!m)return[3,2];return[4,(0,e_.F)(b,m.id)];case 1:e.sent(),e.label=2;case 2:return C(),f(),[2]}})})}),1)[0],A=(l=(0,q.Z)(function(e,n){var t,i;return(0,T.__generator)(this,function(i){switch(i.label){case 0:return t="timing"!==e?n-(0,e1.B)(e,w)||0:null,[4,R({variables:{objects:[{type:e,value:n,jobId:m.id,difference:t,meta:{username:"".concat(h.nameFirst," ").concat(h.nameLast),userId:h.id}}]}})];case 1:return i.sent(),[2]}})}),function(e,n){return l.apply(this,arguments)}),E=(d=(0,q.Z)(function(e,n){var t,i;return(0,T.__generator)(this,function(i){switch(i.label){case 0:return t=null,[4,R({variables:{objects:[{type:e,value:null,jobId:m.id,difference:t,meta:{username:"".concat(h.nameFirst," ").concat(h.nameLast),userId:h.id}}]}}).then(function(){return n()})];case 1:return i.sent(),[2]}})}),function(e,n){return d.apply(this,arguments)}),k=function(e,n){j(n)};return(0,r.jsxs)(M.Z,{children:[(0,r.jsxs)(N.Z,{sx:{width:"100%",height:"100%"},children:[(0,r.jsx)(N.Z,{children:(0,r.jsxs)(e4.m,{value:g,onChange:k,children:[(0,r.jsx)(e3.O,{label:"Customer"}),(0,r.jsx)(e3.O,{label:"Supplier"})]})}),(0,r.jsx)(e6.x,{value:g,index:0,children:(0,r.jsxs)(M.Z,{spacing:2,children:[y&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eW,{defaultValue:(0,e1.B)("serviceRateLabour",w),label:"Service Rate Labour ",name:"serviceRateLabour",onSubmit:A,clearLogs:E}),(0,r.jsx)(eW,{defaultValue:(0,e1.B)("serviceRateExpenses",w),label:"Service Rate Expenses and Materials",name:"serviceRateExpenses",onSubmit:A,clearLogs:E})]}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("discount",w),label:"Customer discount",name:"discount",onSubmit:A,clearLogs:E,vat:"Ex VAT"}),!y&&"fixed"===m.pricing&&(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("amount",w),label:"Amount",name:"amount",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),"time-materials"===m.pricing&&!y&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Normal"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateCustomerNormal",w),label:"First hour rate",name:"firstHourRateCustomerNormal",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateCustomerNormal",w),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerNormal",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(L.Z,{variant:"h6",children:"OOH"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateCustomerOOH",w),label:"First hour rate",name:"firstHourRateCustomerOOH",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateCustomerOOH",w),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerOOH",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(L.Z,{variant:"h6",children:"Premium"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateCustomerPremium",w),label:"First hour rate",name:"firstHourRateCustomerPremium",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateCustomerPremium",w),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerPremium",onSubmit:A,clearLogs:E,vat:"Ex Vat"})]})]})}),(0,r.jsx)(e6.x,{value:g,index:1,children:(0,r.jsxs)(M.Z,{spacing:2,children:[(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("supplierDeduction",w),label:"Supplier deduction",name:"supplierDeduction",onSubmit:A,clearLogs:E,vat:"Ex VAT"}),"fixed"===m.pricing&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("supplierLabourAmount",w),label:"Supplier labour amount",name:"supplierLabourAmount",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("supplierMaterialsAmount",w),label:"Supplier materials amount",name:"supplierMaterialsAmount",onSubmit:A,clearLogs:E,vat:"Ex Vat"})]}),"time-materials"===m.pricing&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Normal"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateSupplierNormal",w),label:"First hour rate",name:"firstHourRateSupplierNormal",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateSupplierNormal",w),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierNormal",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(L.Z,{variant:"h6",children:"OOH"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateSupplierOOH",w),label:"First hour rate",name:"firstHourRateSupplierOOH",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateSupplierOOH",w),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierOOH",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(L.Z,{variant:"h6",children:"Premium"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("firstHourRateSupplierPremium",w),label:"First hour rate",name:"firstHourRateSupplierPremium",onSubmit:A,clearLogs:E,vat:"Ex Vat"}),(0,r.jsx)(eJ,{defaultValue:(0,e1.B)("subsequentHoursRateSupplierPremium",w),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierPremium",onSubmit:A,clearLogs:E,vat:"Ex Vat"})]})]})})]}),(0,r.jsx)(e0,{loading:I,logs:w})]})};e5.propTypes={job:A.object.isRequired,refetchJob:A.func.isRequired};var e7=t(86036),e8=t(43006),e9=t(32109),ne=t(50135),nn=t(69368),nt=t(50480),ni=t(42575),nr=t(6054),no=t(87556),na=t(32749),ns=t(28591),nu=function(e){var n,t,a,s,u,l,d,p,m,f,v=e.description,h=e.handleWorkDescriptionSubmit,b=e.job,x=e.currentQuestions,g=(0,o.useState)(x),j=g[0],y=g[1],Z=(0,o.useState)(!1),I=Z[0],S=Z[1],w=(0,o.useState)(null),C=w[0],R=w[1],q=(0,c.aM)(ni.Im,{variables:{orderBy:{name:"asc"}}}).data,_=(void 0===q?{}:q).taxonomy,T=(0,o.useMemo)(function(){return(null==_?void 0:_.map(function(e){return{id:e.id,name:e.name}}))||[]},[_]),A=function(){var e=document.querySelector('label[for="taxonomyId_ShortDesc"]');if(e){var n=e.querySelector('[class*="singleValue"]');if(n){var t=n.textContent;if(t&&t!==(null==C?void 0:C.name)){var i=null==T?void 0:T.find(function(e){return(null==e?void 0:e.name)===t});i&&R(i)}}}};(0,o.useEffect)(function(){var e=setInterval(function(){A()},100);return function(){clearInterval(e)}});var E=["raised","offered","accepted"].includes(b.status),D={};b.shortJobDesc&&b.shortJobDesc.length>0&&(D={value:b.shortJobDesc[0].taxonomyId,label:b.shortJobDesc[0].taxonomy.name});var P=(0,ei.cI)({defaultValues:{description:v,taxonomyId_ShortDesc:D,name:"".concat(null===(n=b.meta)||void 0===n?void 0:null===(t=n.reporter)||void 0===t?void 0:t.nameFirst," ").concat(null===(a=b.meta)||void 0===a?void 0:null===(s=a.reporter)||void 0===s?void 0:s.nameLast),email:null===(u=b.meta)||void 0===u?void 0:null===(l=u.reporter)||void 0===l?void 0:l.email,phone:null===(d=b.meta)||void 0===d?void 0:null===(p=d.reporter)||void 0===p?void 0:p.phone,shouldSendNotifications:null===(m=b.meta)||void 0===m?void 0:null===(f=m.reporter)||void 0===f?void 0:f.shouldSendNotifications}}),k=P.control,$=P.errors,O=P.handleSubmit,N=P.register,H=P.setValue,F=(0,P.watch)("taxonomyId_ShortDesc",x),J=(0,nr.Z)(F);(0,o.useEffect)(function(){F!==J&&J&&(null==F?void 0:F.childs)&&y(F.childs)},[F]);var U={control:k,errors:$,register:N},V=function(e){S(!0),h(e)},Q=function(e){H("questions",JSON.stringify(e)),O(V)()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(eo.Z,{handleSubmit:O(V),children:[(0,r.jsx)(na.l,(0,et.Z)((0,i.Z)({},U),{label:"Short Job Description",name:"taxonomyId_ShortDesc",type:"jobTags"})),(0,r.jsx)(ns.i,{isSubmit:I,control:k,errors:$,register:N,setValue:H,entity:"ppm"===b.type?"Ppm":"Job",entityId:b.id,linkedTo:{entity:"Taxonomy",entityId:null==C?void 0:C.id},isDisabled:!E,hasPreview:!0}),(0,r.jsx)(eb.Z,{label:"Work description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},U),{name:"description",rows:3}))}),(0,r.jsxs)(M.Z,{rowGap:2,children:[(0,r.jsx)(L.Z,{typography:"h6",children:"Originator"}),(0,r.jsx)(ne.Z,{name:"name",placeholder:"Name",inputRef:N}),(0,r.jsx)(ne.Z,{name:"phone",placeholder:"Phone",inputRef:N}),(0,r.jsx)(ne.Z,{name:"email",placeholder:"Email",inputRef:N}),(0,r.jsx)(ei.Qr,{control:k,name:"shouldSendNotifications",render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(nt.Z,{label:"Should originator receive notifications",control:(0,r.jsx)(nn.Z,{checked:n,color:"secondary",onChange:function(e){var n;return t(null===(n=e.target)||void 0===n?void 0:n.checked)}})})}})]}),(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},U),{name:"questions",type:"hidden"}))]}),(0,r.jsx)(no.D,{entity:"Job",entityId:b.id,onSuccess:Q,questions:j})]})};nu.propTypes={description:A.string.isRequired,handleWorkDescriptionSubmit:A.func.isRequired};var nl=function(e){var n,t,i,a=e.isQuotes,s=e.edit,u=e.job,l=e.refetch,c=(0,o.useContext)(J.Z),d=u.shortJobDesc&&u.shortJobDesc.length?u.shortJobDesc[0].taxonomy.name:"",m=null===(n=u.answers)||void 0===n?void 0:n.map(function(e){var n;return{id:e.id,taxonomyId:e.taxonomyId,comments:e.comments,name:null===(n=e.taxonomy)||void 0===n?void 0:n.name}}),f=(0,_.Z)((0,P.D)(p.FA),1)[0],v=(i=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){switch(t.label){case 0:return n=(0,e8.eD)(e,u.id),delete e.questions,delete e.taxonomyId_ShortDesc,[4,f({variables:{jobId:u.id,changes:e,questions:n,hasQuestions:n.length>0}})];case 1:return t.sent(),c.close(),l(),[2]}})}),function(e){return i.apply(this,arguments)}),h=function(){c.show({content:(0,r.jsx)(nu,{description:u.description||"",handleWorkDescriptionSubmit:v,job:u,currentQuestions:m}),title:"Work Description"})},b=function(){return(0,r.jsx)(eg.Z,{context:"secondary",onClick:h,size:"sm",children:"Edit"})};return(0,r.jsxs)(eN.Z,(t={fitParentHeight:!0,open:!0,title:"Sensors"},(0,ep.Z)(t,"title","Issue Reported - Client"),(0,ep.Z)(t,"toolbar",s&&(0,r.jsx)(b,{})),(0,ep.Z)(t,"children",[!a&&(0,r.jsx)(e7.Z,{content:"Short Job Description",text:d}),(0,r.jsx)(e7.Z,{content:a?"Description":"Job Description",text:u.description}),(0,r.jsx)(e9.y,{answers:m})]),t))};nl.propTypes={isQuotes:A.bool,edit:A.bool,job:A.object.isRequired},nl.defaultProps={edit:!1};var nc=function(e){var n=e.job,t=e.refetch;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(e$.Z,{children:[(0,r.jsx)(eO.Z,{md:6,children:(0,r.jsx)(eH.z,{enableUpdate:!0,job:n,open:!0,refetchParent:t},"expenses-".concat(n.id))}),(0,r.jsx)(eO.Z,{md:6,children:(0,r.jsx)(nl,{edit:!0,job:n,refetch:t},"workDescription-".concat(n.id))})]}),(0,r.jsx)(eN.Z,{title:"Amounts",open:!0,children:(0,r.jsx)(e5,{job:n,refetchJob:t})})]})};function nd(){var e=(0,m.Z)(['\n  mutation UpdateJobTiming(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "timingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_SupplierOffer(where: { jobId: { _eq: $id } }, _set: { status: "offered" }) {\n      returning {\n        id\n      }\n    }\n  }\n']);return nd=function(){return e},e}var np=(0,f.Ps)(nd()),nm=t(52019),nf=t(59983),nv=(0,eu.Ry)().shape({timing:(0,eu.Z_)().required().oneOf(["at","between"]),timingStart:(0,eu.hT)().required(),timingEnd:(0,eu.hT)().when("timing",{is:"between",then:(0,eu.hT)().required()}),timingNormalHours:(0,eu.Z_)()}),nh=function(e){var n,t=e.job,s=e.refetch,l=e.toggleShow,c=(0,a.useRouter)().query,d=(0,D.x)(),p=(0,o.useContext)(u.Z).user,m=(0,o.useContext)(nm.Z).hasRole,f=(0,ei.cI)({defaultValues:{timing:t.timing,timingEnd:t.timingEnd?new Date(t.timingEnd):null,allowTimingNormalHours:!t.timingNormalHours,timingStart:t.timingStart?new Date(t.timingStart):null},resolver:(0,er.S)(nv)}),v=f.control,h=f.errors,b=f.handleSubmit,x=f.register,g=f.setValue,j=f.watch,y=j("timing",t.timing),Z=(0,_.Z)((0,P.D)(np,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!t)return[3,2];return[4,(0,e_.F)(d,t.id)];case 1:e.sent(),e.label=2;case 2:return s&&s(),l(),[2]}})})}),1)[0],I=(n=(0,q.Z)(function(e){var n,r;return(0,T.__generator)(this,function(o){return r=e,["timingEnd","timingStart"].forEach(function(e){r[e]&&(r[e]=K()(r[e]).utc().format())}),"allowTimingNormalHours"===r.allowTimingNormalHours?r.timingNormalHours=!1:r.timingNormalHours=!0,delete r.allowTimingNormalHours,r.timing&&"at"===r.timing&&(r.timingEnd=null),r.scheduledAt=null,r.status="offered",(null===(n=t.meta)||void 0===n?void 0:n.arrivalAnytime)&&(r.meta=(0,et.Z)((0,i.Z)({},t.meta),{arrivalAnytime:!1})),delete r.timeSpan,Z({variables:{id:t.id,changes:(0,i.Z)({},r),timing:{status:"timingChanged",meta:{timingEnd:K()(t.timingEnd).utc().format(),timingStart:K()(t.timingStart).utc().format()},jobId:t.id,userId:p.id}}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:b(I),children:(0,r.jsx)(nf.X,(0,et.Z)((0,i.Z)({},{control:v,errors:h,register:x}),{hasRole:m,timingWatch:y,setValue:g,watch:j,query:c}))})};function nb(){var e=(0,m.Z)(['\n  mutation UpdateJobPricing(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n    $offerId: Int!\n    $offerChanges: SupplierOffer_set_input\n    $hasOfferAccept: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $offerId }, _set: $offerChanges)\n      @include(if: $hasOfferAccept) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "pricingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']);return nb=function(){return e},e}nh.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var nx=(0,f.Ps)(nb()),ng=t(61816),nj=t(64714),ny=function(e){var n={};return["amount","customerSpendThreshold","paymentMethod","pricing","supplierLabourAmount","supplierMaterialsAmount"].forEach(function(t){var i=e[t];"number"==typeof i&&(i=i.toString()),n[t]=i}),e.service&&(n.serviceSelected={value:e.service.id,label:e.service.name}),e.costCategoryTaxonomy&&(n.costCategorySelected={value:e.costCategoryTaxonomy.id,label:e.costCategoryTaxonomy.name}),n},nZ=(0,eu.Ry)().shape({costCategorySelected:(0,eu.Ry)().required(),serviceSelected:(0,eu.Ry)().required(),pricing:(0,eu.Z_)().oneOf(["time-materials","fixed"]),customerSpendThreshold:(0,eu.Z_)(),amount:(0,eu.Z_)(),supplierLabourAmount:(0,eu.Z_)(),supplierMaterialsAmount:(0,eu.Z_)(),paymentMethod:(0,eu.Z_)().oneOf(["card","invoice","N/A"])}),nI=function(e){var n,t,a,s=e.job,c=e.refetch,d=e.toggleShow,p=(0,o.useContext)(u.Z).user,m=(0,D.x)(),f=(0,ei.cI)({defaultValues:ny(s),resolver:(0,er.S)(nZ)}),v=f.control,h=f.errors,b=f.handleSubmit,x=f.register,g=f.watch,j=g("pricing",s.pricing),y=g("serviceSelected",{value:null===(n=s.service)||void 0===n?void 0:n.id,label:null===(t=s.service)||void 0===t?void 0:t.name}),Z=(0,_.Z)((0,P.D)(nx,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!s)return[3,2];return[4,(0,e_.F)(m,s.id)];case 1:e.sent(),e.label=2;case 2:return c&&c(),d(),[2]}})})}),1)[0],I=(a=(0,q.Z)(function(e){var n,t,r,o,a;return(0,T.__generator)(this,function(u){var c;return c=e,(["amount","customerSpendThreshold","supplierLabourAmount","supplierMaterialsAmount"].forEach(function(e){c[e]?c[e]=parseInt(c[e]):c[e]=null}),["costCategory","service"].forEach(function(e){c[e+"Selected"]&&c[e+"Selected"].value&&(c[e+"Id"]=c[e+"Selected"].value),delete c[e+"Selected"]}),n=c).status="offered",r=(null==(t=s.supplierOffers.find(function(e){return"accepted"===e.status}))?void 0:t.statusLog)||[],o=(null==t?void 0:t.id)||0,a=(0,l.Z)(r).concat([{createdAt:new Date,status:"offered",userId:p.id}]),Z({variables:{id:s.id,changes:(0,i.Z)({},n),timing:{status:"pricingChanged",jobId:s.id,userId:p.id},offerId:o,hasOfferAccept:!!o,offerChanges:{status:"offered",statusLog:a}}}),[2]})}),function(e){return a.apply(this,arguments)}),S={control:v,errors:h,register:x};return(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:b(I),children:[(0,r.jsx)(nj.t,(0,i.Z)({},S)),(0,r.jsx)(ng.n,(0,et.Z)((0,i.Z)({},S),{pricingWatch:j,serviceSelectedWatch:y}))]})};function nS(){var e=(0,m.Z)(["\n  mutation AssignSupplier($object: AssignSupplierInput!) {\n    assignSupplier(assignSupplierInput: $object) {\n      data\n      success\n    }\n  }\n"]);return nS=function(){return e},e}function nw(){var e=(0,m.Z)(["\n  query GetSuppliersForAssign($jobId: Int!) {\n    data: getSuppliersForAssign(jobId: $jobId) {\n      job\n      customerRates\n      suppliers\n      hasArea\n      hasActiveOffer\n    }\n  }\n"]);return nw=function(){return e},e}nI.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var nC=(0,f.Ps)(nS()),nR=(0,f.Ps)(nw()),nq=t(72852),n_=t(75832),nT=function(e){var n=e.suppliers,t=e.customerRates,i=e.selected,a=e.setSelected,s=e.setError,u=(0,o.useMemo)(function(){return n.map(function(e){var n,i,r,o,a,s;return{id:e.id,name:e.name,normal:{firstHour:e.normal.firstHour,subsequentHours:e.normal.subsequentHours},ooh:{firstHour:e.ooh.firstHour,subsequentHours:e.ooh.subsequentHours},premium:{firstHour:e.premium.firstHour,subsequentHours:e.premium.subsequentHours},above:(null==t?void 0:null===(n=t.normal)||void 0===n?void 0:n.firstHour)<e.normal.firstHour||(null==t?void 0:null===(i=t.normal)||void 0===i?void 0:i.subsequentHours)<e.normal.subsequentHours||(null==t?void 0:null===(r=t.ooh)||void 0===r?void 0:r.firstHour)<e.ooh.firstHour||(null==t?void 0:null===(o=t.ooh)||void 0===o?void 0:o.subsequentHours)<e.ooh.subsequentHours||(null==t?void 0:null===(a=t.premium)||void 0===a?void 0:a.firstHour)<e.premium.firstHour||(null==t?void 0:null===(s=t.premium)||void 0===s?void 0:s.subsequentHours)<e.premium.subsequentHours}})},[n,t]),c=(0,o.useCallback)(function(e,n){n?(a((0,l.Z)(u.map(function(e){return e.id}))),u.some(function(e){return e.above})&&s({message:"Supplier rates are above customer rates.",severity:"error",color:"error"})):a([])},[u,s,a]),d=(0,o.useCallback)(function(e,n,t){n?(a((0,l.Z)(i).concat([t.id])),t.above&&s({message:"Supplier rates are above customer rates.",severity:"error",color:"error"})):a(i.filter(function(e){return e!==t.id}))},[i,s,a]),p=(0,o.useMemo)(function(){return[{flex:1,field:"name",headerName:"Supplier",sortable:!1},{flex:1,field:"normal",headerName:"Normal",sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsxs)(M.Z,{children:[(0,r.jsxs)(L.Z,{children:["First hour: ",(0,n_.T)(n.normal.firstHour)]}),(0,r.jsxs)(L.Z,{children:["Subsequent hours: ",(0,n_.T)(n.normal.subsequentHours)]})]})}},{flex:1,field:"ooh",headerName:"OOH",sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsxs)(M.Z,{children:[(0,r.jsxs)(L.Z,{children:["First hour: ",(0,n_.T)(n.ooh.firstHour)]}),(0,r.jsxs)(L.Z,{children:["Subsequent hours: ",(0,n_.T)(n.ooh.subsequentHours)]})]})}},{flex:1,field:"premium",headerName:"Premium",sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsxs)(M.Z,{children:[(0,r.jsxs)(L.Z,{children:["First hour: ",(0,n_.T)(n.premium.firstHour)]}),(0,r.jsxs)(L.Z,{children:["Subsequent hours: ",(0,n_.T)(n.premium.subsequentHours)]})]})}},{minWidth:60,field:"switch",headerName:"",sortable:!1,renderHeader:function(){return(0,r.jsx)(nq.Z,{color:"secondary",onChange:function(e,n){return c(e,n)}})},renderCell:function(e){var n=e.row;return(0,r.jsx)(nq.Z,{color:"secondary",checked:i.includes(n.id),onChange:function(e,t){return d(e,t,n)}})}}]},[c,d,i]);return(0,r.jsx)(eX.i,{autoHeight:!1,hideFooter:!1,columns:p,rows:u,pagination:!0,sortingMode:"client",paginationSize:10,initialState:{pagination:{paginationModel:{pageSize:10}}}})};nT.propTypes={customerRates:E().object,setError:E().func,setSelected:E().func,suppliers:E().array},nT.defaultProps={customerRates:{},setError:function(){},setSelected:function(){},suppliers:[]};var nA,nE=t(46901),nD=t(84808),nP=t(98456),nk=t(39641),n$=function(e){var n,t,i,a,s,u,l,d,p=e.jobId,m=e.repost,f=e.refetch,v=e.toggleShow,h=e.isSingleSupplier,b=(0,D.x)(),x=(0,nk.D)(),g=(0,o.useState)([]),j=g[0],y=g[1],Z=(0,o.useState)(null),I=Z[0],S=Z[1],w=(0,ei.cI)().handleSubmit,C=(0,c.aM)(nR,{variables:{jobId:p},onError:function(e){x.show({content:"Error: ".concat(e.message),severity:"error"})}}),R=C.data,A=(void 0===R?{data:{job:{},customerRates:null,suppliers:[],hasArea:!0,hasActiveOffer:!1}}:R).data,E=A.job,k=A.suppliers,$=A.customerRates,O=A.hasArea,N=A.hasActiveOffer,H=C.loading,F=(0,_.Z)((0,P.D)(nC,{onCompleted:(l=(0,q.Z)(function(e){return(0,T.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,e_.F)(b,p)];case 1:return e.sent(),x.show({content:"Supplier was assigned.",severity:"success"}),f(),v(),[2]}})}),function(e){return l.apply(this,arguments)}),onError:function(e){x.show({content:"Error: ".concat(e.message),severity:"error"})}}),2),J=F[0],U=F[1].loading,V=(d=(0,q.Z)(function(){return(0,T.__generator)(this,function(e){return j.length?h&&N||h&&j.length>1?[2,x.show({content:"Jobs can only be reallocated to one supplier.",severity:"warning",color:"info"})]:"quote"===E.type&&j.length>E.quoteNumber?[2,x.show({content:"Jobs can be assigned to a maximum of ".concat(E.quoteNumber," suppliers."),severity:"warning",color:"info"})]:(J({variables:{object:{jobId:p,repost:m,supplierIds:j}}}),[2]):[2,x.show({content:"Error: Select at least one supplier.",severity:"error"})]})}),function(){return d.apply(this,arguments)});return(0,r.jsxs)("form",{id:"offCanvasForm",onSubmit:w(V),children:[(H||U)&&(0,r.jsx)(nD.Z,{sx:{zIndex:1e5},open:!0,children:(0,r.jsx)(nP.Z,{color:"secondary"})}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{children:"Suppliers have been pruned based on the location of the customer and assigned services."}),(0,r.jsxs)(L.Z,{children:["Service: ",(0,r.jsx)("strong",{children:E.serviceName})]}),"quote"!==E.type&&$&&(0,r.jsxs)(L.Z,{children:["Customer rates:"," ",(0,r.jsxs)("strong",{children:[(0,n_.T)(null==$?void 0:null===(n=$.normal)||void 0===n?void 0:n.firstHour),"/",(0,n_.T)(null==$?void 0:null===(t=$.normal)||void 0===t?void 0:t.subsequentHours),"(Normal),","  "]}),(0,r.jsxs)("strong",{children:[(0,n_.T)(null==$?void 0:null===(i=$.ooh)||void 0===i?void 0:i.firstHour),"/",(0,n_.T)(null==$?void 0:null===(a=$.ooh)||void 0===a?void 0:a.subsequentHours),"(OOH),","  "]}),(0,r.jsxs)("strong",{children:[(0,n_.T)(null==$?void 0:null===(s=$.premium)||void 0===s?void 0:s.firstHour),"/",(0,n_.T)(null==$?void 0:null===(u=$.premium)||void 0===u?void 0:u.subsequentHours),"(Premium)"]})]}),"quote"===E.type&&E.quoteNumber&&(0,r.jsxs)(L.Z,{children:[(0,r.jsx)("strong",{children:E.quoteNumber})," supplier(s) needed for quote."]}),(0,r.jsxs)(M.Z,{spacing:1,mt:1,mb:1,children:[!O&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"error",children:"This location does not have an address associated."}),m&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"info",children:"Note: Reposting the job will cancel previous offers."}),I&&(0,r.jsx)(nE.Z,{variant:"filled",severity:I.severity,color:I.color,children:I.message})]}),(0,r.jsx)(nT,{suppliers:k,customerRates:$,selected:j,setSelected:y,setError:S})]})]})};n$.propTypes={jobId:E().string.isRequired,refetch:E().func.isRequired,repost:E().bool,toggleShow:E().func.isRequired,isSingleSupplier:E().bool},n$.defaultProps={repost:!1,isSingleSupplier:!1,refetch:function(){},toggleShow:function(){}};var nO,nN,nH,nF,nM,nL=(nA=(0,q.Z)(function(e){var n,t,i,o;return(0,T.__generator)(this,function(a){return n=e.jobId,t=e.offCanvas,i=e.refetch,o=e.isSingleSupplier,t.show({content:(0,r.jsx)(n$,{jobId:n,refetch:i,toggleShow:t.show,isSingleSupplier:o}),anchor:"left",title:"Assign Supplier",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"65vw",lg:"65vw",lg2:"65vw"}),[2]})}),function(e){return nA.apply(this,arguments)}),nJ=(nO=(0,q.Z)(function(e,n,t,i,o){return(0,T.__generator)(this,function(a){return n.show({content:(0,r.jsx)(ek,{addJobTiming:i,job:e,toggleShow:n.show,updateJob:t,user:o}),placement:"left",title:"Create Quote",width:"50%"}),[2]})}),function(e,n,t,i,r){return nO.apply(this,arguments)}),nU=(nN=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(nI,{job:e,toggleShow:n.show,refetch:t}),title:"Change job pricing/service",width:"40%"}),[2]})}),function(e,n,t){return nN.apply(this,arguments)}),nV=(nH=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(nh,{job:e,toggleShow:n.show,refetch:t}),title:"Change job timing",width:"40%"}),[2]})}),function(e,n,t){return nH.apply(this,arguments)}),nQ=(nF=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(nc,{job:e,refetch:t}),submit:!1,title:"Change job finance",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"50vw",lg:"50vw",lg2:"50vw"}),[2]})}),function(e,n,t){return nF.apply(this,arguments)}),nz=(nM=(0,q.Z)(function(e){var n,t,i,o;return(0,T.__generator)(this,function(a){return n=e.jobId,e.repost,t=e.offCanvas,i=e.refetch,o=e.isSingleSupplier,t.show({content:(0,r.jsx)(n$,{jobId:n,repost:!0,refetch:i,toggleShow:t.show,isSingleSupplier:o}),anchor:"left",title:"Repost Job",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"65vw",lg:"65vw",lg2:"65vw"}),[2]})}),function(e){return nM.apply(this,arguments)}),nY=t(74975),nB=function(e){var n,t=e.job,o=e.quotation,a=e.refetch,s=e.toggleShow,u=(0,ei.cI)({defaultValues:{siteVisitAt:o.siteVisitAt?new Date(o.siteVisitAt):null}}),l=u.control,c=u.errors,d=u.handleSubmit,p=u.register,m=t.siteVisitEnd,f=t.siteVisitStart,v=t.siteVisitWeekends,h=(0,_.Z)((0,P.D)(em.HI,{onCompleted:function(e){a&&a(),s()}}),1)[0],b=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){switch(n.label){case 0:return e.startDate&&(e.startDate=(0,nY.Z)(new Date(e.startDate))),[4,h({variables:{id:o.id,changes:e,recommend:!1}})];case 1:return n.sent(),[2]}})}),function(e){return n.apply(this,arguments)}),x=function(e){var n=new Date(e);return n.getHours()>=8&&17>n.getHours()&&n.getTime()<=new Date(m).getTime()&&n.getTime()>=new Date(f).getTime()},g=function(e){var n=e.getDay();return 0!==n&&6!==n};return(0,r.jsxs)(eo.Z,{handleSubmit:d(b),children:[(0,r.jsx)(eb.Z,{label:"Site visit time"}),(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},{control:l,errors:c,register:p}),{register:p,dateFormat:"d MMM yyyy HH:mm",minDate:f?new Date(f):new Date,maxDate:m&&new Date(m),filterTime:x,filterDate:!v&&g,name:"siteVisitAt",showTimeSelect:!0,todayButton:!1})),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};nB.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var nW=function(e,n,t,i){t.show({content:(0,r.jsx)(nB,{job:e,quotation:n,refetch:i,toggleShow:t.close}),submit:!1,title:"Site visit time",width:"40%"})};function nG(){var e=(0,m.Z)(["\n  mutation CreateRemedialQuote($jobId: Int!, $slaId: Int!, $description: String) {\n    createRemedialQuote(jobId: $jobId, slaId: $slaId, description: $description) {\n      data\n      success\n    }\n  }\n"]);return nG=function(){return e},e}var nK,nX=(0,f.Ps)(nG()),n0=eu.Ry({slaId:eu.Rx().integer().required()}),n1=function(e){var n,t,i=e.jobId,o=e.customerId,a=e.locationId,s=e.toggleShow,u=(0,ei.cI)({defaultValues:{},resolver:(0,er.S)(n0)}),l=u.watch,d=u.handleSubmit,m=u.errors,f=u.register,v=l("slaId"),h=(0,c.aM)(p.Ab,{skip:!o||!a,variables:{customerId:o,locationId:a}}).data,b=(0,e8.GU)("quote",h),x=null===(n=null==b?void 0:b.find(function(e){return e.id===Number(v)}))||void 0===n?void 0:n.notes,g=(0,_.Z)((0,P.D)(nX,{onCompleted:function(){return s()},refetchQueries:["GetJob"]}),2),j=g[0],y=g[1].loading,Z=(t=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(t){switch(t.label){case 0:return n=e.description,[4,j({variables:{jobId:i,slaId:e.slaId,description:n}})];case 1:return t.sent(),[2]}})}),function(e){return t.apply(this,arguments)});return y?(0,r.jsx)(M.Z,{width:"100%",alignItems:"center",children:(0,r.jsx)(nP.Z,{color:"secondary"})}):(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:d(Z),children:[(0,r.jsx)(eh.Z,{register:f,errors:m,data:b,legend:"Priority",name:"slaId"}),v&&(0,r.jsx)(ef.Z,{content:x||"-",context:"light"}),(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,{errors:m,name:"description",register:f,rows:3})}),(0,r.jsx)(ea.H,{content:"Create remedial quote",type:"submit"})]})};n1.defaultProps={toggleShow:function(){}},n1.propTypes={jobId:A.object.isRequired,toggleShow:A.func};var n2,n4=(nK=(0,q.Z)(function(e){var n,t,i,o;return(0,T.__generator)(this,function(a){return n=e.jobId,t=e.customerId,i=e.locationId,(o=e.offCanvas).show({content:(0,r.jsx)(n1,{jobId:n,customerId:t,locationId:i,toggleShow:o.close}),title:"Remedial quote",submit:!1}),[2]})}),function(e){return nK.apply(this,arguments)}),n3=(n2=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return s().push("/dashboard/issues/view?id=".concat(e)),[2]})}),function(e){return n2.apply(this,arguments)}),n6=function(e){var n,t,i,o=e.user,a=(e.deleteJobTiming,e.job),s=e.offCanvas,u=e.offCanvasNew,l=e.refetch,c=e.updateJob,d=e.client,p=a.siteVisitStart,m=(null===(n=a.parentJob)||void 0===n?void 0:n.type)==="reactive";return"closed"===a.status?[{id:1,label:"New Quote",date:(0,W.E)(a,"quoteOffered")||(0,W.E)(a,"closed")},{id:2,label:"Quote Closed",date:(0,W.E)(a,"closed"),actions:[{id:1,active:(0,W.E)(a,"closed"),content:"Repost job",context:"danger",handleClick:function(){return eA(a,c,"quoteNew")},type:"button"}]}]:[{id:1,label:"New Quote",date:(0,W.E)(a,"quoteNew"),content:[{id:1,active:!0,data:"Created By ".concat((null===(t=null==a?void 0:a.timings[0])||void 0===t?void 0:null===(i=t.user)||void 0===i?void 0:i.fullName)||"")}],actions:[{id:1,active:(0,W.E)(a,"quoteNew")&&!(0,W.E)(a,"inProgress")&&!(0,W.E)(a,"quoteOffered"),content:"Make reactive",context:"secondary",handleClick:function(){return ed(a,s,l)},type:"button"},{id:2,active:m,content:"Related works",context:"info",handleClick:function(){var e;return n3(null===(e=a.parentJob)||void 0===e?void 0:e.number)},type:"button"}]},{id:2,label:"Sent to Supplier(s)",info:a.quotations.length<a.quoteNumber?"".concat(a.quoteNumber," supplier(s) needed for this quote\n            (").concat(a.quotations.length,"/").concat(a.quoteNumber," selected)"):"no assigned suppliers",date:a.quotations.length>0&&(0,W.E)(a,"quoteOffered"),actions:[{id:1,active:a.quotations.length<a.quoteNumber&&("quoteNew"===a.status||(0,W.E)(a,"quoteNew"))&&!(0,W.E)(a,"inProgress"),content:"Assign suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){return nL({jobId:a.id,offCanvas:u,refetch:l})},type:"button"},{id:2,active:a.quotations.length>=a.quoteNumber&&(0,W.E)(a,"quoteOffered")&&!(0,W.E)(a,"quoteAccepted"),content:"Repost job",context:"danger",handleClick:function(){return nz({jobId:a.id,offCanvas:u,refetch:l})},type:"button"}]},{id:3,label:"Received from Supplier(s)",info:"waiting for supplier to submit",date:(0,W.E)(a,"quoteReceived"),content:a.quotations.map(function(e,n){return{id:n,active:!(0,W.E)(a,"supplierQuoteComplete")&&e.siteVisitAt&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,data:function(){return(0,r.jsxs)(r.Fragment,{children:["Site visit at ".concat(e.quoteNumber),":",(0,r.jsxs)("b",{children:[" ",(0,ee.Z)(e.siteVisitAt,!0)]})]})}}}),actions:a.quotations.map(function(e,n){return{id:n,active:!(0,W.E)(a,"supplierQuoteComplete")&&p&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,content:e.siteVisitAt?"Edit site visit time ".concat(e.quoteNumber):"Select site visit time ".concat(e.quoteNumber),context:"secondary",handleClick:function(){return nW(a,e,s,l)},type:"button"}})},{id:4,label:"Sent to Customer",info:"not sent",date:(0,W.E)(a,"quoteSent"),actions:[{id:1,active:!!a.quotations.find(function(e){return"supplierQuoteSent"===e.status})&&(0,W.E)(a,"quoteSent"),content:"Download quote",context:"secondary",handleClick:function(){return(0,en.g)(a,null,d)},type:"button"},{id:2,active:(0,W.E)(a,"quoteReceived")&&!(0,W.E)(a,"quoteSent"),content:"Send quote",context:"secondary",handleClick:function(){return eR(a,o,s,l)},type:"button"}]},{id:5,label:"Accepted / Rejected",info:"waiting for customer to accept",date:(0,W.E)(a,"quoteAccepted")||"quoteRejected"===a.status&&(0,W.E)(a,"quoteRejected")},{id:6,label:"Closed",date:(0,W.E)(a,"quoteClosed")}]},n5=function(e){var n=e.job;return e.offCanvas,e.refetch,[{id:1,label:"Quote raised",info:"quote is with contractor for pricing",date:(0,W.E)(n,"quoteNew")||(0,W.E)(n,"quoteOffered")},{id:2,label:"In review",info:"currently being reviewed",date:(0,W.E)(n,"quoteReceived")},{id:3,label:"Awaiting acceptance",info:"awaiting your acceptance",date:(0,W.E)(n,"quoteSent")},{id:4,label:"Accept / Reject",date:(0,W.E)(n,"quoteAccepted")||"quoteRejected"===n.status&&(0,W.E)(n,"quoteRejected")},{id:5,label:"Closed",date:(0,W.E)(n,"quoteClosed")}]},n7=function(e){var n,t=e.job,i=e.offCanvas,o=e.refetch,a=e.user,s=(null===(n=t.parentJob)||void 0===n?void 0:n.type)==="reactive",u=t.quotations.length>0?t.quotations.find(function(e){return e.accountId===a.accountId}):{},l=u&&("supplierQuoteDraft"===u.status||"supplierQuoteComplete"===u.status)?u.updatedAt:null,c=u&&"supplierQuoteComplete"===u.status?u.updatedAt:null,d=t.siteVisitStart;return[{id:1,label:"Quotation offered",date:(0,W.E)(t,"quoteOffered"),actions:[{id:2,active:s,content:"Related works",context:"info",handleClick:function(){var e;return n3(null===(e=t.parentJob)||void 0===e?void 0:e.number)},type:"button"}]},{id:2,label:"Quotation",info:"need to complete the quotation",date:l,content:t.quotations.map(function(e,n){return{id:n,active:!(0,W.E)(t,"supplierQuoteComplete")&&e.siteVisitAt&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,data:function(){return(0,r.jsxs)(r.Fragment,{children:["Site visit at ".concat(e.quoteNumber),":",(0,r.jsxs)("b",{children:[" ",(0,ee.Z)(e.siteVisitAt,!0)]})]})}}}),actions:t.quotations.map(function(e,n){return{id:n,active:!(0,W.E)(t,"supplierQuoteComplete")&&d&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,content:e.siteVisitAt?"Edit site visit time ".concat(e.quoteNumber):"Select site visit time ".concat(e.quoteNumber),context:"secondary",handleClick:function(){return nW(t,e,i,o)},type:"button"}})},{id:3,label:"Completed",date:c}]},n8=function(e,n,t,i,r,o,a,s,u,l){var c;return t("admin")?c=n6({user:u,deleteJobTiming:n,job:i,offCanvas:r,offCanvasNew:o,refetch:a,updateJob:s,client:l}):t("supplier")?c=n7({job:i,offCanvas:r,refetch:a,user:u}):t("customer")&&(c=n5({job:i,offCanvas:r,refetch:a})),c.forEach(function(e){e.date&&(e.date=K()(e.date).format("D MMM YYYY HH:mm"))}),c},n9=function(e){var n=[];return n.push({label:"Scheduled start:",value:e.timingStart?K()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&n.push({label:"Scheduled end:",value:e.timingEnd?K()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),"chargable"===e.quoteCharge&&n.push({label:"Quote charge:",value:(0,X.Z)(e.quoteChargeAmount)}),n},te=t(73303),tn=t.n(te);function tt(e){var n,t=e.autoStart,i=e.startTime,r=e.endTime,a=e.interval,s=void 0===a?1e3:a,u=(0,o.useState)((n=(r?K()(r):K()()).diff()-K()(i).diff())>-1?n:0),l=u[0],c=u[1],d=(0,o.useState)(t),p=d[0],m=d[1];(0,o.useEffect)(function(){var e=null;return p?e=setInterval(function(){c(K()().diff()-K()(i).diff())},s):clearInterval(e),function(){clearInterval(e)}},[p]);var f,v=function(){m(!0)},h=function(){m(!1)};return{time:{seconds:(f=K().duration(l)).seconds().toString().padStart(2,"0"),minutes:f.minutes().toString().padStart(2,"0"),hours:parseInt(f.asHours(),10),exactHours:f.asHours().toFixed(2)},start:v,stop:h}}tt.propTypes={autoStart:A.bool,startTime:A.string.isRequired,endTime:A.string,interval:A.number};var ti=function(e){for(var n=null,t=(0,l.Z)(null==e?void 0:e.timings).sort(function(e,n){return e.id-n.id}),i=t.length-1;i>=0;i--){var r,o=t[i].status;if("inProgress"===o||"resumed"===o||"continued"===o){n=(null===(r=t[i])||void 0===r?void 0:r.createdAt)||n;break}}return n},tr=function(e){for(var n=null,t=(0,l.Z)(null==e?void 0:e.timings).sort(function(e,n){return e.id-n.id}),i=t.length-1;i>=0;i--){var r,o=t[i].status;if("paused"===o||"onHold"===o||"completed"===o){n=(null===(r=t[i])||void 0===r?void 0:r.createdAt)||n;break}}return n},to=t(11699),ta=function(e){var n=e.slice().sort(function(e,n){return Number(e.id)-Number(n.id)}).filter(function(e){return"inProgress"===e.status||"paused"===e.status||"resumed"===e.status||"continued"===e.status||"completed"===e.status||"onHold"===e.status}),t=[],i=n.findIndex(function(e){return"inProgress"===e.status}),r=n.findIndex(function(e){return"completed"===e.status});if(-1===i&&-1===r)return t;-1===r&&(r=n.length-1);for(var o=i;o<=r;o+=2)if(("inProgress"===n[o].status||"resumed"===n[o].status||"continued"===n[o].status)&&o+1<n.length){var a=(0,to.Z)(new Date(n[o+1].createdAt),new Date(n[o].createdAt));t.push({startDate:n[o].createdAt,endDate:n[o+1].createdAt,duration:Math.round(a)})}return t},ts=t(48218),tu=t(33223),tl=t(21023),tc=t(38216),td=t(11994),tp=t(79424),tm=o.memo(function(e){var n=e.openModal,t=e.handleCloseModal,a=e.selectedField,s=e.entityId,u=(0,o.useState)({}),l=u[0],c=u[1],d=(0,o.useState)(""),p=d[0],m=d[1],f=(0,o.useState)(0),v=f[0],h=f[1],b=(0,o.useCallback)(function(e,n){c(function(t){return t[e]===n?t:(0,et.Z)((0,i.Z)({},t),(0,ep.Z)({},e,n))})},[]),x=function(e){b("checkboxes",e)},g=function(e){b("signature",e)},j=(0,o.useCallback)(function(e){h(function(n){return n===e?n:e})},[]),y=function(){var e;v>0&&(null===(e=l.checkboxes)||void 0===e?void 0:e.length)>0&&l.signature?(t(),m("")):m("Please fill in all required fields.")};return n?(0,r.jsx)(td.Z,{sx:{zIndex:1199,overflow:"auto"},open:n,onClose:y,"aria-labelledby":"modal-title","aria-describedby":"modal-description",slotProps:{backdrop:{sx:{backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:0}}},children:(0,r.jsx)(N.Z,{sx:tf,children:(0,r.jsx)(N.Z,{sx:tv,children:a?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tp.D,{headerNotification:a.label,entityId:s,desc:a.desc,popupContext:a.popupContext,url:a.url,linkText:a.linkText,isMultiple:a.isMultiple,id:a.id,options:a.options||[],checkedValues:l.checkboxes||[],onCheckboxChange:x,onFileChange:j,onSignatureChange:g}),p&&(0,r.jsx)(L.Z,{color:"error",mt:2,children:p}),(0,r.jsx)(N.Z,{sx:th,children:(0,r.jsx)(H.Z,{variant:"contained",onClick:y,children:"Ok"})})]}):null})})}):null}),tf={display:"flex",overflow:"hidden",flexDirection:"column",position:"relative",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:600,height:600,backgroundColor:"#FFFFFF",border:"2px solid #000",borderRadius:"12px",boxShadow:24,p:4},tv={flex:1,overflowY:"auto",padding:"10px"},th={display:"flex",justifyContent:"center",marginTop:"20px",position:"relative",bottom:0},tb=function(e){var n=e.job,t=(0,D.x)(),i=(0,o.useContext)(u.Z).user,a=(0,o.useState)(!1),s=a[0],l=a[1],d=(0,o.useState)(null),p=d[0],m=d[1],f=(0,o.useState)(!1),v=f[0],h=f[1],b="fixed"===n.pricing,x="incorrect"===n.timingStatus,g=n.supplier,j=(0,ts.L)(n.timings),y=(0,W.E)(n,"accepted"),Z=(0,W.E)(n,"inProgress")&&!(0,W.E)(n,"completed"),I="onHold"===j,S="paused"===j,w=!(n.media.filter(function(e){var n;return!(null===(n=e.item.meta)||void 0===n?void 0:n.adminOnly)}).length>0),C=(0,W.E)(n,"closed"),R=ta(n.timings),A=tn()(R,"duration"),E=tt({autoStart:!1,startTime:ti(n),endTime:tr(n)}),J=E.time,U=J.seconds,V=J.minutes,Q=J.hours,z=E.start,Y=E.stop,G=(0,_.Z)((0,P.D)(tu.xY,{refetchQueries:["GetJob"],onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!n)return[3,2];return[4,(0,e_.F)(t,n.id)];case 1:e.sent(),e.label=2;case 2:return[2]}})})}),1)[0],X=(0,c.aM)(tc.Q2,{variables:{entity:"ppm"===n.type?"Ppm":"Job",entityId:null==n?void 0:n.id},skip:!(null==n?void 0:n.id)}).data,ee=function(){l(!1),v&&(G({variables:{id:n.id,changes:{status:"inProgress"},timing:{status:"inProgress",jobId:n.id,userId:i.id},_append:{statusData:{inProgress:K()().toISOString()}}}}),h(!1)),m(null)};(0,o.useEffect)(function(){!Z||S||I?Y():z()},[Z,n,I,S,z,Y]);var en=function(e){return function(t){t.stopPropagation(),G({variables:{id:n.id,changes:{status:e},timing:{status:e,jobId:n.id,userId:i.id}}})}},et=function(e){var t,r,o,a=(t=null===(o=null==X?void 0:X.FormSubmissions[0])||void 0===o?void 0:o.formFields).find(function(e){return"onTimerStart"===e.notificationType});a?(m(a),l(!0),h(!0)):(e.stopPropagation(),G({variables:{id:n.id,changes:{status:"inProgress"},timing:{status:"inProgress",jobId:n.id,userId:i.id},_append:{statusData:{inProgress:K()().toISOString()}}}}))},ei=function(e){e.stopPropagation(),G({variables:{id:n.id,changes:{status:"completed"},timing:{status:"completed",jobId:n.id,userId:i.id},_append:{statusData:{completed:K()().toISOString()}}}})},er=R.map(function(e,n){return{id:n,startDate:e.startDate,endDate:e.endDate,duration:e.duration}});return(0,r.jsxs)(k.Z,{disableGutters:!0,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),"aria-controls":"timer-content",id:"timer-header",children:(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsx)(F.ZP,{item:!0,xs:12,children:(0,r.jsx)(L.Z,{variant:"h6",children:"Timer"})}),(0,r.jsx)(F.ZP,{item:!0,xs:12,display:"flex",justifyContent:"center",sx:{marginTop:"-18px"},children:(0,r.jsxs)(L.Z,{sx:{fontSize:"24px",fontWeight:600},children:[Q,":",V,":",U]})}),(0,r.jsxs)(F.ZP,{item:!0,xs:12,display:"flex",justifyContent:"center",children:[Z&&w&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"info",sx:{mb:1},children:"You must add at least one photo in order to end the timer."}),x&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"error",sx:{mb:1},children:"Timer has been marked as incorrect by supplier"})]}),(0,r.jsx)(tm,{openModal:s,handleCloseModal:ee,selectedField:p,entityId:n.id}),(0,r.jsx)(F.ZP,{item:!0,xs:12,children:!C&&g&&(0,r.jsxs)(M.Z,{direction:"row",display:"flex",justifyContent:"center",spacing:2,children:[!I&&!!y&&!(0,W.E)(n,"inProgress")&&(0,r.jsx)(H.Z,{mt:2,color:"success",variant:"contained",onClick:et,children:"Start"}),!!(0,W.E)(n,"inProgress")&&!(0,W.E)(n,"completed")&&!S&&!I&&(0,r.jsx)(H.Z,{mt:2,color:"danger",variant:"contained",onClick:en("paused"),children:"Pause"}),!(0,W.E)(n,"completed")&&S&&!I&&(0,r.jsx)(H.Z,{mt:2,variant:"contained",onClick:en("continued"),children:"Continue"}),!!(0,W.E)(n,"inProgress")&&!(0,W.E)(n,"completed")&&!I&&!S&&!w&&(0,r.jsx)(H.Z,{mt:2,variant:"contained",color:"danger",onClick:ei,children:"End"})]})})]})}),(0,r.jsx)($.Z,{children:!b&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(eX.i,{rows:er,columns:[{field:"startDate",headerName:"Date",flex:1,sortable:!1,valueGetter:function(e){var n=e.row;return K()(n.startDate).format("YYYY-MM-DD")}},{field:"duration",headerName:"Minutes",flex:1,sortable:!1,renderCell:function(e){var n=e.row;return e.value,(0,r.jsx)(tl.Z,{title:(0,r.jsxs)(r.Fragment,{children:["From: ".concat(K()(n.startDate).format("YYYY-MM-DD HH:mm")),(0,r.jsx)("br",{}),"To: ".concat(K()(n.endDate).format("YYYY-MM-DD HH:mm")," ")]}),children:(0,r.jsx)("span",{children:Math.round(n.duration/60)})})}}]}),(0,r.jsxs)(M.Z,{direction:"row",pl:"10px",children:[(0,r.jsx)(L.Z,{children:"Total:"}),(0,r.jsx)(L.Z,{ml:.5,color:"secondary",children:Math.round(A/60)})]})]})})]})};tb.propTypes={job:E().object.isRequired};var tx,tg,tj=t(6538),ty=t(35418),tZ=(tx=(0,q.Z)(function(e,n){return(0,T.__generator)(this,function(t){return n.show({content:(0,r.jsx)(ty.G,{entity:"JobTiming",entityId:e}),title:"Dispute media"}),[2]})}),function(e,n){return tx.apply(this,arguments)}),tI=t(76256),tS=function(e){var n,t=e.job,i=e.refetch,a=e.status,s=e.toggleShow,l=(0,o.useContext)(J.Z),c=(0,o.useContext)(u.Z).user,d=(0,ei.cI)({defaultValues:{comments:""}}),m=d.errors,f=d.handleSubmit,v=d.register,h=(0,_.Z)((0,P.D)(p.r2,{onCompleted:function(e){var n=e.insert_JobTiming.returning[0].id;n&&"inDispute"===a?b(n):(i&&i(),s())}}),1)[0],b=function(e){l.show({content:(0,r.jsx)(tI.z,{accept:"image/*",category:null,entity:"JobTiming",entityId:e,expiryShow:!1,onSuccess:function(){return x(e)},showSubmitButton:!0}),title:"Upload Photo",submit:!1})},x=function(e){i&&i(),s(),l.close()},g=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(i){return n={notes:e.comments,status:a,jobId:t.id,userId:c.id},h({variables:{objects:[n]}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:f(g),children:(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:m,name:"comments",register:v,rows:3})})})};tS.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var tw,tC,tR=(tg=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(tS,{job:e,status:"inDispute",toggleShow:n.show,refetch:t}),title:"Dispute"}),[2]})}),function(e,n,t){return tg.apply(this,arguments)}),tq=(tw=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(tS,{job:e,status:"disputeResolved",toggleShow:n.show,refetch:t}),title:"Resolve Dispute"}),[2]})}),function(e,n,t){return tw.apply(this,arguments)}),t_=t(35842),tT=function(e){var n,t=e.job,o=e.toggleShow,a=(0,ei.cI)({defaultValues:{isRecall:!1}}),u=a.errors,l=a.handleSubmit,c=a.register,d=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(n){return"true"===e.isRecall?(0,t_.e)({adminId:t.adminId,job:t,openReport:!1}).then(function(e){s().push("/dashboard/issues/manage?recall=true&parentId=".concat(t.id,"&report=").concat(encodeURIComponent(e.blob.key)))}):s().push("/dashboard/issues/manage?recall=false&parentId=".concat(t.id)),o(),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:l(d),children:(0,r.jsx)(eb.Z,{label:"",children:(0,r.jsx)(ev.Z,(0,et.Z)((0,i.Z)({},{errors:u,register:c}),{name:"isRecall",data:[{label:"Is this a recall?",key:"recall",value:!0}]}))})})};tT.propTypes={job:A.object.isRequired,toggleShow:A.func.isRequired};var tA=(tC=(0,q.Z)(function(e,n){return(0,T.__generator)(this,function(t){return n.show({content:(0,r.jsx)(tT,{job:e,toggleShow:n.close}),title:"Follow On"}),[2]})}),function(e,n){return tC.apply(this,arguments)}),tE=t(75759),tD=t(97768),tP=t(45416),tk=t(18586),t$=t(96216),tO=function(e){var n,t=e.job,a=e.refetch,s=e.toggleShow,l=(0,o.useContext)(u.Z).user,c=(0,ei.cI)({defaultValues:{comments:"",jobHoldReason:null}}),d=c.control,p=c.errors,m=c.handleSubmit,f=c.register,h=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){a&&a(),s()}}),1)[0],b=(n=(0,q.Z)(function(e){var n,i,r;return(0,T.__generator)(this,function(o){return i="onHold",r={},(null===(n=e.jobHoldReason)||void 0===n?void 0:n.value)&&(r.jobHoldReason={},r.jobHoldReason.value=e.jobHoldReason.value,r.jobHoldReason.label=e.jobHoldReason.label),h({variables:{id:t.id,changes:{status:i},timing:{jobId:t.id,meta:r,notes:e.comments,status:i,userId:l.id}}}),[2]})}),function(e){return n.apply(this,arguments)}),x={errors:p,register:f,control:d};return(0,r.jsxs)(eo.Z,{handleSubmit:m(b),children:[(0,r.jsx)(na.l,(0,et.Z)((0,i.Z)({},x),{label:"Reason",name:"jobHoldReason",type:"jobHoldReason"})),(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},x),{name:"comments",rows:3}))}),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};function tN(){var e=(0,m.Z)(['\n  mutation UpdateSupplierOffer(\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: ["accepted", "offered"] } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n\n    update_SupplierOffer(where: { jobId: { _eq: $jobId } }, _set: { status: "cancelled" }) {\n      returning {\n        id\n      }\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']);return tN=function(){return e},e}tO.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var tH=(0,f.Ps)(tN());function tF(){var e=(0,m.Z)(["\n  mutation AcceptJob($object: AcceptJobOfferInput!) {\n    acceptJobOffer(acceptOfferInput: $object) {\n      data\n      success\n    }\n  }\n"]);return tF=function(){return e},e}function tM(){var e=(0,m.Z)(['\n  mutation UpdateSupplierOffer(\n    $noAnotherOffers: Boolean!\n    $assignedReject: Boolean!\n    $changes: SupplierOffer_set_input\n    $id: Int!\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    insert_JobTiming(objects: $timing) @include(if: $assignedReject) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: "offered" } })\n      @include(if: $noAnotherOffers) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) @include(if: $assignedReject) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n']);return tM=function(){return e},e}var tL=(0,f.Ps)(tF()),tJ=(0,f.Ps)(tM()),tU=t(55377),tV=t(55843),tQ=(0,eu.Ry)().shape({arrivalTime:(0,eu.hT)().required(),acceptedContractor:(0,eu.Ry)().required(),time:(0,eu.Xg)()}),tz=(0,eu.Ry)().shape({rejectedNotes:(0,eu.Z_)().required()}),tY=t(14149),tB=function(e){var n,t,a,s=e.accountId,u=e.job,l=e.offCanvas,c=e.refetch,d=e.edit,p=(0,o.useState)(),m=p[0],f=p[1],v=(0,e2.x)(),h=v.hasRole,b=v.user,x=(0,D.x)(),g=h("admin"),j=h("supplier"),y=s||"supplier"===b.accountType&&b.accountId,Z=(null===(n=null==u?void 0:u.quotations.find(function(e){return"quotationAccepted"===e.status}))||void 0===n?void 0:n.startDate)||new Date,I=u.quoted?Z:u.timingStart,S=(0,o.useState)(null),w=S[0],C=S[1],R=(0,o.useState)(null),A=R[0],E=R[1],k=(0,o.useState)(null),$=k[0],O=k[1],N=(0,o.useState)(null),H=N[0],F=N[1],M=(0,o.useState)(!1),L=M[0],J=M[1],U=(0,o.useState)(!1),V=U[0],Q=U[1],z=(0,o.useState)(!1),Y=z[0],B=z[1];(0,o.useEffect)(function(){var e=function(e,i,r,o){var a=n(e,r),s=n(i,o);t(e,i,a,s)},n=function(e,n){return e.set({hour:n.hour()||0,minute:n.minute()||0,second:n.second()||0,millisecond:n.millisecond()||0}).toISOString()},t=function(e,n,t,i){C(e?new Date(e):null),E(n?new Date(n):null),O(t?new Date(t):null),F(i?new Date(i):null)};if("ppm"===u.type&&u.timingStart&&u.timingEnd&&j){if(K()().isAfter(K()(u.timingStart))){var i=K()(u.timingStart),r=K()(u.timingEnd),o=K()(u.hourStart||K()().startOf("day"),"HH:mm:ssZ"),a=K()(u.hourEnd||K()().endOf("day"),"HH:mm:ssZ");e(i,r,o,a)}else if(K()().isAfter(K()(u.timingStart).subtract(7,"day"))){var s=K()().diff(K()(u.timingStart).subtract(7,"day"),"ms"),l=K()(u.timingStart),c=K()(u.timingStart).set({millisecond:s||0}),d=K()(u.hourStart||K()().startOf("day"),"HH:mm:ssZ"),p=K()(u.hourEnd||K()().endOf("day"),"HH:mm:ssZ");e(l,c,d,p)}else K()().isBefore(K()(u.timingStart).subtract(7,"day"))&&(t(),J(!0));Q(!0)}else if("ppm"===u.type&&u.timingStart&&u.timingEnd&&!j){var m=K()(u.timingStart),f=K()(u.timingEnd),v=K()(u.hourStart||K()().startOf("day"),"HH:mm:ssZ"),h=K()(u.hourEnd||K()().endOf("day"),"HH:mm:ssZ");e(m,f,v,h),Q(!1)}else"reactive"===u.type&&u.quoted?t(u.timingStart,K()(u.timingStart).add(60,"day")):"reactive"===u.type&&(g||j)&&t(u.timingStart,null)},[u.timingStart,u.timingEnd,u.type,u.quoted,u.hourStart,u.hourEnd,j,g]);var W,G=u.supplierOffers.filter(function(e){return"cancelled"!==e.status}),X=null;G.forEach(function(e){e.account.id===y&&(X=e)});var ee,en=(0,_.Z)((0,P.D)(tL,{onCompleted:(W=(0,q.Z)(function(e){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!u)return[3,2];return[4,(0,e_.F)(x,u.id)];case 1:e.sent(),e.label=2;case 2:return c&&c(),l.close(),[2]}})}),function(e){return W.apply(this,arguments)}),onError:function(e){f(e.message)}}),1)[0],eu=(ee=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){return en({variables:{object:{arrivalAnytime:!1,jobId:u.id,scheduledAt:e.arrivalTime?(0,tY.v)(e.arrivalTime):null,supplierId:y,supplierUserId:null===(n=e.acceptedContractor)||void 0===n?void 0:n.value,supplierOfferId:X.id,offerStatusLog:JSON.stringify(X.statusLog),userId:b.id,edit:d}}}),[2]})}),function(e){return ee.apply(this,arguments)}),el=(0,ei.cI)({defaultValues:{arrivalTime:w,acceptedContractor:(null==u?void 0:null===(t=u.supplier)||void 0===t?void 0:null===(a=t.contactUsers)||void 0===a?void 0:a.length)?{value:u.supplier.contactUsers[0].user.id,label:u.supplier.contactUsers[0].user.fullName}:null},resolver:(0,er.S)(tQ)}),ec=el.control,ed=el.errors,ep=el.handleSubmit,em=el.register,ev=el.setValue,eh=(0,el.watch)("arrivalTime");(0,o.useEffect)(function(){ev("arrivalTime",w)},[w,ev]),(0,o.useEffect)(function(){eh&&u.onSiteTimingEnd&&K()(eh).isAfter(K()(u.onSiteTimingEnd))?B(!0):B(!1)},[eh,u.onSiteTimingEnd]);var ex={control:ec,errors:ed,register:em};return(0,r.jsxs)(eo.Z,{handleSubmit:ep(eu),children:[V&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"warning",color:"info",sx:{"& .MuiAlert-icon":{alignItems:"center"},mb:2},children:"Please be aware that you can only choose a date and time for attendance no more than 7 days prior, or any time within the calendar month of the job."}),Y&&(0,r.jsx)(nE.Z,{variant:"filled",severity:"warning",color:"info",sx:{"& .MuiAlert-icon":{alignItems:"center"},mb:2},children:"Warning: The selected time is beyond the relevant SLA."}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Scheduled:"})," ",(0,r.jsx)("span",{children:(0,nY.Z)(new Date(I),"d MMM yyyy HH:mm")}),u.timingEnd&&(0,r.jsxs)("span",{children:[" - ",(0,nY.Z)(new Date(u.timingEnd),"d MMM yyyy HH:mm")]})]}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(eb.Z,{label:"Arrival time"}),(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},ex),{dateFormat:"d MMM yyyy HH:mm",readOnly:L,disabled:L,maxDate:A,minDate:w,maxTime:H,minTime:$,name:"arrivalTime",showTimeSelect:!0,timeIntervals:15,todayButton:!1})),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(es.P,(0,et.Z)((0,i.Z)({},ex),{accountId:y,errors:(0,i.Z)({},ed),label:"Operative",name:"acceptedContractor",type:"user"})),(0,r.jsx)(ea.H,{content:"Confirm",type:"submit"}),m&&(0,r.jsx)(ef.Z,{content:m,context:"danger"})]})};tB.propTypes={accountId:A.number,edit:A.bool,job:A.object.isRequired,offCanvas:A.object.isRequired,refetch:A.func},tB.defaultProps={edit:!1};var tW=(0,eu.Ry)().shape({cancellingReason:(0,eu.Z_)().required()}),tG=function(e){var n,t,a=e.job,l=e.refetch,c=e.offCanvas,d=(0,o.useContext)(u.Z).user,p=(0,ei.cI)({defaultValues:{notes:""},resolver:(0,er.S)(tW)}),m=p.errors,f=p.handleSubmit,v=p.register,h=(0,p.watch)("canNotMakeDate"),b={errors:m,register:v},x=(0,_.Z)((0,P.D)(tH,{onCompleted:function(e){c.close(),"supplier"===d.accountType?s().push("/dashboard"):l&&l()}}),1)[0],g=(t=(0,q.Z)(function(e){var n,t,i;return(0,T.__generator)(this,function(r){return i=null,i={scheduledAt:null,status:"raised",supplierId:null,supplierUserId:null},(t=[]).push({status:"supplierCancel",jobId:a.id,userId:d.id,notes:e.cancellingReason,meta:{supplierId:null===(n=a.supplier)||void 0===n?void 0:n.id}}),x({variables:{jobChanges:i,jobId:a.id,timing:t}}),[2]})}),function(e){return t.apply(this,arguments)});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},b),{data:[{id:"yes",label:"Yes",value:!0},{id:"no",label:"No",value:!1}],legend:"Are you cancelling because you cannot make the scheduled date and time?",name:"canNotMakeDate",stacked:!0})),"true"===h&&(0,r.jsx)(tB,{accountId:null===(n=a.supplier)||void 0===n?void 0:n.id,edit:!0,job:a,offCanvas:c,refetch:l}),"false"===h&&(0,r.jsxs)(eo.Z,{handleSubmit:f(g),children:[(0,r.jsx)(eb.Z,{label:"Please provide a reason for cancelling this job",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},b),{name:"cancellingReason",rows:3}))}),(0,r.jsx)(ea.H,{content:"Confirm",type:"submit"})]})]})};tG.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,offCanvas:A.func.isRequired};var tK,tX=t(39474),t0=t(67212),t1=(tK=(0,q.Z)(function(e){var n,t,i,o,a;return(0,T.__generator)(this,function(s){switch(n=e.type,t=e.job,i=e.offCanvas,o=e.refetch,n){case"customer":a=t.customerId;break;case"supplier":a=t.supplierId;break;default:return[2]}return i.show({content:(0,r.jsx)(t0.q,{type:n,accountId:a,adminId:t.adminId,jobId:t.id,jobNumber:t.number,refetch:o,toggleShow:i.show,invoicesForJobOnly:!0}),title:"Payment",width:"50%"}),[2]})}),function(e){return tK.apply(this,arguments)}),t2=function(e){var n,t=e.job,i=e.refetch,a=e.status,s=e.toggleShow,l=(0,o.useContext)(u.Z).user,c=(0,ei.cI)({defaultValues:{comments:""}}),d=c.errors,m=c.handleSubmit,f=c.register,v=(0,_.Z)((0,P.D)(p.r2,{onCompleted:function(){i&&i(),s()}}),1)[0],h=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(i){return n={notes:e.comments,status:a,jobId:t.id,userId:l.id},v({variables:{objects:[n]}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:m(h),children:(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:d,name:"comments",register:f,rows:3})})})};t2.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var t4,t3,t6,t5=function(e,n){var t=e.addJobTiming,i=e.entityId,o=e.job,a=e.onlyShow,s=void 0!==a&&a,u=e.userId,l={status:"complianceReportSent",jobId:o.id,userId:u};n.show({content:(0,r.jsx)(ty.G,{entity:"Compliance_Entity",entityId:i,showActionButtons:!s,showItemActions:!s,onMediaAdd:function(){t({variables:{objects:[l]}}),n.close()}}),submit:!1,title:s?"Compliance report":"Upload report"})},t7=(t4=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(t2,{job:e,refetch:t,status:"complianceApproved",toggleShow:n.show}),title:"Approve report"}),[2]})}),function(e,n,t){return t4.apply(this,arguments)}),t8=(t3=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(t2,{job:e,refetch:t,status:"complianceRejected",toggleShow:n.show}),title:"Reject report"}),[2]})}),function(e,n,t){return t3.apply(this,arguments)}),t9=function(e){var n=e.deleteJobTiming,t=e.job,i=e.userId;n({variables:{id:t.id,status:"complianceRequestedDocumentation",userId:i}})},ie=(t6=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(t2,{job:e,refetch:t,status:"complianceRequestedDocumentation",toggleShow:n.show}),title:"Request Documentation"}),[2]})}),function(e,n,t){return t6.apply(this,arguments)}),it=t(36641),ii=t(85113);function ir(){var e=(0,m.Z)(["\n  mutation ValidateJob($jobId: Int!, $invoiceIds: [Int], $notes: String) {\n    validateJob(jobId: $jobId, invoiceIds: $invoiceIds, notes: $notes) {\n      success\n      data\n    }\n  }\n"]);return ir=function(){return e},e}function io(){var e=(0,m.Z)(['\n  query GetInvoicesByJobId($jobId: Int!, $invoiceTypes: [String!]!) {\n    invoices: Invoice(\n      where: {\n        invoiceType: { _in: $invoiceTypes }\n        entityId: { _eq: $jobId }\n        entity: { _eq: "Job" }\n      }\n    ) {\n      id\n      invoiceNumber\n      invoiceType\n    }\n  }\n']);return io=function(){return e},e}function ia(){var e=(0,m.Z)(['\n  mutation UpdateJob($id: Int!, $timing: [JobTiming_insert_input!]!) {\n    delete_JobTiming(where: { jobId: { _eq: $id }, status: { _eq: "validated" } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']);return ia=function(){return e},e}var is=(0,f.Ps)(ir()),iu=(0,f.Ps)(io()),il=(0,f.Ps)(ia()),ic=t(41255),id=t(48580),ip=t(98552),im=function(e){e.addJobTiming;var n=e.deleteJobTiming,t=e.job,i=e.refetch,s=e.status,u=e.toggleShow,l=(0,a.useRouter)().query,d=(0,e2.x)().user,p=(0,nk.D)(),m=(0,ic.RM)(null==d?void 0:d.id),f=(0,W.E)(t,"unvalidated"),v=(0,ic.BR)({adminId:d.id,xeroClientId:null==l?void 0:l.clientId,onSaveXeroTokenCallback:function(){return i&&i()}},[d]),h=v.tokenStatus,b=v.onCallAuthorize,x=v.onUpdateInvoiceInXero,g=(0,ei.cI)({defaultValues:{notes:"",invoice:[]}}),j=g.errors,y=g.control,Z=g.handleSubmit;(0,o.useEffect)(function(){t.invoices.some(function(e){var n;return null===(n=e.accountEntry.meta)||void 0===n?void 0:n.xeroInvoiceId})&&!l.clientId&&m&&"unauthenticated"===h&&b(window.location.href)},[m,h]);var I,S=(0,c.aM)(iu,{variables:{jobId:t.id,invoiceTypes:["customerVat","ProformaInvoiceCustomer"]}}).data,w=(void 0===S?{invoices:[]}:S).invoices,C=(0,_.Z)((0,P.D)(is,{refetchQueries:function(){return["getInvoices"]},onError:function(e){p.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(0,q.Z)(function(){var e,n,r,o,a,s,l,c;return(0,T.__generator)(this,function(d){switch(d.label){case 0:p.show({content:"Job was successfully validated.",severity:"success"}),e=!0,n=!1,r=void 0,d.label=1;case 1:d.trys.push([1,6,7,8]),o=t.invoices[Symbol.iterator](),d.label=2;case 2:if(e=(a=o.next()).done)return[3,5];if(s=a.value,!(m&&"authorized"===h&&(null===(l=s.accountEntry.meta)||void 0===l?void 0:l.xeroInvoiceId)))return[3,4];return[4,x({accountEntryId:s.accountEntry.id,invoiceType:s.invoiceType})];case 3:d.sent(),d.label=4;case 4:return e=!0,[3,2];case 5:return[3,8];case 6:return c=d.sent(),n=!0,r=c,[3,8];case 7:try{e||null==o.return||o.return()}finally{if(n)throw r}return[7];case 8:return i&&i(),u(),[2]}})})}),2),R=C[0],A=C[1].loading,E=(0,_.Z)((0,P.D)(il,{refetchQueries:function(){return["getInvoices"]},onError:function(e){p.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){p.show({content:"Job was successfully un-validated.",severity:"success"}),i&&i(),u()}}),2),D=E[0],k=E[1].loading,$=(I=(0,q.Z)(function(e){var i,r,o,a;return(0,T.__generator)(this,function(r){return"validated"===s?R({variables:{jobId:t.id,invoiceIds:(null===(i=e.invoice)||void 0===i?void 0:i.map(function(e){return e.value}))||[],notes:e.notes}}):"unvalidated"===s&&(n({variables:{id:t.id,status:"waitingForThresholdApproval",userId:d.id}}),n({variables:{id:t.id,status:"thresholdRejected",userId:d.id}}),n({variables:{id:t.id,status:"thresholdApproved",userId:d.id}}),D({variables:{id:t.id,timing:{notes:e.notes,status:s,jobId:t.id,userId:d.id}}})),[2]})}),function(e){return I.apply(this,arguments)});if(A||k)return(0,r.jsx)(M.Z,{alignItems:"center",children:(0,r.jsx)(nP.Z,{color:"secondary"})});var O=w.map(function(e){return{value:e.id,label:"".concat(e.invoiceNumber," ").concat(ip.Tq[e.invoiceType])}}),N="validated"===s?"Leave comments below, if appropriate, to provide context for other users.":"Please leave comments below to provide relevant context for other users.";return(0,r.jsx)("form",{id:"offCanvasForm",onSubmit:Z($),children:(0,r.jsxs)(M.Z,{spacing:2,children:["validated"===s&&(0,r.jsx)(nE.Z,{severity:"warning",color:"info",children:f?"Please choose the invoices from the below\n    for which you would like to update the information.":"Once validated, you will not be able to amend financial information within the job.\n    Invoices already generated cannot be changed."}),"unvalidated"===s&&(0,r.jsx)(nE.Z,{children:"This enables you to update financial information within the job. However, please note that any previously generated invoices will remain unchanged."}),"validated"===s&&f&&(0,r.jsx)(ei.Qr,{name:"invoice",control:y,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(id.q,{multiple:!0,value:n,onChange:function(e,n){t(n)},options:O,textFieldProps:{fullWidth:!0,color:"secondary",variant:"filled",label:"Select invoices",error:j.invoice,helperText:j.invoice&&j.invoice.message}})}}),(0,r.jsx)(ei.Qr,{name:"notes",control:y,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(ne.Z,{multiline:!0,fullWidth:!0,rows:4,color:"secondary",variant:"filled",label:"Notes",value:n,onChange:t,error:j.notes,helperText:N})}})]})})};function iv(){var e=(0,m.Z)(["\n  mutation InsertJobTiming($timing: [JobTiming_insert_input!]!) {\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n"]);return iv=function(){return e},e}function ih(){var e=(0,m.Z)(["\n  query GetInvoicePointer($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n      meta\n    }\n  }\n"]);return ih=function(){return e},e}function ib(){var e=(0,m.Z)(["\n  mutation createCustomerInvoice(\n    $jobId: Int!\n    $customerEmail: String\n    $sendEmail: String\n    $dueDate: timestamptz!\n  ) {\n    createCustomerInvoice(\n      jobId: $jobId\n      customerEmail: $customerEmail\n      sendEmail: $sendEmail\n      dueDate: $dueDate\n    ) {\n      data\n    }\n  }\n"]);return ib=function(){return e},e}function ix(){var e=(0,m.Z)(["\n  mutation createSupplierInvoice(\n    $jobId: Int!\n    $supplierEmail: String\n    $sendEmail: String\n    $dueDate: timestamptz!\n  ) {\n    createSupplierInvoice(\n      jobId: $jobId\n      supplierEmail: $supplierEmail\n      sendEmail: $sendEmail\n      dueDate: $dueDate\n    ) {\n      data\n    }\n  }\n"]);return ix=function(){return e},e}im.propTypes={addJobTiming:A.func.isRequired,deleteJobTiming:A.func.isRequired,job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var ig=(0,f.Ps)(iv());(0,f.Ps)(ih());var ij=(0,f.Ps)(ib()),iy=(0,f.Ps)(ix()),iZ=t(73359),iI=t(16551),iS=t(86021),iw=t(25771),iC=t(56063);function iR(){var e=(0,m.Z)(["\n  align-self: center;\n"]);return iR=function(){return e},e}var iq=function(e){var n,t,o,a,s,u,l=e.defaultOptions,c=e.job,d=e.showSubmit,p=e.watch,m=(0,D.x)(),f=p("sendEmail"),v=p("revisions"),h=(0,_.Z)((0,iZ.t)(iw.By,{onCompleted:function(e){var n,t=e.invoices,i=null==t?void 0:t[0];ip.YK.includes(null==i?void 0:i.invoiceType)?(0,iC.$)(null==i?void 0:null===(n=i.accountEntry)||void 0===n?void 0:n.meta):(0,iS._Z)({client:m,jobId:c.id,type:"customerVat",preview:d})}}),1)[0],b=(u=(0,q.Z)(function(){return(0,T.__generator)(this,function(e){return"reactive"===c.type?h({variables:{jobId:c.id,invoiceType:"customerVat"}}):h({variables:{jobId:c.id,invoiceType:"customerPpmInvoice"}}),[2]})}),function(){return u.apply(this,arguments)});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(i_,{md:10,children:(0,r.jsx)(ej.Z,{children:d?"Preview PDF":"Download PDF"})})}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(iI.Z,{align:"flex-start",children:(0,r.jsx)(eg.Z,{content:"reactive"===c.type?"Customer VAT":"Customer PPM",context:v&&"-1"!==v?"warning":"secondary",onClick:b,size:"sm"})}),d&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tV.Z,{}),(0,r.jsx)(e7.Z,{content:"Customer",text:null===(n=c.customer)||void 0===n?void 0:n.name}),(0,r.jsx)(e7.Z,{content:"Customer Contact",text:null===(t=c.customerUser)||void 0===t?void 0:t.fullName}),(0,r.jsx)(e7.Z,{content:"Phone",text:null===(o=c.customerUser)||void 0===o?void 0:o.phone}),(0,r.jsx)(e7.Z,{content:"Email",text:null===(a=c.customerUser)||void 0===a?void 0:a.email}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eb.Z,{label:"Due date",children:(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},l),{name:"dueDate",placeholder:"Due date"}))}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},l),{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===f&&(0,r.jsx)(eb.Z,{label:"Send to email address",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},l),{defaultValue:null===(s=c.customerUser)||void 0===s?void 0:s.email,name:"customerEmail"}))})]})]})};iq.propTypes={defaultOptions:A.object.isRequired,job:A.object.isRequired,showSubmit:A.bool};var i_=(0,eU.ZP)(eO.Z).withConfig({displayName:"customer__StyledColumn",componentId:"sc-31df35a5-0"})(iR());function iT(){var e=(0,m.Z)(["\n  align-self: center;\n"]);return iT=function(){return e},e}var iA=function(e){var n,t,o,a,s=e.defaultOptions,u=e.job,l=e.showSubmit,c=e.watch,d=(0,D.x)(),p=(null===(t=null==u?void 0:null===(n=u.supplier)||void 0===n?void 0:n.contactUsers[0])||void 0===t?void 0:t.user)||null,m=c("sendEmail"),f=c("revisions"),v=(0,_.Z)((0,iZ.t)(iw.By,{onCompleted:function(e){var n,t=e.invoices,i=null==t?void 0:t[0];ip.YK.includes(null==i?void 0:i.invoiceType)?(0,iC.$)(null==i?void 0:null===(n=i.accountEntry)||void 0===n?void 0:n.meta):(0,iS._Z)({client:d,jobId:u.id,type:"supplier",preview:l})}}),1)[0],h=(a=(0,q.Z)(function(){return(0,T.__generator)(this,function(e){return"reactive"===u.type?v({variables:{jobId:u.id,invoiceType:"supplier"}}):v({variables:{jobId:u.id,invoiceType:"supplierPpmInvoice"}}),[2]})}),function(){return a.apply(this,arguments)});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(iE,{md:10,children:(0,r.jsx)(ej.Z,{children:l?"Preview PDF":"Download PDF"})})}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eg.Z,{content:"Supplier",context:f&&"-1"!==f?"warning":"secondary",onClick:h,size:"md"}),l&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tV.Z,{}),(0,r.jsx)(e7.Z,{content:"Supplier",text:null===(o=u.supplier)||void 0===o?void 0:o.name}),p&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e7.Z,{content:"Supplier Contact",text:p.fullName}),(0,r.jsx)(e7.Z,{content:"Phone",text:p.phone}),(0,r.jsx)(e7.Z,{content:"Email",text:p.email})]}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eb.Z,{label:"Due date",children:(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},s),{name:"dueDate",placeholder:"Due date"}))}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},s),{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===m&&(0,r.jsx)(eb.Z,{label:"Send to email address",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},s),{defaultValue:p.email,name:"supplierEmail"}))})]})]})};iA.propTypes={defaultOptions:A.object.isRequired,job:A.object.isRequired,showSubmit:A.bool};var iE=(0,eU.ZP)(eO.Z).withConfig({displayName:"supplier__StyledColumn",componentId:"sc-9b407a40-0"})(iT()),iD=(0,eu.Ry)().shape({sendEmail:(0,eu.Z_)().required(),dueDate:(0,eu.Z_)().required()}),iP=t(40234),ik=function(e){var n,t=e.job,i=e.refetch,a=e.showSubmit,s=e.toggleShow,l=e.type,c=(0,o.useContext)(u.Z).user,d=(0,D.x)(),p=(0,nk.D)(),m=(0,ei.cI)({resolver:(0,er.S)(iD),defaultValues:{dueDate:(0,iP.I)({job:t,type:l,invoiceDate:new Date})}}),f=m.errors,v=m.handleSubmit,h=m.register,b=m.control,x=m.watch,g=x("sendEmail"),j=x("customerEmail"),y=x("supplierEmail"),Z=(0,_.Z)((0,P.D)(ig,{onError:function(e){p.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){i&&i(),s()}}),1)[0],I=(0,_.Z)((0,P.D)(ij,{refetchQueries:function(){return["getInvoices"]},onError:function(e){p.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(0,q.Z)(function(){var e;return(0,T.__generator)(this,function(n){switch(n.label){case 0:if("sendEmail"!==g)return[3,3];return[4,(0,iS._Z)({client:d,jobId:t.id,type:"customerVat",getUrl:!0})];case 1:return e=n.sent(),[4,Z({variables:{timing:{status:"invoicePDFSent",jobId:t.id,userId:c.id,meta:{toEmail:j,fileUrl:e}}}})];case 2:return n.sent(),[3,4];case 3:i&&i(),s(),n.label=4;case 4:return[2]}})})}),2),S=I[0],w=I[1].loading,C=(0,_.Z)((0,P.D)(iy,{refetchQueries:function(){return["getInvoices"]},onError:function(e){p.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(0,q.Z)(function(){var e;return(0,T.__generator)(this,function(n){switch(n.label){case 0:if("sendEmail"!==g)return[3,3];return[4,(0,iS._Z)({client:d,jobId:t.id,type:"supplier",getUrl:!0})];case 1:return e=n.sent(),[4,Z({variables:{timing:{status:"invoicePDFSentSupplier",jobId:t.id,userId:c.id,meta:{toEmail:y,fileUrl:e}}}})];case 2:return n.sent(),[3,4];case 3:i&&i(),s(),n.label=4;case 4:return[2]}})})}),2),R=C[0],A=C[1].loading,E=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){switch(n.label){case 0:if("customer"!==l)return[3,2];return[4,S({variables:{jobId:t.id,customerEmail:e.customerEmail,sendEmail:e.sendEmail,dueDate:new Date(e.dueDate)}})];case 1:return n.sent(),[3,4];case 2:if("supplier"!==l)return[3,4];return[4,R({variables:{jobId:t.id,supplierEmail:e.supplierEmail,sendEmail:e.sendEmail,dueDate:new Date(e.dueDate)}})];case 3:n.sent(),n.label=4;case 4:return[2]}})}),function(e){return n.apply(this,arguments)}),k={errors:f,register:h,control:b};return w||A?(0,r.jsx)(M.Z,{alignItems:"center",children:(0,r.jsx)(nP.Z,{color:"secondary"})}):(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:v(E),children:["customer"===l?(0,r.jsx)(iq,{defaultOptions:k,job:t,showSubmit:a,watch:x}):(0,r.jsx)(iA,{defaultOptions:k,job:t,showSubmit:a,watch:x}),a&&(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};ik.defaultProps={refetch:function(){},toggleShow:function(){}},ik.propTypes={job:E().object,refetch:E().func,showSubmit:E().bool,toggleShow:E().func,type:E().oneOf(["supplier","customer"]).isRequired};var i$,iO=function(e,n,t,i,o){i.show({content:(0,r.jsx)(im,{job:e,addJobTiming:n,deleteJobTiming:t,refetch:o,status:"validated",toggleShow:i.close}),title:"Validate job"})},iN=function(e,n,t,i,o){i.show({content:(0,r.jsx)(im,{addJobTiming:n,deleteJobTiming:t,job:e,refetch:o,status:"unvalidated",toggleShow:i.show}),title:"Unvalidate job"})},iH=function(e,n,t,i,o,a){t.show({content:(0,r.jsx)(ik,{job:n,refetch:i,showSubmit:o,toggleShow:t.close,type:e}),submit:!1,title:o?"Send ".concat(e," invoice"):"Download ".concat(e," invoice")})},iF=function(e,n,t){var i=(0,ii.Hv)(e,"customer"),o=function(e){e&&t()};n.show({content:(0,r.jsx)(it.H,{entity:"Location",entityId:e.location.id,id:i.id,onSubmit:o,addressId:i.address.id,type:"invoice"}),submit:!1,title:"Manage addresses"})},iM=function(e){var n,t=e.job,a=e.refetch,s=e.toggleShow,c=(0,o.useContext)(u.Z).user,d=(0,ei.cI)({defaultValues:{comments:""}}),m=d.errors,f=d.handleSubmit,h=d.register,b=(0,_.Z)((0,P.D)(p.Tw,{onCompleted:function(){a&&a()}}),1)[0],x=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){a&&a(),s()}}),1)[0],g=(n=(0,q.Z)(function(e){var n,r,o,a,s,u,d,p,m,f,v,h,g,j,y,Z,I,S,w,C,R,q,_,A;return(0,T.__generator)(this,function(T){switch(T.label){case 0:return n={value:0,jobId:t.id,difference:0,system:!0,meta:{username:"".concat(c.nameFirst," ").concat(c.nameLast),userId:c.id,notes:e.comments}},r=(0,i.Z)({type:"discount"},n),o=(0,i.Z)({type:"customerDeposit"},n),a=(0,i.Z)({type:"supplierDeposit"},n),s=(0,i.Z)({type:"supplierDeduction"},n),u=(0,i.Z)({type:"amount"},n),d=(0,i.Z)({type:"supplierMaterialsAmount"},n),p=(0,i.Z)({type:"supplierLabourAmount"},n),m=(0,i.Z)({type:"additions"},n),f=(0,i.Z)({type:"deductions"},n),v=(0,i.Z)({type:"firstHourRateCustomerNormal"},n),h=(0,i.Z)({type:"subsequentHoursRateCustomerNormal"},n),g=(0,i.Z)({type:"firstHourRateCustomerOOH"},n),j=(0,i.Z)({type:"subsequentHoursRateCustomerOOH"},n),y=(0,i.Z)({type:"firstHourRateCustomerPremium"},n),Z=(0,i.Z)({type:"subsequentHoursRateCustomerPremium"},n),I=(0,i.Z)({type:"firstHourRateSupplierNormal"},n),S=(0,i.Z)({type:"subsequentHoursRateSupplierNormal"},n),w=(0,i.Z)({type:"firstHourRateSupplierOOH"},n),C=(0,i.Z)({type:"subsequentHoursRateSupplierOOH"},n),R=(0,i.Z)({type:"firstHourRateSupplierPremium"},n),q=(0,i.Z)({type:"subsequentHoursRateSupplierPremium"},n),_=[r,a,s,o],A="fixed"===t.pricing?[u,d,p]:[m,f,v,h,g,j,y,Z,I,S,w,C,R,q],[4,b({variables:{objects:(0,l.Z)(_).concat((0,l.Z)(A))}}).then(function(n){x({variables:{id:t.id,changes:{status:"closed"},_append:{statusData:{closed:new Date().toISOString()}},timing:{notes:e.comments,status:"closed",jobId:t.id,userId:c.id}}})})];case 1:return T.sent(),[2]}})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:f(g),children:[(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:m,name:"comments",register:h,rows:3})}),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};iM.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var iL,iJ=(i$=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(iM,{job:e,toggleShow:n.show,refetch:t}),submit:!1,title:"Close and zero value job"}),[2]})}),function(e,n,t){return i$.apply(this,arguments)}),iU=function(e){var n,t,a=e.accountId,c=e.job,d=e.offCanvas,p=e.refetch,m=e.cancelMod,f=(0,o.useContext)(u.Z).user,v=(0,D.x)(),h=a||"supplier"===f.accountType&&f.accountId,b=!!(null===(n=c.supplier)||void 0===n?void 0:n.id)||!!(0,W.E)(c,"quoteNew"),x=c.supplierOffers.filter(function(e){return"cancelled"!==e.status}),g=null;x.forEach(function(e){e.account.id===h&&(g=e)});var j,y=(0,_.Z)((0,P.D)(tJ,{onCompleted:(t=(0,q.Z)(function(e){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!c)return[3,2];return[4,(0,e_.F)(v,c.id)];case 1:e.sent(),e.label=2;case 2:return d.close(),"supplier"===f.accountType?s().push("/dashboard"):p&&p(),[2]}})}),function(e){return t.apply(this,arguments)})}),1)[0],Z=(j=(0,q.Z)(function(e){var n,t,i,r,o,a;return(0,T.__generator)(this,function(s){return n=[],t=null,i=null,r=!0,o="rejected",(null==x?void 0:x.length)>1&&(r=!1),a={createdAt:(0,tY.v)(),notes:e.rejectedNotes,status:"cancelled",userId:f.id},(null==g?void 0:g.statusLog)?(t=(0,l.Z)(g.statusLog)).push(a):t=[a],b&&(i={scheduledAt:null,status:o,supplierId:null,supplierUserId:null},n.push({status:o,jobId:c.id,userId:f.id,notes:e.rejectedNotes})),y({variables:{noAnotherOffers:r,assignedReject:b,changes:{status:"cancelled",notes:e.rejectedNotes,statusLog:t},id:g.id,jobChanges:i,jobId:c.id,timing:n,cancelMod:m}}),[2]})}),function(e){return j.apply(this,arguments)}),I=(0,ei.cI)({defaultValues:{rejectedNotes:null==g?void 0:g.notes},resolver:(0,er.S)(tz)}),S=I.control,w=I.errors,C=I.handleSubmit,R=I.register;return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:C(Z),children:(0,r.jsx)(eb.Z,{label:"Notes",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},{control:S,errors:w,register:R}),{name:"rejectedNotes",rows:3}))})})};iU.propTypes={accountId:A.number,cancelMod:A.bool,job:A.object.isRequired,offCanvas:A.object.isRequired,refetch:A.func},iU.defaultProps={cancelMod:!1};var iV,iQ=(iL=(0,q.Z)(function(e){var n,t,i,o;return(0,T.__generator)(this,function(a){return n=e.job,t=e.offCanvas,i=e.refetch,o=e.accountId,t.show({content:(0,r.jsx)(tB,{accountId:o||null,job:n,offCanvas:t,refetch:i}),submit:!1,title:"Accept Job"}),[2]})}),function(e){return iL.apply(this,arguments)}),iz=(iV=(0,q.Z)(function(e){var n,t,i,o;return(0,T.__generator)(this,function(a){return n=e.job,t=e.offCanvas,i=e.refetch,o=e.accountId,t.show({content:(0,r.jsx)(iU,{accountId:o||null,job:n,offCanvas:t,refetch:i}),title:"Reject Job"}),[2]})}),function(e){return iV.apply(this,arguments)});function iY(){var e=(0,m.Z)(["\n  mutation UpdateJob($id: Int!, $update: Job_set_input!) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $update) {\n      id\n    }\n  }\n"]);return iY=function(){return e},e}function iB(){var e=(0,m.Z)(['\n  mutation UPSERT_JOB_REPORT_WITH_MEDIA(\n    $objects: [JobReport_insert_input!]!\n    $jobReportId: Int\n    $isNewCustomerSignature: Boolean!\n    $isNewSupplierSignature: Boolean!\n  ) {\n    deleteCustomerSignature: delete_Media(\n      where: {\n        category: { _eq: "customerSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n    ) @skip(if: $isNewCustomerSignature) {\n      returning {\n        id\n      }\n    }\n    deleteSupplierSignature: delete_Media(\n      where: {\n        category: { _eq: "supplierSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n    ) @skip(if: $isNewSupplierSignature) {\n      returning {\n        name\n        id\n      }\n    }\n    insert_JobReport(\n      objects: $objects\n      on_conflict: {\n        constraint: uc_JobReport_jobId\n        update_columns: [completion, meta, notes, timing, passFailStatus, recommendations]\n      }\n    ) {\n      returning {\n        id\n        completion\n        meta\n        notes\n        timing\n        createdAt\n        updatedAt\n      }\n    }\n  }\n']);return iB=function(){return e},e}var iW=(0,f.Ps)(iY()),iG=(0,f.Ps)(iB()),iK=t(56815),iX=t(46169),i0=t(44634),i1=(0,eu.Ry)({id:(0,eu.Rx)(),completion:(0,eu.Z_)().when("completed",{is:"true",then:(0,eu.Z_)().oneOf(i0.M2.map(function(e){return e.value})).required()}),notes:(0,eu.Z_)().min(50,"Insufficient information added.\n    Please enter a minimum of 50 characters in the description before submitting your report."),timing:(0,eu.Z_)().when("completed",{is:"true",then:(0,eu.Z_)().oneOf(["correct","incorrect"]).required()}),completionNotes:(0,eu.Z_)(),houseKeepingExpenses:(0,eu.nK)(),houseKeepingPhotos:(0,eu.nK)(),correctStart:(0,eu.hT)().max(new Date),correctEnd:(0,eu.hT)().when("correctStart",function(e,n){return e?n.min(e).max(new Date):n.max(new Date)}),correctDuration:(0,eu.Rx)().min(1).when(["correctStart","correctEnd"],function(e,n,t){var i=K()(n).diff(e,"minutes");return t.max(i)}),recommendations:(0,eu.Z_)().when(["passFailStatus","$requireRecommendations"],function(e,n,t){return"Failed"===e&&n?t.min(50,"Please enter a minimum of 50 characters in the\n          recommendations before submitting your report."):t.min(0)})}),i2=t(10166),i4=t(64666),i3=t(6514),i6=t(74721),i5=t(40656),i7=function(e){var n=e.status,t=e.open,i=e.onClose,o=e.onConfirm;return(0,r.jsx)(i8,{open:t,onClose:i,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:(0,r.jsxs)(i3.Z,{sx:{fontFamily:i5.Q.THEME_TYPOGRAPHY.newFont,padding:"32px 44px"},children:[(0,r.jsxs)(M.Z,{width:"100%",alignItems:"center",spacing:1,mb:"24px",children:[(0,r.jsx)(i6.Z,{sx:{color:i5.Q.COLOUR.warning}}),(0,r.jsx)(re,{variant:"h6",children:"Please ensure that the job's Pass/Fail status below is correct."}),(0,r.jsx)(re,{variant:"h6",color:"Passed"===n?"green":"red",children:n})]}),(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"center",spacing:2,children:[(0,r.jsx)(i9,{variant:"outlined",onClick:i,children:"Cancel"}),(0,r.jsx)(i9,{type:"submit",form:"offCanvasForm",variant:"contained",onClick:o,children:"Confirm"})]})]})})};i7.propTypes={status:E().oneOf(["Failed","Passed"]),open:E().bool,onClose:E().func,onConfirm:E().func},i7.defaultProps={onClose:function(){},onConfirm:function(){}};var i8=(0,i2.Z)(i4.Z)(function(){return{"&.MuiDialog-root.MuiModal-root":{zIndex:1e4},"& .MuiPaper-root":{width:"400px"}}}),i9=(0,i2.Z)(H.Z)(function(){return{fontFamily:"inherit"}}),re=(0,i2.Z)(L.Z)(function(){return{fontFamily:"inherit",fontWeight:600,textAlign:"center"}}),rn=t(37645),rt=t(61730);function ri(){var e=(0,m.Z)(['\n  query GET_SIGNATURES_TAXONOMY($signatureType: jsonb) {\n    Taxonomy(\n      where: {\n        type: { _eq: "signatures" }\n        status: { _eq: "active" }\n        meta: { _contains: $signatureType }\n      }\n    ) {\n      id\n      name\n      status\n      meta\n    }\n  }\n']);return ri=function(){return e},e}function rr(){var e=(0,m.Z)(['\n  query GET_SIGNATURES_MEDIA($jobReportId: Int) {\n    customerSignatureMedia: Media(\n      where: {\n        category: { _eq: "customerSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n      order_by: { createdAt: desc }\n      limit: 1\n    ) {\n      filename\n      id\n      category\n    }\n    supplierSignatureMedia: Media(\n      where: {\n        category: { _eq: "supplierSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n      order_by: { createdAt: desc }\n      limit: 1\n    ) {\n      filename\n      id\n      category\n    }\n    JobReport(where: { id: { _eq: $jobReportId } }) {\n      meta\n    }\n  }\n']);return rr=function(){return e},e}var ro=(0,f.Ps)(ri()),ra=(0,f.Ps)(rr()),rs=t(78232),ru=t(93362);function rl(){var e;return{width:window.innerWidth,height:window.innerHeight}}var rc=(0,ru.D)(),rd={customer:{customerSignature:!0},supplier:{supplierSignature:!0}},rp=function(e){var n,t,i,a=e.label,s=e.title,u=e.signatureState,l=e.setSignatureState,d=e.signatureType,p=e.signatureError,m=(t=(n=(0,o.useState)(rl()))[0],i=n[1],(0,o.useEffect)(function(){var e=function(){i(rl())};return window.addEventListener("resize",e),function(){return window.removeEventListener("resize",e)}},[]),t).width,f=(0,rt.Z)("(max-width: 600px)"),v=(0,_.Z)(o.useState(!1),2),h=v[0],b=v[1],x=(0,o.useState)([{label:"Select...",value:null}]),g=x[0],j=x[1],y=(0,o.useState)(!1),Z=y[0],I=y[1],S=(0,o.useState)((null==u?void 0:u.signer)||""),w=S[0],C=S[1],R=(0,o.useState)(!1),q=R[0],T=R[1],A=(0,o.useState)(!0),E=A[0],D=A[1],P=(0,o.useRef)(null),k=(0,c.aM)(ro,{variables:{signatureType:rd[d]},onCompleted:function(e){j(e.Taxonomy.map(function(e){return{label:e.name,value:e.name}}))}}).loading,$=function(){b(!1)},O=function(e){D(!1);var n=P.current,t=n.getContext("2d"),i=e.nativeEvent.changedTouches[0],r=i.clientX,o=i.clientY,a=n.getBoundingClientRect();t.beginPath(),t.moveTo(r-a.left,o-a.top),I(!0)},F=function(e){D(!1);var n=P.current.getContext("2d"),t=e.nativeEvent,i=t.offsetX,r=t.offsetY;n.beginPath(),n.moveTo(i,r),I(!0)},J=function(e){if(Z){var n=P.current.getContext("2d"),t=e.nativeEvent,i=t.offsetX,r=t.offsetY;n.lineTo(i,r),n.stroke()}},U=function(e){if(Z){var n=P.current,t=n.getContext("2d"),i=e.nativeEvent.changedTouches[0],r=i.clientX,o=i.clientY,a=n.getBoundingClientRect();t.lineTo(r-a.left,o-a.top),t.stroke()}},V=function(){I(!1)},Q=function(e){if(!w){T(!0);return}var n={signature:P.current.toDataURL("image/png"),signer:w.label,timestamp:K()().toISOString(),isBase64:!0,isBlank:E};l(function(){return n}),T(!1),b(!1)},z=function(){b(!1)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(M.Z,{direction:"row",spacing:2,alignItems:"center",children:[(0,r.jsx)(H.Z,{variant:"outlined",color:p?"error":"secondary",sx:{width:"40px",height:"40px",borderRadius:"20px",minWidth:0},onClick:function(){b(!0)},children:"+"}),(0,r.jsx)(L.Z,{sx:{color:"rgb(0,55,83)"},children:a}),(0,r.jsxs)(rm,{fullScreen:f,open:h,onClose:$,sx:{zIndex:1500},children:[(0,r.jsx)(rn.Z,{children:s}),(0,r.jsxs)(M.Z,{direction:"column",sx:{padding:2},spacing:2,children:[(0,r.jsx)("canvas",{ref:P,width:f?m:600,height:200,style:{border:"1px solid #000",padding:"10px"},onTouchStart:O,onTouchMove:U,onTouchEnd:V,onTouchCancel:V,onMouseDown:F,onMouseMove:J,onMouseUp:V,onMouseOut:V}),(0,r.jsxs)(M.Z,{direction:"row",spacing:2,sx:{height:"fit"},alignItems:"center",children:[(0,r.jsx)(L.Z,{children:"Name: "}),(0,r.jsx)(rs.F,{freeSolo:!0,error:q,sx:{width:"100%",zIndex:11e3},loading:k,placeholder:a,size:"medium",options:g,className:"responsive-fontSize",value:w,getOptionLabel:function(e){return"string"==typeof e?e:e.value?e.value:e.label},onChange:function(e,n){"string"==typeof n?C({label:n}):n&&n.value?C({label:n.value}):C(n)},filterOptions:function(e,n){var t=rc(e,n),i=n.inputValue,r=e.some(function(e){return i===e.title});return""===i||r||t.push({value:i,label:'Add "'.concat(i,'"')}),t}})]}),(0,r.jsxs)(M.Z,{direction:"row",spacing:3,justifyContent:"flex-end",children:[(0,r.jsx)(H.Z,{variant:"contained",color:"error",onClick:z,children:"Cancel"}),(0,r.jsx)(H.Z,{variant:"contained",color:"success",onClick:Q,children:"Submit"})]})]})]})]}),(null==u?void 0:u.signature)&&(0,r.jsxs)(M.Z,{direction:"column",children:[(0,r.jsx)(N.Z,{children:(0,r.jsx)("img",{src:null==u?void 0:u.signature,alt:"signature",width:400,height:200})}),(0,r.jsxs)(L.Z,{children:["Name: ",null==u?void 0:u.signer]}),(0,r.jsxs)(L.Z,{children:["Time: ",K()(null==u?void 0:u.timestamp).format("YYYY-MM-DD HH:mm")]})]})]})};rp.defaultProps={label:"",title:"Customer signature",signatureState:{signature:"",signer:"",timestamp:""},setSignatureState:function(){},signatureError:!1},rp.propTypes={label:E().string,title:E().string,signatureState:E().shape({signature:E().string,signer:E().string,timestamp:E().string}),setSignatureState:E().func,signatureType:E().oneOf(["customer","supplier"]),signatureError:E().bool};var rm=(0,i2.Z)(i4.Z)(function(){return{"&.MuiDialog-root.MuiModal-root":{zIndex:1e4},"& .MuiPaper-root":{width:"100%",maxWidth:"600px"}}}),rf=t(56671),rv=function(e){for(var n=atob(e.split(",")[1]),t=Array(n.length),i=0;i<n.length;i++)t[i]=n.charCodeAt(i);var r=new Uint8Array(t),o=new Blob([r],{type:"image/png"});return new File([o],"canvasImage.png",{type:"image/png"})};function rh(){var e=(0,m.Z)(["\n  margin-top: -0.75rem;\n  display: block;\n"]);return rh=function(){return e},e}var rb=function(e){var n,t,a,s,l,d,p,m,f,v,h,b,x,g,j,y,Z,I,S,w=e.job,C=e.offCanvas,R=e.refetch,A=(0,D.x)(),E=(0,e2.x)().user,k={id:null===(n=w.report)||void 0===n?void 0:n.id,completion:null===(t=w.report)||void 0===t?void 0:t.completion,notes:(null===(a=w.report)||void 0===a?void 0:a.notes)||"",timing:w.timingStatus,completionNotes:(null===(s=w.report)||void 0===s?void 0:null===(l=s.meta)||void 0===l?void 0:l.completionNotes)||"",houseKeepingExpenses:null===(d=w.report)||void 0===d?void 0:null===(p=d.meta)||void 0===p?void 0:p.houseKeepingExpenses,houseKeepingPhotos:null===(m=w.report)||void 0===m?void 0:null===(f=m.meta)||void 0===f?void 0:f.houseKeepingPhotos,correctDuration:w.correctDuration,correctStart:w.correctStart?new Date(w.correctStart):"",correctEnd:w.correctEnd?new Date(w.correctEnd):"",passFailStatus:(null===(v=w.report)||void 0===v?void 0:v.passFailStatus)||"Passed",recommendations:(null===(h=w.report)||void 0===h?void 0:h.recommendations)||""},$=(0,ei.cI)({defaultValues:k,resolver:(0,er.S)(i1),context:{completed:(0,W.E)(w,"completed"),requireRecommendations:w.requireReportRecommendations}}),O=$.errors,N=$.handleSubmit,H=$.register,F=$.watch,J=$.control,U=$.setValue,V=(0,o.useState)(!1),Q=V[0],z=V[1],Y=(0,o.useState)(!1),B=Y[0],G=Y[1],ee=(0,o.useState)(!1),en=ee[0],eo=ee[1],ea=(0,o.useState)(!1),es=ea[0],eu=ea[1],el=(0,o.useState)(!1),ec=el[0],ed=el[1],ep=F("notes"),em=F("timing"),ef=F("completion"),ej=F("correctStart"),ey=F("correctEnd"),eZ=F("recommendations"),eI=F("passFailStatus"),eS=(0,o.useState)({signature:"",signer:"",timestamp:"",isBase64:!1,isBlank:!0}),ew=eS[0],eC=eS[1],eR=(0,o.useState)({signature:"",signer:"",timestamp:"",isBase64:!1,isBlank:!0}),eT=eR[0],eA=eR[1];(0,o.useEffect)(function(){return!w.reportPassFail||k.id?eo(!0):eo(!1)},[]),(0,o.useEffect)(function(){var e,n;(null===(e=w.report)||void 0===e?void 0:e.passFailStatus)&&((null===(n=w.report)||void 0===n?void 0:n.passFailStatus)!==eI?eo(!1):eo(!0))},[eI]),(0,o.useEffect)(function(){var e;ew.signature&&(null==w?void 0:null===(e=w.meta)||void 0===e?void 0:e.customerSignature)&&eu(!1)},[ew]),(0,o.useEffect)(function(){var e;eT.signature&&(null==w?void 0:null===(e=w.meta)||void 0===e?void 0:e.supplierSignature)&&ed(!1)},[eT]);var eE,eP=tt({autoStart:!1,startTime:(0,W.E)(w,"inProgress"),endTime:(0,W.E)(w,"completed")}).time,ek=eP.seconds,eO=eP.minutes,eN=eP.hours,eH=(0,_.Z)((0,P.D)(iW,{onCompleted:(eE=(0,q.Z)(function(e){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!w)return[3,2];return[4,(0,e_.F)(A,w.id)];case 1:e.sent(),e.label=2;case 2:return C.close(),R&&R(),[2]}})}),function(e){return eE.apply(this,arguments)})}),1)[0];(0,c.aM)(ra,{skip:!(null===(b=w.report)||void 0===b?void 0:b.id),variables:{jobReportId:null===(x=w.report)||void 0===x?void 0:x.id},onCompleted:function(e){if(e.customerSignatureMedia.length>0){var n={};n.signature="".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e.customerSignatureMedia[0].filename),n.signer=e.JobReport[0].meta.customerSignatureName,n.timestamp=e.JobReport[0].meta.customerSignatureTime,n.isBlank=!1,eC(n)}if(e.supplierSignatureMedia.length>0){var t={};t.signature="".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e.supplierSignatureMedia[0].filename),t.signer=e.JobReport[0].meta.supplierSignatureName,t.timestamp=e.JobReport[0].meta.supplierSignatureTime,t.isBlank=!1,eA(t)}}});var eF,eM=(0,_.Z)((0,P.D)(iG,{onCompleted:function(e){C.close(),R&&R()}}),1)[0],eL=(0,o.useContext)(u.Z).user,eJ=(eF=(0,q.Z)(function(e){var n,t,i,r,o,a,s,u,l,c,d;return(0,T.__generator)(this,function(o){switch(o.label){case 0:if(o.trys.push([0,,5,6]),eu(!1),ed(!1),!en)return[2,G(!0)];if(!ew.signature&&(null==w?void 0:null===(n=w.meta)||void 0===n?void 0:n.customerSignature)&&(0,W.E)(w,"completed"))return eu(!0),[2];if(!eT.signature&&(null==w?void 0:null===(t=w.meta)||void 0===t?void 0:t.supplierSignature)&&(0,W.E)(w,"completed"))return ed(!0),[2];if(z(!0),r=[],!ew.isBase64)return[3,2];return[4,(0,rf.V)(rv(ew.signature),"image")];case 1:a=o.sent().key,(s={entity:"JobReport"}).Medium={data:{adminId:E.adminId,category:"customerSignature",caption:"test",expiryAt:null,extension:null==a?void 0:a.split(".").pop(),userId:eL.id,filename:a,meta:{},type:"image"}},r.push(s),o.label=2;case 2:if(!eT.isBase64)return[3,4];return[4,(0,rf.V)(rv(eT.signature),"image")];case 3:l=o.sent().key,(c={entity:"JobReport"}).Medium={data:{adminId:E.adminId,category:"supplierSignature",caption:"test",expiryAt:null,extension:null==l?void 0:l.split(".").pop(),userId:eL.id,filename:l,meta:{},type:"image"}},r.push(c),o.label=4;case 4:return d={id:e.id,jobId:w.id,completion:e.completion,notes:e.notes,passFailStatus:e.passFailStatus,recommendations:e.recommendations,meta:{houseKeepingExpenses:e.houseKeepingExpenses,houseKeepingPhotos:e.houseKeepingPhotos,customerSignatureName:ew.signer,customerSignatureTime:ew.timestamp,customerSignatureIsBlank:ew.isBlank,supplierSignatureName:eT.signer,supplierSignatureTime:eT.timestamp,supplierSignatureIsBlank:eT.isBlank},Media_Entity:{data:r.length>0?r:[]}},e.completionNotes&&(d.meta.completionNotes=e.completionNotes),eM({variables:{jobReportId:null==w?void 0:null===(i=w.report)||void 0===i?void 0:i.id,objects:[d],isNewCustomerSignature:!ew.isBase64,isNewSupplierSignature:!eT.isBase64}}),(0,W.E)(w,"completed")&&eH({variables:{id:w.id,update:{timingStatus:e.timing,correctDuration:"incorrect"===e.timing?e.correctDuration:null,correctStart:"incorrect"===e.timing?e.correctStart:null,correctEnd:"incorrect"===e.timing?e.correctEnd:null}}}),[3,6];case 5:return z(!1),[7];case 6:return[2]}})}),function(e){return eF.apply(this,arguments)}),eU=(null==w?void 0:null===(g=w.media)||void 0===g?void 0:g.length)||0,eV={control:J,errors:O,register:H},eY=null;switch(ef){case"returnVisit":eY="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":eY="Please indicate the type of works and engineer required";break;case"couldNotDo":eY="Please advise why you were unable to do these works"}var eB,eW=function(e){e.target.checked?U("passFailStatus","Failed"):U("passFailStatus","Passed")},eG=function(){G(!1)},eK=function(){eo(!0),G(!1)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i7,{status:eI,open:B,onClose:eG,onConfirm:eK}),Q?(0,r.jsx)(nP.Z,{color:"inherit",size:20}):(0,r.jsxs)("form",{id:"offCanvasForm",onSubmit:N(eJ),children:[(0,r.jsxs)(eb.Z,{label:"Detailed description of works",children:[(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},eV),{name:"notes",rows:4})),(null==O?void 0:O.notes)&&(0,r.jsx)(iK.Z,{sx:{m:0},children:null==O?void 0:null===(j=O.notes)||void 0===j?void 0:j.message}),(0,r.jsxs)(L.Z,{children:[ep.length,"/50"]})]}),!(0,W.E)(w,"completed")&&(0,r.jsx)(e$.Z,{style:{margin:0,justifyContent:"flex-end"},children:(0,r.jsx)(eg.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})}),!(0,W.E)(w,"completed")&&(0,r.jsx)(M.Z,{spacing:1,children:(null==w?void 0:null===(y=w.meta)||void 0===y?void 0:y.customerSignature)&&(0,r.jsx)(rp,{label:"Add customer signature",title:"Add customer signature",name:"customerSignature",jobReport:w.report,onCancel:function(){},signatureState:ew,setSignatureState:eC,signatureType:"customer",signatureError:es})}),(0,W.E)(w,"completed")&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tU.Z,{}),(0,r.jsx)(eb.Z,{label:"Timing",children:(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},eV),{data:[{id:"correct",label:"I confirm that the job took ".concat(eN,":").concat(eO,":").concat(ek),value:"correct"},{id:"incorrect",label:"The timing is incorrect",value:"incorrect"}],name:"timing",stacked:!0}))}),"incorrect"===em&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eb.Z,{label:"Enter correct time of starting ",children:(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},eV),{errors:O,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select Start time",name:"correctStart",showTimeSelect:!0,todayButton:!1,maxDate:ey?new Date(ey):new Date,onChange:function(e){U("correctStart",e),U("correctDuration",K()(ey).diff(e,"minutes"))}}))}),(0,r.jsx)(eb.Z,{label:"Enter correct time of ending ",children:(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},eV),{errors:O,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select End time",name:"correctEnd",showTimeSelect:!0,todayButton:!1,minDate:ej?new Date(ej):new Date,maxDate:new Date,onChange:function(e){U("correctEnd",e),U("correctDuration",K()(e).diff(ej,"minutes"))}}))}),(0,r.jsx)(eb.Z,{label:"Enter correct job duration",children:(0,r.jsxs)(eQ.Z,{children:[(0,r.jsx)(ex.Z,{errors:O,min:0,name:"correctDuration",register:H,type:"number"}),(0,r.jsx)(ez.Z,(0,et.Z)((0,i.Z)({},eV),{addonType:"append",size:"sm",text:!0,children:"Minutes"}))]})})]}),w.reportPassFail&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tU.Z,{}),(0,r.jsx)(L.Z,{sx:{color:"rgb(0,55,83)"},children:w.reportPassFailTitle}),(0,r.jsxs)(M.Z,{direction:"row",spacing:1,alignItems:"center",children:[(0,r.jsx)(L.Z,{children:"Pass"}),(0,r.jsx)(ei.Qr,{name:"passFailStatus",control:J,render:function(e){var n=e.value;return(0,r.jsx)(rg,{checked:"Passed"!==n,onChange:eW})}}),(0,r.jsx)(L.Z,{children:"Fail"})]}),(0,r.jsxs)(eb.Z,{label:"Recommendations",children:[(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},eV),{name:"recommendations",rows:4})),(null==O?void 0:O.recommendations)&&(0,r.jsx)(iK.Z,{sx:{m:0},children:null==O?void 0:null===(Z=O.recommendations)||void 0===Z?void 0:Z.message}),(0,r.jsxs)(L.Z,{children:[eZ.length,"/50"]})]})]}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(eb.Z,{label:"Job status",children:(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},eV),{data:i0.M2,name:"completion",stacked:!0}))}),eY&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(eb.Z,{label:eY,children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},eV),{name:"completionNotes",rows:2}))})}),(0,r.jsx)(tU.Z,{}),(0,r.jsxs)(eb.Z,{label:"Requirements",children:[(0,r.jsx)(ev.Z,(0,et.Z)((0,i.Z)({},eV),{data:[{id:"expensesAdded",label:"Expenses added",value:"expensesAdded"}],name:"houseKeepingExpenses"})),(0,r.jsxs)(rx,{children:["Confirm all expenses have been added, expenses not added before completing a job may not be paid",(eB=(0,iX.E)(w.expenses,0,"supplier").totalExpenses,(0,r.jsx)(e7.Z,{content:"Total submitted",text:(0,X.Z)(eB)}))]}),(0,r.jsx)(ev.Z,(0,et.Z)((0,i.Z)({},eV),{data:[{id:"photosAdded",label:"Photos added",value:"photosAdded"}],name:"houseKeepingPhotos"})),(0,r.jsxs)(rx,{children:["You must add at least 1 photo, but please include before and after photos as a minimum (",eU," Photo(s) added)"]}),(0,r.jsx)(tU.Z,{}),(0,r.jsxs)(M.Z,{spacing:1,children:[(null==w?void 0:null===(I=w.meta)||void 0===I?void 0:I.customerSignature)&&(0,r.jsx)(rp,{label:"Add customer signature",title:"Add customer signature",name:"customerSignature",jobReport:w.report,onCancel:function(){},signatureState:ew,setSignatureState:eC,signatureType:"customer",signatureError:es}),(null==w?void 0:null===(S=w.meta)||void 0===S?void 0:S.supplierSignature)&&(0,r.jsx)(rp,{label:"Add engineer signature",title:"Add engineer signature",jobReport:w.report,name:"supplierSignature",onCancel:function(){},signatureState:eT,setSignatureState:eA,signatureType:"supplier",signatureError:ec})]})]})]})]})]})},rx=eU.ZP.small.withConfig({displayName:"form__StyledSmall",componentId:"sc-fb84fd32-0"})(rh());rb.propTypes={job:A.object.isRequired,offCanvas:A.object.isRequired,refetch:A.func};var rg=(0,i2.Z)(nq.Z)(function(e){var n=e.checked;return{"&.MuiSwitch-root":{"& .MuiSwitch-thumb":{backgroundColor:n?"red":"green"},"& .MuiSwitch-track":{backgroundColor:n?"red":"green"},"& .Mui-checked+.MuiSwitch-track":{backgroundColor:n?"red":"green"}}}}),rj=t(70136),ry=t(34613),rZ=t(33006),rI=t(40826);function rS(){var e=(0,m.Z)(["\n  display: block;\n"]);return rS=function(){return e},e}function rw(){var e=(0,m.Z)(["\n  display: flex;\n  align-items: center;\n"]);return rw=function(){return e},e}var rC=function(e){var n,t,i,o,a,s,u,l,c,d,p,m,f,v=e.job,h={completion:null===(t=v.report)||void 0===t?void 0:t.completion,notes:null===(i=v.report)||void 0===i?void 0:i.notes,timing:v.timingStatus,completionNotes:(null===(o=v.report)||void 0===o?void 0:null===(a=o.meta)||void 0===a?void 0:a.completionNotes)||"",houseKeepingExpenses:null===(s=v.report)||void 0===s?void 0:null===(u=s.meta)||void 0===u?void 0:u.houseKeepingExpenses,houseKeepingPhotos:null===(l=v.report)||void 0===l?void 0:null===(c=l.meta)||void 0===c?void 0:c.houseKeepingPhotos,correctDuration:v.correctDuration,correctStart:v.correctStart?new Date(v.correctStart):"",correctEnd:v.correctEnd?new Date(v.correctEnd):"",passFailStatus:null===(d=v.report)||void 0===d?void 0:d.passFailStatus,reportPassFailTitle:v.reportPassFailTitle||"",recommendations:(null===(p=v.report)||void 0===p?void 0:p.recommendations)||"",comments:(null===(m=v.report)||void 0===m?void 0:m.comments)||""},b=(0,rj.Z)({autoStart:!1,startTime:(0,W.E)(v,"inProgress"),endTime:(0,W.E)(v,"completed")}).time,x=b.seconds,g=b.minutes,j=b.hours,y=null;switch(h.completionNotes){case"returnVisit":y="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":y="Please indicate the type of works and engineer required";break;case"couldNotDo":y="Please advise why you were unable to do these works"}return(0,r.jsxs)("div",{children:[(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e7.Z,{content:"Notes",text:h.notes}),(0,r.jsx)(tU.Z,{})]}),(0,W.E)(v,"completed")&&(0,r.jsxs)(r.Fragment,{children:["correct"===h.timing&&(0,r.jsx)(e7.Z,{content:"Timing",text:"I confirm that the job took ".concat(j,":").concat(g,":").concat(x)}),"incorrect"===h.timing&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e7.Z,{content:"The timing is incorrect",text:"incorrect"}),h.correctStart&&(0,r.jsx)(e7.Z,{content:"Correct start",text:"".concat((0,ee.Z)(h.correctStart)," - ").concat((0,ry.Z)(h.correctStart))}),h.correctEnd&&(0,r.jsx)(e7.Z,{content:"Correct end",text:"".concat((0,ee.Z)(h.correctEnd)," - ").concat((0,ry.Z)(h.correctEnd))}),h.correctDuration&&(0,r.jsx)(e7.Z,{content:"Correct duration",text:"".concat(h.correctDuration," - minutes")})]}),h.passFailStatus&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e7.Z,{content:h.reportPassFailTitle,text:h.passFailStatus}),(0,r.jsx)(e7.Z,{content:"Recommendations",text:h.recommendations}),h.comments&&(0,r.jsx)(e7.Z,{content:"Comments",text:h.comments})]}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(e7.Z,{content:"Job status",text:null===(f=i0.M2.find(function(e){return e.value===h.completion}))||void 0===f?void 0:f.label}),y&&(0,r.jsx)(e7.Z,{content:y,text:h.completionNotes}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(rZ.Z,{tag:"h4",content:"Requirements"}),"expensesAdded"===h.houseKeepingExpenses&&(0,r.jsxs)(rq,{children:[(0,r.jsx)(rI.Z,{context:"success",icon:"check",size:"sm"}),(0,r.jsx)(e7.Z,{content:"",text:"Expenses added"}),(0,r.jsx)(rR,{children:(n=(0,iX.E)(v.expenses,0,"supplier").totalExpenses,(0,r.jsx)(e7.Z,{content:"Total submitted",text:(0,X.Z)(n)}))})]}),"photosAdded"===h.houseKeepingPhotos&&(0,r.jsxs)(rq,{children:[(0,r.jsx)(rI.Z,{context:"success",icon:"check",size:"sm"}),(0,r.jsx)(e7.Z,{content:"",text:"Photos added"})]})]})]})},rR=eU.ZP.small.withConfig({displayName:"details__StyledSmall",componentId:"sc-355ce9ba-0"})(rS()),rq=eU.ZP.div.withConfig({displayName:"details__StyledIconBox",componentId:"sc-355ce9ba-1"})(rw());rC.propTypes={job:A.object.isRequired};var r_,rT=function(e){var n,t,a,s,l,c,d=e.job,p=e.refetch,m=e.toggleShow,f=(0,o.useContext)(u.Z).user,h=(0,ei.cI)({defaultValues:{email:null===(n=d.customerUser)||void 0===n?void 0:n.email}}),b=h.errors,x=h.control,g=h.handleSubmit,j=h.register,y=h.watch,Z=y("sendEmail"),I=y("email"),S=(0,_.Z)((0,P.D)(v.yT),1)[0],w=(0,_.Z)((0,P.D)(v.xY,{onCompleted:(0,q.Z)(function(){var e;return(0,T.__generator)(this,function(n){switch(n.label){case 0:if(!(I&&"sendEmail"===Z))return[3,2];return[4,(0,t_.e)({adminId:d.adminId,job:d,openReport:!1})];case 1:e=n.sent(),S({variables:{timing:{status:"reportPDFSentSupplier",jobId:d.id,userId:f.id,meta:{toEmail:I,fileUrl:e.link}}}}),n.label=2;case 2:return p&&p(),m(),[2]}})})}),1)[0],C=(c=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(e){return n="reportSent",t=d.meta||{},w({variables:{id:d.id,changes:{meta:t,status:n},timing:{status:n,jobId:d.id,userId:f.id},_append:{statusData:(0,ep.Z)({},n,K()().toISOString())}}}),[2]})}),function(e){return c.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:g(C),children:[(0,r.jsx)(e7.Z,{content:"Customer",text:null===(t=d.customer)||void 0===t?void 0:t.name}),(0,r.jsx)(e7.Z,{content:"Customer Contact",text:null===(a=d.customerUser)||void 0===a?void 0:a.fullName}),(0,r.jsx)(e7.Z,{content:"Phone",text:null===(s=d.customerUser)||void 0===s?void 0:s.phone}),(0,r.jsx)(e7.Z,{content:"Email",text:null===(l=d.customerUser)||void 0===l?void 0:l.email}),(0,r.jsx)(tV.Z,{}),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},{errors:b,register:j,control:x}),{data:[{id:"sendEmail",label:"Send report via email",value:"sendEmail"},{id:"markAsReportSent",label:"Mark report as sent",value:"markAsReportSent"}],name:"sendEmail"})),"sendEmail"===Z&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ne.Z,{fullWidth:!0,inputRef:j,label:"Send to email address",name:"email"})}),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};rT.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired};var rA,rE,rD=(r_=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(rT,{job:e,refetch:t,toggleShow:n.show}),submit:!1,title:"Send Report"}),[2]})}),function(e,n,t){return r_.apply(this,arguments)}),rP=(rA=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(rb,{job:e,offCanvas:n,refetch:t}),title:e.report?"Update Report":"Create Report"}),[2]})}),function(e,n,t){return rA.apply(this,arguments)}),rk=(rE=(0,q.Z)(function(e,n){return(0,T.__generator)(this,function(t){return n.show({submit:!1,content:(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(rC,{job:e})}),title:"Details Report"}),[2]})}),function(e,n){return rE.apply(this,arguments)});function r$(){var e=(0,m.Z)(["\n  mutation AddQuotation($objects: [SupplierQuote_insert_input!]!) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return r$=function(){return e},e}function rO(){var e=(0,m.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $jobId: Int\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      status\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"]);return rO=function(){return e},e}function rN(){var e=(0,m.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $supplierOffer: [SupplierOffer_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_SupplierOffer(objects: $supplierOffer) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return rN=function(){return e},e}(0,f.Ps)(r$());var rH=(0,f.Ps)(rO());function rF(){var e=(0,m.Z)(["\n  query GetQuotationLineItems($quotationId: Int!, $type: String) {\n    lineItems: SupplierQuoteLineItem(\n      where: { quoteId: { _eq: $quotationId }, type: { _eq: $type } }\n    ) {\n      id\n      description\n      item\n      qty\n      qtyUnit\n      quoteId\n      supplierTotal\n      total\n      type\n      unitRate\n    }\n  }\n"]);return rF=function(){return e},e}function rM(){var e=(0,m.Z)(['\n  query GetQuoteUplift($jobId: Int) {\n    SupplierQuote: SupplierQuote(where: { jobId: { _eq: $jobId }, type: { _eq: "uplift" } }) {\n      status\n      quotationId: id\n      jobId\n      totalDuration\n      totalDurationUnit\n      startDate\n      methodStatement\n      notes\n    }\n  }\n']);return rM=function(){return e},e}function rL(){var e=(0,m.Z)(["\n  mutation InsertSupplierQuoteLineItem($objects: [SupplierQuoteLineItem_insert_input!]!) {\n    insert_SupplierQuoteLineItem(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return rL=function(){return e},e}function rJ(){var e=(0,m.Z)(["\n  mutation UpdateSupplierQuoteLineItem($id: Int!, $changes: SupplierQuoteLineItem_set_input) {\n    update_SupplierQuoteLineItem_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return rJ=function(){return e},e}function rU(){var e=(0,m.Z)(["\n  mutation DeleteSupplierQuoteLineItem($id: Int!) {\n    delete_SupplierQuoteLineItem_by_pk(id: $id) {\n      id\n    }\n  }\n"]);return rU=function(){return e},e}function rV(){var e=(0,m.Z)(["\n  mutation InsertSupplierQuoteLineItem(\n    $objects: [SupplierQuote_insert_input!]!\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n        status\n      }\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"]);return rV=function(){return e},e}(0,f.Ps)(rN());var rQ=(0,f.Ps)(rF()),rz=(0,f.Ps)(rM()),rY=(0,f.Ps)(rL()),rB=(0,f.Ps)(rJ()),rW=(0,f.Ps)(rU()),rG=(0,f.Ps)(rV()),rK=t(11587),rX=t(68956),r0=t(8500),r1=t(82058),r2=t(28497),r4=function(e){var n,t,o=e.editMode,a=e.onSuccess,s=e.rawData,u=e.quotationId,l=(e.setQuote,e.supplierId),c=e.type,d=e.toggleShow,p=e.jobId,m=e.refetchView,f=(0,e2.x)(),v=f.hasRole,h=f.user,b=(0,ei.cI)({defaultValues:{description:o?s.description:"",qty:o?s.qty:"",qtyUnit:o?s.qtyUnit:"hours",unitRate:o?s.unitRate:"",item:o?s.item:"",total:o?s.total:null},resolver:(0,er.S)((n=c,(0,eu.Ry)().shape({qty:(0,eu.Rx)().required(),unitRate:(0,eu.Rx)().required(),qtyUnit:"Labour"===n&&(0,eu.Z_)().oneOf(["hours","days"]).required()})))}),x=b.control,g=b.errors,j=b.handleSubmit,y=b.register,Z=b.watch,I={control:x,errors:g,register:y},S=Z("qty"),w=Z("unitRate"),C=Z("total"),R=(0,_.Z)((0,P.D)(rY,{onCompleted:function(e){var n=e.insert_SupplierQuoteLineItem.returning[0].id;a&&a(n)}}),2),A=R[0],E=R[1].loading,D=(0,_.Z)((0,P.D)(rG),2),k=D[0],$=D[1].loadingInsert,O=(0,_.Z)((0,P.D)(rB,{onCompleted:function(e){var n=e.update_SupplierQuoteLineItem_by_pk.id;a&&a(n)}}),2),N=O[0],H=O[1].loadingUpdate,F=(t=(0,q.Z)(function(e){var n,t,r,a;return(0,T.__generator)(this,function(r){switch(r.label){case 0:if(e.total=Number(e.total),!o)return[3,2];return e.supplierTotal=e.qty*e.unitRate,[4,N({variables:{id:null==s?void 0:s.id,changes:e}})];case 1:case 3:return r.sent(),[3,8];case 2:if(e.accountId=Number(l),e.type=c,e.quoteId=Number(u),e.supplierTotal=e.qty*e.unitRate,!u)return[3,4];return[4,A({variables:{objects:[e]}})];case 4:return n={accountId:l,jobId:p,status:"upliftDraft",quoteNumber:"Uplift",type:"uplift"},t={notes:"Create uplift draft with insert line item",status:"upliftDraft",jobId:p,userId:h.id},[4,k({variables:{objects:[n],objectJobTiming:[t]}})];case 5:return[4,r.sent().data.insert_SupplierQuote.returning[0]];case 6:return a=r.sent().id,[4,A({variables:{objects:[(0,et.Z)((0,i.Z)({},e),{quoteId:a})]}})];case 7:r.sent(),m(),r.label=8;case 8:return[2]}})}),function(e){return t.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:j(F),children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},I),{name:"description",rows:2}))})})}),(0,r.jsxs)(e$.Z,{children:[(0,r.jsx)(eO.Z,{md:4,children:(0,r.jsx)(eb.Z,{label:"Quantity",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},I),{name:"qty",type:"number"}))})}),"Labour"===c&&(0,r.jsx)(eO.Z,{md:4,children:(0,r.jsx)(eb.Z,{label:"Quantity Unit",children:(0,r.jsx)(eE.Z,(0,et.Z)((0,i.Z)({},I),{name:"qtyUnit",options:[{text:"Hours",value:"hours",disabled:!1},{text:"Days",value:"days",disabled:!1}]}))})}),(0,r.jsx)(eO.Z,{md:4,children:(0,r.jsx)(r2.Z,(0,et.Z)((0,i.Z)({},I),{label:v("supplier")?"Unit Rate":"Supplier Unit Rate",name:"unitRate",vat:"Ex VAT"}))})]}),(0,r.jsxs)(ej.Z,{children:["Supplier Total: ",(0,X.Z)(S*w)]}),(0,r.jsx)(tU.Z,{}),v("admin")&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(r2.Z,(0,et.Z)((0,i.Z)({},I),{label:"Customer Unit Rate",name:"total",vat:"Ex VAT"}))})}),(0,r.jsxs)(ej.Z,{children:["Customer Total (Labour Item): ",(0,X.Z)(S*C)]}),(0,r.jsx)(tU.Z,{})]}),(0,r.jsxs)(e$.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,r.jsx)(eg.Z,{content:"Cancel",onClick:d,style:{margin:"0 5px"}}),(0,r.jsx)(eg.Z,{content:o?"Save":"Add",disabled:E||H||$,type:"submit"})]}),(0,r.jsx)("div",{style:{clear:"both"}})]})};function r3(){var e=(0,m.Z)(["\n  margin: 0 5px;\n"]);return r3=function(){return e},e}function r6(){var e=(0,m.Z)(["\n  margin: 0;\n"]);return r6=function(){return e},e}r4.propTypes={editMode:A.bool,onSuccess:A.func,rawData:A.object,quotationId:A.number,supplierId:A.number,type:A.string,toggleShow:A.func},r4.defaultProps={rawData:{}};var r5=function(e){var n=e.type,t=e.updateTotal,i=e.quotationId,a=e.jobId,s=e.supplierId,u=e.success,l=e.readOnly,d=e.refetchView,p=(0,o.useContext)(nm.Z).hasRole,m=(0,o.useContext)(J.Z),f=(0,c.aM)(rQ,{skip:!i,variables:{quotationId:i,type:n}}),v=f.data,h=(void 0===v?{lineItems:[]}:v).lineItems,b=f.loading,x=f.refetch,g=(0,_.Z)((0,P.D)(rW,{onCompleted:function(e){x(),u()}}),1)[0];(0,o.useEffect)(function(){(null==h?void 0:h.length)&&t(h)},[h]);var j=function(){x(),u(),m.close()},y=function(e,t){m.show({content:(0,r.jsx)(r4,{editMode:!!(null==t?void 0:t.rawData),onSuccess:j,rawData:null==t?void 0:t.rawData,toggleShow:m.close,quotationId:i,supplierId:s,type:n,jobId:a,readOnly:l,refetchView:d}),submit:!1,title:"".concat(t?"Edit":"Insert"," ").concat(n," Item")})},Z=function(e,n){g({variables:{id:n.id}})},I=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!p(["admin","supplier","customer"]),text:"Qty"},{hidden:!p(["admin","supplier"]),text:"Supplier Rate"},{hidden:!p(["admin","supplier"]),text:"Supplier Total"},{hidden:!p(["admin","customer"]),text:"Customer Rate"},{hidden:!p(["admin","customer"]),text:"Customer Total"},{hidden:!p(["admin","supplier"])||l,formatter:rX.Z,formatterData:(0,r1.N)("",{onEditClick:y,onDeleteClick:Z}),text:"Actions"},{text:"Raw Data",hidden:!0}],S=h.reduce(function(e,n){return e+n.total*n.qty},0),w=h.reduce(function(e,n){return e+n.supplierTotal},0);return b?(0,r.jsx)(nD.Z,{sx:{zIndex:1e5},open:!0,children:(0,r.jsx)(nP.Z,{color:"secondary"})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(rZ.Z,{content:(0,r.jsxs)(r7,{align:"center",justify:"between",children:[(0,r.jsx)("span",{children:n}),p(["admin","supplier"])&&!l&&(0,r.jsx)(eg.Z,{content:"Insert ".concat(n," Item"),context:"secondary",onClick:y,size:"sm"})]}),tag:"h4"}),(0,r.jsx)(r0.Z,{columns:I,rows:h.map(function(e){return{id:e.id,description:e.description,qty:"Labour"===e.type?"".concat(e.qty," ").concat(e.qtyUnit):e.qty,rate:(0,X.Z)(e.unitRate),supplierTotal:(0,X.Z)(e.supplierTotal),customerRate:e.total,total:(0,X.Z)(e.total*e.qty),action:"",rawData:e}})}),(0,r.jsxs)("div",{style:{textAlign:"right"},children:[p(["admin","supplier"])&&(0,r.jsxs)(r8,{children:["Subtotal - ",n," ",p(["admin"])&&"- Supplier",": ",(0,X.Z)(w)]}),p(["admin","customer"])&&(0,r.jsxs)(r8,{children:["Subtotal - ",n,": ",(0,X.Z)(S)]})]})]})},r7=(0,eU.ZP)(e$.Z).attrs(function(){return{align:"center",justify:"between"}}).withConfig({displayName:"lineItemTable__StyledRow",componentId:"sc-b993cba9-0"})(r3()),r8=eU.ZP.p.withConfig({displayName:"lineItemTable__StyledP",componentId:"sc-b993cba9-1"})(r6());r5.propTypes={success:A.func.isRequired,supplierId:A.number.isRequired,type:A.string,updateTotal:A.func.isRequired,readOnly:A.bool};var r9=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0;return e.reduce(function(e,t){return"total"===n?e+=t[n]*t.qty:e+=t[n]},0)},oe=function(e){var n=e.quotationId,t=e.jobId,a=e.supplierId,s=e.success,u=e.readOnly,l=e.refetchView,c=e.total,d=e.setTotal,p=(e.supplierTotal,e.setSupplierTotal),m=(e.customerTotal,e.setCustomerTotal),f=(0,o.useContext)(nm.Z).hasRole,v=function(e,n){return d(function(t){return(0,et.Z)((0,i.Z)({},t),(0,ep.Z)({},e,r9(n,"total")))})},h=function(e,n){return p(function(t){return(0,et.Z)((0,i.Z)({},t),(0,ep.Z)({},e,r9(n,"supplierTotal")))})},b=function(e,n){return m(function(t){return(0,et.Z)((0,i.Z)({},t),(0,ep.Z)({},e,r9(n,"total")))})},x=c.labour+c.materials,g=.2*x;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(r5,{jobId:t,quotationId:n,readOnly:u,success:s,supplierId:a,type:"Labour",updateTotal:function(e){v("labour",e),h("labour",e),b("labour",e)},refetchView:l})})}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(r5,{jobId:t,quotationId:n,readOnly:u,success:s,supplierId:a,type:"Materials",updateTotal:function(e){v("materials",e),h("materials",e),b("materials",e)},refetchView:l})})}),(0,r.jsx)(tU.Z,{}),f(["admin","customer"])&&(0,r.jsx)(e$.Z,{children:(0,r.jsxs)(eO.Z,{md:12,style:{textAlign:"right"},children:[(0,r.jsxs)("div",{children:["Sub Total: ",(0,X.Z)(x)]}),(0,r.jsxs)("div",{children:["VAT (20%): ",(0,X.Z)(g)]}),(0,r.jsxs)("div",{children:["Total: ",(0,X.Z)(x+g)]})]})})]})},on=(0,eu.Ry)().shape({notes:(0,eu.Z_)()}),ot=t(22244),oi=function(e){var n,t,a,s,u=e.jobId,d=e.onSuccess,p=e.supplierId,m=e.readOnly,f=e.refetchView,v=(0,o.useContext)(J.Z),h=(0,D.x)(),b=(0,e2.x)(),x=b.hasRole,g=b.user,j=(0,o.useState)(),y=j[0],Z=j[1],I=(0,o.useState)(),S=I[0],w=I[1],C=(0,o.useState)({text:"-",context:"info"}),R=C[0],A=C[1],E=(0,o.useState)({labour:0,materials:0}),k=E[0],$=E[1],O=(0,o.useState)({labour:0,materials:0}),N=O[0],H=O[1],F=(0,o.useState)({labour:0,materials:0}),M=F[0],L=F[1],U=(0,_.Z)((0,P.D)(rH,{skip:m,onCompleted:(n=(0,q.Z)(function(e){var n,t,i;return(0,T.__generator)(this,function(r){switch(r.label){case 0:if(!u)return[3,2];return[4,(0,e_.F)(h,u)];case 1:r.sent(),r.label=2;case 2:return t=(n=e.update_SupplierQuote_by_pk).id,i=n.status,d&&d({id:t,status:i}),v.close(),[2]}})}),function(e){return n.apply(this,arguments)})}),1)[0],V=(0,_.Z)((0,P.D)(rG,{skip:m,onCompleted:(t=(0,q.Z)(function(e){var n,t,i;return(0,T.__generator)(this,function(r){switch(r.label){case 0:if(!u)return[3,2];return[4,(0,e_.F)(h,u)];case 1:r.sent(),r.label=2;case 2:return t=(n=e.insert_SupplierQuote.returning[0]).id,i=n.status,d&&d({id:t,status:i}),v.close(),[2]}})}),function(e){return t.apply(this,arguments)})}),1)[0],Q=(0,c.aM)(rz,{variables:{jobId:u},onCompleted:(a=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){switch(t.label){case 0:if(!u)return[3,2];return[4,(0,e_.F)(h,u)];case 1:t.sent(),t.label=2;case 2:return Z(null===(n=e.SupplierQuote[0])||void 0===n?void 0:n.quotationId),w(e.SupplierQuote[0]),[2]}})}),function(e){return a.apply(this,arguments)})}).refetch,z=(0,ei.cI)({resolver:(0,er.S)(on)}),Y=z.handleSubmit,B=z.setValue;(0,o.useEffect)(function(){B("totalDuration",null==S?void 0:S.totalDuration),B("totalDurationUnit",null==S?void 0:S.totalDurationUnit),B("methodStatement",null==S?void 0:S.methodStatement),S&&A(ot.AK.find(function(e){return e.value===(null==S?void 0:S.status)}))},[S]);var W=(s=(0,q.Z)(function(e){var n,t,r,o;return(0,T.__generator)(this,function(a){switch(a.label){case 0:if(e.status=x("supplier")?"supplierUpliftRequested":"upliftRequestSendCustomer",n={jobId:u,userId:g.id,notes:"Supplier Uplift requested ",status:"supplierUpliftRequested",meta:{total:N.labour+N.materials}},t={jobId:u,userId:g.id,notes:"Uplift requested sent customer ",status:"upliftRequestSendCustomer",meta:{total:(k.labour+k.materials)*1.2}},r=x("supplier")?[n]:(null==S?void 0:S.status)==="supplierUpliftRequested"?[t]:(0,l.Z)([n]).concat((0,l.Z)([t])),!y)return[3,2];return[4,U({variables:{id:y,changes:e,objectJobTiming:r}})];case 1:return a.sent(),[3,4];case 2:return o=(0,et.Z)((0,i.Z)({},e),{accountId:p,jobId:u,quoteNumber:"Uplift",type:"uplift"}),[4,V({variables:{objects:[o],objectJobTiming:r}})];case 3:a.sent(),a.label=4;case 4:return[2]}})}),function(e){return s.apply(this,arguments)}),G=function(){v.close(),f()};return(0,r.jsxs)(eo.Z,{handleSubmit:Y(W),children:[(0,r.jsxs)(e$.Z,{children:[(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(ef.Z,{content:"This is the total amount to be paid for the job and includes any time spent on the job thus far.",context:"info"})}),(0,r.jsxs)(eO.Z,{md:12,children:["Status: ",(0,r.jsx)(rK.Z,{content:null==R?void 0:R.text,size:"md",context:null==R?void 0:R.context})]})]}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(oe,{quotationId:y,jobId:u,supplierId:p,success:Q,readOnly:m,refetchView:f,total:k,setTotal:$,supplierTotal:N,setSupplierTotal:H,customerTotal:M,setCustomerTotal:L}),(0,r.jsx)(e$.Z,{justify:"end",style:{margin:"0 5px"},children:(0,r.jsxs)(iI.Z,{children:[x(["admin","supplier"])&&!m&&(0,r.jsx)(eg.Z,{content:"Cancel",context:"danger",onClick:G,type:"button",size:"sm"}),x(["admin","supplier"])&&!m&&(0,r.jsx)(eg.Z,{content:"Submit ".concat(x(["admin"])?"(send to customer)":""),type:"submit",size:"sm"})]})}),(0,r.jsx)("div",{style:{clear:"both"}})]})};oi.propTypes={jobId:A.number,onSuccess:A.func,supplierId:A.number,readOnly:A.bool,refetchView:A.func},oi.defaultProps={readOnly:!1};var or,oo=function(e){var n=e.jobId,t=e.onSuccess,i=e.readOnly,o=e.supplierId,a=e.refetch;return(0,r.jsx)(oi,{jobId:n,onSuccess:t,supplierId:o,readOnly:i,refetchView:a})},oa=function(e){var n,t,a,s=e.job,l=e.refetch,c=e.status,d=e.toggleShow,m=(0,o.useContext)(u.Z).user,f=null===(n=s.quotations.find(function(e){return"uplift"===e.type}))||void 0===n?void 0:n.lineItems,v="customerUpliftApproved"===c,h=null==s?void 0:s.financeLogs,b=(0,ei.cI)({defaultValues:{comments:""}}),x=b.errors,g=b.handleSubmit,j=b.register,y=(0,_.Z)((0,P.D)(p.wU,{onCompleted:function(){l&&l(),d()}}),1)[0],Z=f.reduce(function(e,n){return e+n.total*n.qty},0),I=f.filter(function(e){return"Materials"===e.type}).reduce(function(e,n){return e+n.supplierTotal},0),S=f.filter(function(e){return"Labour"===e.type}).reduce(function(e,n){return e+n.supplierTotal},0),w=(t=(0,q.Z)(function(){var e,n;return(0,T.__generator)(this,function(t){return e={jobId:s.id,meta:{username:"".concat(m.nameFirst," ").concat(m.nameLast),userId:m.id}},(n=[]).push((0,et.Z)((0,i.Z)({},e),{type:"supplierLabourAmount",value:S,difference:S-(0,e1.B)("supplierLabourAmount",h)})),n.push((0,et.Z)((0,i.Z)({},e),{type:"supplierMaterialsAmount",value:I,difference:I-(0,e1.B)("supplierMaterialsAmount",h)})),n.push((0,et.Z)((0,i.Z)({},e),{type:"amount",value:Z,difference:Z-(0,e1.B)("amount",h)})),[2,n]})}),function(){return t.apply(this,arguments)}),C=(a=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(i){switch(i.label){case 0:if(n={notes:e.comments,status:c,jobId:s.id,userId:m.id},!(t=v))return[3,2];return[4,w()];case 1:t=i.sent(),i.label=2;case 2:return y({variables:{financeLog:t,hasFinanceLog:v,jobChange:{pricing:"fixed"},jobId:s.id,timing:[n]}}),[2]}})}),function(e){return a.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:g(C),children:(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:x,name:"comments",register:j,rows:3})})})};oa.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,status:A.string.isRequired,toggleShow:A.func.isRequired};var os,ou,ol=(or=(0,q.Z)(function(e,n,t){var i,o,a=arguments;return(0,T.__generator)(this,function(s){return i=a.length>3&&void 0!==a[3]&&a[3],o=function(){n.close(),t()},n.show({content:(0,r.jsx)(oo,{jobId:e.id,onSuccess:o,readOnly:i,supplierId:e.supplier.id,refetch:t}),submit:!1,title:"".concat(i?"Uplift details":"Uplift request"),width:"50%"}),[2]})}),function(e,n,t){return or.apply(this,arguments)}),oc=(os=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(oa,{job:e,refetch:t,status:"customerUpliftApproved",toggleShow:n.show}),title:"Approve uplift"}),[2]})}),function(e,n,t){return os.apply(this,arguments)}),od=(ou=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(i){return n.show({content:(0,r.jsx)(oa,{job:e,refetch:t,status:"customerUpliftRejected",toggleShow:n.show}),title:"Reject uplift"}),[2]})}),function(e,n,t){return ou.apply(this,arguments)}),op=function(e){var n,t=e.job,i=e.offCanvas,a=e.refetch,s=(0,o.useContext)(u.Z).user,l=(0,ei.cI)({defaultValues:{comments:""}}),c=l.errors,d=l.handleSubmit,p=l.register,m=(0,_.Z)((0,P.D)(R,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){return a&&a(),i&&i.close(),[2]})})}),1)[0],f=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(i){return n=(0,tj.e)(t,["onHold","closed"]),m({variables:{id:t.id,changes:{status:null==n?void 0:n.status},_delete_key:{statusData:"closed"},deleteTiming:{jobId:{_eq:t.id},status:{_eq:"closed"}},insertTiming:{notes:e.comments,status:"reopened",jobId:t.id,userId:s.id}}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:d(f),children:[(0,r.jsx)(eb.Z,{label:"Comments",children:(0,r.jsx)(eq.Z,{errors:c,name:"comments",register:p,rows:3})}),(0,r.jsx)(ea.H,{content:"Submit",type:"submit"})]})};op.propTypes={job:A.object.isRequired,offCanvas:A.object.isRequired,refetch:A.func.isRequired},op.defaultProps={job:{},offCanvas:{},refetch:function(){}};var om=function(e){var n=e.job,t=e.offCanvas,i=e.refetch;t.show({content:(0,r.jsx)(op,{job:n,offCanvas:t,refetch:i}),submit:!1,title:"Reopen job"})};function of(){var e=(0,m.Z)(["\n  mutation AcceptCustomerIssue($jobId: Int!, $notes: String) {\n    acceptCustomerIssue(jobId: $jobId, notes: $notes) {\n      data\n      success\n    }\n  }\n"]);return of=function(){return e},e}var ov=(0,f.Ps)(of()),oh=function(e){var n,t=e.jobId,i=e.refetch,o=e.close,a=(0,nk.D)(),s=(0,ei.cI)({defaultValues:{notes:""}}),u=s.control,l=s.errors,c=s.handleSubmit,d=(0,_.Z)((0,P.D)(ov,{onError:function(e){a.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){i(),o()}}),1)[0],p=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){switch(n.label){case 0:return[4,d({variables:{jobId:t,notes:e.notes}})];case 1:return n.sent(),[2]}})}),function(e){return n.apply(this,arguments)});return(0,r.jsx)("form",{id:"offCanvasForm",onSubmit:c(p),children:(0,r.jsx)(ei.Qr,{control:u,name:"notes",render:function(e){var n,t=e.value,i=e.onChange;return(0,r.jsx)(ne.Z,{fullWidth:!0,multiline:!0,minRows:6,variant:"filled",color:"secondary",label:"Please insert any relevant information for this approval.",value:t,onChange:i,error:l.notes,helperText:null===(n=l.notes)||void 0===n?void 0:n.message})}})})};oh.defaultProps={refetch:function(){},close:function(){}},oh.propTypes={jobId:E().number.isRequired,refetch:E().func,close:E().func};var ob,ox=(ob=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(i){return n=e.jobId,(t=e.offCanvas).show({content:(0,r.jsx)(oh,{jobId:n,close:t.close}),submit:!0,title:"Issue approval"}),[2]})}),function(e){return ob.apply(this,arguments)}),og=function(e){var n,t=e.timings,i=(void 0===t?[]:t).find(function(e){return"reportSentSupplier"===e.status});return i&&"Report Sent by ".concat((null==i?void 0:null===(n=i.user)||void 0===n?void 0:n.fullName)||"")},oj=function(e){var n,t=e.timings,i=void 0===t?[]:t,r=null==i?void 0:i.find(function(e){return"invoiceSent"===e.status});return r&&"Invoice sent by ".concat((null==r?void 0:null===(n=r.user)||void 0===n?void 0:n.fullName)||"")},oy=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,t=null==e?void 0:e.reduce(function(e,t){return"total"===n?e+=t[n]*t.qty:e+=t[n]},0);return isNaN(t)?null:t},oZ=function(e){var n,t,i,o,a,s,u,l,c,d,p,m,f,v,h,b,x,g,j=e.addJobTiming,y=e.deleteJobTiming,Z=e.job,I=e.offCanvas,S=e.offCanvasNew,w=e.updateJob,C=e.refetch,R=e.hasRole,q=e.user,_=(0,D.x)(),T=null;R(["admin","superadmin"])&&q.accountId&&(T=q.accountId);var A=null==q?void 0:q.invoiceThreshold,E=null==Z?void 0:null===(n=Z.quotations)||void 0===n?void 0:n.find(function(e){return"quotationRejected"!==e.status}),P=oy(null==E?void 0:E.lineItems,"total"),k=P+.2*P,$=null==Z?void 0:null===(t=Z.customerFinances)||void 0===t?void 0:null===(i=t.amountInfo)||void 0===i?void 0:i.vatTotal,O="onHold"===(0,ts.L)(Z.timings),N=(0,W.E)(Z,"accepted"),F=(0,W.E)(Z,"closed"),M="incorrect"===Z.timingStatus?Z.correctEnd:(0,W.E)(Z,"completed"),L=(0,W.E)(Z,"complianceRejected"),J=(0,W.E)(Z,"complianceApproved"),U=(0,W.E)(Z,"complianceRequestedDocumentation"),V=(0,W.E)(Z,"customerPaid"),Q=(null===(o=Z.compliances)||void 0===o?void 0:o.length)>0,z="incorrect"===Z.timingStatus?Z.correctStart:(0,W.E)(Z,"inProgress"),Y=(0,W.E)(Z,"supplierUpliftRequested"),B=(0,W.E)(Z,"upliftRequestSendCustomer"),G=(0,W.E)(Z,"customerUpliftApproved"),ee=(0,W.E)(Z,"customerUpliftRejected"),en=(0,W.E)(Z,"invoiceSent"),et=(0,W.E)(Z,"invoiceSentSupplier"),ei=(0,W.E)(Z,"ppmInvoiceCreated"),er=(0,W.E)(Z,"offered"),eo=(0,W.E)(Z,"pending"),ea=(0,W.E)(Z,"pricingChanged"),es=(0,W.E)(Z,"quoteAccepted"),eu=(0,W.E)(Z,"quoteNew"),el=(0,W.E)(Z,"raised"),ec=(0,W.E)(Z,"rejected"),ed=(0,W.E)(Z,"reportSent"),ep=(0,W.E)(Z,"reportSentSupplier"),em=(0,W.E)(Z,"supplierPaid"),ef=(0,W.E)(Z,"timingChanged"),ev=(0,W.E)(Z,"unvalidated"),eh=(0,W.E)(Z,"validated"),eb=null===(a=Z.childJobs)||void 0===a?void 0:a.find(function(e){return"quote"===e.type}),ex=(0,W.E)(Z,"updateAcceptOfferInput"),eg=(0,W.E)(Z,"supplierCancel"),ej=(0,W.E)(Z,"expensesPendingAmount"),ey=(0,W.E)(Z,"expensesPendingAmountResolved"),ew=Z.scheduledAt?(null===(s=Z.meta)||void 0===s?void 0:s.arrivalAnytime)?"".concat(K()(Z.scheduledAt).format("D MMM YYYY")," (anytime)"):K()(Z.scheduledAt).format("D MMM YYYY HH:mm"):K()(es||N).format("D MMM YYYY HH:mm"),eC=Z.supplierOffers.filter(function(e){return"cancelled"!==e.status}).length,eR=(0,eI.Xd)("adminUplift",null==Z?void 0:Z.timings),eq=(0,eI.nN)("adminUplift",null==Z?void 0:Z.timings),e_=(0,eI.OQ)("adminUplift",null==Z?void 0:Z.timings),eT=(0,eI.Xd)("adminInvoice",null==Z?void 0:Z.timings),eE=(0,eI.nN)(["adminUplift","adminInvoice"],null==Z?void 0:Z.timings),eD=(0,eI.OQ)("adminInvoice",null==Z?void 0:Z.timings),eP=null==Z?void 0:null===(u=Z.invoices)||void 0===u?void 0:u.filter(function(e){return ip.SR.customer.includes(e.invoiceType)}),ek=null==Z?void 0:null===(l=Z.invoices)||void 0===l?void 0:l.filter(function(e){return ip.SR.supplier.includes(e.invoiceType)}),e$=(null==eP?void 0:eP.reduce(function(e,n){var t,i,r,o;return e+((null==n?void 0:null===(t=n.reconciledAmount)||void 0===t?void 0:null===(i=t.reconciliations)||void 0===i?void 0:null===(r=i.aggregate)||void 0===r?void 0:null===(o=r.sum)||void 0===o?void 0:o.amount)||0)},0))||null,eO=(null==ek?void 0:ek.reduce(function(e,n){var t,i,r,o;return e+((null==n?void 0:null===(t=n.reconciledAmount)||void 0===t?void 0:null===(i=t.reconciliations)||void 0===i?void 0:null===(r=i.aggregate)||void 0===r?void 0:null===(o=r.sum)||void 0===o?void 0:o.amount)||0)},0))||null,eN=(null==eP?void 0:eP.reduce(function(e,n){var t;return e+((null==n?void 0:null===(t=n.amounts)||void 0===t?void 0:t.vatTotal)||0)},0))||null,eH=(null==ek?void 0:ek.reduce(function(e,n){var t;return e+((null==n?void 0:null===(t=n.amounts)||void 0===t?void 0:t.vatTotal)||0)},0))||null;return"pending"!==Z.status&&"closed"!==Z.status||el||eu?[{id:1,label:"Job raised",date:(0,W.E)(Z,["raised","quoteNew"]),content:[{id:1,active:!0,data:"Created By ".concat((null===(c=null==Z?void 0:Z.timings[0])||void 0===c?void 0:null===(d=c.user)||void 0===d?void 0:d.fullName)||"")}]},{id:2,label:"Job offered",info:"no assigned suppliers",date:er,content:[{id:1,active:!O&&er&&!z&&!N&&!ef&&!ea&&Z.supplierOffers&&Z.supplierOffers.length>0,data:"Offered to ".concat(eC," suppliers")},{id:2,active:!O&&ec,data:"Job rejected by supplier"}],actions:[{id:1,active:!O&&el&&!z&&!er&&!Z.jobScheduleId,content:"Create Quote",context:"secondary",handleClick:function(){return nJ(Z,I,w,j,q)},type:"button"},{id:2,active:!F&&!O&&(0,W.E)(Z,["raised","quoteNew"])&&!z&&!N&&!Z.supplier,content:"Assign Suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){return nL({jobId:Z.id,offCanvas:S,refetch:C,isSingleSupplier:(0,W.E)(Z,"quoteNew")})},type:"button"},{id:3,active:!(0,W.E)(Z,"quoteAccepted")&&!O&&!z&&Z.supplier&&(er||ec),content:"Repost Job",context:"danger",handleClick:function(){return nz({jobId:Z.id,offCanvas:S,refetch:C})},type:"button"}]},{id:3,label:"Accepted",info:"waiting for supplier to accept",date:"quote"!==Z.type?(0,W.E)(Z,"accepted"):(0,W.E)(Z,"quoteAccepted"),content:[{id:1,active:(N||es||ef||ea)&&Z.supplier,data:"Assigned to ".concat(null===(p=Z.supplier)||void 0===p?void 0:p.name)},{id:2,active:(N||es)&&Z.supplierUser,data:"Operative: ".concat(null===(m=Z.supplierUser)||void 0===m?void 0:m.fullName)},{id:3,active:N||es,data:"Arrival time: ".concat(ew)},{id:4,active:ef&&!N&&Z.supplier,data:"Job timing has changed, supplier needs to Accept the job again and set new\n          attendance time"},{id:5,active:ea&&!N&&Z.supplier,data:"Job service or pricing has changed, supplier needs to Accept the job again and\n          confirm attendance and operative"},{id:6,active:ex,data:"Attendance and operative has changed by ".concat((0,eS.j$)(Z,"updateAcceptOfferInput"))},{id:7,active:eg,data:"Job canceled by ".concat((0,eS.j$)(Z,"supplierCancel"))},{id:8,active:!0,data:function(){var e;return!F&&"offered"===Z.status&&(null===(e=Z.supplier)||void 0===e?void 0:e.id)&&!N&&(0,r.jsxs)(tX.Z,{size:"small",children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){var e;return iQ({job:Z,offCanvas:I,refetch:C,accountId:null==Z?void 0:null===(e=Z.supplier)||void 0===e?void 0:e.id})},size:"small",children:"Accept job"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){var e;return iz({job:Z,offCanvas:I,refetch:C,accountId:null==Z?void 0:null===(e=Z.supplier)||void 0===e?void 0:e.id})},size:"small",children:"Reject job"})]})}}],actions:[{id:1,active:!F&&!O&&!z&&(N||ef||ea)&&Z.supplier,content:"Change job timing",context:"danger",handleClick:function(){return nV(Z,I,C)},type:"button"},{id:2,active:!F&&!O&&!z&&(N||ef||ea)&&Z.supplier,content:"Change job pricing or service",context:"danger",handleClick:function(){return nU(Z,I,C)},type:"button"}]},{id:4,label:"In progress",info:"waiting for supplier to start",date:z,actions:[{id:1,active:!F&&!O&&z&&!(G||ee)&&"reactive"===Z.type&&!M,content:"".concat(Y?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return ol(Z,I,C,!1)},type:"button"},{id:2,active:z&&!eb,content:"Create remedial quote",context:"success",handleClick:function(){return n4({jobId:Z.id,customerId:Z.customerId,locationId:Z.locationId,offCanvas:I})},type:"button"},{id:3,active:eb,content:"Remedial quote Q ".concat(null==eb?void 0:eb.number),context:"info",handleClick:function(){return n3(null==eb?void 0:eb.number,I)},type:"button"}]},{id:5,label:"Uplift requested",info:"waiting for customer",date:z&&(B||Y),active:!!(z&&(B||Y))&&"reactive"===Z.type,content:[{id:1,active:G,data:"Uplift approved by ".concat((0,eS.j$)(Z,"customerUpliftApproved"))},{id:2,active:ee,data:"Uplift rejected by ".concat((0,eS.j$)(Z,"customerUpliftRejected"))},{id:4,active:Y,data:function(){var e=B&&!(G||ee);return(0,r.jsxs)(tX.Z,{size:"small",children:[e&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eS.il)(A,k)||eq?oc(Z,I,C):(0,eZ.I_)({type:"issue",role:"adminUplift",jobId:Z.id,accountId:q.accountId,quotationId:null==E?void 0:E.id,amount:k,offCanvas:I})},size:"small",children:"Approve"}),(B||Y)&&(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return ol(Z,I,C,!0)},size:"small",children:"Details"}),e&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){(0,eS.il)(A,k)||eq?od(Z,I,C):(0,eZ.I_)({type:"issue",role:"adminUplift",jobId:Z.id,accountId:q.accountId,quotationId:null==E?void 0:E.id,amount:k,offCanvas:I})},size:"small",children:"Reject"})]})}}]},{id:6,label:"Threshold approval",info:"",date:(null==eq?void 0:eq.createdAt)||(null==e_?void 0:e_.createdAt),active:!!(eR||eq||e_),content:[{id:1,active:eR&&!eq&&!e_,data:"Awaiting threshold approval"},{id:2,active:eq,data:"Threshold approved by ".concat(null==eq?void 0:null===(f=eq.user)||void 0===f?void 0:f.fullName)},{id:3,active:e_,data:"Threshold rejected by ".concat(null==e_?void 0:null===(v=e_.user)||void 0===v?void 0:v.fullName)},{id:4,active:!O&&eR&&(0,eS.il)(A,k),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[eR&&!en&&!eq&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eZ.i$)({type:"issue",role:"adminUplift",job:Z,quoteId:null==E?void 0:E.id,offCanvas:I,refetch:C})},size:"small",children:"Approve"}),eR&&!en&&!eq&&!e_&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return(0,eZ.Ii)({type:"issue",role:"adminUplift",job:Z,quoteId:null==E?void 0:E.id,offCanvas:I,refetch:C})},size:"small",children:"Reject"})]})}}]},{id:7,label:"Complete",info:"waiting for supplier to complete",date:M,content:[{id:1,active:M&&Q&&U,data:(0,r.jsx)(tX.Z,{size:"small",children:(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){var e;return t5({addJobTiming:j,job:Z,entityId:null===(e=Z.compliances[0])||void 0===e?void 0:e.id,userId:q.id},I)},size:"small",children:"Upload compliance Documentation"})})}],actions:[{id:1,active:!O&&M&&Q&&!U,content:"Request Documentation",context:"secondary",handleClick:function(){return ie(Z,I,C)},type:"button"},{id:2,active:!O&&M&&Q&&U,content:"No Documentation Required",context:"info",handleClick:function(){return t9({job:Z,userId:q.id,deleteJobTiming:y})},type:"button"},{id:3,active:null===Z.pricing&&!O&&M&&!F,content:"Change job pricing or service",context:"danger",handleClick:function(){return nU(Z,I,C)},type:"button"}]},{id:8,label:"Report sent",info:"after job complete",date:ed,content:[{id:1,active:ep,data:"Report submitted by supplier"},{id:2,active:!0,data:og(Z)}],actions:[{id:1,active:Z.report&&(ep||ed),content:"Download job report",context:"secondary",handleClick:function(){return(0,t_.e)({job:Z,adminId:T})},type:"button"},{id:2,active:Z.report&&!O&&(ep||ed)&&!F,content:Z.report?"Update report":"Create report",context:"info",handleClick:function(){return rP(Z,I,C)},type:"button"},{id:3,active:Z.report&&!O&&ep&&!ed&&!F,content:"Send to customer",context:"primary",handleClick:function(){return rD(Z,I,C)},type:"button"}]},{id:9,label:"Customer Sign Off",info:"",date:Q&&(J||L),active:Q,content:[{id:1,active:J,data:"Compliance sing off by ".concat((0,eS.j$)(Z,"complianceApproved"))},{id:2,active:L,data:"Compliance rejected by ".concat((0,eS.j$)(Z,"complianceRejected"))},{id:3,active:!O&&Q&&U&&!(J||L),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return t7(Z,I,C)},size:"small",children:"Approve"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return t8(Z,I,C)},size:"small",children:"Reject"})]})}}]},{id:10,label:"Threshold approval",info:"",date:(null==eE?void 0:eE.createdAt)||(null==eD?void 0:eD.createdAt),active:!!(eT||eE||eD),content:[{id:1,active:eT&&!eE&&!eD,data:"Awaiting threshold approval"},{id:2,active:eE,data:"Threshold approved by ".concat(null==eE?void 0:null===(h=eE.user)||void 0===h?void 0:h.fullName)},{id:3,active:eD,data:"Threshold rejected by ".concat(null==eD?void 0:null===(b=eD.user)||void 0===b?void 0:b.fullName)},{id:4,active:!O&&eT&&(0,eS.il)(A,$),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[eT&&!eh&&!eE&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eZ.i$)({type:"issue",role:"adminInvoice",job:Z,quoteId:null==E?void 0:E.id,offCanvas:I,refetch:C})},size:"small",children:"Approve"}),eT&&!eh&&!eE&&!eD&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return(0,eZ.Ii)({type:"issue",role:"adminInvoice",job:Z,quoteId:null==E?void 0:E.id,offCanvas:I,refetch:C})},size:"small",children:"Reject"})]})}}]},{id:11,label:"Awaiting expenses pricing",info:"",date:ey,active:!!(ej||ey)},{id:12,label:"Invoices sent",info:"after validation",date:en,content:[{id:1,active:eh,data:"Job validated"},{id:2,active:"ppm"!==Z.type&&en,data:"Invoice number ".concat(null==Z?void 0:null===(x=Z.invoices)||void 0===x?void 0:null===(g=x[0])||void 0===g?void 0:g.invoiceNumber," sent")},{id:3,active:!0,data:oj(Z)}],actions:"ppm"===Z.type?[{id:1,active:en,content:"Download customer invoice",context:"secondary",handleClick:function(){return iH("customer",Z,S,C,!1,_)},type:"button"},{id:2,active:et,content:"Download supplier invoice",context:"secondary",handleClick:function(){return iH("supplier",Z,S,C,!1,_)},type:"button"}]:[{id:1,active:!F&&!O&&ev&&!eh,content:"Change finance",context:"danger",handleClick:function(){return nQ(Z,S,C)},type:"button"},{id:2,active:!F&&!O&&ev&&!eh,content:"Update invoice address",context:"danger",handleClick:function(){return iF(Z,S,C)},type:"button"},{id:3,active:!O&&!eh&&ed&&(!ej||ey)&&!F,content:"Validate job",context:"info",handleClick:function(){return(0,eS.il)(A,$)||eE?iO(Z,j,y,S,C):(0,eZ.I_)({type:"issue",role:"adminInvoice",jobId:Z.id,accountId:q.accountId,quotationId:null==E?void 0:E.id,amount:$,offCanvas:I})},type:"button"},{id:5,active:!O&&eh&&!F,content:"Un-Validate job",context:"danger",handleClick:function(){return iN(Z,j,y,S,C)},type:"button"},{id:6,active:!O&&!en&&eh&&!F,content:"Send customer invoice",context:"primary",handleClick:function(){return iH("customer",Z,S,C,!0)},type:"button"},{id:7,active:!O&&en&&!et&&eh&&!F,content:"Send supplier invoice",context:"primary",handleClick:function(){return iH("supplier",Z,S,C,!0)},type:"button"},{id:8,active:eh&&en,content:"Download customer invoice",context:"secondary",handleClick:function(){return iH("customer",Z,S,C,!1,_)},type:"button"},{id:9,active:eh&&et,content:"Download supplier invoice",context:"secondary",handleClick:function(){return iH("supplier",Z,S,C,!1,_)},type:"button"}]},{id:13,label:"Customer ".concat(V?"paid":e$>0?"partially paid":"not paid"),date:V,active:"quote"!==Z.type,actions:[{id:1,active:!F&&!O&&!V&&(en||ei)&&eh,content:"Mark customer paid",context:"info",handleClick:function(){return t1({type:"customer",job:Z,offCanvas:I,refetch:C})},type:"button"}],content:[{id:1,active:!V&&e$,data:"Reconciled amount ".concat((0,X.Z)(e$))},{id:2,active:!V&&e$,data:"Amount outstanding ".concat((0,X.Z)(eN))}]},{id:14,label:"Supplier ".concat(em?"paid":eO>0?"partially paid":"not paid"),date:em,active:"quote"!==Z.type,actions:[{id:1,active:!F&&!O&&!em&&(et||ei)&&eh,content:"Mark supplier paid",context:"info",handleClick:function(){return t1({type:"supplier",job:Z,offCanvas:I,refetch:C})},type:"button"}],content:[{id:1,active:!em&&eO,data:"Reconciled amount ".concat((0,X.Z)(eO))},{id:2,active:!em&&eO,data:"Amount outstanding ".concat((0,X.Z)(eH))}]},{id:15,label:"Closed",info:"automatically after steps complete",date:F,actions:[{id:1,active:!O&&!F,content:"Close job",context:"danger",handleClick:function(){return eA(Z,"closed",I,C)},type:"button"},{id:2,active:!O&&!z&&!F,content:"Close and zero value job",context:"danger",handleClick:function(){return iJ(Z,I,C)},type:"button"},{id:3,active:F,content:"Re-open job",context:"danger",handleClick:function(){return om({job:Z,offCanvas:I,refetch:C})},type:"button"}]}]:[{id:1,label:"Issue Reported",date:eo,actions:[{id:1,active:!el&&!F,content:"Approve job",context:"primary",handleClick:function(){return ox({jobId:Z.id,offCanvas:S})},type:"button"}]},{id:2,label:"Closed",date:F,actions:[{id:1,active:!F,content:"Close request",context:"danger",handleClick:function(){return eA(Z,"closed",I,C)},type:"button"}]}]},oI=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,t=null==e?void 0:e.reduce(function(e,t){return"total"===n?e+=t[n]*t.qty:e+=t[n]},0);return isNaN(t)?null:t},oS=function(e){var n,t,i,o,a=e.job,s=e.user,u=e.offCanvas,l=e.offCanvasNew,c=e.refetch,d=(0,tk.q)().hasUserModule,p=(0,e2.x)().hasRole,m=(0,D.x)(),f=p("customer_user"),v=d("finances"),h=d("jobReports"),b=null==s?void 0:s.invoiceThreshold,x=null==a?void 0:null===(n=a.quotations)||void 0===n?void 0:n.find(function(e){return"quotationRejected"!==e.status}),g=oI(null==x?void 0:x.lineItems,"total"),j=g+.2*g,y=(0,ts.L)(a.timings),Z="incorrect"===a.timingStatus?a.correctEnd:(0,W.E)(a,"completed"),I=(0,W.E)(a,"complianceRejected"),S=(0,W.E)(a,"complianceApproved"),w=(null===(t=a.compliances)||void 0===t?void 0:t.length)>0,C=(0,W.E)(a,"inDispute"),R=(0,W.E)(a,"reportSent"),q=(0,W.E)(a,"invoiceSent"),_=(0,W.E)(a,"complianceRequestedDocumentation"),T="incorrect"===a.timingStatus?a.correctStart:(0,W.E)(a,"inProgress"),A=(0,W.E)(a,"upliftRequestSendCustomer"),E=(0,W.E)(a,"customerUpliftApproved"),P=(0,W.E)(a,"customerUpliftRejected"),k=(0,W.E)(a,"closed"),$=(0,eI.Xd)("customer",null==a?void 0:a.timings),O=(0,eI.nN)("customer",null==a?void 0:a.timings),N=(0,eI.OQ)("customer",null==a?void 0:a.timings),F=(0,W.E)(a,"raised"),M=(0,W.E)(a,"quoteNew"),L=(0,W.E)(a,"pending"),J=a.timings.find(function(e){return"reportedByNonLoggedUser"===e.status});return"pending"!==a.status&&"closed"!==a.status||F||M||!J?[{id:1,label:"Issue reported",info:"no assigned suppliers",date:(0,W.E)(a,"pending")||(0,W.E)(a,"raised")||(0,W.E)(a,"quoteNew")},{id:2,label:"Job offered",info:"no assigned suppliers",date:(0,W.E)(a,"offered")||(0,W.E)(a,"quoteNew")},{id:3,label:"Accepted",info:"waiting for supplier to accept the job",date:"quote"!==a.type?(0,W.E)(a,"accepted"):(0,W.E)(a,"quoteAccepted")},{id:4,label:"In progress",info:"waiting for supplier to start the job",date:T},{id:44,label:"Uplift requested",info:"waiting for you",date:T&&A,active:!!(T&&A)&&"reactive"===a.type,content:[{id:1,active:E,data:"Uplift approved by ".concat((0,eS.j$)(a,"customerUpliftApproved"))},{id:2,active:P,data:"Uplift rejected by ".concat((0,eS.j$)(a,"customerUpliftRejected"))},{id:4,active:A&&"reactive"===a.type,data:function(){var e=A&&!(E||P);return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(tX.Z,{size:"small",children:[e&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eS.il)(b,j)||O?oc(a,u,c):(0,eZ.I_)({type:"issue",role:"customer",jobId:null==a?void 0:a.id,accountId:null==s?void 0:s.accountId,quotationId:null==x?void 0:x.id,amount:j,offCanvas:u})},size:"small",children:"Approve"}),A&&(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return ol(a,u,c,!0)},size:"small",children:"Details"}),e&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return(0,eS.il)(b,j)||O?od(a,u,c):(0,eZ.I_)({type:"issue",role:"customer",jobId:null==a?void 0:a.id,accountId:null==s?void 0:s.accountId,quotationId:null==x?void 0:x.id,amount:j,offCanvas:u})},size:"small",children:"Reject"})]})})}}]},{id:8,label:"Threshold approval",info:"",date:(null==O?void 0:O.createdAt)||(null==N?void 0:N.createdAt),active:!!($||O||N),content:[{id:1,active:$&&!O&&!N,data:"Awaiting threshold approval"},{id:2,active:O,data:"Threshold approved by ".concat(null==O?void 0:null===(i=O.user)||void 0===i?void 0:i.fullName)},{id:3,active:N,data:"Threshold rejected by ".concat(null==N?void 0:null===(o=N.user)||void 0===o?void 0:o.fullName)},{id:4,active:"onHold"!==y&&$&&(0,eS.il)(b,j),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[$&&!q&&!O&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eZ.i$)({type:"issue",role:"customer",job:a,quoteId:null==x?void 0:x.id,offCanvas:u,refetch:c})},size:"small",children:"Approve"}),$&&!q&&!O&&!N&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return(0,eZ.Ii)({type:"issue",role:"customer",job:a,quoteId:null==x?void 0:x.id,offCanvas:u,refetch:c})},size:"small",children:"Reject"})]})}}]},{id:5,label:"Complete",info:"waiting for supplier to complete the job",date:Z,actions:[{id:1,active:!k&&Z&&!C&&(h||!f),content:"Dispute",context:"danger",handleClick:function(){return tR(a,u,c)},type:"button"}],content:[{id:1,active:C&&(h||!f),data:(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return tZ((0,eS.wo)(a,"inDispute"),u)},size:"small",children:"Dispute media"})}]},{id:6,label:"Report sent",info:"waiting for supplier to send report",date:R,actions:[{id:1,active:R&&(h||!f),content:"Download job report",context:"secondary",handleClick:function(){return(0,t_.e)({adminId:a.adminId,job:a})},type:"button"}]},{id:7,label:"Customer Sign Off",info:"",date:w&&(S||I),active:w,content:[{id:1,active:S,data:"Compliance report sang off by ".concat((0,eS.j$)(a,"complianceApproved"))},{id:3,active:w&&_&&!(S||I),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return t7(a,u,c)},size:"small",children:"Approve"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return t8(a,u,c)},size:"small",children:"Reject"})]})}}]},{id:8,label:"Invoice sent",info:"",date:q,actions:[{id:1,active:"ppm"!==a.type&&q&&(v||!f),content:"Download invoice",context:"secondary",handleClick:function(){return iH("customer",a,l,c,!1,m)},type:"button"},{id:2,active:"ppm"===a.type&&q&&(v||!f),content:"Download invoice",context:"secondary",handleClick:function(){return iH("customer",a,l,c,!1,m)},type:"button"}]}]:[{id:1,label:"Issue Reported",date:L,actions:[{id:1,active:!F&&!k,content:"Approve job",context:"primary",handleClick:function(){return ox({jobId:a.id,offCanvas:l})},type:"button"}]},{id:2,label:"Closed",date:k,actions:[{id:1,active:!k,content:"Close request",context:"danger",handleClick:function(){return eA(a,"closed",u,c,{shouldCalculateFinance:!1})},type:"button"}]}]},ow=function(e){var n,t,i,o,a,s,u=e.addJobTiming,l=e.job,c=e.offCanvas,d=e.offCanvasNew,p=e.refetch,m=e.user,f=null==m?void 0:m.invoiceThreshold,v=null==l?void 0:null===(n=l.quotations)||void 0===n?void 0:n.find(function(e){return"quotationRejected"!==e.status}),h=null==v?void 0:null===(t=v.lineItems)||void 0===t?void 0:t.reduce(function(e,n){return e+n.supplierTotal},0),b=(0,D.x)(),x=(null==l?void 0:null===(i=l.compliances)||void 0===i?void 0:i.length)>0,g=(0,W.E)(l,"complianceRequestedDocumentation"),j="incorrect"===l.timingStatus?l.correctEnd:(0,W.E)(l,"completed"),y="incorrect"===l.timingStatus?l.correctStart:(0,W.E)(l,"inProgress"),Z=(0,W.E)(l,"closed"),I=(0,W.E)(l,"accepted"),S=(0,W.E)(l,"supplierUpliftRequested"),w=(0,W.E)(l,"customerUpliftApproved"),C=(0,W.E)(l,"customerUpliftRejected"),R=(0,W.E)(l,"invoiceSent"),q=(0,W.E)(l,"invoiceSentSupplier"),_=(0,W.E)(l,"upliftRequestSendCustomer"),T=null===(o=l.childJobs)||void 0===o?void 0:o.find(function(e){return"quote"===e.type}),A=(0,eI.Xd)("supplier",null==l?void 0:l.timings),E=(0,eI.nN)("supplier",null==l?void 0:l.timings),P=(0,eI.OQ)("supplier",null==l?void 0:l.timings),k=(0,W.E)(l,"expensesPendingAmount"),$=(0,W.E)(l,"expensesPendingAmountResolved");return[{id:1,label:"Job offered",info:"no assigned suppliers",date:(0,W.E)(l,"offered"),active:"quote"!==l.type&&!(0,W.E)(l,"quoteAccepted")},{id:2,label:"Accepted",info:"need to accept the job",date:"quote"!==l.type?(0,W.E)(l,"accepted"):(0,W.E)(l,"quoteAccepted"),content:[{id:1,active:(0,W.E)(l,"timingChanged")&&!(0,W.E)(l,"accepted")&&l.supplier,data:"Job timing has changed, click Accept to set new attendance time or Reject if you\n          can\n        not make it"},{id:2,active:(0,W.E)(l,"pricingChanged")&&!(0,W.E)(l,"accepted")&&l.supplier,data:"Job service or pricing has changed, click Accept to confirm attendance"},{id:3,active:!0,data:function(){return!Z&&"offered"===l.status&&!I&&(0,r.jsxs)(tX.Z,{size:"small",children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return iQ({job:l,offCanvas:c,refetch:p,accountId:m.accountId})},size:"small",children:"Accept job"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return iz({job:l,offCanvas:c,refetch:p,accountId:m.accountId})},size:"small",children:"Reject job"})]})}}]},{id:3,label:"In progress",info:"click the timer to start",date:(0,W.E)(l,"inProgress"),actions:[{id:1,active:!Z&&y&&!(w||C)&&"reactive"===l.type&&!j&&!_,content:"".concat(S?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return ol(l,c,p,!1)},type:"button"},{id:2,active:y&&!T,content:"Create remedial quote",context:"success",handleClick:function(){return n4({jobId:l.id,customerId:l.customerId,locationId:l.locationId,offCanvas:c})},type:"button"},{id:3,active:T,content:"Remedial quote Q ".concat(null==T?void 0:T.number),context:"info",handleClick:function(){return n3(null==T?void 0:T.number,c)},type:"button"}]},{id:44,label:"Uplift requested",info:"",date:"reactive"===l.type&&y&&S,active:!!(y&&S),content:[{id:1,active:w,data:"Uplift request approved"},{id:2,active:C,data:"Uplift request rejected"},{id:3,active:S,data:function(){return(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return ol(l,c,p,!0)},size:"small",children:"Uplift details"})}}]},{id:4,label:"Complete",info:"upload a photo and stop timer",date:j,content:[{id:1,active:x&&g,data:(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){var e;return t5({addJobTiming:u,job:l,entityId:null===(e=l.compliances[0])||void 0===e?void 0:e.id,userId:m.id},c)},size:"small",children:"Upload compliance Documentation"})}]},{id:8,label:"Threshold approval",info:"",date:(null==E?void 0:E.createdAt)||(null==P?void 0:P.createdAt),active:!!(A||E||P),content:[{id:1,active:A&&!E&&!P,data:"Awaiting threshold approval"},{id:2,active:E,data:"Threshold approved by ".concat(null==E?void 0:null===(a=E.user)||void 0===a?void 0:a.fullName)},{id:3,active:P,data:"Threshold rejected by ".concat(null==P?void 0:null===(s=P.user)||void 0===s?void 0:s.fullName)},{id:4,active:A&&(0,eS.il)(f,h),data:function(){return(0,r.jsxs)(tX.Z,{size:"small",children:[A&&!E&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",onClick:function(){return(0,eZ.i$)({type:"issue",role:"supplier",job:l,quoteId:null==v?void 0:v.id,offCanvas:c,refetch:p})},size:"small",children:"Approve"}),A&&!E&&!P&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){return(0,eZ.Ii)({type:"issue",role:"supplier",job:l,quoteId:null==v?void 0:v.id,offCanvas:c,refetch:p})},size:"small",children:"Reject"})]})}}]},{id:5,label:"Report sent",info:"after job complete",date:(0,W.E)(l,"reportSentSupplier"),actions:[{id:1,active:(0,W.E)(l,"reportSentSupplier")||R||q,content:"View job report",context:"info",handleClick:function(){return rk(l,c)},type:"button"}]},{id:6,label:"Awaiting expenses pricing",info:"",date:$,active:!!(k||$)},{id:7,label:"Invoice sent",info:"",date:q,actions:[{id:1,active:"ppm"!==l.type&&q,content:"Download invoice",context:"secondary",handleClick:function(){return iH("supplier",l,d,p,!1,b)},type:"button"},{id:2,active:"ppm"===l.type&&q,content:"Download invoice",context:"secondary",handleClick:function(){return iH("supplier",l,d,p,!1,b)},type:"button"}]}]},oC=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,t=null==e?void 0:e.reduce(function(e,t){return"total"===n?e+=t[n]*t.qty:e+=t[n]},0);return isNaN(t)?null:t},oR=function(e){var n,t,i,o,a,s=e.job,u=e.user,l=e.offCanvas,c=e.refetch,d=null==u?void 0:u.invoiceThreshold,p=null==s?void 0:null===(n=s.quotations)||void 0===n?void 0:n.find(function(e){return"quotationRejected"!==e.status}),m=oC(null==p?void 0:p.lineItems,"total"),f=(0,ts.L)(s.timings),v="incorrect"===s.timingStatus?s.correctEnd:(0,W.E)(s,"completed"),h=(0,W.E)(s,"complianceRejected"),b=(0,W.E)(s,"complianceApproved"),x=(null===(t=s.compliances)||void 0===t?void 0:t.length)>0,g=(0,W.E)(s,"inDispute"),j=(0,W.E)(s,"reportSent"),y=(0,W.E)(s,"invoiceSent"),Z=(0,W.E)(s,"complianceRequestedDocumentation"),I="incorrect"===s.timingStatus?s.correctStart:(0,W.E)(s,"inProgress"),S=(0,W.E)(s,"upliftRequestSendCustomer"),w=(0,W.E)(s,"customerUpliftApproved"),C=(0,W.E)(s,"customerUpliftRejected"),R=(0,W.E)(s,"closed"),q=(0,eI.Xd)("customer",null==s?void 0:s.timings),_=(0,eI.nN)("customer",null==s?void 0:s.timings),T=(0,eI.OQ)("customer",null==s?void 0:s.timings);return[{id:1,label:"Issue reported",info:"no assigned suppliers",date:(0,W.E)(s,"pending")||(0,W.E)(s,"raised")||(0,W.E)(s,"quoteNew")},{id:2,label:"Job offered",info:"no assigned suppliers",date:(0,W.E)(s,"offered")||(0,W.E)(s,"quoteNew")},{id:3,label:"Accepted",info:"waiting for supplier to accept the job",date:"quote"!==s.type?(0,W.E)(s,"accepted"):(0,W.E)(s,"quoteAccepted")},{id:4,label:"In progress",info:"waiting for supplier to start the job",date:I},{id:44,label:"Uplift requested",info:"waiting for you",date:I&&S,active:!!(I&&S)&&"reactive"===s.type,content:[{id:1,active:w,data:"Uplift approved by ".concat((0,eS.j$)(s,"customerUpliftApproved"))},{id:2,active:C,data:"Uplift rejected by ".concat((0,eS.j$)(s,"customerUpliftRejected"))},{id:4,active:S&&"reactive"===s.type,data:"Uplift requested by ".concat((0,eS.j$)(s,"upliftRequestSendCustomer"))}]},{id:8,label:"Threshold approval",info:"",date:(null==_?void 0:_.createdAt)||(null==T?void 0:T.createdAt),active:!!(q||_||T),content:[{id:1,active:q&&!_&&!T,data:"Awaiting threshold approval"},{id:2,active:_,data:"Threshold approved by ".concat(null==_?void 0:null===(i=_.user)||void 0===i?void 0:i.fullName)},{id:3,active:T,data:"Threshold rejected by ".concat(null==T?void 0:null===(o=T.user)||void 0===o?void 0:o.fullName)},{id:4,active:"onHold"!==f&&q&&(0,eS.il)(d,m+.2*m),data:"Threshold requested by ".concat(null==q?void 0:null===(a=q.user)||void 0===a?void 0:a.fullName)}]},{id:5,label:"Complete",info:"waiting for supplier to complete the job",date:v,actions:[{id:1,active:!R&&v&&!g,content:"Dispute",context:"danger",handleClick:function(){return tR(s,l,c)},type:"button"}],content:[{id:1,active:g,data:(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return tZ((0,eS.wo)(s,"inDispute"),l)},size:"small",children:"Dispute media"})}]},{id:6,label:"Report sent",info:"waiting for supplier to send report",date:j,actions:[{id:1,active:j,content:"Download job report",context:"secondary",handleClick:function(){return(0,t_.e)({adminId:s.adminId,job:s})},type:"button"}]},{id:7,label:"Customer Sign Off",info:"",date:x&&(b||h),active:x,content:[{id:1,active:b,data:"Compliance report sang off by ".concat((0,eS.j$)(s,"complianceApproved"))},{id:3,active:x&&Z&&!(b||h),data:"Compliance report sang off by ".concat((0,eS.j$)(s,"complianceRequestedDocumentation"))}]},{id:8,label:"Invoice sent",info:"",date:y}]},oq=function(e,n,t,i,r,o,a,s,u){var l;return t("admin")?l=oZ({addJobTiming:e,deleteJobTiming:n,job:i,offCanvas:r,offCanvasNew:o,updateJob:a,refetch:s,hasRole:t,user:u}):t("supplier")?l=ow({addJobTiming:e,job:i,offCanvas:r,offCanvasNew:o,refetch:s,user:u}):t("customer")?l=oS({job:i,user:u,offCanvas:r,offCanvasNew:o,refetch:s}):t("tenant")&&(l=oR({addJobTiming:e,job:i,offCanvas:r,offCanvasNew:o,refetch:s,user:u})),l.forEach(function(e){e.date&&(e.date=K()(e.date).format("D MMM YYYY HH:mm"))}),l},o_=function(e){var n,t=[],i=(null===(n=e.meta)||void 0===n?void 0:n.arrivalAnytime)?"".concat(K()(e.scheduledAt).format("D MMM YYYY")," (anytime)"):K()(e.scheduledAt).format("D MMM YYYY HH:mm");return t.push({label:"Scheduled start:",value:e.timingStart?K()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&t.push({label:"Scheduled end:",value:e.timingEnd?K()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),t.push({label:"Supplier arrival:",value:i}),t};function oT(){var e=(0,m.Z)(['\n  mutation UpdateSupplierOffer(\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: ["accepted", "offered"] } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n\n    update_SupplierOffer(where: { jobId: { _eq: $jobId } }, _set: { status: "cancelled" }) {\n      returning {\n        id\n      }\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']);return oT=function(){return e},e}var oA=(0,f.Ps)(oT()),oE=function(e){var n=e.job,t=e.refetch,i=e.offCanvas,o=(0,e2.x)().user,a=(0,_.Z)((0,P.D)(oA,{onCompleted:function(e){i.close(),"supplier"===o.accountType?s().push("/dashboard"):t&&t()}}),1)[0],u=function(){var e,t=[],i=null;i={scheduledAt:null,status:"raised",supplierId:null,supplierUserId:null},t.push({status:"supplierCancel",jobId:n.id,userId:o.id,notes:null,meta:{supplierId:null===(e=n.supplier)||void 0===e?void 0:e.id}}),a({variables:{jobChanges:i,jobId:n.id,timing:t}})};return(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(ef.Z,{context:"help",content:"Please confirm that you want to revert this job to a raised status."}),(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,mt:2,children:[(0,r.jsx)(eg.Z,{content:"Cancel",context:"danger",onClick:function(){return i.close()},size:"md"}),(0,r.jsx)(eg.Z,{content:"Confirm",context:"secondary",onClick:u,size:"md"})]})]})};oE.propTypes={job:A.object.isRequired,refetch:A.func.isRequired,offCanvas:A.func.isRequired};var oD=t(64872),oP=t(22713),ok=function(e){var n,t,i,a,u,l,c,d,m,f,h=e.job,b=e.refetch,x=(0,tk.q)(),g=(0,D.x)(),j=null===(n=x.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,y=null===(i=x.admin)||void 0===i?void 0:null===(a=i.jobSetting)||void 0===a?void 0:a.jobNumberSuffix,Z=(0,o.useContext)(J.Z),I=(0,oD.a)(),S=(0,e2.x)(),w=S.user,C=S.hasRole,R=C("admin"),A=(0,ts.L)(h.timings),E="onHold"===A,G=(0,W.E)(h,"quoteOffered"),K=(0,W.E)(h,"accepted"),X="incorrect"===h.timingStatus?h.correctEnd:(0,W.E)(h,"completed"),ee="incorrect"===h.timingStatus?h.correctStart:(0,W.E)(h,"inProgress"),en=(0,W.E)(h,"disputeResolved"),et=(0,W.E)(h,"inDispute"),ei=(0,W.E)(h,"reportSent"),er=(0,W.E)(h,"quoteClosed"),eo=(0,W.E)(h,"closed"),ea=(0,_.Z)((0,P.D)(p.qD,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!h)return[3,2];return[4,(0,e_.F)(g,h.id)];case 1:e.sent(),e.label=2;case 2:return b(),[2]}})})}),1)[0],es=(0,_.Z)((0,P.D)(em.j6,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!h)return[3,2];return[4,(0,e_.F)(g,h.id)];case 1:e.sent(),e.label=2;case 2:return b(),[2]}})})}),1)[0],eu=(0,_.Z)((0,P.D)(p.r2,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!h)return[3,2];return[4,(0,e_.F)(g,h.id)];case 1:e.sent(),e.label=2;case 2:return b(),[2]}})})}),1)[0],el=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){b&&b()}}),1)[0],ec=(0,_.Z)((0,P.D)(p.k7,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!h)return[3,2];return[4,(0,e_.F)(g,h.id)];case 1:e.sent(),e.label=2;case 2:return b(),[2]}})})}),1)[0],ed="quote"===h.type?n9(h):o_(h),ep=function(){s().push("quote"===h.type?"/dashboard/issues/manage?id=".concat(h.number,"&quoted=1"):"/dashboard/issues/manage?id=".concat(h.number))},ef=function(){Z.show({content:(0,r.jsx)(tO,{job:h,refetch:b,toggleShow:Z.show}),submit:!1,title:"Put the job on hold"})},ev=function(){var e;el({variables:{id:h.id,changes:{status:null===(e=(0,tj.e)(h,"onHold"))||void 0===e?void 0:e.status},timing:{status:"resumed",jobId:h.id,userId:w.id}}})},eh=function(){Z.show({content:(0,r.jsx)(tG,{job:h,refetch:b,offCanvas:Z}),submit:!1,title:"Cancel"})},eb=function(){Z.show({content:(0,r.jsx)(oE,{job:h,refetch:b,offCanvas:Z}),submit:!1,title:"Revert"})},ex=(0,o.useCallback)(function(){I.show({content:(0,r.jsx)(oP.h,{jobId:h.id,completed:!!X,close:I.close}),title:"Roll back"})},[I,h.id,X]),eg=(C("admin")||C("supplier")&&!!(K||G))&&"paused"!==A&&!E&&"quote"!==h.type,ej=(C("admin")||C("supplier")&&!!(K||G))&&E&&"quote"!==h.type;return(0,r.jsxs)(N.Z,{children:[(0,r.jsxs)(k.Z,{expanded:!0,children:[(0,r.jsx)(O.Z,{children:(0,r.jsx)(L.Z,{variant:"h6",children:(null==h?void 0:null===(u=h.shortJobDesc)||void 0===u?void 0:u.length)>0&&(null===(l=null==h?void 0:h.shortJobDesc[0])||void 0===l?void 0:l.taxonomy.name)||h.title})}),(0,r.jsx)($.Z,{sx:{pt:0},children:(0,r.jsxs)(F.ZP,{container:!0,rowGap:1,columnSpacing:1,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:5,pt:0,display:"flex",alignItems:"center",children:[(0,r.jsx)(Q.Z,{sx:{width:"24px"}}),(0,r.jsx)(L.Z,{ml:1.5,children:"Type "})," ",(0,r.jsx)(L.Z,{ml:.5,color:"secondary",children:(null===(c=tD.x.find(function(e){return e.value===h.type}))||void 0===c?void 0:c.text)||"-"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:7,pt:0,display:"flex",alignItems:"center",children:[(0,r.jsx)(z.Z,{sx:{width:"24px"}}),(0,r.jsx)(L.Z,{ml:1.5,children:"Order"})," ",(0,r.jsx)(L.Z,{ml:.5,color:"secondary",children:(0,r.jsx)(tP.D,{id:h.id,number:h.number,invoiceNumber:null==h?void 0:null===(d=h.invoices)||void 0===d?void 0:null===(m=d[0])||void 0===m?void 0:m.invoiceNumber,type:h.type,numberPrefix:j,numberSuffix:y,isQuote:h.quoted})})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:5,display:"flex",alignItems:"center",children:[(0,r.jsx)(Y.Z,{sx:{width:"24px"}}),(0,r.jsx)(L.Z,{ml:1.5,children:"Source "}),(0,r.jsx)(L.Z,{ml:.5,color:"secondary",children:null===(f=t$.Y.find(function(e){return e.value===h.source}))||void 0===f?void 0:f.text})]}),h&&C(["admin","customer_owner","customer_manager"])&&(0,r.jsx)(F.ZP,{item:!0,xs:12,xs3:7,children:(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",startIcon:(0,r.jsx)(V.Z,{}),onClick:ep,sx:{height:"30px"},children:"Edit"})})]})})]}),C(["admin","supplier"])&&(0,W.E)(h,["accepted","quoteAccepted"])&&(0,r.jsx)(tb,{job:h}),(0,r.jsxs)(k.Z,{children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{direction:"row",spacing:3,children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Workflow"}),(0,r.jsx)(tE.B,{value:h.status})]})}),(0,r.jsxs)($.Z,{children:[(0,r.jsx)(U.v,{steps:"quote"!==h.type||(0,W.E)(h,"quoteAccepted")?oq(eu,ec,C,h,Z,I,ea,b,w):n8(es,ec,C,h,Z,I,b,ea,w,g)}),(0,r.jsx)(M.Z,{mt:2,children:ed.map(function(e){var n=e.label,t=e.value;return(0,r.jsxs)(M.Z,{direction:"row",spacing:1,children:[(0,r.jsx)(L.Z,{sx:{fontSize:"14px"},children:n}),(0,r.jsx)(L.Z,{sx:{fontSize:"14px",color:"secondary.main"},children:t})]})})}),(0,r.jsxs)(M.Z,{direction:"row",sx:{flexWrap:"wrap",rowGap:"8px",columnGap:"8px"},mt:2,children:[C("admin")&&!E&&X&&(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:function(){tA(h,Z)},size:"medium",children:"Follow On"}),C("supplier")&&!eo&&!E&&!ee&&K&&"quote"!==h.type&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:eh,size:"medium",children:"Cancel"}),C("admin")&&!eo&&!E&&!ee&&K&&"quote"!==h.type&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:eb,size:"medium",children:"Revert job"}),C(["admin","customer"])&&"quote"===h.type&&!er&&!eo&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",onClick:function(){eA(h,"quoteClosed",Z,b)},size:"medium",children:"Close"}),!E&&X&&!et&&(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:function(){tR(h,Z,b)},size:"medium",children:"Dispute"}),(C("admin")||C("supplier"))&&et&&!en&&"onHold"!==A&&(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:function(){tq(h,Z,b)},size:"medium",children:"Resolve Dispute"}),!eo&&eg&&(0,r.jsx)(H.Z,{variant:"contained",onClick:ef,size:"medium",children:"On Hold"}),!eo&&ej&&(0,r.jsx)(H.Z,{variant:"contained",onClick:ev,size:"medium",children:"Resume"}),!E&&et&&!en&&(0,r.jsx)(H.Z,{variant:"contained",color:"info",onClick:function(){return tZ((0,eS.wo)(h,"inDispute"),Z)},size:"medium",children:"Dispute media"}),R&&(X||ee)&&!ei&&!E&&!eo&&(0,r.jsx)(H.Z,{variant:"outlined",color:"danger",onClick:ex,size:"medium",children:"Roll back"})]})]})]})]})};ok.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var o$=t(90948),oO=t(83985),oN=t(93946),oH=t(46003),oF=t(99534),oM=function(e){var n=e.apiKey,t=e.center,a=e.zoom,s=e.size,u=e.scale,l=e.mapType,c=e.format,d=e.language,p=e.markers,m=e.path,f=e.region,v=(0,oF.Z)(e,["apiKey","center","zoom","size","scale","mapType","format","language","markers","path","region"]),h=(0,o.useState)(""),b=h[0],x=h[1];return(0,o.useEffect)(function(){var e=new URLSearchParams;e.append("center",t),e.append("zoom",a.toString()),e.append("size",s),e.append("scale",u),e.append("maptype",l),e.append("format",c),e.append("language",d),p&&e.append("markers",p),m&&e.append("path",m),f&&e.append("region",f),e.append("key",n),x("".concat("https://maps.googleapis.com/maps/api/staticmap","?").concat(e.toString()))},[n,t,a,s,l,c,d,p,m,f]),(0,r.jsx)("img",(0,et.Z)((0,i.Z)({},v),{src:b,alt:"Static Map"}))};oM.propTypes={apiKey:E().string.isRequired,center:E().string.isRequired,zoom:E().number,size:E().string,scale:E().number,mapType:E().string,format:E().string,language:E().string,markers:E().string,path:E().string,region:E().string},oM.defaultProps={apiKey:"YOUR_DEFAULT_API_KEY",center:"0,0",zoom:15,size:"400x200",scale:1,mapType:"roadmap",format:"png",language:"en",markers:"",path:"",region:""};var oL=t(96337),oJ=function(e){var n=e.access,t=e.address,o=e.edit,a=e.entity,s=e.entityId,u=e.id,l=e.name,c=(e.open,e.refetch),d=e.showMap,p=e.showLink,m=e.title,f=e.type,v=e.expanded,h=e.onChangeExpanded,b=e.hideExpandIcon,x=(0,oD.a)(),g=function(e){e&&c&&c()},j=function(e){e.stopPropagation(),x.show({content:(0,r.jsx)(it.H,{entity:a,entityId:s,id:u,onSubmit:g,addressId:t.id,type:f}),submit:!1,title:"Manage addresses"})},y=function(){x.show({title:"Property information",content:(0,r.jsx)(oL.w,{propertyId:s,toggleShow:x.close})})},Z=(0,ii.UC)(t);return(0,r.jsxs)(k.Z,{disableGutters:!0,expanded:v,onChange:h,children:[(0,r.jsx)(oU,(0,et.Z)((0,i.Z)({},b?{}:{expandIcon:(0,r.jsx)(B.Z,{})}),{"aria-controls":"address-content",id:"address-header",sx:{mb:0},children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,r.jsx)(L.Z,{variant:"h6",children:m}),o&&(0,r.jsx)(oN.Z,{size:"small",onClick:j,children:(0,r.jsx)(V.Z,{sx:{height:"17px",width:"17px"}})})]})})),(0,r.jsx)($.Z,{children:(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsxs)(F.ZP,{container:!0,item:!0,xs:12,rowSpacing:1,columnSpacing:1,children:[l&&(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Property"}),(0,r.jsx)(oO.O,(0,et.Z)((0,i.Z)({maxLength:17},p&&{color:"secondary",sx:{"&:hover":{cursor:"pointer"}},onClick:y}),{children:l}))]}),"invoice"===f&&t.invoicingEntity&&(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Property"}),(0,r.jsx)(oO.O,{maxLength:17,children:t.invoicingEntity})]}),"invoice"!==f&&t.name&&(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oO.O,{maxLength:17,children:t.name})]})]}),(0,r.jsxs)(F.ZP,{container:!0,item:!0,xs:6,rowSpacing:1,columnSpacing:1,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:12,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Address"}),(0,r.jsx)(L.Z,{children:t.addressLine1}),(0,r.jsx)(L.Z,{children:t.addressLine2}),(0,r.jsx)(L.Z,{children:t.addressLine3}),(0,r.jsx)(L.Z,{children:t.city}),(0,r.jsx)(L.Z,{children:t.county}),(0,r.jsx)(L.Z,{children:t.postCode})]}),n&&(0,r.jsxs)(F.ZP,{item:!0,xs:12,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Access"}),(0,r.jsx)(oO.O,{maxLength:17,children:n})]})]}),(0,r.jsx)(F.ZP,{container:!0,item:!0,xs:6,children:d&&oH.ie.map&&(0,r.jsx)(F.ZP,{item:!0,xs:12,children:(0,r.jsx)(oV,{apiKey:oH.ie.map,center:Z,markers:[Z],size:"400x300",style:{display:"block",maxWidth:"250px",width:"100%",height:"auto"}})})})]})})]})};oJ.propTypes={access:E().string,address:E().object.isRequired,edit:E().bool,entity:E().string.isRequired,entityId:E().number.isRequired,id:E().number,name:E().string,open:E().bool,refetch:E().func,showMap:E().bool,showLink:E().bool,title:E().string,type:E().string,expanded:E().bool,onChangeExpanded:E().func,hideExpandIcon:E().bool},oJ.defaultProps={edit:!1,open:!0,showMap:!1,showLink:!0,title:"Address",expanded:void 0,onChangeExpanded:function(){},hideExpandIcon:!1};var oU=(0,o$.ZP)(O.Z)(function(){return{"&.MuiButtonBase-root.Mui-expanded":{minHeight:"auto"},"& .MuiAccordionSummary-content.Mui-expanded":{marginBottom:0}}}),oV=(0,o$.ZP)(oM)(function(e){var n=e.theme;return{marginLeft:"4px",border:"1px solid ".concat(n.palette.secondary.main),borderRadius:"10px"}}),oQ=t(12547),oz=function(e){var n,t,a,s,u,c,d,p,m=e.job,f=e.refetch,v=(0,e2.x)().hasRole,h=(0,o.useState)(["job-location"]),b=h[0],x=h[1],g=((null===(n=m.location)||void 0===n?void 0:n.name)||"")+(m.sublocation?" (".concat(m.sublocation.name,")"):""),j=(0,ii.WE)(null==m?void 0:m.location,"registered"),y=null;y=(0,W.E)(m,"validated")&&(null===(t=m.meta)||void 0===t?void 0:null===(a=t.customerVATInvoice)||void 0===a?void 0:null===(s=a.invoiceInfo)||void 0===s?void 0:s.invoiceToAddress)?{address:(0,i.Z)({},m.meta.customerVATInvoice.invoiceInfo.invoiceToAddress)}:(0,ii.Hv)(m,"customer");var Z=function(e){return function(n,t){t?x(function(n){return(0,l.Z)(n).concat([e])}):x(function(n){return n.filter(function(n){return n!==e})})}};return(0,r.jsxs)(oY,{children:[m.customer&&v(["admin"])&&(0,r.jsxs)(k.Z,{expanded:b.includes("customer-content"),onChange:Z("customer-content"),children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),"aria-controls":"customer-content",id:"customer-header",children:(0,r.jsxs)(M.Z,{width:"100%",children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Customer"}),!b.includes("customer-content")&&(0,r.jsxs)(F.ZP,{container:!0,columnSpacing:2,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oO.O,{href:"/dashboard/customers/view?id=".concat(m.customer.id),maxLength:17,children:m.customer.name})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Contact"}),(0,r.jsx)(oO.O,{maxLength:17,children:null===(u=m.customerUser)||void 0===u?void 0:u.fullName})]})]})]})}),(0,r.jsx)($.Z,{sx:{pt:0},children:(0,r.jsxs)(M.Z,{spacing:1,children:[(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oQ.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(m.customer.id),children:(0,r.jsx)(L.Z,{children:m.customer.name})})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Contact"}),(0,r.jsx)(L.Z,{children:null===(c=m.customerUser)||void 0===c?void 0:c.fullName})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Email"}),(0,r.jsx)(L.Z,{children:null===(d=m.customerUser)||void 0===d?void 0:d.email})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Phone"}),(0,r.jsx)(L.Z,{children:null===(p=m.customerUser)||void 0===p?void 0:p.phone})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Spend Threshold"}),(0,r.jsx)(L.Z,{children:(0,n_.T)(m.customerSpendThreshold)})]})]})})]}),m.customer&&y&&v(["admin"])&&b.includes("customer-content")&&(0,r.jsx)(oJ,{hideExpandIcon:!0,expanded:b.includes("customer-content"),address:y.address,edit:!(0,W.E)(m,"validated"),entity:"Location",entityId:m.location.id,id:y.id,refetch:f,title:"Invoice Address",type:"invoice"}),j&&(0,r.jsx)(oJ,{expanded:b.includes("job-location"),onChangeExpanded:Z("job-location"),access:m.access,address:j.address,edit:v(["admin","customer"]),entity:"Location",entityId:m.location.id,id:j.id,name:g,showMap:!0,showLink:v(["admin","customer"]),title:"Job Location",type:"registered"}),m.customer&&y&&v(["customer"])&&(0,r.jsx)(oJ,{expanded:b.includes("customer-content"),onChangeExpanded:Z("customer-content"),address:y.address,entity:"Location",entityId:m.location.id,id:y.id,refetch:f,title:"Invoice Address",type:"invoice"})]})};oz.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var oY=(0,o$.ZP)(N.Z)(function(e){var n=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(n.palette.secondary.main),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}}),oB=function(e){var n,t,i,a,s,u,c,d,p=e.job,m=e.refetch,f=(0,o.useState)(["operating-location"]),v=f[0],h=f[1],b=(0,ii.WE)(p.supplier,"registered"),x=(0,ii.WE)(p.supplier,"operating"),g=p.supplier.contactUsers[0],j=(null===(n=p.supplierUser)||void 0===n?void 0:n.id)&&(null==g?void 0:g.user)&&(null===(t=p.supplierUser)||void 0===t?void 0:t.id)!==(null==g?void 0:g.user.id),y=function(e){return function(n,t){t?h(function(n){return(0,l.Z)(n).concat([e])}):h(function(n){return n.filter(function(n){return n!==e})})}};return(0,r.jsxs)(oW,{children:[(0,r.jsxs)(k.Z,{expanded:v.includes("supplier-content"),onChange:y("supplier-content"),children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),"aria-controls":"supplier-content",id:"supplier-header",children:(0,r.jsxs)(M.Z,{width:"100%",children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Supplier"}),!v.includes("supplier-content")&&(0,r.jsxs)(F.ZP,{container:!0,columnSpacing:2,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oO.O,{href:"/dashboard/suppliers/view?id=".concat(p.supplier.id),maxLength:17,children:p.supplier.name})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:j?"Contact":"Contact / Operative"}),(0,r.jsx)(oO.O,{maxLength:17,children:g.user.fullName})]})]})]})}),(0,r.jsx)($.Z,{sx:{pt:0},children:(0,r.jsxs)(M.Z,{spacing:1,children:[(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oQ.r,{color:"secondary",href:"/dashboard/suppliers/view?id=".concat(p.supplier.id),children:(0,r.jsx)(L.Z,{children:p.supplier.name})})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:j?"Contact":"Contact / Operative"}),(0,r.jsx)(L.Z,{children:g.user.fullName})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:j?"Contact email":"Email"}),(0,r.jsx)(L.Z,{children:null==g?void 0:null===(i=g.user)||void 0===i?void 0:i.email})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:j?"Contact phone":"Phone"}),(0,r.jsx)(L.Z,{children:null==g?void 0:null===(a=g.user)||void 0===a?void 0:a.phone})]}),p.supplierUser&&j&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Operative"}),(0,r.jsx)(L.Z,{children:p.supplierUser.fullName})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Operative email"}),(0,r.jsx)(L.Z,{children:null===(s=p.supplierUser)||void 0===s?void 0:s.email})]}),(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Operative phone"}),(0,r.jsx)(L.Z,{children:null===(u=p.supplierUser)||void 0===u?void 0:u.phone})]})]})]})})]}),b&&v.includes("supplier-content")&&(0,r.jsx)(oJ,{hideExpandIcon:!0,expanded:v.includes("supplier-content"),showMap:!0,address:b.address,entity:"Account",entityId:null===(c=p.supplier)||void 0===c?void 0:c.id,id:b.id,refetch:m,title:"Registered Address",type:"registered"}),x&&(0,r.jsx)(oJ,{expanded:v.includes("operating-location"),onChangeExpanded:y("operating-location"),showMap:!0,address:x.address,entity:"Account",entityId:null===(d=p.supplier)||void 0===d?void 0:d.id,id:x.id,refetch:m,title:"Operating Address",type:"operating"})]})};oB.defaultProps={},oB.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var oW=(0,o$.ZP)(N.Z)(function(e){var n=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(n.palette.primary.main),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}}),oG=t(90263),oK=t(67720),oX=t(24519),o0=t(32320),o1=function(e,n,t){var o,a,s,u,l=e.invoiceType,c=e.customerInfo.customerSpendThreshold,d=e.addendum,p=d.additions,m=d.deductions,f=d.discount,v=d.deposit,h=e.amountInfo,b=h.supplierAmountByTiming,x=h.vatAmount,g=h.vatRate,j=h.vatTotal,y=h.total,Z=e.expensesInfo,I=Z.expenses,S=Z.expensesTotalExVAT,w=e.rateInfo,C=w.normalRate,R=w.oohRate,q=w.premiumRate,_=w.calcWithServiceRate,T=(w.costWithServiceRateExVat,w.totalbyAmount,w.totalByTiming),A=w.timeSegmentsNormalRateDuration,E=w.timeSegmentsOohRateDuration,D=w.timeSegmentsPremiumRateDuration,P=w.timeSegmentsTotalDuration,k=w.pricing,$=w.selectedSla,O=w.serviceRateExpenses,N=w.serviceRateLabour,H=w.supplierService,F=w.selectedService,M=e.rebate,L=e.hidden,J=n.reconciledAmount,U=n.invoicedToDate,V=t.type,Q=function(e){return e?"".concat(e>0?"+":"-").concat((0,n_.T)(Math.abs(e))):""},z="supplier"===l?H:F,Y=P>z.minimumDuration?"actual":"minimum length",B=null==I?void 0:I.find(function(e){return e.vatRate!==g}),W=U-J,G=j-U,K=[{key:"Labour",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(b)})},show:_},{key:"Service Rate Labour",value:"".concat(N,"%"),calcAmount:null,show:_},{key:"Service Rate Expenses and Materials",value:"".concat(O,"%"),calcAmount:null,show:_},{key:"Time",value:"".concat((0,o0.pv)(P/60),":").concat((0,o0.pv)(P%60)," (").concat(Y,")"),calcAmount:null,show:!_},{key:"First hour rate",value:"".concat((0,n_.T)(null==C?void 0:C.firstHour)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==A?void 0:A.firstHourTotal)})},show:!_},{key:"Rate \xa3/H",value:"".concat((0,n_.T)(null==C?void 0:C.subsequentHours)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==A?void 0:A.subsequentHoursTotal)})},show:!_},{key:"First hour rate(OOH)",value:"".concat((0,n_.T)(null==R?void 0:R.firstHour)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==E?void 0:E.firstHourTotal)})},show:!_},{key:"Rate \xa3/H(OOH)",value:"".concat((0,n_.T)(null==R?void 0:R.subsequentHours)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==E?void 0:E.subsequentHoursTotal)})},show:!_},{key:"First hour rate(Premium)",value:"".concat((0,n_.T)(null==q?void 0:q.firstHour)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==D?void 0:D.firstHourTotal)})},show:!_},{key:"Rate \xa3/H(Premium)",value:"".concat((0,n_.T)(null==q?void 0:q.subsequentHours)," ").concat((null==M?void 0:M.percent)?"(+".concat(null==M?void 0:M.percent,"% rebate)"):""),calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==D?void 0:D.subsequentHoursTotal)})},show:!_},{key:"SLA",value:"(".concat(null==$?void 0:$.name," -").concat(null==$?void 0:$.entity,")"),calcAmount:function(){return""},show:!_&&"ppm"!==V},{key:"Labour",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(T)})},show:!_&&"supplier"!==l},{key:"Expenses",value:(null==M?void 0:M.percent)?"".concat((0,n_.T)(S*(1-M.percent/100))," (+").concat(M.percent,"% rebate)"):"",calcAmount:function(){return Q(S)},show:S||!1},{key:"Additions",value:null,calcAmount:function(){return Q(p)},show:p&&"supplier"!==l||!1},{key:"Deductions",value:null,calcAmount:function(){return Q(-1*m)},show:m&&"supplier"!==l||!1},{key:"supplier"===l?"Deductions":"Discount",value:null,calcAmount:function(){return Q(-1*f)},show:f||!1},{key:(0,r.jsx)(r.Fragment,{children:"Net"}),value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"=".concat((0,n_.T)(y))})},show:!0},{key:"VAT",value:!B&&"(".concat(100*g,"%)"),calcAmount:function(){return Q(x)},show:!0},{key:(0,r.jsx)(r.Fragment,{children:"Gross"}),value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"=".concat((0,n_.T)(j))})},show:!0},{key:"Rebate",value:(null==M?void 0:M.percent)?"(".concat(M.percent,"%)"):"",calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==M?void 0:M.amount)})},show:(null==M?void 0:M.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(j-(null==M?void 0:M.amount))})},show:!_&&(null==M?void 0:M.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,n_.T)(v)},show:!!v},{key:"Reconciled Amount",value:null,calcAmount:(0,r.jsx)(r.Fragment,{children:(0,n_.T)(J)}),show:J>0},{key:"Amount outstanding",value:null,calcAmount:function(){return(0,n_.T)(W)},show:!0},{key:"Amount to be invoiced",value:null,calcAmount:function(){return(0,n_.T)(G)},show:!0}],X=[{id:1,key:"Pricing",value:_?"Service Rate":"time-materials"===k?"Time & Materials":"Fixed"},{id:2,key:"Threshold",value:c&&(0,n_.T)(c)},{id:3,key:_?"":"Rate \xa3/H",value:_?"":"Adjusted by ".concat((a=(o={entity:z.entity,rebate:M}).entity,u=(null==(s=o.rebate)?void 0:s.amount)>0?"/ Rebate":"","".concat(a," ").concat("Service"," ").concat(u)))}];return{amounts:K.map(function(e,n){return(0,et.Z)((0,i.Z)({},e),{id:n+1,calcAmount:L||e.calcAmount})}).filter(function(e){return e.show}),texts:X}};o1.propTypes={job:E().object.isRequired,isOOH:E().string,multiplier:E().string,rate:E().string,selectedSla:E().string,selectedService:E().string};var o2=function(e,n,t){var o,a=e.invoiceType,s=e.customerInfo.customerSpendThreshold,u=e.addendum,l=u.additions,c=u.deductions,d=u.discount,p=u.deposit,m=e.amountInfo,f=m.amount,v=m.amountIncludingRebate,h=m.supplierLabourAmount,b=m.supplierMaterialsAmount,x=m.vatAmount,g=m.vatRate,j=m.total,y=m.vatTotal,Z=e.expensesInfo,I=Z.expenses,S=Z.expensesTotalExVAT,w=e.rateInfo,C=w.calcWithServiceRate,R=w.pricing,q=w.selectedSla,_=w.serviceRateExpenses,T=w.serviceRateLabour,A=e.rebate,E=e.hidden,D=n.reconciledAmount,P=n.invoicedToDate,k=t.type,$=function(e){return e?"".concat(e>0?"+":"-").concat((0,n_.T)(Math.abs(e))):""},O=null==I?void 0:I.find(function(e){return e.vatRate!==g}),N=P-D,H=y-P,F=[{key:"Labour",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(h)})},show:C},{key:"Service Rate Labour",value:"",calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"".concat(T,"%")})},show:C},{key:"Materials",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(b)})},show:C},{key:"Service Rate Expenses and Materials",value:"",calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"".concat(_,"%")})},show:C},{key:"Amount",value:(null==A?void 0:A.percent)?"".concat(f," (+").concat(A.percent,"% rebate)"):"",calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(v)})},show:!("supplier"===a||C)},{key:"Labour",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(h)})},show:"supplier"===a},{key:"Materials",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(b)})},show:"supplier"===a},{key:"Expenses",value:(null==A?void 0:A.percent)?"".concat((0,n_.T)(S*(1-A.percent/100))," (+").concat(A.percent,"% rebate)"):"",calcAmount:function(){return $(S)},show:!0},{key:"Additions",value:null,calcAmount:function(){return $(l)},show:l&&"supplier"!==a||!1},{key:"Deductions",value:null,calcAmount:function(){return $(-1*c)},show:c&&"supplier"!==a||!1},{key:"supplier"===a?"Deductions":"Discount",value:null,calcAmount:function(){return $(-1*d)},show:!!d},{key:(0,r.jsx)(r.Fragment,{children:"Net"}),value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"=".concat((0,n_.T)(j))})},show:!0},{key:"VAT",value:!O&&"(".concat(100*g,"%)"),calcAmount:function(){return $(x)},show:!0},{key:(0,r.jsx)(r.Fragment,{children:"Gross"}),value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:"=".concat((0,n_.T)(y))})},show:!0},{key:"Rebate",value:(null==A?void 0:A.percent)?"(".concat(A.percent,"%)"):"",calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(null==A?void 0:A.amount)})},show:(null==A?void 0:A.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(y-(null==A?void 0:A.amount))})},show:(null==A?void 0:A.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,n_.T)(p)},show:!!p},{key:"Reconciled Amount",value:null,calcAmount:(0,r.jsx)(r.Fragment,{children:(0,n_.T)(D)}),show:D>0},{key:"Amount outstanding",value:null,calcAmount:function(){return(0,n_.T)(N)},show:!0},{key:"Amount to be invoiced",value:null,calcAmount:function(){return(0,n_.T)(H)},show:!0}],M=[{id:1,key:"Pricing",value:C?"Service Rate":R||"Fixed"},{id:2,key:"Threshold",value:s&&(0,n_.T)(s)},{id:3,key:"SLA",value:"ppm"!==k?(null==q?void 0:q.name)||(null==q?void 0:null===(o=q.sla)||void 0===o?void 0:o.name):"N/A"}];return{amounts:F.map(function(e,n){return(0,et.Z)((0,i.Z)({},e),{id:n+1,calcAmount:E||e.calcAmount})}).filter(function(e){return e.show}),texts:M}};o2.propTypes={job:E().object.isRequired,selectedSla:E().string};var o4=t(97432),o3=function(e){var n=e.filter(function(e){return ip.cJ.includes(e.invoiceType)});return{invoicedToDate:null==e?void 0:e.reduce(function(e,n){var t;return e+(Number(null===(t=n.amounts)||void 0===t?void 0:t.vatTotal)||0)},0),reconciledAmount:null==e?void 0:e.reduce(function(e,n){var t,i,r,o;return e+(Number(null==n?void 0:null===(t=n.reconciledAmount)||void 0===t?void 0:null===(i=t.reconciliations)||void 0===i?void 0:null===(r=i.aggregate)||void 0===r?void 0:null===(o=r.sum)||void 0===o?void 0:o.amount)||0)},0),proformaInvoiceVatTotal:null==n?void 0:n.reduce(function(e,n){var t;return e+(Number(null===(t=n.amounts)||void 0===t?void 0:t.vatTotal)||0)},0)}},o6=function(e){var n,t,i,r,o,a,s=e.financeSupplier,u=e.financeCustomer,l=null==s?void 0:null===(n=s.amountInfo)||void 0===n?void 0:n.total,c=null==u?void 0:null===(t=u.amountInfo)||void 0===t?void 0:t.total,d=(null==u?void 0:null===(i=u.amountInfo)||void 0===i?void 0:i.vatTotal)-(null==u?void 0:null===(r=u.rebate)||void 0===r?void 0:r.amount),p=(0,o4.l)(c-l,2),m=(0,o4.l)(p/c*100,2),f=(0,o4.l)(d-l,2),v=(0,o4.l)(f/d*100,2);return!(null==u?void 0:null===(o=u.rateInfo)||void 0===o?void 0:o.calcWithServiceRate)&&(null==u?void 0:null===(a=u.rebate)||void 0===a?void 0:a.percent)?{netProfitAmount:f,netProfitMargin:v}:{netProfitAmount:p,netProfitMargin:m}},o5=function(e){var n=e.job,t=e.type,i=e.financeSupplier,a=e.financeCustomer,s=(0,e2.x)().hasRole,u=s("customer"),l=s("customer_user"),c=s("tenant_user"),d=(0,o.useState)([]),p=d[0],m=d[1],f=(0,o.useState)([]),v=f[0],h=f[1],b=(0,o.useState)(),x=b[0],g=b[1],j=(0,o.useState)(),y=j[0],Z=j[1],I=(0,W.E)(n,"invoiceSent");(0,o.useEffect)(function(){var e,r="supplier"===t?i:a;u&&!I&&(r.hidden="N/A");var o=null==n?void 0:null===(e=n.invoices)||void 0===e?void 0:e.filter(function(e){return ip.SR[t].includes(e.invoiceType)}),s=o3(o),l="time-materials"===n.pricing?o1(r,s,n):o2(r,s,n),c=l.amounts;h(l.texts),m(c);var d=o6({financeCustomer:a,financeSupplier:i}),p=d.netProfitAmount,f=d.netProfitMargin;g((0,n_.T)(p||0)),Z("".concat(f||0,"%"))},[u,n,t,I,i,a,l,c]);var S=(0,o.useMemo)(function(){return[{field:"key",flex:1,sortable:!1,renderCell:function(e){var n=e.value,t="function"==typeof n?n():n;return(0,r.jsx)(tl.Z,{title:t,children:t})}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var n=e.value,t="function"==typeof n?n():n;return(0,r.jsx)(tl.Z,{title:t,children:t})}},{field:"calcAmount",flex:1,sortable:!1,align:"right",renderCell:function(e){var n=e.value,t="function"==typeof n?n():n;return(0,r.jsx)(tl.Z,{title:t,children:t})}}]},[]);return(0,r.jsxs)(M.Z,{spacing:2,children:[v.length>0&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(M.Z,{direction:"row",justifyContent:"space-between",spacing:2,sx:{pl:"10px",pr:"10px"},children:v.map(function(e){var n=e.key,t=e.value;return(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:n}),(0,r.jsx)(L.Z,{children:t})]})})}),(0,r.jsx)(oK.Z,{})]}),p.length>0&&(0,r.jsx)(eX.i,{hideHeader:!0,columns:S,rows:p,getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}}),s("admin")&&"customer"===t&&(0,r.jsxs)(F.ZP,{container:!0,pl:"10px",pr:"10px",children:[(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Net Profit"}),(0,r.jsx)(L.Z,{children:x})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:8,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Net Profit Margin"}),(0,r.jsx)(L.Z,{children:y})]})]})]})};function o7(){var e=(0,m.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      pendingAmount\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']);return o7=function(){return e},e}function o8(){var e=(0,m.Z)(["\n  mutation InsertExpense(\n    $objects: [Expense_insert_input!]!\n    $pendingAmountJobTiming: [JobTiming_insert_input!]!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldAddPendingAmount: Boolean!\n    $shouldRemovePendingAmountResolved: Boolean!\n  ) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $pendingAmountJobTiming) @include(if: $shouldAddPendingAmount) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere)\n      @include(if: $shouldRemovePendingAmountResolved) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return o8=function(){return e},e}function o9(){var e=(0,m.Z)(["\n  mutation UpdateExpense(\n    $id: Int!\n    $changes: Expense_set_input\n    $pendingAmountJobTiming: [JobTiming_insert_input!]!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldAddPendingAmount: Boolean!\n    $shouldRemovePendingAmountResolved: Boolean!\n  ) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $pendingAmountJobTiming) @include(if: $shouldAddPendingAmount) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere)\n      @include(if: $shouldRemovePendingAmountResolved) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return o9=function(){return e},e}function ae(){var e=(0,m.Z)(["\n  mutation DeleteExpense(\n    $id: Int!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldRemovePendingAmount: Boolean!\n  ) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere) @include(if: $shouldRemovePendingAmount) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return ae=function(){return e},e}o5.defaultProps={},o5.propTypes={job:E().object.isRequired,type:E().oneOf(["customer","supplier"]).isRequired,financeSupplier:E().object.isRequired,financeCustomer:E().object.isRequired};var an=(0,f.Ps)(o7()),at=(0,f.Ps)(o8()),ai=(0,f.Ps)(o9()),ar=(0,f.Ps)(ae()),ao=(0,eu.Ry)().shape({amount:(0,eu.Rx)().when("pendingAmount",{is:function(e){return!1===e},then:function(e){return(0,eu.Rx)().required()}}),unit:(0,eu.Rx)().min(0).required(),categoryId:(0,eu.Ry)().required(),description:(0,eu.Z_)().required(),markup:(0,eu.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),paid:(0,eu.Z_)().when("isAdmin",{is:function(e){return!0===e},then:function(){return(0,eu.Z_)().oneOf(["admin","supplier"]).required()}}),vatMarkup:(0,eu.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),pendingAmount:(0,eu.O7)()}),aa=[{id:"admin",label:"Admin",value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],as=[{id:"pendingAmount",label:"Pending amount",value:!0}],au=[{id:"default",label:"Default (20%)",value:"20"},{id:"custom",label:"Custom",value:"custom"}],al=function(e){var n,t=e.defaultValues,a=e.submit,s=e.serviceRateExpenses,u=(0,(0,e2.x)().hasRole)("admin"),l=(0,ei.cI)({defaultValues:(0,i.Z)({vat:"20"},t),resolver:(0,er.S)(ao),context:{isAdmin:u}}),c=l.control,d=l.errors,p=l.handleSubmit,m=l.register,f=l.watch,v=l.setValue,h=(0,o.useState)(!1),b=h[0],x=h[1],g=f("vat"),j=f("pendingAmount");(0,o.useEffect)(function(){(null==t?void 0:t.vat)&&(null==t?void 0:t.vat)!=="20"?(v("vatMarkup",t.vat),v("vat","custom")):v("vat","20")},[j]);var y=(n=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){switch(t.label){case 0:n=(0,et.Z)((0,i.Z)({},e),{paid:u?e.paid:"supplier"}),t.label=1;case 1:return t.trys.push([1,,3,4]),x(!0),[4,a(n)];case 2:return t.sent(),[3,4];case 3:return x(!1),[7];case 4:return[2]}})}),function(e){return n.apply(this,arguments)}),Z={control:c,errors:d,register:m};return b?(0,r.jsx)(M.Z,{direction:"row",justifyContent:"center",children:(0,r.jsx)(nP.Z,{color:"secondary"})}):(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:p(y),children:[u&&(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},Z),{name:"paid",data:aa,legend:"Paid by"})),(0,r.jsx)(ev.Z,(0,et.Z)((0,i.Z)({},Z),{data:as,name:"pendingAmount"})),!j&&(0,r.jsx)(r2.Z,(0,et.Z)((0,i.Z)({},Z),{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,r.jsx)(eb.Z,{label:"Units",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},Z),{name:"unit"}))}),!j&&(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},Z),{name:"vat",data:au,legend:"VAT"})),!j&&"custom"===g&&(0,r.jsx)(eV.Z,(0,et.Z)((0,i.Z)({},Z),{label:"Custom VAT",name:"vatMarkup"})),!j&&!!s&&(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},Z),{name:"markup",type:"hidden"})),!j&&!s&&u&&(0,r.jsx)(eV.Z,(0,et.Z)((0,i.Z)({},Z),{label:"Markup ".concat(s?"(Service Rate Expenses and Materials : ".concat(s,"%)"):""),name:"markup"})),(0,r.jsx)(es.P,(0,et.Z)((0,i.Z)({},Z),{errors:(0,i.Z)({},d),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},Z),{name:"description",rows:2}))}),t.id&&(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},Z),{name:"id",type:"hidden"}))]})};al.propTypes={defaultValues:A.object,serviceRateExpenses:A.number,submit:A.func.isRequired,submitting:A.bool.isRequired},al.defaultProps={serviceRateExpenses:0,submitting:!1};var ac=function(e,n,t){var r=0,o=0,a=null==e?void 0:e.filter(function(e){return"supplier"===t&&"supplier"===e.paid||"supplier"!==t});return{preparedExpenses:null==a?void 0:a.map(function(e){var a=e.amount;"supplier"!==t&&(a+=e.markup/100*a,a/=1-n/100);var s=a*(e.unit||1),u=s+s*(e.vat/100);return o+=s,r+=u,(0,et.Z)((0,i.Z)({},e),{id:e.id,name:e.description,unitCost:a,price:s,total:u,unit:e.unit||1,vatAmount:s*(e.vat/100),vatRate:e.vat/100,markup:e.markup})}),totalExpenses:r,totalExpensesExVAT:o}},ad=t(5336),ap=t(41687),am=function(e){var n,t,a,s,u,l=e.job,d=e.refetchParent,p=e.tab,m=e.expanded,f=e.onChangeExpanded,v=(0,D.x)(),h=(0,e2.x)(),b=h.hasRole,x=h.user,g=(0,o.useContext)(J.Z),j=(0,W.E)(l,"invoiceSent"),y=(0,W.E)(l,"closed"),Z=b("customer")&&!j,I=!l||!y&&(b(["admin"])&&!(0,W.E)(l,["validated","unvalidated"])||b(["admin","supplier"])&&!(0,W.E)(l,"reportSent")),S=(0,e1.B)("serviceRateExpenses",null==l?void 0:l.financeLogs,null==l?void 0:null===(n=l.customer)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:null===(a=t.finance)||void 0===a?void 0:a.serviceRateExpenses)||0,w=p||(!b("admin")&&b("supplier")?"supplier":"admin"),C=(0,c.aM)(an,{variables:{jobId:l.id},skip:Z}),R=C.data,A=(void 0===R?{expenses:[]}:R).expenses,E=C.loading,N=C.refetch,H=ac(A,0,w),U=H.preparedExpenses,V=H.totalExpenses,Q=H.totalExpensesExVAT,z=U.length>0&&U.length===U.filter(function(e){return e.pendingAmount}).length,Y=(0,_.Z)((0,P.D)(ar,{onCompleted:function(){l&&(0,e_.F)(v,l.id),d(),N()}}),1)[0],B=(0,_.Z)((0,P.D)(at,{onCompleted:function(){l&&(0,e_.F)(v,l.id),g.close(),d(),N()}}),1)[0],G=(0,_.Z)((0,P.D)(ai,{onCompleted:function(){l&&(0,e_.F)(v,l.id),g.close(),d(),N()}}),1)[0],K=(s=(0,q.Z)(function(e){var n,t,r,o,a,s,u,c,d,p,m,f,h;return(0,T.__generator)(this,function(a){switch(a.label){case 0:return"custom"===e.vat&&(e.vat=e.vatMarkup),r=(t=(n=(e.unit||0)*(e.amount||0))*((e.markup||0)/100)+n)*((e.vat||0)/100)+t,o={id:e.id,paid:e.paid,markup:e.markup||0,description:e.description,categoryId:e.categoryId.value,unit:e.unit,pendingAmount:e.pendingAmount,amount:e.amount||0,vat:e.vat||0,total:r},[4,v.query({query:an,variables:{jobId:l.id}})];case 1:if(c=(u=(void 0===(s=a.sent().data)?{expenses:[]}:s).expenses).find(function(n){return n.id===+e.id})||{},d=u.filter(function(n){var t=n.id;return n.pendingAmount&&t!==+e.id}),p=e.pendingAmount,m=c.pendingAmount&&!e.pendingAmount&&d.length<=0,f=[],h={},p&&(f.push({status:"expensesPendingAmount",notes:e.description,userId:x.id,jobId:l.id}),h.status={_eq:"expensesPendingAmountResolved"},h.jobId={_eq:l.id}),m&&f.push({status:"expensesPendingAmountResolved",userId:x.id,jobId:l.id}),!o.id)return[3,3];return[4,G({variables:{id:o.id,changes:o,pendingAmountJobTiming:f,pendingAmountJobTimingWhere:h,shouldAddPendingAmount:!!p||!!m,shouldRemovePendingAmountResolved:!!p}})];case 2:return a.sent(),[3,5];case 3:return[4,B({variables:{objects:(0,et.Z)((0,i.Z)({},o),{jobId:null==l?void 0:l.id}),pendingAmountJobTiming:f,pendingAmountJobTimingWhere:h,shouldAddPendingAmount:!!p||!!m,shouldRemovePendingAmountResolved:!!p}})];case 4:a.sent(),a.label=5;case 5:return[2]}})}),function(e){return s.apply(this,arguments)}),X=function(e){return function(n){n.stopPropagation();var t=(null==e?void 0:e.item)?(0,i.Z)({},null==e?void 0:e.item):{markup:S};(null==t?void 0:t.vat)&&(t.vat=String(t.vat)),g.show({content:(0,r.jsx)(al,{defaultValues:t,submit:K,serviceRateExpenses:S}),title:"Expenses"})}},ee=(u=(0,q.Z)(function(e,n){var t,i,r,o,a,s;return(0,T.__generator)(this,function(t){switch(t.label){case 0:return e.preventDefault(),e.stopPropagation(),[4,v.query({query:an,variables:{jobId:l.id}})];case 1:return o=(0,(void 0===(i=t.sent().data)?{expenses:[]}:i).expenses).filter(function(e){var t=e.id;return e.pendingAmount&&t!==+n.id}),a=n.pendingAmount&&o.length<=0,s={},a&&(s.status={_eq:"expensesPendingAmount"},s.jobId={_eq:l.id}),[4,Y({variables:{id:n.item.id,shouldRemovePendingAmount:a,pendingAmountJobTimingWhere:s}})];case 2:return t.sent(),[2]}})}),function(e,n){return u.apply(this,arguments)}),en=function(e){g.show({content:(0,r.jsx)(ty.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})},ei=function(e){return[{context:"secondary",icon:"edit",onClick:function(n){return X(e)(n)},tooltip:"Edit"},{context:"info",icon:"uploadFile",onClick:function(n){return en(e)},tooltip:"Media"},{context:"danger",icon:"delete",onClick:function(n){return ee(n,e)},tooltip:"Delete"}]};return(0,r.jsxs)(k.Z,{expanded:m,onChange:f,children:[(0,r.jsx)(O.Z,{children:(0,r.jsxs)(M.Z,{width:"100%",spacing:2,children:[(0,r.jsx)(L.Z,{variant:"h6",children:" Expenses"}),(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{children:"Total"}),(0,r.jsx)(L.Z,{children:z?"N/A":(0,n_.T)(Q)})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:8,children:[(0,r.jsx)(L.Z,{children:"VAT Total"}),(0,r.jsx)(L.Z,{children:z?"N/A":(0,n_.T)(V)})]})]})]})}),(0,r.jsx)($.Z,{sx:{pt:0},children:(0,r.jsxs)(M.Z,{width:"100%",children:[(0,r.jsx)(eX.i,{columns:[{field:"description",headerName:"Description",flex:1,sortable:!1},{field:"total",headerName:"Total",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return e.row.pendingAmount?"Pending":(0,n_.T)(n)}},{field:"paid",headerName:"Paid By",flex:1,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsx)(ad.C,{actionsData:ei,row:n})},hide:!I}],rows:null==U?void 0:U.map(function(e){var n,t;return{id:e.id,description:e.description,total:e.total,paid:e.paid.charAt(0).toUpperCase()+e.paid.slice(1),actions:"",item:(0,i.Z)({},e,{occurredAt:new Date(e.occurredAt)},{categoryId:{label:null===(n=e.category)||void 0===n?void 0:n.name,value:e.categoryId}}),mediaCount:null===(t=e.media)||void 0===t?void 0:t.length,pendingAmount:e.pendingAmount}}),loading:E,noResultsMessage:"There are currently no expenses.",columnVisibilityModel:{actions:I}}),I&&(0,r.jsx)(oN.Z,{onClick:X(),sx:{alignSelf:"center"},children:(0,r.jsx)(ap.Z,{})})]})})]})};am.defaultProps={refetchParent:function(){},onChangeExpanded:function(){}},am.propTypes={job:E().object,refetchParent:E().func,tab:E().oneOf(["supplier","customer"]),expanded:E().bool,onChangeExpanded:E().func};var af=t(43800);function av(){var e=(0,m.Z)(["\n  query getReconciliation($accountEntryId: Int!) {\n    reconciliation: Reconciliation(where: { InvoiceEntry: { id: { _eq: $accountEntryId } } }) {\n      amount\n      createdAt\n      id\n      creditEntity\n      creditEntityId\n      meta\n      paymentEntry: PaymentEntry {\n        id\n        meta\n        credit\n      }\n    }\n    meta: Reconciliation_aggregate(where: { InvoiceEntry: { id: { _eq: $accountEntryId } } }) {\n      aggregate {\n        total: sum {\n          amount\n        }\n      }\n    }\n  }\n"]);return av=function(){return e},e}function ah(){var e=(0,m.Z)(["\n  mutation AddCreditNote(\n    $job: Job_set_input!\n    $jobId: Int!\n    $timing: [JobTiming_insert_input!]!\n    $isPaid: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $job) @include(if: $isPaid) {\n      id\n    }\n\n    insert_JobTiming(objects: $timing) @include(if: $isPaid) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return ah=function(){return e},e}function ab(){var e=(0,m.Z)(["\n  mutation AddCreditNote($object: AccountEntry_insert_input!) {\n    insert_AccountEntry_one(object: $object) {\n      id\n    }\n  }\n"]);return ab=function(){return e},e}var ax=(0,f.Ps)(av()),ag=(0,f.Ps)(ah()),aj=(0,f.Ps)(ab()),ay=function(e){var n=e.loading,t=e.reconciliation;return(0,r.jsx)(r0.Z,{columns:[{hidden:!0},{hidden:!0},{text:"Type"},{formatter:function(e){var n=e.row;return(0,X.Z)(n.amountReceived)},text:"Payment Amount "},{formatter:function(e){var n=e.row;return(0,X.Z)(n.reconciledAmount)},text:"Reconciled"},{text:"Date"},{hidden:!0,text:"Reference"},{hidden:!0},{hidden:!0}],loading:n,rows:t.map(function(e){var n,t,i,r;return{id:e.id,creditEntityId:e.creditEntityId,creditEntity:e.creditEntity,amountReceived:e.paymentEntry.credit,reconciledAmount:e.amount,dateReceived:(0,ee.Z)(e.createdAt),paymentReference:(null===(n=e.paymentEntry)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:t.paymentReference)||"-",comment:(null===(i=e.paymentEntry)||void 0===i?void 0:null===(r=i.meta)||void 0===r?void 0:r.comment)||"-",meta:e.meta}})})};ay.propTypes={loading:A.bool,reconciliation:A.array};var aZ=function(e){var n=e.accountEntryId,t=e.currency,i=(0,c.aM)(ax,{variables:{accountEntryId:n}}),o=i.loading,a=i.data,s=void 0===a?{reconciliation:[],meta:{aggregate:{total:{amount:0}}}}:a,u=s.reconciliation,l=s.meta;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("strong",{children:"Reconciliation"}),(0,r.jsx)(e7.Z,{content:"Total",text:(0,X.Z)(l.aggregate.total.amount,t)}),(0,r.jsx)(ay,{loading:o,reconciliation:u})]})};aZ.propTypes={currency:A.string.isRequired,accountEntryId:A.number.isRequired};var aI=t(83395),aS=function(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return(null==n?void 0:null===(e=n.items)||void 0===e?void 0:e.map(function(e){return{type:e.type,unit:e.minutes,description:e.name,price:e.itemTotal,gross:e.itemTotalIncVAT,unitCost:e.rate,net:e.minutes*(e.rate||1),vat:e.rate*e.minutes*1.2-(e.rate*e.minutes||1),vatPercent:100*e.vatRate}}))||[]},aw=function(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return null==n?void 0:null===(e=n.items)||void 0===e?void 0:e.map(function(e){return{description:e.description,unit:e.unit,rate:e.rate,net:e.unit*e.rate,vatRate:100*e.vatRate,vat:e.unit*e.rate*e.vatRate,gross:e.unit*e.rate*(e.vatRate+1)}})},aC=function(e){var n=e.unit,t=void 0===n?0:n,i=e.unitCost,r=void 0===i?0:i,o=e.vatPercent,a=void 0===o?0:o;return{net:t*r||0,vatTotal:r*t*(1+a)-r*t||0,gross:r*t*(1+a)||0,price:r*(t||1)}},aR=function(e){var n=e.type,t=e.invoiceType,i=e.vatId,r={type:n,vat:"default",vatPercent:20,vatDefault:20};return"ProformaInvoiceSupplier"!==t||(0,aI.b)(i)||(r.vatPercent=0,r.vatDefault=0),r},aq=function(e){var n=e.rowData,t=e.invoiceType,r=e.vatId,o=(0,et.Z)((0,i.Z)({},n),{vat:"default",vatDefault:20});return 20!==Number(n.vatPercent)&&(o.vat="custom"),"ProformaInvoiceSupplier"!==t||(0,aI.b)(r)||0===Number(n.vatPercent)||(o.vat="custom",o.vatDefault=0),o},a_=(0,eu.Ry)().shape({type:(0,eu.Z_)().oneOf((0,l.Z)(ip.cJ)).required(),description:(0,eu.Z_)(),dueDate:(0,eu.Z_)().required()}),aT=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;return[{id:"default",label:"Default (".concat(e,"%)"),value:"default"},{id:"custom",label:"Custom",value:"custom"}]},aA=function(e){var n=e.defaultValues,t=e.editMode,a=e.toggleShow,s=e.onSuccess,u=n.vat,l=n.vatPercent,c=n.vatDefault,d=(0,ei.cI)({defaultValues:(0,et.Z)((0,i.Z)({},n),{vat:u,vatPercent:l})}),p=d.control,m=d.errors,f=d.handleSubmit,v=d.register,h=d.watch,b=d.setValue,x=h("unitCost"),g=h("unit"),j=h("vat"),y=h("vatPercent");(0,o.useEffect)(function(){"default"===j&&b("vatPercent",c)},[j]);var Z,I=aC({unit:g,unitCost:x,vatPercent:y/100}),S=I.net,w=I.vatTotal,C=I.gross,R=I.price,_=(Z=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return s((0,et.Z)((0,i.Z)({},e),{price:R,net:S,vat:w,gross:C,vatPercent:y})),[2]})}),function(e){return Z.apply(this,arguments)}),A={control:p,errors:m,register:v};return(0,r.jsxs)(eo.Z,{handleSubmit:f(_),children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},A),{name:"description",rows:2}))})})}),(0,r.jsxs)(e$.Z,{children:[(0,r.jsx)(eO.Z,{md:8,children:(0,r.jsx)(r2.Z,(0,et.Z)((0,i.Z)({},A),{name:"unitCost",label:"Unit Cost",vat:"Ex VAT",min:.01}))}),(0,r.jsx)(eO.Z,{md:4,children:(0,r.jsx)(eb.Z,{label:"Units",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},A),{name:"unit",type:"number",step:"1",min:1}))})})," ",(0,r.jsxs)(eO.Z,{md:12,children:[(0,r.jsx)(eb.Z,{label:"VAT %"}),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},A),{name:"vat",data:aT(c)})),(0,r.jsx)(eV.Z,(0,et.Z)((0,i.Z)({},A),{label:"Custom VAT",name:"vatPercent",show:"custom"===j}))]})]}),(0,r.jsxs)(ej.Z,{children:["Net: ",(0,X.Z)(S)]}),(0,r.jsxs)(ej.Z,{children:["VAT: ",(0,X.Z)(w)]}),(0,r.jsxs)(ej.Z,{children:["Gross: ",(0,X.Z)(C)]}),(0,r.jsxs)(e$.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,r.jsx)(eg.Z,{content:"Back",onClick:a,style:{margin:"0 5px"},context:"danger"}),(0,r.jsx)(eg.Z,{content:t?"Save":"Add",type:"submit"})]}),(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},A),{name:"id",type:"hidden"})),(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},A),{name:"type",type:"hidden"})),(0,r.jsx)("div",{style:{clear:"both"}})]})};function aE(){var e=(0,m.Z)(["\n  width: 100%;\n  margin: 1rem 0;\n"]);return aE=function(){return e},e}function aD(){var e=(0,m.Z)(["\n  margin: 0;\n  display: flex;\n  justify-content: space-between;\n"]);return aD=function(){return e},e}function aP(){var e=(0,m.Z)(["\n  margin: 0 0 0 auto;\n  display: flex;\n  flex-direction: column;\n  width: 144px;\n"]);return aP=function(){return e},e}aA.propTypes={defaultValues:A.object,editMode:A.bool,toggleShow:A.bool,type:A.string,onSuccess:A.func};var ak=[{id:"ProformaInvoiceCustomer",label:"Customer invoice",value:"ProformaInvoiceCustomer"},{id:"ProformaInvoiceSupplier",label:"Supplier invoice",value:"ProformaInvoiceSupplier"}],a$=function(e){var n,t,a,s,u=e.job,c=e.showDetails,d=e.defaultValues,p=e.toggleShow,m=(0,oD.a)(),f=(0,nk.D)(),v=(0,ei.cI)({resolver:(0,er.S)(a_),defaultValues:{description:null==d?void 0:null===(n=d.configs)||void 0===n?void 0:n.descriptionInvoice,type:"ProformaInvoiceCustomer"}}),h=v.control,b=v.errors,x=v.handleSubmit,g=v.register,j=v.watch,y=v.setValue,Z=j("type");(0,o.useEffect)(function(){c||("ProformaInvoiceCustomer"===Z?y("dueDate",(0,iP.I)({job:u,type:"customer",invoiceDate:new Date})):y("dueDate",(0,iP.I)({job:u,type:"supplier",invoiceDate:new Date})))},[Z]);var I,S=(0,o.useState)(aS(null==d?void 0:null===(t=d.accountEntry)||void 0===t?void 0:t.meta)),w=S[0],C=S[1],R=(0,_.Z)((0,P.D)(iw.bK,{refetchQueries:["getInvoices","GetJob"],onCompleted:function(){f.show({content:"Ad-hoc invoice was created"}),p()},onError:function(e){f.show({content:"Error: ".concat(e.message),color:"error"})}}),2),A=R[0],E=R[1].loading,D=(I=(0,q.Z)(function(e){var n,t,i;return(0,T.__generator)(this,function(r){switch(r.label){case 0:return n=e.type,t=e.description,i=e.dueDate,[4,A({variables:{jobId:u.id,invoiceType:n,description:t,dueDate:K()(i).toISOString(),items:w}})];case 1:return r.sent(),[2]}})}),function(e){return I.apply(this,arguments)}),k=function(e){if(e.id){var n=Number(e.id),t=w.map(function(t){return t.id!==n?t:(0,i.Z)({},e)});C((0,l.Z)(t))}else{e.id=(null==w?void 0:w.length)+1;var r=w.concat(e);C((0,l.Z)(r))}m.close()},$=function(e){var n,t=aR({type:e,invoiceType:Z,vatId:null===(n=u.supplier)||void 0===n?void 0:n.vatId});m.show({content:(0,r.jsx)(aA,{onSuccess:k,toggleShow:m.close,defaultValues:t}),submit:!1,title:"Insert Item",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},O=function(e,n){var t,i=aq({rowData:n.rowData,invoiceType:Z,vatId:null===(t=u.supplier)||void 0===t?void 0:t.vatId});m.show({content:(0,r.jsx)(aA,{editMode:!0,onSuccess:k,toggleShow:m.close,defaultValues:i}),submit:!1,title:"Edit Item",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},N=function(e,n){w.splice(w.findIndex(function(e){return e.id===n.id}),1),C((0,l.Z)(w))},H=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!1,text:"Quantity"},{hidden:!1,text:"Rate"},{hidden:!1,text:"Net"},{hidden:!1,text:"VAT % "},{hidden:!1,text:"VAT"},{hidden:!1,text:"Gross"},{hidden:!0},{formatter:rX.Z,formatterData:(0,r1.N)(null,{onEditClick:O,onDeleteClick:N}),text:"Actions",hidden:c}],F=w.reduce(function(e,n){return e+(n.net||0)},0),M=w.reduce(function(e,n){return e+(n.vat||0)},0),L=w.reduce(function(e,n){return e+(n.gross||0)},0),J={control:h,errors:b,register:g};return E?(0,r.jsx)(e$.Z,{style:{justifyContent:"center",alignItems:"center"},children:(0,r.jsx)(nP.Z,{size:30})}):(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:x(D),children:[!(0,l.Z)(ip.pX).concat((0,l.Z)(ip.YK)).includes(null==d?void 0:d.invoiceType)&&(0,r.jsxs)(r.Fragment,{children:[!c&&(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},J),{name:"type",data:ak}))})}),(0,r.jsx)(e$.Z,{children:(0,r.jsxs)(eO.Z,{md:12,children:[(0,r.jsx)(tU.Z,{}),(0,r.jsxs)(aO,{align:"center",justify:"between",children:[(0,r.jsx)(ej.Z,{children:"Labour"}),!c&&(0,r.jsx)(eg.Z,{content:"Insert Labour Item",context:"secondary",onClick:function(){return $("Labour")},size:"sm"})]}),(0,r.jsx)(r0.Z,{columns:H,rows:w.filter(function(e){return"Labour"===e.type}).map(function(e,n){return{id:n,description:e.description,units:e.unit,unitCost:(0,X.Z)(null==e?void 0:e.unitCost),net:(0,X.Z)(e.net),vatPercent:"".concat(e.vatPercent,"%"),vat:(0,X.Z)(e.vat),gross:(0,X.Z)(e.gross),rowData:e,action:""}})}),(0,r.jsx)(tU.Z,{}),(0,r.jsxs)(aO,{align:"center",justify:"between",children:[(0,r.jsx)(ej.Z,{children:"Materials"}),!c&&(0,r.jsx)(eg.Z,{content:"Insert Materials Item",context:"secondary",onClick:function(){return $("Materials")},size:"sm"})]}),(0,r.jsx)(r0.Z,{columns:H,rows:w.filter(function(e){return"Materials"===e.type}).map(function(e){return{id:e.id,description:e.description,units:e.unit,unitCost:(0,X.Z)(null==e?void 0:e.unitCost),net:(0,X.Z)(e.net),vatPercent:"".concat(e.vatPercent,"%"),vat:(0,X.Z)(e.vat),gross:(0,X.Z)(e.gross),rowData:e,action:""}})}),(0,r.jsxs)(aH,{children:[(0,r.jsxs)(aN,{children:[(0,r.jsx)("div",{children:"Net Total :"})," ",(0,r.jsx)("div",{children:(0,X.Z)(F)})]}),(0,r.jsxs)(aN,{children:[(0,r.jsx)("div",{children:"VAT Total :"})," ",(0,r.jsx)("div",{children:(0,X.Z)(M)})]}),(0,r.jsxs)(aN,{children:[(0,r.jsx)("div",{children:"Gross Total :"})," ",(0,r.jsx)("div",{children:(0,X.Z)(L)})]})]})]})}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:c?(0,r.jsx)(e7.Z,{content:"Description",text:null==d?void 0:null===(a=d.configs)||void 0===a?void 0:a.descriptionInvoice}):(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},J),{name:"description",rows:2,disabled:c}))})})}),(0,r.jsx)(tU.Z,{}),(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:6,children:!c&&(0,r.jsx)(eb.Z,{label:"Due date",children:(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},J),{name:"dueDate",placeholder:"Due date"}))})})})]}),(null==d?void 0:null===(s=d.accountEntry)||void 0===s?void 0:s.id)&&(0,r.jsx)(aZ,{currency:"GBP",accountEntryId:d.accountEntry.id})]})};a$.propTypes={job:A.object,showDetails:A.bool,defaultValues:A.object,refetch:A.func,toggleShow:A.func};var aO=(0,eU.ZP)(e$.Z).withConfig({displayName:"addInvoiceForm__StyledRow",componentId:"sc-b6993d21-0"})(aE()),aN=eU.ZP.div.withConfig({displayName:"addInvoiceForm__StyledText",componentId:"sc-b6993d21-1"})(aD()),aH=eU.ZP.div.withConfig({displayName:"addInvoiceForm__StyledTextBox",componentId:"sc-b6993d21-2"})(aP()),aF=t(80695),aM=(0,eu.Ry)().shape({amountReceived:(0,eu.Rx)().moreThan(0).required(),dateReceived:(0,eu.hT)().required(),reason:(0,eu.Z_)().required()}),aL=(0,eu.Ry)().shape({id:(0,eu.Rx)(),description:(0,eu.Z_)(),rate:(0,eu.Rx)().moreThan(0).required(),unit:(0,eu.Rx)().integer().moreThan(0).required(),vatRate:(0,eu.Z_)(),vatCustom:(0,eu.Rx)().min(0)}),aJ=[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],aU=function(e){var n,t,o=e.defaultValues,a=e.editMode,s=e.toggleShow,u=e.onSuccess;(null==o?void 0:o.vatRate)&&(null==o?void 0:o.vatRate)!==20?(n=o.vatRate,t="custom"):t="20";var l,c,d,p,m,f,v,h,b=(0,ei.cI)({defaultValues:(0,et.Z)((0,i.Z)({},o),{vatCustom:n,vatRate:t}),resolver:(0,er.S)(aL)}),x=b.control,g=b.errors,j=b.handleSubmit,y=b.register,Z=b.watch,I={control:x,errors:g,register:y},S=Z("vatRate"),w=Z("rate"),C=Z("unit"),R=Z("vatCustom"),_=Z("vatRate"),A=(d=void 0===(c=(l={unit:C,rate:w,vatRate:("20"===_?20:R||0)/100}).unit)?0:c,m=void 0===(p=l.rate)?0:p,v=void 0===(f=l.vatRate)?0:f,{net:d*m||0,vat:m*d*v||0,gross:m*d*(1+v)||0}),E=A.net,D=A.vat,P=A.gross,k=(h=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){return delete(n=(0,et.Z)((0,i.Z)({},e),{vatRate:"20"===e.vatRate?20:e.vatCustom||0})).vatCustom,u((0,et.Z)((0,i.Z)({},n),{net:E,gross:P,vat:D}),a),[2]})}),function(e){return h.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:j(k),children:[(0,r.jsx)(e$.Z,{children:(0,r.jsx)(eO.Z,{md:12,children:(0,r.jsx)(eb.Z,{label:"Description",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},I),{name:"description",rows:2}))})})}),(0,r.jsxs)(e$.Z,{children:[(0,r.jsx)(eO.Z,{md:6,children:(0,r.jsx)(r2.Z,(0,et.Z)((0,i.Z)({},I),{name:"rate",label:"Unit Cost",vat:"Ex VAT"}))}),(0,r.jsx)(eO.Z,{md:6,children:(0,r.jsx)(eb.Z,{label:"Units",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},I),{name:"unit",type:"number"}))})})]}),(0,r.jsx)(e$.Z,{children:(0,r.jsxs)(eO.Z,{md:12,children:[(0,r.jsx)(eb.Z,{label:"VAT %"}),(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},I),{name:"vatRate",data:aJ})),"custom"===S&&(0,r.jsx)(eV.Z,(0,et.Z)((0,i.Z)({},I),{label:"Custom VAT",name:"vatCustom"}))]})}),(0,r.jsxs)(ej.Z,{children:["Net: ",(0,X.Z)(E)]}),(0,r.jsxs)(ej.Z,{children:["VAT: ",(0,X.Z)(D)]}),(0,r.jsxs)(ej.Z,{children:["Gross: ",(0,X.Z)(P)]}),(0,r.jsxs)(e$.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,r.jsx)(eg.Z,{content:"Back",onClick:s,style:{margin:"0 5px"},context:"danger"}),(0,r.jsx)(eg.Z,{content:a?"Save":"Add",type:"submit"})]}),"number"==typeof(null==o?void 0:o.id)&&(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},I),{name:"id",type:"hidden"})),(0,r.jsx)("div",{style:{clear:"both"}})]})};function aV(){var e=(0,m.Z)(["\n  margin: 0 5px;\n"]);return aV=function(){return e},e}function aQ(){var e=(0,m.Z)(["\n  margin: 0;\n"]);return aQ=function(){return e},e}aU.propTypes={defaultValues:A.object,editMode:A.bool,toggleShow:A.bool,type:A.string,onSuccess:A.func};var az=function(e){var n=e.values,t=e.setValue,i=e.showDetails,a=(0,o.useContext)(J.Z),s=function(e,i){if(i){var r=(0,l.Z)(n);r[e.id]=e,t(r)}else t((0,l.Z)(n).concat([e]));a.close()},u=function(e,n){a.show({content:(0,r.jsx)(aU,{editMode:!!n,onSuccess:s,toggleShow:a.close,defaultValues:n}),submit:!1,title:"".concat(n?"Edit":"Insert","  Item")})},c=function(e,i){var r=(0,l.Z)(n);r.splice(i.id,1),t((0,l.Z)(r))},d=[{hidden:!0},{hidden:!1,text:"Description"},{hidden:!1,text:"Quantity",formatter:function(e){return e.row.unit}},{hidden:!1,text:"Rate",formatter:function(e){var n=e.row;return(0,X.Z)(n.rate)}},{hidden:!1,text:"Net",formatter:function(e){var n=e.row;return(0,X.Z)(n.net)}},{hidden:!1,text:"VAT % ",formatter:function(e){var n=e.row;return"".concat(n.vatRate,"%")}},{hidden:!1,text:"VAT",formatter:function(e){var n=e.row;return(0,X.Z)(n.vat)}},{hidden:!1,text:"Gross",formatter:function(e){var n=e.row;return(0,X.Z)(n.gross)}},{formatter:rX.Z,formatterData:(0,r1.N)(null,{onEditClick:u,onDeleteClick:c}),text:"Actions",hidden:i}],p=n.reduce(function(e,n){return e+(n.itemTotal||n.net||0)},0),m=n.reduce(function(e,n){return e+(n.vatAmount||n.vat||0)},0),f=n.reduce(function(e,n){return e+(n.itemTotalIncVAT||n.gross||0)},0);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(rZ.Z,{content:(0,r.jsxs)(aY,{align:"center",justify:"between",children:[(0,r.jsx)("span",{children:"Items:"}),!i&&(0,r.jsx)(eg.Z,{content:"Insert Item",context:"secondary",onClick:u,size:"sm"})]}),tag:"h4"}),(0,r.jsx)(r0.Z,{columns:d,rows:n.map(function(e,n){return{id:n,description:e.description,unit:e.unit,rate:e.rate,net:e.net,vatRate:e.vatRate,vat:e.vat,gross:e.gross,action:""}})}),(0,r.jsxs)("div",{style:{textAlign:"right"},children:[(0,r.jsxs)(aB,{children:["Net Total : ",(0,X.Z)(p)]}),(0,r.jsxs)(aB,{children:["VAT Total : ",(0,X.Z)(m)]}),(0,r.jsxs)(aB,{children:["Gross Total : ",(0,X.Z)(f)]})]})]})},aY=(0,eU.ZP)(e$.Z).attrs(function(){return{align:"center",justify:"between"}}).withConfig({displayName:"creditNoteTable__StyledRow",componentId:"sc-102d7a7e-0"})(aV()),aB=eU.ZP.p.withConfig({displayName:"creditNoteTable__StyledP",componentId:"sc-102d7a7e-1"})(aQ());az.propTypes={};var aW=t(9873),aG=function(e){var n,t,a,s,u,l,c=e.defaultValues,d=e.job,p=e.refetch,m=e.toggleShow,f=(e.userId,e.invoiceId),v=e.invoice,h=e.totalReconciledAmount,b=(0,o.useState)(),x=b[0],g=b[1],j=(0,ei.cI)({defaultValues:(0,i.Z)({},c),resolver:(0,er.S)(aM)}),y=j.control,Z=j.errors,I=j.handleSubmit,S=j.register,w=j.setValue,C=(0,o.useState)(aw(c)),R=C[0],A=C[1],E="ProformaInvoiceCustomer"===v.invoiceType?(null==v?void 0:null===(n=v.reconciledAmount)||void 0===n?void 0:null===(t=n.reconciliations)||void 0===t?void 0:null===(a=t.aggregate)||void 0===a?void 0:null===(s=a.sum)||void 0===s?void 0:s.amount)||0:h||0,D=null!==(u=v.amounts.vatTotal)&&void 0!==u?u:0,k=(0,_.Z)((0,P.D)(ag,{onCompleted:function(){p(),m()}}),1)[0],$=(0,_.Z)((0,P.D)(aj),2),O=$[0],N=$[1].loading,H=(l=(0,q.Z)(function(e){var n,t,i,r;return(0,T.__generator)(this,function(o){switch(o.label){case 0:if(N)return[2];if(Number((n=R.reduce(function(e,n){return e+n.gross},0))+E)>D)return g("maximum allowed value is ".concat((0,X.Z)(D-E))),[2];return t={accountId:d.customer.id,balance:0,credit:parseFloat(e.amountReceived).toFixed(2),currencyId:(0,aW.K)(d.customer.id),debit:0,entity:"CreditNote",meta:{paymentReference:null,comment:e.reason},type:"creditNote",paymentStatus:"creditNote",dateReceived:(0,tY.v)(e.dateReceived),Reconciliations:{data:{amount:n,creditEntity:"CreditNote",debitEntity:"Invoice",debitEntityId:f,meta:{items:R.map(function(e){return{description:e.description,unit:e.unit,rate:e.rate,vatRate:e.vatRate/100}})}}}},[4,O({variables:{object:t}}).then(function(e){return e.data.insert_AccountEntry_one.id})];case 1:return o.sent(),i={job:{},jobId:d.id,timing:[],isPaid:!1},n+E===D&&(r="customerPaid",i.job={status:r},i.timing.push({status:r,jobId:d.id}),i.isPaid="ProformaInvoiceCustomer"!==v.invoiceType),k({variables:i}),[2]}})}),function(e){return l.apply(this,arguments)}),F={control:y,errors:Z,register:S};return w("amountReceived",(0,o4.l)(null==R?void 0:R.reduce(function(e,n){return e+n.gross},0),2)),(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:I(H),children:[(0,r.jsx)(e7.Z,{content:"Invoice amount ",text:(0,X.Z)(D)}),(0,r.jsx)(e7.Z,{content:"Reconciled amount",text:(0,X.Z)(E)}),(0,r.jsx)(az,{setValue:A,values:R,showDetails:!1}),(0,r.jsx)(eb.Z,{label:"Date created"}),(0,r.jsx)(eD.M,(0,et.Z)((0,i.Z)({},F),{name:"dateReceived"})),(0,r.jsx)(eb.Z,{label:"Amount"}),(0,r.jsxs)(eQ.Z,{children:[(0,r.jsx)(ez.Z,(0,et.Z)((0,i.Z)({},F),{addonType:"prepend",size:10,text:!0,children:"\xa3"})),(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},F),{name:"amountReceived",readOnly:!0})),(0,r.jsx)(ez.Z,(0,et.Z)((0,i.Z)({},F),{addonType:"append",size:10,text:!0,children:"EX Vat"}))]}),(0,r.jsx)(eb.Z,{label:"Reason",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},F),{name:"reason",rows:2}))}),x&&(0,r.jsx)(ef.Z,{context:"danger",content:x})]})};aG.propTypes={defaultValues:A.object,job:A.object.isRequired,invoice:A.object.isRequired,refetch:A.func.isRequired,toggleShow:A.func.isRequired,userId:A.number.isRequired,invoiceId:A.number.isRequired,totalReconciledAmount:A.number};var aK=function(e){var n,t,i,a=e.job,u=e.refetch,l=e.type,d=e.financeSupplier,p=e.financeCustomer,m=e.expanded,f=e.onChangeExpanded,v=(0,e2.x)().user,h=(0,oD.a)(),b=(0,D.x)(),x=(0,W.E)(a,"closed"),g=(0,c.aM)(iw.Rm,{variables:{jobId:a.id}}),j=g.loading,y=g.data,Z=void 0===y?{invoices:[],meta:{aggregate:{totalCount:0}}}:y,I=Z.invoices,S=Z.meta,w=g.refetch,C=(0,o.useMemo)(function(){return I.filter(function(e){return ip.SR[l].includes(e.invoiceType)})},[l,I]),R=(0,o.useMemo)(function(){return o3(C)},[C]),_=R.invoicedToDate,A=R.reconciledAmount,E="customer"===l?(null==p?void 0:null===(n=p.amountInfo)||void 0===n?void 0:n.vatTotal)||0:(null==d?void 0:null===(t=d.amountInfo)||void 0===t?void 0:t.vatTotal)||0,P=function(e){e.stopPropagation(),h.show({content:(0,r.jsx)(a$,{job:a,refetch:function(){w(),u()},toggleShow:h.close}),title:"Create invoice",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},N=(i=(0,q.Z)(function(e,n){var t,i,r,o,a,s;return(0,T.__generator)(this,function(o){switch(o.label){case 0:if(e.stopPropagation(),i=(t=n.rowData).invoiceType,!ip.cJ.includes(i))return[3,2];return[4,b.query({query:iw.WG,variables:{id:t.id}})];case 1:return s=o.sent().data.invoice,(0,aF.u)({meta:null==s?void 0:null===(r=s.accountEntry)||void 0===r?void 0:r.meta,invoice:s}),[3,3];case 2:ip.pX.includes(i)?(0,iS._Z)({client:b,jobId:t.entityId,type:i}):ip.YK.includes(i)&&(0,iC.$)(t.accountEntry.meta),o.label=3;case 3:return[2]}})}),function(e,n){return i.apply(this,arguments)}),J=function(e){h.show({content:(0,r.jsx)(a$,{showDetails:!0,defaultValues:e.rowData}),submit:!1,title:"Items Details",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},U=function(e,n){e.stopPropagation(),h.show({content:(0,r.jsx)(aG,{defaultValues:void 0,job:a,refetch:u,toggleShow:h.close,userId:v.id,invoiceId:n.id,invoice:n.rowData,reconciledAmount:A}),title:"Add Credit Note"})},V=function(e){return[{context:"secondary",icon:"download",onClick:function(n){return N(n,e)},tooltip:"Download"},{context:"secondary",icon:"add",onClick:function(n){return U(n,e)},tooltip:"Add Credit Note",disabled:!0},{context:"secondary",icon:"info",onClick:function(n){return J(e)},tooltip:"Details",disabled:"Location"===e.entity}]},Q=function(e){e.stopPropagation(),s().push(aX[l](a))};return(0,r.jsxs)(k.Z,{expanded:m,onChange:f,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Invoices"}),(0,r.jsx)(oN.Z,{size:"small",onClick:Q,children:(0,r.jsx)(af.Z,{sx:{height:"17px",width:"17px"}})})]})}),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{spacing:2,children:[(0,r.jsxs)(F.ZP,{container:!0,columnSpacing:1,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{children:"Invoiced to date"}),(0,r.jsx)(L.Z,{children:(0,n_.T)(_)})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{children:"Amount outstanding"}),(0,r.jsx)(L.Z,{children:(0,n_.T)(_-A)})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{children:"Amount to be invoiced"}),(0,r.jsx)(L.Z,{children:(0,n_.T)(E-_)})]})]}),(0,r.jsx)(eX.i,{columns:[{field:"number",headerName:"Number",minWidth:100,sortable:!1},{field:"type",headerName:"Type",minWidth:200,sortable:!1},{field:"vatTotal",headerName:"VAT total",minWidth:100,sortable:!1,renderCell:function(e){var n=e.value;return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(n)})}},{field:"date",headerName:"Date",minWidth:150,sortable:!1},{field:"dueDate",headerName:"Due Date",minWidth:150,sortable:!1},{field:"status",headerName:"Status",minWidth:100,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsx)(ad.C,{actionsData:V,row:n})}}],rows:null==C?void 0:C.map(function(e){var n,t,i,r,o,a,s,u;return{id:e.id,number:e.invoiceNumber,type:e.invoiceType,entity:e.entity,total:(null===(n=e.amounts)||void 0===n?void 0:n.vatRate)?(null===(t=e.amounts)||void 0===t?void 0:t.vatTotal)/(1+(null===(i=e.amounts)||void 0===i?void 0:i.vatRate)):null===(r=e.amounts)||void 0===r?void 0:r.vatTotal,vatRate:null===(o=e.amounts)||void 0===o?void 0:o.vatRate,date:K()(e.createdAt).format("YYYY-MM-DD"),dueDate:K()(null===(a=e.accountEntry)||void 0===a?void 0:a.dueDate).format("YYYY-MM-DD"),status:null===(s=e.accountEntry)||void 0===s?void 0:s.paymentStatus,vatTotal:null===(u=e.amounts)||void 0===u?void 0:u.vatTotal,rowData:e,action:""}}),meta:S,loading:j,noResultsMessage:"There are currently no invoices."}),!x&&(0,r.jsx)(H.Z,{color:"secondary",variant:"contained",sx:{alignSelf:"center"},onClick:P,children:"Create ad-hoc invoice"})]})})]})};aK.defaultProps={onChangeExpanded:function(){}},aK.propTypes={job:E().object.isRequired,refetch:E().func.isRequired,type:E().oneOf(["customer","supplier"]),expanded:E().bool,onChangeExpanded:E().func};var aX={customer:function(e){var n;return"/dashboard/customers/view?id=".concat(null===(n=e.customer)||void 0===n?void 0:n.id,"&tab=finance")},supplier:function(e){var n;return"/dashboard/suppliers/view?id=".concat(null===(n=e.supplier)||void 0===n?void 0:n.id,"&tab=finance")}},a0=function(e){var n,t,i,a=e.job,u=e.refetch,c=(0,D.x)(),d=(0,e2.x)().hasRole,p=(0,o.useContext)(J.Z),m=(0,oD.a)(),f=d("admin"),v=d("supplier"),h=d("customer"),b=d("tenant"),x=(0,W.E)(a,["validated","unvalidated"]),g=(0,W.E)(a,"invoiceSent"),j="pending"===a.status,y=(0,W.E)(a,"closed"),Z=(0,o.useState)(!f&&v?"supplier":"customer"),I=Z[0],S=Z[1],w=(0,o.useState)([]),C=w[0],R=w[1],_=(0,o.useState)(null),A=_[0],E=_[1],P=(0,o.useState)(null),U=P[0],Q=P[1],z=(null===(n=a.media)||void 0===n?void 0:n.filter(function(e){var n;return(null===(n=e.item)||void 0===n?void 0:n.category)==="invoice"}).length)||0,Y=o6({financeCustomer:U,financeSupplier:A}),G=Y.netProfitAmount,K=Y.netProfitMargin,X=function(){s().push("quote"===a.type?"/dashboard/issues/manage?id=".concat(a.number,"&quoted=1"):"/dashboard/issues/manage?id=".concat(a.number))};(0,o.useEffect)(function(){(0,q.Z)(function(){var e,n,t;return(0,T.__generator)(this,function(i){switch(i.label){case 0:return[4,(0,e_.F)(c,a.id)];case 1:return n=(e=i.sent()).financeSupplier,t=e.financeCustomer,E(n),Q(t),[2]}})})()},[E,Q,a.expenses,a.financeLogs,c,a.id]);var ee,en=function(e){e.stopPropagation(),p.show({content:(0,r.jsx)(ty.G,{category:"invoice",entity:"Job",entityId:a.id,onMediaAdd:u,type:"document"}),submit:!1,title:"Upload Invoice"})},et=function(e){e.stopPropagation(),m.show({content:(0,r.jsx)(e5,{job:a,refetchJob:u,activeTab:I}),title:"Update Amounts",submit:!1,xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"50vw",lg:"50vw",lg2:"50vw"})},ei=function(e){return function(n){n.stopPropagation(),S(e)}},er=[{id:1,label:"Gross",value:"customer"===I?null==U?void 0:null===(t=U.amountInfo)||void 0===t?void 0:t.vatTotal:null==A?void 0:null===(i=A.amountInfo)||void 0===i?void 0:i.vatTotal}];return(0,r.jsxs)(N.Z,{children:[(0,r.jsxs)(k.Z,{expanded:C.includes("finance-content"),onChange:(ee="finance-content",function(e,n){n?R(function(e){return(0,l.Z)(e).concat([ee])}):R(function(e){return e.filter(function(e){return e!==ee})})}),children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{width:"100%",spacing:1,children:[(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Finance"}),f&&null!==a.pricing&&!y&&!x&&(0,r.jsx)(oN.Z,{size:"small",onClick:et,children:(0,r.jsx)(V.Z,{sx:{height:"17px",width:"17px"}})})]}),!y&&!x&&!h&&!b&&(0,r.jsx)(oG.Z,{color:"info",badgeContent:z,showZero:!0,children:(0,r.jsx)(H.Z,{disableMinWidth:!0,color:"info",variant:"contained",size:"small",onClick:en,children:(0,r.jsx)(oX.Z,{})})})]}),f&&null!==a.pricing&&(0,r.jsxs)(tX.Z,{children:[(0,r.jsx)(a1,{color:"secondary",variant:"customer"===I?"contained":"outlined",onClick:ei("customer"),children:"Customer"}),(0,r.jsx)(a1,{color:"primary",variant:"supplier"===I?"contained":"outlined",onClick:ei("supplier"),children:"Supplier"})]}),!C.includes("finance-content")&&null!==a.pricing&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(eX.i,{hideHeader:!0,columns:[{field:"label",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return(0,r.jsx)(L.Z,{fontWeight:700,children:n})}},{field:"value",flex:1,sortable:!1,align:"right",renderCell:function(e){var n=e.value;return(0,r.jsx)(r.Fragment,{children:(h||b)&&!g?"N/A":(0,n_.T)(n)})}}],rows:er}),(0,r.jsx)(oK.Z,{})]}),d("admin")&&"customer"===I&&(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Net Profit"}),(0,r.jsx)(L.Z,{children:(0,n_.T)(G||0)})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:8,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Net Profit Margin"}),(0,r.jsxs)(L.Z,{children:[K||0,"%"]})]})]})]}),null===a.pricing&&(0,r.jsxs)(M.Z,{spacing:2,children:[(0,r.jsx)(nE.Z,{severity:"error",children:"Finance information will only be available once job has been created."}),f&&!j&&!y&&(0,r.jsx)(H.Z,{color:"danger",variant:"contained",size:"large",onClick:function(e){e.stopPropagation(),d("admin")?X():nU(a,p,u)},children:"Change job pricing or service"})]})]})}),(0,r.jsx)($.Z,{sx:{pt:0},children:null!==a.pricing&&(U&&"customer"===I||A&&"supplier"===I)&&(0,r.jsx)(o5,{job:a,type:I,financeSupplier:A,financeCustomer:U})})]}),C.includes("finance-content")&&(0,W.E)(a,"accepted")&&(0,r.jsx)(am,{expanded:C.includes("finance-content"),job:a,refetchParent:u,tab:I}),d("admin")&&"quote"!==a.type&&(0,r.jsx)(aK,{job:a,refetch:u,type:I,financeSupplier:A,financeCustomer:U})]})};a0.defaultProps={},a0.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var a1=(0,o$.ZP)(H.Z)(function(){return{height:"30px"}}),a2=t(4243),a4=(0,eu.Ry)().shape({relatedSelected:(0,eu.Ry)().required(),relType:(0,eu.Z_)().required()}),a3=function(e){var n,t,o,a,s,u=e.job,l=e.submit,c=(0,ei.cI)({resolver:(0,er.S)(a4)}),d=c.control,p=c.errors,m=c.handleSubmit,f=c.register,v=c.watch,h={control:d,errors:p,register:f},b=v("relatedSelected"),x=v("relType"),g=function(e){l(e)};return(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:m(g),children:[(0,r.jsx)(eh.Z,(0,et.Z)((0,i.Z)({},h),{legend:"Relation Type",name:"relType",data:[{id:"parent",label:"Parent",value:"parent"},{id:"child",label:"Child",value:"child"}]})),(0,r.jsx)(es.P,(0,et.Z)((0,i.Z)({},h),{errors:(0,i.Z)({},p),label:"Work Orders",locationId:u.locationId,name:"relatedSelected",type:"job"})),b&&(0,r.jsxs)("div",{children:[(0,r.jsx)(e7.Z,{content:"Id",text:b.number}),(0,r.jsx)(e7.Z,{content:"Title",text:b.title}),(0,r.jsx)(e7.Z,{content:"Date",text:(0,ee.Z)(b.timingStart)}),(0,r.jsx)(e7.Z,{content:"Short Job Description",text:(null==b?void 0:b.Taxonomy.length)>0&&null!==(a=null===(n=null==b?void 0:b.Taxonomy[0].Taxonomy)||void 0===n?void 0:n.shortJobDescription)&&void 0!==a?a:"-"}),(0,r.jsx)(e7.Z,{content:"Address",text:null!==(s=null==b?void 0:null===(t=b.Location)||void 0===t?void 0:t.name)&&void 0!==s?s:""}),(0,r.jsx)(e7.Z,{content:"Status",text:null===(o=ot.yW.find(function(e){return e.value===b.status}))||void 0===o?void 0:o.text}),(0,r.jsx)("br",{})]}),"parent"===x&&u.parentId&&(0,r.jsx)(ef.Z,{content:"This job already has a parent job defined. Do you want to update it?",context:"warning"})]})};a3.propTypes={submit:A.func.isRequired};var a6=function(e){var n,t,i,a,s=e.job,u=e.refetch,l=e.expanded,c=e.onChangeExpanded,d=(0,tk.q)(),m=(0,e2.x)().hasRole,f=(0,o.useContext)(J.Z),v=null===(n=d.admin.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,h=null===(t=d.admin.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,b=[],x=(0,_.Z)((0,P.D)(p.qD),1)[0],g=function(e){return[{context:"danger",icon:"delete",onClick:function(n){return Z(n,e)},tooltip:"Delete"}]},j=[{field:"relType",headerName:"Relation",flex:1,sortable:!1},{field:"number",headerName:"Number",flex:1,sortable:!0,renderCell:function(e){var n=e.row;return(0,r.jsx)(tP.D,{id:n.id,number:n.number,openCanvas:!0,type:n.type,numberPrefix:v,numberSuffix:h})}},{field:"actions",headerName:"",width:50,sortable:!1,hide:!m("admin"),renderCell:function(e){var n=e.row;return(0,r.jsx)(ad.C,{actionsData:g,row:n})}}];s.parentJob&&b.push({relType:"parent",id:s.parentJob.id,type:s.parentJob.type,number:s.parentJob.number,reference:s.parentJob.reference,status:(null===(i=ot.yW.find(function(e){return e.value===s.parentJob.status}))||void 0===i?void 0:i.text)||"",date:K()(s.parentJob.createdAt).format("YYYY-MM-DD"),actions:""}),(null===(a=s.childJobs)||void 0===a?void 0:a.length)&&s.childJobs.forEach(function(e){var n=(ot.yW.find(function(n){return n.value===e.status})||"").text;b.push({relType:"child",id:e.id,type:e.type,number:e.number,reference:e.reference,status:n,date:K()(e.createdAt).format("YYYY-MM-DD"),actions:""})});var y,Z=function(e,n){x({variables:{id:"child"===n.relType?n.id:s.id,changes:{parentId:null}}}),e.stopPropagation(),u()},I=(y=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(i){return n=e.relatedSelected,"parent"===(t=e.relType)&&n.value?x({variables:{id:s.id,changes:{parentId:n.value}}}):"child"===t&&n.value&&x({variables:{id:n.value,changes:{parentId:s.id}}}),u(),f.close(),[2]})}),function(e){return y.apply(this,arguments)}),S=function(e){f.show({content:(0,r.jsx)(a3,{job:s,submit:I,type:e}),title:"Related Works"})},w={actions:m("admin")};return(0,r.jsxs)(k.Z,{expanded:l,onChange:c,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(L.Z,{variant:"h6",children:"Related Works"})}),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{width:"100%",children:[(0,r.jsx)(eX.i,{columns:j,rows:b,columnVisibilityModel:w}),(0,r.jsx)(oN.Z,{sx:{alignSelf:"center"},onClick:function(){return S("parent")},children:(0,r.jsx)(ap.Z,{})})]})})]})};a6.defaultProps={onChangeExpanded:function(){}},a6.propTypes={job:E().object.isRequired,refetch:E().func.isRequired,expanded:E().bool,onChangeExpanded:E().func};var a5=t(93739),a7=t(90629),a8=t(87918),a9=function(e){var n,t,o=e.job,a=(null===(n=i0.M2.find(function(e){var n;return e.value===(null==o?void 0:null===(n=o.report)||void 0===n?void 0:n.completion)}))||void 0===n?void 0:n.label)||"Unconfirmed";return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a8.Z,{color:function(){var e;switch(null==o?void 0:null===(e=o.report)||void 0===e?void 0:e.completion){case"complete":return"success";case"couldNotDo":return"danger";default:return"info"}}(),label:a,size:"small"}),(0,r.jsx)(a8.Z,(0,et.Z)((0,i.Z)({},function(){switch(null==o?void 0:o.timingStatus){case"correct":return{color:"success",label:"Timing: Correct"};case"incorrect":return{color:"danger",label:"Timing: Incorrect"};default:return{color:"info",label:"Timing: Unconfirmed"}}}()),{size:"small"})),(null===(t=o.report)||void 0===t?void 0:t.passFailStatus)&&(0,r.jsx)(a8.Z,(0,et.Z)((0,i.Z)({},function(){var e;switch(null===(e=o.report)||void 0===e?void 0:e.passFailStatus){case"Passed":return{label:"Passed",color:"success"};case"Failed":return{label:"Failed",color:"warning"};case"Failure resolved":return{label:"Failure resolved",color:"info"}}}()),{size:"small"}))]})};function se(){var e=(0,m.Z)(["\n  mutation ResolveJobReport(\n    $id: Int!\n    $changes: JobReport_set_input!\n    $timings: [JobTiming_insert_input!]!\n  ) {\n    update_JobReport(where: { id: { _eq: $id } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $timings) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return se=function(){return e},e}a9.propTypes={job:A.object},a9.defaultProps={job:{}};var sn=(0,f.Ps)(se()),st=eu.Ry({comments:eu.Z_().min(30,"Comments must have a minimum of 30 characters.").required()}),si=function(e){var n,t,i=e.id,o=e.jobId,a=e.offCanvas,s=e.refetch,u=(0,ei.cI)({defaultValues:{comments:""},resolver:(0,er.S)(st)}),l=u.register,c=u.errors,d=u.handleSubmit,p=(0,_.Z)((0,P.D)(sn,{onCompleted:function(){a.close(),s()}}),1)[0],m=function(e){p({variables:{id:i,changes:{passFailStatus:"Failure resolved",comments:e.comments},timings:[{status:"reportFailureResolved",jobId:o,notes:e.comments,userId:1}]}})};return(0,r.jsx)("form",{id:"offCanvasForm",onSubmit:d(m),children:(0,r.jsx)(N.Z,{children:(0,r.jsx)(ne.Z,{fullWidth:!0,label:"Comments",multiline:!0,rows:4,maxRows:4,name:"comments",inputRef:l,error:null===(n=c.comments)||void 0===n?void 0:n.message,helperText:null===(t=c.comments)||void 0===t?void 0:t.message})})})};si.defaultProps={offCanvas:{},refetch:function(){}},si.propTypes={id:E().number.isRequired,jobId:E().number.isRequired,offCanvas:E().object.isRequired,refetch:E().func};var sr=function(e){var n=e.job,t=e.handlePreviewSubmit,i=(0,o.useState)(!1),a=i[0],s=i[1],u=(0,o.useState)(!1),l=u[0],c=u[1],d=(0,o.useState)(0),p=d[0],m=d[1],f=(0,o.useState)(""),v=f[0],h=f[1],b=function(e){c(e)},x=(0,ei.cI)(),g=x.handleSubmit,j=x.control,y=x.errors,Z=x.register,I=x.setValue,S=function(e,n){m(e),h(n)},w=function(e){l&&(s(!0),t(e,p,v))};return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:g(w),children:(null==n?void 0:n.id)&&(0,r.jsx)(ns.i,{isSubmit:a,control:j,errors:y,register:Z,setValue:I,entity:"ppm"===n.type?"Ppm":"Job",entityId:n.id,hasForm:!0,hasSelect:!1,handleValidation:b,doValidation:!0,onTotalScoreAndLabelChange:S})})},so=t(22961),sa=t(72450),ss=function(e){var n,t,i,a,s,u,l,d,p,m,f,h,b,x,g,j,y,Z,I,S,w,C,R,A,E,D=e.job,F=e.refetch,U=e.expanded,V=e.onChangeExpanded,Q=(0,o.useState)(!1),z=Q[0],Y=Q[1],G=(0,o.useContext)(J.Z),K=(0,oD.a)(),X=(0,e2.x)(),ee=X.hasRole,en=X.user,et=null==en?void 0:en.invoiceThreshold,ei=null==D?void 0:D.supplierVatTotal,er=(0,o.useState)(0),eo=er[0],ea=er[1],es=(0,o.useState)(""),eu=es[0],el=es[1],ec=(0,o.useState)(!1),ed=ec[0],ep=ec[1],em=(0,o.useState)(null),ef=em[0],ev=em[1],eh=(0,o.useState)(!1),eb=eh[0],ex=eh[1],eg=(0,ts.L)(D.timings),ej=(0,W.E)(D,"inProgress"),ey=(0,W.E)(D,"reportSentSupplier"),ew=(0,W.E)(D,"closed"),eC=(0,eI.nN)("supplier",null==D?void 0:D.timings),eR=(0,c.aM)(tc.Q2,{variables:{entity:"ppm"===D.type?"Ppm":"Job",entityId:null==D?void 0:D.id},skip:!(null==D?void 0:D.id)}),eq=eR.data,e_=eR.refetch,eT=(0,_.Z)((0,P.D)(tc.FE),1)[0],eA=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){F&&F()}}),1)[0],eE=["raised","offered","accepted"].includes(D.status),eD=function(){G.show({content:(0,r.jsx)(rb,{job:D,offCanvas:G,refetch:F}),title:"Job Report",submit:(0,W.E)(D,"completed")})},eP=(A=(0,q.Z)(function(){var e,n,t;return(0,T.__generator)(this,function(n){switch(n.label){case 0:return[4,eT({variables:{id:null===(e=null==eq?void 0:eq.FormSubmissions[0])||void 0===e?void 0:e.id,changes:{type:"submitted"}}})];case 1:return n.sent().data&&e_(),[2]}})}),function(){return A.apply(this,arguments)}),ek=function(e){e.stopPropagation(),(0,t_.e)({job:D,adminId:en.adminId})},e$=function(){var e,n,t=[{jobId:D.id,status:"reportSentSupplier",userId:en.id}];(null===(e=D.report)||void 0===e?void 0:e.passFailStatus)==="Failed"&&t.push({jobId:D.id,status:"reportFailed",notes:null===(n=D.report)||void 0===n?void 0:n.recommendations,userId:en.id}),eA({variables:{id:D.id,changes:{},timing:t}})},eO=function(e){e.stopPropagation(),(0,t_.e)({job:D,adminId:en.adminId})},eN=function(e){var n;e.stopPropagation(),G.show({content:(0,r.jsx)(si,{id:null===(n=D.report)||void 0===n?void 0:n.id,jobId:D.id,offCanvas:G,refetch:F}),title:"Resolve",submit:!0})},eH=function(){ep(!1),eb&&(eL(),ex(!1)),ev(null)},eF=function(e){e.stopPropagation();var n,t,i,r=(n=null===(i=null==eq?void 0:eq.FormSubmissions[0])||void 0===i?void 0:i.formFields).find(function(e){return"onCompleteForm"===e.notificationType});r?(ev(r),ep(!0),ex(!0)):eL()},eM=(E=(0,q.Z)(function(e,n,t){return(0,T.__generator)(this,function(e){return ea(n),el(t),K.close(),[2]})}),function(e,n,t){return E.apply(this,arguments)}),eL=function(e){var n;K.show({content:(0,r.jsx)(sr,{job:D,handlePreviewSubmit:eM,onTotalScoreAndLabelChange:eM}),title:null===(n=null==eq?void 0:eq.FormSubmissions[0])||void 0===n?void 0:n.form.name})},eJ=function(){var e;(null==eq?void 0:eq.FormSubmissions[0])&&(null===(e=null==eq?void 0:eq.FormSubmissions[0])||void 0===e?void 0:e.form.name)!=="None"&&Y(!z)},eU=function(){var e,n;return(null===(e=null==eq?void 0:eq.FormSubmissions[0])||void 0===e?void 0:e.type)!=="submitted"||eE?(null===(n=null==eq?void 0:eq.FormSubmissions[0])||void 0===n?void 0:n.type)==="submitted"||eE?{status:"preview",color:"#7DC3E1"}:{status:"draft",color:"#EAB853"}:{status:"submitted",color:"#316B39"}};return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(k.Z,{expanded:U,onChange:V,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{direction:"row",children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Report"}),(0,r.jsx)(su,{direction:"row",alignItems:"center",flexWrap:"wrap",children:D.report&&(0,W.E)(D,"completed")&&(0,r.jsx)(a9,{job:D})})]})}),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{width:"100%",spacing:2,children:[(null===(n=D.report)||void 0===n?void 0:n.notes)?(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Notes"}),(0,r.jsx)(L.Z,{children:D.report.notes})]}):(0,r.jsx)(N.Z,{children:(0,r.jsx)(L.Z,{children:"The job report has not yet been created"})}),((null===(t=D.report)||void 0===t?void 0:t.passFailStatus)==="Failed"||(null===(i=D.report)||void 0===i?void 0:i.passFailStatus)==="Failure resolved")&&(null===(a=D.report)||void 0===a?void 0:a.recommendations)&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",sx:{fontWeight:700},children:"Recommendations"}),(0,r.jsx)(L.Z,{sx:{fontWeight:700},children:D.report.recommendations})]}),(null===(s=D.report)||void 0===s?void 0:s.passFailStatus)==="Failure resolved"&&(null===(u=D.report)||void 0===u?void 0:u.comments)&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",sx:{fontWeight:700},children:"Comments"}),(0,r.jsx)(L.Z,{sx:{fontWeight:700},children:D.report.comments})]}),ej&&!ey&&"onHold"!==eg&&!ew&&(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:[(0,r.jsx)(H.Z,{color:"secondary",variant:"contained",onClick:eD,children:D.report?"Update Report":"Create Report"}),ee("supplier")&&((0,eS.il)(et,ei)||eC)&&(0,r.jsx)(H.Z,{variant:"contained",onClick:e$,disabled:!(null===(l=D.report)||void 0===l?void 0:l.completion),children:"Submit Report"}),ee("supplier")&&!((0,eS.il)(et,ei)||eC)&&(0,r.jsx)(H.Z,{variant:"contained",onClick:function(){return(0,eZ.I_)({type:"issue",role:"supplier",jobId:D.id,accountId:en.accountId,amount:ei,offCanvas:G})},disabled:!(null===(d=D.report)||void 0===d?void 0:d.completion),children:"Request approval"}),!ee("supplier")&&(0,r.jsx)(H.Z,{variant:"contained",onClick:e$,disabled:!(null===(p=D.report)||void 0===p?void 0:p.completion),children:"Submit Report"})]}),(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:[D.report&&ey&&ee("admin")&&(0,r.jsx)(H.Z,{color:"secondary",variant:"contained",onClick:eO,children:"Download report"}),(null===(m=D.report)||void 0===m?void 0:m.passFailStatus)==="Failed"&&ey&&ee("admin")&&(0,r.jsx)(H.Z,{color:"secondary",variant:"contained",onClick:eN,children:"Resolve"})]}),(null===(f=null==eq?void 0:eq.FormSubmissions[0])||void 0===f?void 0:f.id)&&(null===(h=null==eq?void 0:eq.FormSubmissions[0])||void 0===h?void 0:h.formId)!==1&&(0,r.jsxs)(L.Z,{style:sl.formData,children:[(0,r.jsxs)("div",{style:{display:"flex"},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{style:{minHeight:"26px",fontSize:"17px",fontWeight:"500",lineHeight:"1.5"},children:null===(b=null==eq?void 0:eq.FormSubmissions[0])||void 0===b?void 0:b.form.name}),(0,r.jsx)("div",{style:{fontSize:"12px",fontWeight:"500",lineHeight:"1.75"},children:(null===(x=null==eq?void 0:eq.FormSubmissions[0])||void 0===x?void 0:x.form.description)&&(null===(g=null==eq?void 0:eq.FormSubmissions[0])||void 0===g?void 0:g.form.description)}),"preview"!==eU().status&&(0,r.jsxs)("div",{style:{fontSize:"12px",fontWeight:"500",lineHeight:"1.75"},children:["Total score: ",eo," ",eu&&"(".concat(eu,")")]})]}),(null===(j=null==eq?void 0:eq.FormSubmissions[0])||void 0===j?void 0:j.formFields)&&"preview"===eU().status&&(0,r.jsx)(oN.Z,{color:"secondary",onClick:eJ,sx:{marginLeft:"10px",height:"26px"},children:(0,r.jsx)(so.Z,{sx:{fontSize:20}})}),z&&"preview"===eU().status&&(0,r.jsx)(td.Z,{open:z,onClose:eJ,slotProps:{backdrop:{sx:{backgroundColor:"rgba(0, 0, 0, 0.7)"}}},children:(0,r.jsx)(N.Z,{sx:sl.modalContainerStyle,children:(0,r.jsxs)(a7.Z,{sx:sl.modalContentStyle,children:[(0,r.jsxs)(N.Z,{sx:sl.stickyHeaderStyle,marginBottom:1,children:[(0,r.jsx)(L.Z,{variant:"h6",sx:{fontFamily:"Nunito-Regular",fontSize:"16px",paddingLeft:"10px"},children:"Form preview"}),(0,r.jsx)(oN.Z,{color:"secondary",onClick:eJ,sx:{marginLeft:"10px"},children:(0,r.jsx)(sa.Z,{sx:{fontSize:20}})})]}),(0,r.jsx)("div",{style:sl.previewScheme,children:(0,r.jsx)(a5.L,{scheme:null===(y=null==eq?void 0:eq.FormSubmissions[0])||void 0===y?void 0:y.formFields,submissionData:null===(Z=null==eq?void 0:eq.FormSubmissions[0])||void 0===Z?void 0:Z.submissionData,formSchemeOnEdit:null,formSchemeOnCopy:null,formSchemeOnDelete:null,blockStyle:sl.blockStyle})})]})})}),(null===(I=null==eq?void 0:eq.FormSubmissions[0])||void 0===I?void 0:I.formFields)&&(0,r.jsx)("span",{style:{display:"flex",alignItems:"center",color:"white",backgroundColor:eU().color,paddingInline:"12px",borderRadius:"12px",marginLeft:"8px",height:"26px"},children:eU().status})]}),(0,r.jsxs)("div",{style:{marginLeft:"auto",gap:"20px",display:"flex"},children:["draft"===eU().status&&(null===(S=null==eq?void 0:eq.FormSubmissions[0])||void 0===S?void 0:S.type)!=="submitted"&&(0,r.jsx)("button",{onClick:eF,style:{fontWeight:"500",fontSize:"0.875rem",lineHeight:"1.75",width:"130px",height:"36px",backgroundColor:"#fff",color:"#2DCCBD",border:"1px solid #2DCCBD",borderRadius:4,cursor:"pointer"},children:"Complete form"}),ed&&(0,r.jsx)(tm,{openModal:ed,handleCloseModal:eH,selectedField:ef,entityId:D.id}),"draft"===eU().status&&(null===(w=null==eq?void 0:eq.FormSubmissions[0])||void 0===w?void 0:w.type)!=="submitted"&&(0,r.jsx)("button",{disabled:!(null===(C=null==eq?void 0:eq.FormSubmissions[0])||void 0===C?void 0:C.submissionData),onClick:eP,style:{fontWeight:"500",fontSize:"0.875rem",lineHeight:"1.75",width:"130px",height:"36px",backgroundColor:"rgb(6, 121, 216)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Submit form"}),(null===(R=null==eq?void 0:eq.FormSubmissions[0])||void 0===R?void 0:R.type)==="submitted"&&(0,r.jsx)("button",{onClick:ek,style:{fontWeight:"500",fontSize:"0.875rem",lineHeight:"1.75",width:"130px",height:"36px",backgroundColor:"rgb(6, 121, 216)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Download form"})]})]})]})})]})})};ss.defaultProps={onChangeExpanded:function(){}},ss.propTypes={job:E().object.isRequired,refetch:E().func.isRequired,expanded:E().bool,onChangeExpanded:E().func};var su=(0,i2.Z)(M.Z)(function(){return{rowGap:"4px","& .MuiChip-root":{marginLeft:"16px"}}}),sl={formData:{display:"flex",alignItems:"stretch",flexDirection:"column",marginTop:"16px",marginInline:"-16px",paddingInline:"16px",paddingTop:"16px",borderTop:"1px solid rgba(0, 0, 0, 0.12)"},previewScheme:{pointerEvents:"none"},modalContainerStyle:{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh"},modalContentStyle:{width:"650px",height:"600px",padding:"10px",overflowY:"auto",borderRadius:"12px",backgroundColor:"#FFFFFF"},stickyHeaderStyle:{position:"sticky",top:0,height:"44px",backgroundColor:"#F5F5F5",borderRadius:"12px",zIndex:1,fontFamily:"Nunito-SemiBold",border:1,padding:"15px",display:"flex",alignItems:"center",justifyContent:"space-between"}},sc=function(e){var n,t,a,s,u,l,c,d,m,f,v,h,b,x,g,j=e.job,y=e.refetch,Z=(0,o.useContext)(J.Z),I=(0,e2.x)().hasRole,S=j.shortJobDesc&&j.shortJobDesc.length?j.shortJobDesc[0].taxonomy.name:"",w=j.assets||[],C=null===(n=j.answers)||void 0===n?void 0:n.map(function(e){var n;return{id:e.id,taxonomyId:e.taxonomyId,comments:e.comments,name:null===(n=e.taxonomy)||void 0===n?void 0:n.name}}),R=(0,_.Z)((0,P.D)(p.FA),1)[0],A=(g=(0,q.Z)(function(e){var n,t,r;return(0,T.__generator)(this,function(o){switch(o.label){case 0:return n=(0,e8.eD)(e,j.id),t=(0,e8.G2)(e),r=(0,e8.a6)(j,e).meta,delete e.questions,delete e.taxonomyId_ShortDesc,delete e.formSubmission,[4,R({variables:{jobId:j.id,originatorEmail:t.email,originatorChanges:t,changes:(0,et.Z)((0,i.Z)({},e),{meta:r}),questions:n,hasQuestions:n.length>0}})];case 1:return o.sent(),Z.close(),y(),[2]}})}),function(e){return g.apply(this,arguments)}),E=function(e){e.stopPropagation(),Z.show({content:(0,r.jsx)(nu,{description:j.description||"",handleWorkDescriptionSubmit:A,job:j,currentQuestions:C}),title:"Work Description"})};return(0,r.jsxs)(N.Z,{children:[(0,r.jsxs)(k.Z,{children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(M.Z,{width:"100%",spacing:2,children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:2,children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Issue Reported"}),I(["admin"])&&!(0,W.E)(j,"validated")&&(0,r.jsx)(oN.Z,{size:"small",onClick:E,children:(0,r.jsx)(V.Z,{sx:{height:"17px",width:"17px"}})})]})})}),(0,r.jsxs)($.Z,{children:[(0,r.jsxs)(F.ZP,{container:!0,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Short Job Description"}),(0,r.jsx)(oO.O,{maxLength:20,children:S||"-"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Job Description"}),(0,r.jsx)(oO.O,{maxLength:20,children:j.description||"-"})]}),w.length>0&&(0,r.jsxs)(F.ZP,{item:!0,xs:12,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Asset(s)"}),(0,r.jsx)(oO.O,{maxLength:100,children:w.map(function(e){var n=e.asset;return(0,r.jsxs)(oQ.r,{color:"secondary",href:"/dashboard/assets/view?id=".concat(n.id),children:[(null==n?void 0:n.name)||"-",";"]})})})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:12,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Issue description"}),(0,r.jsx)(oO.O,{maxLength:20,children:j.issueReportedDescription||"-"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:12,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Issue type"}),(0,r.jsx)(oO.O,{maxLength:20,children:(null===(t=j.issueTypes)||void 0===t?void 0:null===(a=t[0])||void 0===a?void 0:null===(s=a.issue)||void 0===s?void 0:s.name)||"-"})]}),(null===(u=j.meta)||void 0===u?void 0:null===(l=u.reporter)||void 0===l?void 0:l.email)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(F.ZP,{item:!0,xs:12,mt:1,mb:1,children:(0,r.jsx)(L.Z,{typography:"subtitle1",children:"Originator"})}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Email"}),(0,r.jsx)(oO.O,{maxLength:20,children:(null===(c=j.meta)||void 0===c?void 0:null===(d=c.reporter)||void 0===d?void 0:d.email)||"-"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Name"}),(0,r.jsx)(oO.O,{maxLength:20,children:"".concat(null===(m=j.meta)||void 0===m?void 0:null===(f=m.reporter)||void 0===f?void 0:f.nameFirst," ").concat(null===(v=j.meta)||void 0===v?void 0:null===(h=v.reporter)||void 0===h?void 0:h.nameLast)||"-"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:6,children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Phone"}),(0,r.jsx)(oO.O,{maxLength:20,children:(null===(b=j.meta)||void 0===b?void 0:null===(x=b.reporter)||void 0===x?void 0:x.phone)||"-"})]})]})]}),(0,r.jsx)(a2.y,{answers:C})]})]}),(I(["admin"])||I(["customer"]))&&(0,r.jsx)(a6,{job:j,refetch:y}),I(["admin","supplier"])&&(0,r.jsx)(ss,{job:j,refetch:y})]})};sc.defaultProps={},sc.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var sd=t(83704),sp=t.n(sd),sm=t(96486),sf=(0,eu.Ry)().shape({assignedTo:(0,eu.Ry)().required()}),sv=function(e){var n,t=e.defaultValues,o=e.onSuccess,a=e.user,s=(0,ei.cI)({defaultValues:t,resolver:(0,er.S)(sf)}),u=s.control,l=s.errors,c=s.handleSubmit,d={control:u,errors:l,register:s.register},p=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return o(e),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{id:"offCanvasForm",handleSubmit:c(p),children:[(0,r.jsx)(es.P,(0,et.Z)((0,i.Z)({},d),{accountId:a.accountId,errors:(0,i.Z)({},l),label:"Assigned to",name:"assignedTo",type:"user"})),(0,r.jsx)(eb.Z,{label:"Customer reference",children:(0,r.jsx)(ex.Z,(0,et.Z)((0,i.Z)({},d),{name:"reference"}))})]})};sv.propTypes={defaultValues:A.object,onSuccess:A.func.isRequired,user:A.object.isRequired};var sh=t(52971),sb=t(22186),sx=t(54049);sp()(K());var sg=function(e){var n,t,a,s,u,l,c,d,m,f,v,h,b,x,g,j,y,Z,I=e.job,S=e.refetch,w=e.isQuotes,C=e.showOrder,R=e.expanded,A=e.onChangeExpanded,E=(0,tk.q)(),F=(0,e2.x)(),U=F.hasRole,Q=F.user,z=(0,D.x)(),Y=(0,o.useContext)(J.Z),W=(0,ei.cI)({defaultValues:{relatedLinks:(null==I?void 0:I.relatedLinks)||[]}}),G=W.setValue,X=W.watch,ee=W.register,en=W.handleSubmit,et=(0,sx.b)(I),er=null==E?void 0:null===(n=E.admin)||void 0===n?void 0:null===(t=n.meta)||void 0===t?void 0:null===(a=t.supplierInstructions)||void 0===a?void 0:a.terms,eo=null===(s=E.admin)||void 0===s?void 0:null===(u=s.jobSetting)||void 0===u?void 0:u.jobNumberPrefix,ea=null===(l=E.admin)||void 0===l?void 0:null===(c=l.jobSetting)||void 0===c?void 0:c.jobNumberSuffix,es=X("relatedLinks"),eu=(0,_.Z)((0,P.D)(p.qD,{onCompleted:(0,q.Z)(function(){return(0,T.__generator)(this,function(e){switch(e.label){case 0:if(!I)return[3,2];return[4,(0,e_.F)(z,I.id)];case 1:e.sent(),e.label=2;case 2:return S(),[2]}})})}),1)[0],el=function(e){eu({variables:{id:I.id,changes:e}})},ec=function(e){e.stopPropagation();var n,t,i,o,a={reference:I.reference,location:I.location};(null===(n=I.manager)||void 0===n?void 0:n.id)&&(a.assignedTo={value:null===(t=I.manager)||void 0===t?void 0:t.id,label:"".concat(null===(i=I.manager)||void 0===i?void 0:i.nameFirst," ").concat(null===(o=I.manager)||void 0===o?void 0:o.nameLast)}),Y.show({content:(0,r.jsx)(sv,{defaultValues:a,onSuccess:ed,user:Q}),title:"Edit Assignee"})},ed=(Z=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return eu({variables:{id:I.id,changes:{managerId:e.assignedTo.value,reference:e.reference}}}),S(),Y.close(),[2]})}),function(e){return Z.apply(this,arguments)});return(0,r.jsxs)(k.Z,{expanded:R,onChange:A,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,r.jsx)(L.Z,{variant:"h6",children:"Details"}),U("admin")&&(0,r.jsx)(oN.Z,{size:"small",onClick:ec,children:(0,r.jsx)(V.Z,{sx:{height:"17px",width:"17px"}})})]})}),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{direction:"row",children:[(0,r.jsxs)(M.Z,{spacing:1,sx:{width:"100%",height:"auto"},children:[U(["admin","supplier"])&&er&&(0,r.jsx)(N.Z,{children:(0,r.jsx)(nE.Z,{severity:"warning",children:er})}),C&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Order"}),(0,r.jsx)(L.Z,{children:(0,r.jsx)(tP.D,{id:I.id,number:I.number,numberPrefix:eo,numberSuffix:ea,type:I.type})})]}),I.tenantUser&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Tenant"}),(0,r.jsx)(L.Z,{children:I.tenantUser&&I.tenantUser.fullName})]}),!w&&I.reference&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Reference"}),(0,r.jsx)(L.Z,{children:I.reference})]}),(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:w?"Description":"Short Job Description"}),(0,r.jsx)(L.Z,{children:(null==I?void 0:null===(d=I.shortJobDesc)||void 0===d?void 0:d.length)>0&&(null===(m=null==I?void 0:I.shortJobDesc[0])||void 0===m?void 0:m.taxonomy.name)||I.title})]}),(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Status"}),(0,r.jsx)(tE.B,{value:I.status})]}),w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Quote due date"}),(0,r.jsxs)(L.Z,{children:[K()(I.quoteDue).format("YYYY-MM-DD")," "]})]}),w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Supplier(s)"}),I.quotations.map(function(e){return(0,r.jsxs)(L.Z,{children:[e.supplier.name," "]})})]}),w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Quotation"}),(0,r.jsxs)(L.Z,{children:[I.quotations.length," "]})]}),w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Received"}),(0,r.jsx)(L.Z,{children:"".concat((I.quotations||[]).reduce(function(e,n){return"supplierQuoteComplete"===n.status?e+1:e},0),"/").concat((null===(f=I.quotations)||void 0===f?void 0:f.length)||0)})]}),!w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Cost Category"}),(0,r.jsx)(L.Z,{children:null===(v=I.costCategoryTaxonomy)||void 0===v?void 0:v.name})]}),!w&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Service"}),(0,r.jsx)(L.Z,{children:null===(h=I.service)||void 0===h?void 0:h.name})]}),I.estimatedDuration&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Estimated duration"}),(0,r.jsx)(L.Z,{children:K().duration(I.estimatedDuration).format()})]}),!w&&"ppm"!==I.type&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Priority"}),(0,r.jsx)(L.Z,{children:(0,r.jsx)(r.Fragment,{children:"".concat((null==et?void 0:et.name)||"Not Specified "," (").concat((null==et?void 0:et.entity)||"Default",")")})})]}),(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Assigned To"}),(0,r.jsx)(L.Z,{children:I.manager?"".concat(I.manager.nameFirst," ").concat(I.manager.nameLast," "):"Unassigned"})]}),(null===(b=I.compliances)||void 0===b?void 0:b.length)>0&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Compliance"}),(0,r.jsx)(L.Z,{children:I.compliances[0].compliance.name})]}),U(["admin","customer","supplier"])&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Permits required"}),(0,r.jsx)(L.Z,{children:(null===(x=I.location)||void 0===x?void 0:x.permitsRequired)?"Yes":"No"})]}),U("admin")&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{typography:"subtitle2",children:"Tags"}),(0,r.jsx)(M.Z,{direction:"row",columnGap:1,rowGap:2,sx:{marginTop:"5px",flexWrap:"wrap"},children:null===(g=I.tags)||void 0===g?void 0:g.map(function(e){var n;return(0,r.jsx)(sb.V,{tagEntityId:e.id,name:e.tag.name,color:null===(n=e.tag.meta)||void 0===n?void 0:n.color},null==e?void 0:e.tag.id)})})]}),(0,r.jsxs)("form",{id:"relatedLinksForm",onSubmit:en(el),children:[(0,r.jsx)(sh.V,{setValue:G,values:es,name:"relatedLinks",noDeleteEdit:!0,titleSx:{fontSize:"12px!important"}}),((null===(j=I.relatedLinks)||void 0===j?void 0:j.length)>0||(null==es?void 0:es.length)>0)&&!sm.isEqual(I.relatedLinks,es)&&(0,r.jsx)(H.Z,{type:"submit",variant:"contained",color:"secondary",sx:{marginTop:"30px"},children:"Submit"}),(0,r.jsx)("input",(0,i.Z)({type:"hidden"},ee("relatedLinks")))]})]}),(null===(y=I.compliances)||void 0===y?void 0:y.length)>0&&(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(L.Z,{variant:"subtitle2",children:"Compliance"}),(0,r.jsx)(L.Z,{children:I.compliances[0].compliance.name})]})]})})]})};sg.propTypes={isQuotes:E().bool,job:E().object.isRequired,refetch:E().func.isRequired,showOrder:E().bool,expanded:E().bool,onChangeExpanded:E().func},sg.defaultProps={showOrder:!0,onChangeExpanded:function(){}};var sj=t(86267),sy=function(e){var n=e.job,t=e.refetch,i=(0,e2.x)().hasRole,a=(0,o.useState)([]),s=a[0],u=a[1],c=i("tenant");(0,o.useEffect)(function(){var e=(0,W.E)(n,"inProgress")&&!(0,W.E)(n,"completed"),t=!n.media||0===n.media.length;e&&t&&d("issues-details")(null,!0)},[n]);var d=function(e){return function(n,t){t?u(function(n){return(0,l.Z)(n).concat([e])}):u(function(n){return n.filter(function(n){return n!==e})})}};return(0,r.jsxs)(N.Z,{children:[(0,r.jsx)(sg,{expanded:s.includes("issues-details"),onChangeExpanded:d("issues-details"),job:n,refetch:t,showOrder:!1}),s.includes("issues-details")&&(0,r.jsx)(sj.G,{hideExpandIcon:!0,showActionButtons:!c,expanded:s.includes("issues-details"),entity:"Job",entityId:n.id,onMediaAdd:function(){return t()},onMediaRemove:function(){return t()}})]})};sy.defaultProps={},sy.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var sZ=t(14067),sI=t(1306),sS=t(71225),sw=t(4380),sC=t(45795),sR=t(8879),sq=function(e){var n=e.supplierId,t=e.toggleShow,i=(0,a.useRouter)();(0,o.useEffect)(function(){var e=function(e){t()};return i.events.on("routeChangeComplete",e),function(){i.events.off("routeChangeComplete",e)}},[]);var s=(0,c.aM)(sZ.l1,{variables:{id:n}}),u=s.loading,l=s.refetch,d=s.data,p=(void 0===d?{supplier:{}}:d).supplier;if(u)return(0,r.jsx)(nD.Z,{sx:{zIndex:1e5},open:!0,children:(0,r.jsx)(nP.Z,{color:"secondary"})});var m=(0,ii.WE)(p,"registered"),f=(0,ii.WE)(p,"operating");return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(sw.g,{avatar:(0,sS.Q)(p.media),editable:!1,entity:p,entityName:"Account",linkTitleTo:"/dashboard/suppliers/view?id=".concat(p.id)}),(0,r.jsx)(sR.D,{supplier:p}),(0,r.jsx)(sC.T,{open:!1,supplier:p}),m&&(0,r.jsx)(sI.f,{address:m.address,entity:"Account",entityId:p.id,id:m.id,open:!1,refetch:l,title:"Registered Address",type:"registered"}),f&&(0,r.jsx)(sI.f,{address:f.address,entity:"Account",entityId:p.id,id:f.id,open:!1,refetch:l,title:"Operating Address",type:"operating"})]})};sq.propTypes={supplierId:A.number.isRequired,toggleShow:A.func.isRequired};var s_=function(e){var n=e.job,t=e.refetch,i=(0,o.useContext)(J.Z),a=(0,e2.x)().hasRole,s=(0,ts.L)(n.timings),u=function(e,o,a){e.stopPropagation(),"accepted"===a?i.show({content:(0,r.jsx)(tB,{accountId:o.accountId,job:n,offCanvas:i,refetch:t}),submit:!1,title:"Accept Job"}):i.show({content:(0,r.jsx)(iU,{accountId:o.accountId,job:n,offCanvas:i,refetch:t}),title:"Reject Job"})},l=function(e){return[{context:"primary",icon:"check",onClick:function(n){return u(n,e,"accepted")},tooltip:"Accept"},{context:"danger",icon:"delete",onClick:function(n){return u(n,e,"rejected")},tooltip:"Reject"}]},c=n.supplierOffers.filter(function(e){return"cancelled"!==e.status}).map(function(e){var n=e.account,t=e.dayRate,i=e.id,r=e.status,o=e.rate;return{id:i,accountId:n.id,name:n.name,rate:o,dayRate:t,status:r||"pending",actions:""}}),d=function(e){var n=e.row;i.show({title:"Supplier information",content:(0,r.jsx)(sq,{supplierId:n.accountId,toggleShow:i.close})})};return"onHold"!==s&&n.supplierOffers&&n.supplierOffers.length>0&&(null==c?void 0:c.length)>0&&(0,r.jsx)(N.Z,{children:(0,r.jsxs)(k.Z,{children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(L.Z,{variant:"h6",children:"Supplier Offers"})}),(0,r.jsx)($.Z,{children:a("admin")&&n.supplierOffers&&n.supplierOffers.length>0&&(0,r.jsx)(eX.i,{columns:[{field:"name",headerName:"Supplier",flex:1,sortable:!1},{field:"rate",headerName:"Rate/h",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return(0,r.jsx)(r.Fragment,{children:(0,n_.T)(n)})}},{field:"status",headerName:"Status",flex:1,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var n=e.row;return(0,r.jsx)(ad.C,{actionsData:l,row:n})}}],rows:c,onRowClick:d})})]})})};s_.defaultProps={},s_.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var sT=t(23855),sA=t(29383),sE=t(76972),sD=t(69690),sP=eu.Ry({slaId:eu.Rx().integer().required()}),sk=function(e){var n,t,o=e.customerId,a=e.locationId,s=e.onSuccess,u=(0,ei.cI)({resolver:(0,er.S)(sP)}),l=u.control,d=u.errors,m=u.handleSubmit,f=u.register,v=(0,u.watch)("slaId"),h=(0,c.aM)(p.Ab,{skip:!o||!a,variables:{customerId:o,locationId:a}}).data,b=(0,e8.GU)("reactive",h),x=null===(n=null==b?void 0:b.find(function(e){return e.id===Number(v)}))||void 0===n?void 0:n.notes,g=(t=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return s(e),[2]})}),function(e){return t.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:m(g),children:[(0,r.jsx)(eh.Z,{register:f,errors:d,data:b,legend:"Priority",name:"slaId"}),v&&(0,r.jsx)(ef.Z,{content:x||"-",context:"light"}),(0,r.jsx)(eb.Z,{label:"Notes",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},{control:l,errors:d,register:f}),{name:"notes",rows:3}))}),(0,r.jsx)(eg.Z,{content:"Accept",context:"primary",type:"submit"})]})},s$=function(e){e.accountId,e.quotationId;var n,t=e.onSuccess,o=(0,ei.cI)(),a=o.control,s=o.errors,u=o.handleSubmit,l=o.register,c=(n=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){return t(e.acceptedNotes),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)(eo.Z,{handleSubmit:u(c),children:[(0,r.jsx)(eb.Z,{label:"Notes",children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},{control:a,errors:s,register:l}),{name:"acceptedNotes",rows:3}))}),(0,r.jsx)(eg.Z,{content:"Reject",context:"danger",type:"submit"})]})},sO=t(95465),sN=(0,eu.Ry)().shape({terms:(0,eu.Z_)().required()}),sH=function(e){var n,t,o,a,s=e.refetch,u=e.quotation,l=e.toggleShow,c=e.PublicQuoteTerms,d=(0,_.Z)((0,P.D)(em.Dg,{onCompleted:function(){l(),s&&s()}}),1)[0],p=(0,ei.cI)({defaultValues:{terms:null!==(o=null!==(t=null===(n=u.meta)||void 0===n?void 0:n.terms)&&void 0!==t?t:c)&&void 0!==o?o:""},resolver:(0,er.S)(sN)}),m=p.control,f=p.errors,v=p.handleSubmit,h=p.register,b=(a=(0,q.Z)(function(e){var n;return(0,T.__generator)(this,function(t){switch(t.label){case 0:return(n=(0,i.Z)({},u.meta)||{}).terms=e.terms,[4,d({variables:{changes:{meta:n},supplierOffer:[],id:u.id}})];case 1:return t.sent(),[2]}})}),function(e){return a.apply(this,arguments)});return(0,r.jsx)(eo.Z,{id:"offCanvasForm",handleSubmit:v(b),children:(0,r.jsx)(eq.Z,(0,et.Z)((0,i.Z)({},{control:m,errors:f,register:h}),{name:"terms",rows:8}))})},sF=t(92148),sM=t(63441);function sL(){var e=(0,m.Z)(["\n  mutation AcceptQuote($quoteId: Int!, $notes: String, $slaId: Int!) {\n    acceptQuote(quoteId: $quoteId, notes: $notes, slaId: $slaId) {\n      data\n      success\n    }\n  }\n"]);return sL=function(){return e},e}function sJ(){var e=(0,m.Z)(["\n  mutation RejectQuote($quoteId: Int!, $notes: String) {\n    rejectQuote(quoteId: $quoteId, notes: $notes) {\n      data\n      success\n    }\n  }\n"]);return sJ=function(){return e},e}var sU=(0,f.Ps)(sL()),sV=(0,f.Ps)(sJ());sp()(K());var sQ=function(e){var n,t,a,s,u,d,p,m,f=e.job,h=e.quote,b=e.quotes,g=e.refetch,j=e.isHideAllQuotation,y=e.expanded,Z=e.onChangeExpanded,I=e.hideExpandIcon,S=(0,oF.Z)(e,["job","quote","quotes","refetch","isHideAllQuotation","expanded","onChangeExpanded","hideExpandIcon"]),w=(0,D.x)(),C=(0,rt.Z)("(max-width: 500px)"),R=(0,nk.D)(),A=(0,e2.x)(),E=A.user,N=A.hasRole,U=N("admin"),V=N((0,l.Z)(sF.Sf)),Q=N(["admin","customer"]),z=N(["admin","supplier"]),Y=N("customer"),W=N((0,l.Z)(sF.n)),G=N("supplier"),X=N((0,l.Z)(sF.nx)),ee=(0,c.aM)(x.nh,{variables:{id:E.id}}).data,ei=(void 0===ee?{user:{}}:ee).user,er=null==(E=(0,i.Z)({},E,ei))?void 0:E.quoteThreshold,eo=h.lineItems.reduce(function(e,n){return e+n.supplierTotal},0),ea=(null==h?void 0:null===(n=h.lineItems)||void 0===n?void 0:n.reduce(function(e,n){return e+n.total},0))||0,es=ea+.2*ea,eu=(0,o.useContext)(J.Z),el=(0,oD.a)(),ec=["supplierQuoteRequested","thresholdApproved","quotationRejected"].includes(h.status),ed=(0,_.Z)((0,P.D)(v.xY,{onCompleted:function(){g&&g()}}),1)[0],ep=(0,_.Z)((0,P.D)(sU,{refetchQueries:["GetJob"],onCompleted:function(){el.close()},onError:function(e){R.show({content:"Error: ".concat(e.message),color:"error"})}}),1)[0],em=(0,_.Z)((0,P.D)(sV,{refetchQueries:["GetJob"],onCompleted:function(){el.close()},onError:function(e){R.show({content:"Error: ".concat(e.message),color:"error"})}}),1)[0],ef=(0,c.aM)(x.nE,{variables:{id:E.adminId}}),ev=ef.data,eh=ef.loading,eb=null==ev?void 0:null===(t=ev.account)||void 0===t?void 0:null===(a=t.meta)||void 0===a?void 0:null===(s=a.quote)||void 0===s?void 0:s.terms,ex=function(e){e.stopPropagation(),el.show({content:(0,r.jsx)(sj.G,{entity:"Quotation",entityId:h.id}),submit:!1,title:"View media"})},eg=function(e){var n=e.status;if(("supplierQuoteComplete"===n||"supplierQuoteRefused"===n||"waitingThresholdApproval"===n)&&("quoteOffered"===f.status||"waitingThresholdApproval"===f.status)){var t="quoteReceived";ed({variables:{id:f.id,changes:{status:t},timing:{status:t,jobId:f.id,userId:E.id,quoteId:h.id}}})}else g&&g();eu.close()},ej=ot.E6.find(function(e){return e.value===h.status})||{text:"-",context:"info"},ey=function(){eu.show({title:"Quotation Number: ".concat(h.quoteNumber),content:(0,r.jsx)(sO.m,{onSuccess:eg,quotationId:h.id}),width:"50%",submit:!1})},ew=(p=(0,q.Z)(function(e){var n,t;return(0,T.__generator)(this,function(i){switch(i.label){case 0:return n=e.notes,t=e.slaId,[4,ep({variables:{quoteId:h.id,notes:n,slaId:t}})];case 1:return i.sent(),[2]}})}),function(e){return p.apply(this,arguments)}),eC=(m=(0,q.Z)(function(e){return(0,T.__generator)(this,function(n){switch(n.label){case 0:return[4,em({variables:{quoteId:h.id,notes:e}})];case 1:return n.sent(),[2]}})}),function(e){return m.apply(this,arguments)}),eR=function(){el.show({title:"Accept Quotation Number: ".concat(h.quoteNumber),submit:!1,content:(0,r.jsx)(sk,{customerId:f.customerId,locationId:f.locationId,onSuccess:ew})})},eq=function(){el.show({title:"Reject Quotation Number: ".concat(h.quoteNumber),submit:!1,content:(0,r.jsx)(s$,{accountId:h.supplier.id,quotationId:h.id,quote:h,toggleShow:eu.close,onSuccess:eC})})},e_=function(){eu.show({content:(0,r.jsx)(sH,{refetch:g,quotation:h,toggleShow:eu.close,PublicQuoteTerms:eb}),title:"Terms of quote",width:"30%"})},eT=(0,o.useCallback)(function(){var e;return[{key:"Status",value:ej.text},{key:"Supplier",hidden:Y,value:(null==h?void 0:null===(e=h.supplier)||void 0===e?void 0:e.name)||f.quotations[0].supplier.name},{hidden:G,key:"Quote due by Customer",value:K()(f.quoteDue).format("YYYY-MM-DD")},{hidden:Y,key:"Quote due from Supplier",value:K()(f.quoteDueSupplier).format("YYYY-MM-DD")},{key:"Date received",value:K()(h.createdAt).format("YYYY-MM-DD")},{hidden:!Q,key:"Labour Total",value:(0,n_.T)(h.lineItems.filter(function(e){return"Labour"===e.type}).reduce(function(e,n){return e+n.total*n.qty},0))},{hidden:!Q,key:"Materials Total",value:(0,n_.T)(h.lineItems.filter(function(e){return"Materials"===e.type}).reduce(function(e,n){return e+n.total*n.qty},0))},{hidden:!Q,key:"Quote Total",value:(0,n_.T)(h.lineItems.reduce(function(e,n){return e+n.total*n.qty},0))},{hidden:!z,key:"Labour Supplier Total",value:(0,n_.T)(h.lineItems.filter(function(e){return"Labour"===e.type}).reduce(function(e,n){return e+n.supplierTotal},0))},{hidden:!z,key:"Materials Supplier Total",value:(0,n_.T)(h.lineItems.filter(function(e){return"Materials"===e.type}).reduce(function(e,n){return e+n.supplierTotal},0))},{hidden:!z,key:"Supplier Total",value:(0,n_.T)(h.lineItems.reduce(function(e,n){return e+n.supplierTotal},0))},{key:"Duration",value:h.totalDuration?"".concat(h.totalDuration," ").concat(h.totalDurationUnit):"-"},{key:"Start date",value:h.startDate?K()(h.startDate).format("YYYY-MM-DD"):"-"},{key:"Site Visit",value:h.siteVisitAt&&K()(h.siteVisitAt,!0).format("YYYY-MM-DD"),hidden:!f.siteVisitStart||!h.siteVisitAt}].filter(function(e){return!e.hidden}).map(function(e,n){return(0,et.Z)((0,i.Z)({},e),{id:n})})},[ej.text,JSON.stringify(h),JSON.stringify(f)]);return eh?null:(0,r.jsxs)(k.Z,(0,et.Z)((0,i.Z)({},S),{expanded:y,onChange:Z,children:[(0,r.jsx)(O.Z,(0,et.Z)((0,i.Z)({},!I&&{expandIcon:(0,r.jsx)(B.Z,{})}),{children:(0,r.jsxs)(L.Z,{variant:"h6",children:["Quotation ",h.quoteNumber,h.recommended?" (Recommended)":"","quotationAccepted"===h.status?" (Accepted)":""]})})),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{spacing:2,children:[(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:(0,r.jsx)(L.Z,{children:"Quotation"})}),(0,r.jsx)(F.ZP,{item:!0,xs:7,display:"flex",children:(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:ey,children:"View Quotation"})})]}),!j&&!ec&&U&&(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:(0,r.jsx)(L.Z,{children:"Accept / Reject"})}),(0,r.jsxs)(F.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,eS.il)(er,es)||(0,eI.Pn)("adminSupplier",null==f?void 0:f.timings,h.id)?eR():(0,eZ.I_)({type:"quote",role:"adminSupplier",quotations:b,quotationId:h.id,jobId:f.id,accountId:f.adminId,amount:es,offCanvas:eu})},children:"Accept"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",size:"small",onClick:eq,children:"Reject"})]})]}),!j&&!ec&&Y&&(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:(0,r.jsx)(L.Z,{children:"Accept / Reject"})}),(0,r.jsxs)(F.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[(0,r.jsx)(H.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,eS.il)(er,es)||(0,eI.Pn)(E.accountType,null==f?void 0:f.timings,h.id)?eR():(0,eZ.I_)({type:"quote",role:"customer",quotations:b,quotationId:h.id,jobId:f.id,accountId:f.customer.id,amount:es,offCanvas:eu})},children:"Accept"}),(0,r.jsx)(H.Z,{variant:"contained",color:"danger",size:"small",onClick:eq,children:"Reject"})]})]}),(X||W)&&(0,eI.aH)(E.accountType,null==f?void 0:f.timings,h.id)&&(0,eS.il)(er,"supplier"===E.accountType?eo:es)&&(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:(0,r.jsx)(L.Z,{children:"Threshold approval"})}),(0,r.jsxs)(F.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!(0,eI.Pn)(E.accountType,null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,eZ.i$)({type:"quote",role:E.accountType,job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Approve"}),!(0,eI.Pn)(E.accountType,null==f?void 0:f.timings,h.id)&&!(0,eI.TT)(E.accountType,null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,eZ.Ii)({type:"quote",role:E.accountType,job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Reject"})]})]}),V&&(0,eI.aH)("adminSupplier",null==f?void 0:f.timings,h.id)&&(0,eS.il)(er,eo)&&(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(F.ZP,{item:!0,xs:4,children:(0,r.jsx)(L.Z,{children:"Permission request to accept quote"})}),(0,r.jsxs)(F.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!(0,eI.Pn)("adminSupplier",null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,eZ.i$)({type:"quote",role:"adminSupplier",job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Approve"}),!(0,eI.Pn)("adminSupplier",null==f?void 0:f.timings,h.id)&&!(0,eI.TT)("adminSupplier",null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,eZ.Ii)({type:"quote",role:"adminSupplier",job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Reject"})]})]}),V&&(0,eI.aH)("adminCustomer",null==f?void 0:f.timings,h.id)&&(0,eS.il)(er,es)&&(0,r.jsxs)(F.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:4,children:[" ",(0,r.jsx)(L.Z,{children:"Permission request to send quote to customer"})]}),(0,r.jsxs)(F.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!(0,eI.Pn)("adminCustomer",null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,eZ.i$)({type:"quote",role:"adminCustomer",job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Approve"}),!(0,eI.Pn)("adminCustomer",null==f?void 0:f.timings,h.id)&&!(0,eI.TT)("adminCustomer",null==f?void 0:f.timings,h.id)&&(0,r.jsx)(H.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,eZ.Ii)({type:"quote",role:"adminCustomer",job:f,quoteId:h.id,offCanvas:eu,refetch:g})},children:"Reject"})]})]}),(0,r.jsx)(oK.Z,{}),(0,r.jsx)(eX.i,{hideHeader:!0,columns:[{field:"key",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return"function"==typeof n?n():n}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return"function"==typeof n?n():n}}],rows:eT(),getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}}),(0,r.jsx)(oK.Z,{}),(0,r.jsxs)(F.ZP,{container:!0,rowSpacing:2,children:[(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:8,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(L.Z,{children:"Attachments"}),(0,r.jsx)(oG.Z,{color:"secondary",badgeContent:(null==h?void 0:null===(u=h.media)||void 0===u?void 0:u.length)>0?null==h?void 0:null===(d=h.media)||void 0===d?void 0:d.length:0,children:(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",size:"small",onClick:ex,children:"View Attachments"})})]}),("quoteSent"===f.status||"quoteReceived"===f.status||"quotationAccepted"===h.status)&&(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:4,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(L.Z,(0,et.Z)((0,i.Z)({},C&&{sx:{width:"80px"}}),{children:"PDF"})),(0,r.jsx)(H.Z,{variant:"contained",color:"info",size:"small",onClick:function(){return(0,en.g)(f,h.id,w)},children:(0,r.jsx)(sM.Z,{})})]}),U&&(0,r.jsxs)(F.ZP,{item:!0,xs:12,xs3:12,display:"flex",alignItems:"center",columnGap:2,children:[(0,r.jsx)(L.Z,{width:"80px",children:"Terms"}),(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",size:"small",onClick:e_,children:"Terms of the Quote"})]})]})]})})]}))};sQ.defaultProps={onChangeExpanded:function(){}},sQ.propTypes={job:E().object.isRequired,quote:E().object.isRequired,quotes:E().arrayOf(E().object).isRequired,refetch:E().func.isRequired,isHideAllQuotation:E().bool,expanded:E().bool,onChangeExpanded:E().func,hideExpandIcon:E().bool};var sz=function(e){var n,t=e.job,i=e.refetch,a=(0,e2.x)().hasRole,s=(0,o.useState)([]),u=s[0],c=s[1],d=(0,o.useState)(0),p=d[0],m=d[1],f=t.quotations.slice().filter(function(e){return"uplift"!==e.type}).sort(function(e){return"quotationAccepted"===e.status?-1:0}),v=!!f.find(function(e){return"quotationAccepted"===e.status}),h=t.siteVisitStart&&K()(t.siteVisitStart,!0).format("YYYY-MM-DD"),b=t.siteVisitEnd&&K()(t.siteVisitEnd,!0).format("YYYY-MM-DD"),x=t.siteVisitWeekends,g=function(e){var n=(0,sA.Z)((0,sT.Z)((0,W.E)(e,"quoteAccepted")),(0,sT.Z)((0,W.E)(e,"quoteReceived"))),t=(0,sE.Z)((0,sT.Z)((0,W.E)(e,"quoteAccepted")),(0,sT.Z)((0,W.E)(e,"quoteReceived"))),i=(0,sD.Z)((0,sT.Z)((0,W.E)(e,"quoteAccepted")),(0,sT.Z)((0,W.E)(e,"quoteReceived")));return"".concat(n>0?n+" day ":"").concat(t>0?t+" hours ":"").concat(i+" minutes")},j=(0,o.useCallback)(function(){var e,n;return[{id:1,key:"Status",value:function(){return(0,r.jsx)(tE.B,{value:t.status})}},{id:2,key:"Required quotes",value:t.quoteNumber},{id:3,key:"Quote due by Customer",value:K()(t.quoteDue).format("YYYY-MM-DD")},{id:4,key:"Quote due from Supplier",value:K()(t.quoteDueSupplier).format("YYYY-MM-DD")},{hidden:t.quotations.find(function(e){return"quotationAccepted"===e.status}),id:5,key:"Sent quotations",value:(null===(e=t.quotations)||void 0===e?void 0:e.filter(function(e){return"supplierQuoteSent"===e.status}).map(function(e){return e.quoteNumber}).join(", "))||"-"},{hidden:!t.quotations.find(function(e){return"quotationAccepted"===e.status}),id:6,key:"Accepted quotation",value:null===(n=t.quotations.find(function(e){return"quotationAccepted"===e.status}))||void 0===n?void 0:n.quoteNumber},{hidden:!t.quotations.find(function(e){return"quotationAccepted"===e.status}),id:7,key:"Acceptance time",value:g(t)},{id:8,key:"Site Visit Start",value:h,hidden:!h},{id:9,key:"Site Visit End",value:b,hidden:!b},{id:10,key:"Include Weekends",value:x&&"Yes",hidden:!x}].filter(function(e){return!e.hidden})},[JSON.stringify(t)]);return(0,r.jsxs)(N.Z,{children:[(0,r.jsxs)(k.Z,{expanded:u.includes("quote-details"),onChange:(n="quote-details",function(e,t){t?c(function(e){return(0,l.Z)(e).concat([n])}):c(function(e){return e.filter(function(e){return e!==n})})}),children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(L.Z,{variant:"h6",children:"Quote details"})}),(0,r.jsxs)($.Z,{sx:{pb:0},children:[(0,r.jsx)(N.Z,{mb:2,children:(0,r.jsx)(eX.i,{hideHeader:!0,columns:[{field:"key",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return"function"==typeof n?n():n}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var n=e.value;return"function"==typeof n?n():n}}],rows:j(),getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}})}),a("admin")&&f.length>1&&(0,r.jsx)(tX.Z,{children:f.map(function(e,n){var t;return(0,r.jsx)(sY,{color:"secondary",variant:p===n?"contained":"outlined",onClick:function(e){e.stopPropagation(),m(n)},children:e.quoteNumber})})})]})]}),u.includes("quote-details")&&a("admin")&&f.map(function(e,n){return p===n?(0,r.jsx)(sQ,{job:t,quote:e,refetch:i,quotes:f,isHideAllQuotation:v,expanded:!0,hideExpandIcon:!0,sx:{"&.MuiAccordion-root.Mui-expanded":{borderTop:0,boxShadow:"none"}}},e.quoteNumber):null})]})};sz.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var sY=(0,o$.ZP)(H.Z)(function(){return{height:"30px"}});function sB(){var e=(0,m.Z)(["\n  fragment TaskFields on Task {\n    id\n    archived\n    status\n    priority\n    statusLog\n    meta\n    relatedLinks\n    title\n    content\n    dueDate\n    createdAt\n    updatedAt\n    adminId\n    userId\n    assignedAccountId\n    assignedUser: AssignedUser {\n      id\n      fullName\n    }\n    jobId\n  }\n"]);return sB=function(){return e},e}function sW(){var e=(0,m.Z)(["\n  query GetTasks(\n    $jobId: Int\n    $assignedUserId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n  ) {\n    tasks: Task(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n    ) {\n      ...TaskFields\n    }\n    meta: Task_aggregate(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n\n  ","\n"]);return sW=function(){return e},e}function sG(){var e=(0,m.Z)(["\n  subscription GetTasks(\n    $jobId: Int\n    $assignedUserId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n  ) {\n    tasks: Task(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n    ) {\n      ...TaskFields\n    }\n  }\n  ","\n"]);return sG=function(){return e},e}var sK=(0,f.Ps)(sB()),sX=(0,f.Ps)(sW(),sK),s0=(0,f.Ps)(sG(),sK),s1=t(20705),s2=t(66242),s4=t(62023),s3=t(44267),s6=t(41796),s5=t(97092),s7=function(e){var n,t=(n=e.priority,s5.FX.find(function(e){return e.value===n})),i=t.icon,o=t.label;return(0,r.jsx)(N.Z,{display:"flex",alignItems:"center",children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",children:[i,(0,r.jsx)(L.Z,{ml:1,children:o})]})})};s7.defaultProps={},s7.propTypes={priority:E().string};var s8=function(e){var n,t=(n=e.status,s5.jb.find(function(e){return e.value===n})),i=t.icon,o=t.label,a=t.color,s=t.bgcolor,u=t.value;return(0,r.jsx)(a8.Z,{size:"small",label:o,icon:i,sx:{color:a,bgcolor:s}},u)};s8.defaultProps={},s8.propTypes={status:E().oneOf(["open","closed","resolved"])};var s9=function(e){var n=e.dueDate,t=e.priority,i=e.status,o=e.title,a=e.content,s=e.assigned,u=e.onView;return(0,r.jsxs)(ue,{variant:"outlined",children:[(0,r.jsxs)(s3.Z,{sx:{padding:1},children:[(0,r.jsxs)(M.Z,{direction:"row",justifyContent:"space-between",children:[(0,r.jsx)(s7,{priority:t}),(0,r.jsx)(s8,{status:i})]}),(0,r.jsxs)(L.Z,{mt:1,variant:"h6",sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[o," \xa0"]}),(0,r.jsx)(L.Z,{mt:1,sx:{height:"63px",overflow:"hidden"},children:a}),(0,r.jsxs)(L.Z,{variant:"subtitle2",children:["Assigned by ",s]})]}),(0,r.jsxs)(s4.Z,{sx:{display:"flex",justifyContent:"space-between",pt:0},children:[(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:u,sx:{height:"30px"},children:"View"}),(0,r.jsx)(un,{variant:"subtitle2",children:n})]})]})};s9.defaultProps={title:"",onView:function(){}},s9.propTypes={dueDate:E().string.isRequired,priority:E().oneOf([1,2,3,4,5]).isRequired,status:E().oneOf(["open","closed","resolved"]).isRequired,title:E().string.isRequired,content:E().string.isRequired,assigned:E().string.isRequired,onView:E().func.isRequired};var ue=(0,o$.ZP)(s2.Z)(function(e){return{display:"flex",flexDirection:"column",justifyContent:"space-between",maxHeight:"210px",minWidth:"280px",backgroundColor:e.theme.palette.muiCardGray.main}}),un=(0,o$.ZP)(L.Z)(function(e){var n=e.theme;return{alignSelf:"flex-end",fontWeight:700,color:(0,s6.$n)(n.palette.black.main,.46)}}),ut=t(24062),ui=t(93859),ur={item:"dueDate",order:"desc"},uo=function(e){var n=e.jobId,t=e.subscription,a=e.showMyTaskButton,s=e.expanded,u=e.onChangeExpanded,l=(0,oD.a)(),p=(0,e2.x)().user,m=(0,s1.x)({filters:{jobId:n},initialSort:ur}).initialData,f=(0,o.useState)(!1),v=f[0],h=f[1],b=(0,et.Z)((0,i.Z)({},m),{assignedUserId:v?p.id:m.userId}),x=(0,c.aM)(sX,{variables:(0,i.Z)({},b),skip:t}),g=x.loading,j=x.data,y=(void 0===j?{tasks:[],meta:{aggregate:{totalCount:0}}}:j).tasks,Z=(0,d.m)(s0,{variables:(0,i.Z)({},b),skip:!t}),I=Z.loading,S=Z.data,w=(void 0===S?{tasks:[]}:S).tasks,C=function(e,n){e.preventDefault(),e.stopPropagation(),l.show({content:(0,r.jsx)(ut.J,{id:n,close:l.close}),title:"Task Details",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"100vw",md2:"100vw",lg:"90vw",lg2:"80vw"})},R=function(e){e.preventDefault(),e.stopPropagation(),l.show({content:(0,r.jsx)(ui.G,{jobId:n,close:l.close}),title:"Create Task",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},q=(t?w:y).map(function(e){var n;return{id:e.id,status:e.status,priority:e.priority,title:e.title,content:e.content,dueDate:K()(e.dueDate).format("YYYY-MM-DD"),assignedUser:null===(n=e.assignedUser)||void 0===n?void 0:n.fullName,item:e,actions:""}}),_=function(e){e.stopPropagation(),h(function(e){return!e})};return(0,r.jsx)(N.Z,{children:(0,r.jsxs)(k.Z,{expanded:s,onChange:u,children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(L.Z,{variant:"h6",children:"Tasks"})}),(0,r.jsx)($.Z,{sx:{paddingTop:0},children:(0,r.jsxs)(M.Z,{width:"100%",spacing:1,children:[(0,r.jsxs)(M.Z,{width:"100%",direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,r.jsx)(L.Z,{children:"Current task in progress"}),a&&(0,r.jsx)(nt.Z,{control:(0,r.jsx)(nn.Z,{color:"secondary",checked:v,onChange:_}),label:"My Tasks"})]}),(0,r.jsx)(M.Z,{width:"100%",direction:"row",spacing:2,pb:1,sx:{overflowX:"scroll"},children:g||I?(0,r.jsx)(M.Z,{width:"100%",direction:"row",justifyContent:"center",children:(0,r.jsx)(nP.Z,{color:"secondary"})}):q.map(function(e){return(0,r.jsx)(s9,{dueDate:e.dueDate,priority:e.priority,status:e.status,title:e.title,content:e.content,assigned:e.assignedUser,onView:function(n){return C(n,e.id)}})})}),(0,r.jsx)(M.Z,{direction:"row",justifyContent:"center",children:(0,r.jsx)(H.Z,{variant:"contained",color:"secondary",onClick:R,children:"Add new task"})})]})})]})})};uo.propTypes={jobId:E().number,showMyTaskButton:E().bool,subscription:E().bool,expanded:E().bool,onChangeExpanded:E().func},uo.defaultProps={showMyTaskButton:!1,onChangeExpanded:function(){}};var ua=t(28700);function us(){var e=(0,m.Z)(["\n  query GetUserLocations($accountId: Int, $jobId: Int) {\n    supplierLocations: UserLocation(\n      limit: 10\n      order_by: { id: desc }\n      where: { jobId: { _eq: $jobId }, accountId: { _eq: $accountId } }\n    ) {\n      id\n      geo\n      meta\n      createdAt\n    }\n  }\n"]);return us=function(){return e},e}var uu=(0,f.Ps)(us()),ul=t(28499),uc=function(e){var n=e.children,t=e.defaultCenter,i=e.defaultZoom,o=function(e){return{fullscreenControl:!0,mapTypeControl:!0,mapTypeId:e.MapTypeId.ROADMAP,scaleControl:!0,scrollwheel:!1,streetViewControl:!0}};return(0,r.jsx)(ul.ZP,{options:o,bootstrapURLKeys:{key:oH.ie.map},defaultCenter:t,defaultZoom:i,children:n})};uc.defaultProps={defaultZoom:14},uc.propTypes={children:E().node,defaultCenter:E().shape({lat:E().number.isRequired,lng:E().number.isRequired}).isRequired,defaultZoom:E().number};var ud=function(e){var n,t=e.job,o=(0,ii.WE)(null==t?void 0:t.location,"registered"),a=null,s=null;(null==o?void 0:null===(n=o.address)||void 0===n?void 0:n.geo)&&(a=(0,ii.Pk)(o.address.geo));var u={jobId:t.id,accountId:t.supplier.id},l=(0,c.aM)(uu,{skip:!a,variables:(0,i.Z)({},u)}).data,d=(void 0===l?{supplierLocations:[]}:l).supplierLocations;if(d.length){var p=d[0];s=(0,ii.Pk)(p.geo)}return a&&s?(0,r.jsx)(N.Z,{children:(0,r.jsxs)(k.Z,{children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsx)(L.Z,{variant:"h6",children:"Supplier Operative Location"})}),(0,r.jsx)($.Z,{children:(0,r.jsxs)(M.Z,{children:[(0,r.jsx)(N.Z,{sx:{height:"300px",width:"100%"},children:(0,r.jsxs)(uc,{defaultCenter:a,children:[a&&(0,r.jsx)(N.Z,(0,i.Z)({component:"img",src:"https://maps.google.com/mapfiles/ms/icons/red-dot.png"},a)),s&&(0,r.jsx)(N.Z,(0,i.Z)({component:"img",src:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png"},s))]})}),(0,r.jsx)(eX.i,{rows:d.map(function(e){var n,t,i=e.meta;return{id:e.id,distance:(null==i?void 0:null===(n=i.distance)||void 0===n?void 0:n.text)?i.distance.text:"-",duration:(null==i?void 0:null===(t=i.duration)||void 0===t?void 0:t.text)?i.duration.text:"-",time:K()(e.createdAt).format("YYYY-MM-DD")}}),columns:[{field:"distance",headerName:"Distance",flex:1,sortable:!1},{field:"duration",headerName:"Arrival",flex:1,sortable:!1},{field:"time",headerName:"Last update",flex:1,sortable:!1}]})]})})]})}):null};ud.defaultProps={},ud.propTypes={job:E().object.isRequired};var up=function(e){var n=e.job,t=e.refetch,i=(0,e2.x)().hasRole,o=["supplierQuoteSent","quotationAccepted","supplierQuoteUpdated","waitingThresholdApproval"],a=!0,s=n.quotations.slice().filter(function(e){return i("customer")?"uplift"!==e.type&&o.find(function(n){return n===e.status}):"uplift"!==e.type});return a=!!s.find(function(e){return"quotationAccepted"===e.status}),s.sort(function(e){return"quotationAccepted"===e.status?-1:0}).map(function(e){return(0,r.jsx)(N.Z,{children:(0,r.jsx)(sQ,{job:n,quote:e,refetch:t,quotes:s,isHideAllQuotation:a},e.quoteNumber)})})};up.defaultProps={},up.propTypes={job:E().object.isRequired,refetch:E().func.isRequired};var um=function(e){var n=e.job,t=e.onUpdateJob,o=(0,ei.cI)({defaultValues:{permitsLinks:n.permitsLinks}}),a=o.setValue,s=o.register,u=o.watch,l=o.handleSubmit,c=u("permitsLinks");return(0,r.jsxs)("form",{id:"supportingDocumentsFrom",onSubmit:l(t),children:[(0,r.jsx)(sh.V,{setValue:a,values:c,name:"permitsLinks",title:"Permit links",noDeleteEdit:!0}),(0,r.jsx)("input",(0,i.Z)({type:"hidden"},s("permitsLinks"))),(0,r.jsx)(H.Z,{type:"submit",variant:"contained",color:"secondary",sx:uf.submitButton,children:"Submit"})]})},uf={submitButton:{marginTop:"20px"}},uv=function(e){var n=e.job,t=e.refetch,i=(0,oD.a)(),o=(0,_.Z)((0,P.D)(p.qD,{}),1)[0],a=function(e){o({variables:{id:n.id,changes:e}}).then(function(){t(),i.close()})},s=function(e){e.stopPropagation(),i.show({content:(0,r.jsx)(um,{job:n,onUpdateJob:a}),title:"Supporting documents",submit:!1})};return(0,r.jsx)(ub,{children:(0,r.jsxs)(k.Z,{children:[(0,r.jsx)(O.Z,{expandIcon:(0,r.jsx)(B.Z,{}),children:(0,r.jsxs)(M.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,r.jsx)(L.Z,{typography:"h6",children:"Supporting Documents"}),(0,r.jsx)(oN.Z,{onClick:s,size:"small",children:(0,r.jsx)(V.Z,{sx:uh.editIcon})})]})}),(0,r.jsxs)($.Z,{children:[(0,r.jsx)(N.Z,{sx:uh.boxContainer,children:(0,r.jsx)(sh.V,{values:n.permitsLinks,title:"Permit links",displayMode:!0})}),(0,r.jsx)(oK.Z,{}),(0,r.jsx)(N.Z,{sx:uh.boxContainer,children:(0,r.jsx)(sj.G,{entity:"Job",entityId:n.id,carousel:!0,category:"supportingDocuments"})})]})]})})},uh={editIcon:{height:"17px",width:"17px"},boxContainer:{padding:"15px 10px"}},ub=(0,o$.ZP)(N.Z)(function(e){var n=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(n.palette.error.light),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}}),ux=function(e){var n,t,a,u,m=e.id,f=(0,o.useState)(["task-board","messaging-comonent"]),v=f[0],h=f[1],b=(0,tk.q)().hasUserModule,g=(0,e2.x)(),j=g.hasRole,y=g.user,Z=j("tenant"),I=j("customer_user"),R=b("quotes"),q=b("finances"),_=(0,c.aM)(x.nh,{variables:{id:y.id}}).data,T=(void 0===_?{user:{}}:_).user;y=(0,i.Z)({},y,T);var A=p.E6;j("supplier")&&(A=w),j("customer")&&(A=C),j("tenant")&&(A=S);var E=(0,c.aM)(A,{skip:!m,variables:{number:m,adminId:y.adminId}}),D=E.loading,P=E.data,k=(void 0===P?{job:null}:P).job,$=E.refetch,O=(0,d.m)(p.$6,{skip:!m,variables:{number:m,adminId:y.adminId}}).data,N=(void 0===O?{timings:[]}:O).timings;if(!m)return null;if(!D&&!k)return s().push("/404"),!1;var H=k?(0,i.Z)({},k[0]):{};if((null==N?void 0:N.length)>0&&(H.timings=N),!R&&I&&"quote"===H.type)throw Error("No access to quotes module");var L=function(e){return function(n,t){t?h(function(n){return(0,l.Z)(n).concat([e])}):h(function(n){return n.filter(function(n){return n!==e})})}};return!D&&(0,r.jsxs)(F.ZP,{container:!0,spacing:4,children:[(0,r.jsx)(F.ZP,{item:!0,xs:12,md:6,lg2:4,children:(0,r.jsxs)(M.Z,{spacing:4,children:[(0,r.jsx)(ok,{job:H,refetch:$}),(0,r.jsx)(oz,{job:H,refetch:$}),H.supplier&&j(["admin"])&&(0,r.jsx)(oB,{job:H,refetch:$})]})}),(0,r.jsxs)(F.ZP,{item:!0,container:!0,xs:12,md:6,lg2:8,spacing:4,children:[(0,r.jsx)(F.ZP,{item:!0,xs:12,lg2:6,children:(0,r.jsxs)(M.Z,{spacing:4,children:["quote"!==H.type&&(!I||q)&&(!Z||q)&&(0,r.jsx)(a0,{job:H,refetch:$}),(0,r.jsx)(sc,{job:H,refetch:$}),(0,r.jsx)(sy,{job:H,refetch:$}),H.supplier&&j(["admin","customer"])&&(0,r.jsx)(ud,{job:H}),!H.supplier&&(null==H?void 0:null===(n=H.supplierOffers)||void 0===n?void 0:n.length)>0&&j(["admin"])&&!(0,W.E)(H,"rejected")&&!(0,W.E)(H,"closed")&&(0,r.jsx)(s_,{job:H,refetch:$}),(0,W.E)(H,"quoteNew")&&j("admin")&&(0,r.jsx)(sz,{job:H,refetch:$}),(0,W.E)(H,"quoteNew")&&j(["customer","supplier"])&&(!I||q)&&(!I||R)&&(0,r.jsx)(up,{job:H,refetch:$})]})}),(0,r.jsx)(F.ZP,{item:!0,xs:12,lg2:6,children:(0,r.jsxs)(M.Z,{spacing:4,children:[(0,r.jsx)(uo,{jobId:H.id,subscription:!0,showMyTaskButton:!0,expanded:v.includes("task-board"),onChangeExpanded:L("task-board")}),(0,r.jsx)(ua.b,{id:H.id,adminId:H.adminId,customerId:null===(t=H.customer)||void 0===t?void 0:t.id,supplierId:null===(a=H.supplier)||void 0===a?void 0:a.id,scope:"job",expanded:v.includes("messaging-comonent"),onChangeExpanded:L("messaging-comonent")}),(null==H?void 0:null===(u=H.location)||void 0===u?void 0:u.permitsRequired)&&(0,r.jsx)(uv,{job:H,refetch:$})]})})]})]})},ug=t(58849),uj=function(){var e=(0,o.useContext)(u.Z).user,n=(0,a.useRouter)().query;return e?(0,r.jsx)(ug.Z,{children:(0,r.jsx)(ux,(0,i.Z)({},n))}):(s().push("/account/sign-in"),null)};uj.getLayout=function(e){return e};var uy=uj}},function(e){e.O(0,[3662,630,367,2283,212,8890,619,2583,4135,8579,6043,1838,4244,3911,1417,3776,1564,3054,2329,8500,778,4046,1023,7454,1870,2797,1047,4043,8062,3058,6313,597,3754,1050,4030,4061,6075,4191,1121,5447,4296,5373,1359,8849,8344,6733,7554,7305,1514,8372,5185,8287,9573,9774,2888,179],function(){return e(e.s=39647)}),_N_E=e.O()}]);