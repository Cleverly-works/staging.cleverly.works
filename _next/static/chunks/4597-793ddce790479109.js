"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4597],{64597:function(t,n,e){e.d(n,{Z:function(){return A}});var i=e(85893),o=e(45697),a=e(11163),r=e(11585),c=e(41085),u=e(67294),s=e(6388),d=e(7297),l=e(75063);function m(){var t=(0,d.Z)(["\n  query GetSupplierCompliance(\n    $adminId: Int\n    $entity: String\n    $gteNow: date\n    $ltNow: date\n    $limit: Int\n    $offset: Int!\n  ) {\n    complianceEntity: Compliance_Entity(\n      limit: $limit\n      offset: $offset\n      where: {\n        entity: { _eq: $entity }\n        _and: [{ expiryAt: { _gte: $gteNow } }, { expiryAt: { _lt: $ltNow } }]\n        Compliance: { adminId: { _eq: $adminId } }\n      }\n      order_by: { expiryAt: asc }\n    ) {\n      id\n      createdAt\n      entity\n      entityId\n      expiryAt\n      regNum\n      insuranceAmount\n      compliance: Compliance {\n        id\n        type\n        name\n        status\n        hasInsuranceAmount\n        regNumExample\n      }\n      account: Account {\n        id\n        name\n        status\n      }\n      location: Location {\n        id\n        name\n        status\n      }\n    }\n    meta: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: $entity }\n        _and: [{ expiryAt: { _gte: $gteNow } }, { expiryAt: { _lt: $ltNow } }]\n        Compliance: { adminId: { _eq: $adminId } }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"]);return m=function(){return t},t}var p=(0,l.Ps)(m()),f=e(78289),g=e(68956),y=e(91272),h=e(35418),v=e(30430),x=e(2845),w=e(20705),b=new Date,C=function(t){var n=t.mode,e=t.entity,o=(0,u.useContext)(f.Z),a=(0,x.x)().user,r=null,c=null;"upcoming"===n?r=b:"expired"===n&&(c=b);var d,l={adminId:a.accountId,entity:e,gteNow:r,ltNow:c},m=(0,w.x)({filters:l,initialSort:{item:"expiryAt",order:"asc"}}),C=m.initialData,I=m.ref,A=(0,s.aM)(p,{variables:C}),Z=A.loading,j=A.refetch,S=A.data,_=void 0===S?{complianceEntity:[],meta:{aggregate:{totalCount:0}}}:S,N=_.complianceEntity,P=_.meta,z=function(t){o.show({content:(0,i.jsx)(h.G,{entity:"Compliance_Entity",entityId:null==t?void 0:t.id}),submit:!1,title:"Media"})},E=[{hidden:!0},{hidden:!0},{text:"Name"},{text:"Account",hidden:"Account"!==e},{text:"Location",hidden:"Location"!==e},{text:"Registration number"},{formatter:v.FT,text:"Expiry date"},{text:"Status",hidden:"Account"!==e,sortable:!0,sortName:'{"Account": {"status": "ORDER"}}'},{text:"Status",hidden:"Location"!==e,sortable:!0,sortName:'{"Location": {"status": "ORDER"}}'},{formatter:g.Z,formatterData:[{context:"info",icon:["fas","file-upload"],onClick:(d={mediaClick:function(t,n){return z(n)}}).mediaClick,tooltip:"Media"}],text:"Actions"}];return(0,i.jsx)(y.t,{columns:E,loading:Z,meta:P,ref:I,refetch:j,rows:N.map(function(t){var n,e,i,o,a,r,c;return{id:t.id,complianceId:{label:null===(n=t.compliance)||void 0===n?void 0:n.name,value:null===(e=t.compliance)||void 0===e?void 0:e.id},name:null===(i=t.compliance)||void 0===i?void 0:i.name,account:null===(o=t.account)||void 0===o?void 0:o.name,location:null===(a=t.location)||void 0===a?void 0:a.name,regNum:t.regNum,expiryAt:t.expiryAt,statusAccount:null===(r=t.account)||void 0===r?void 0:r.status,statusLocation:null===(c=t.location)||void 0===c?void 0:c.status,actions:""}})})};C.propTypes={mode:o.string.isRequired,entity:o.string.isRequired};var I=function(t){var n=t.entity,e=(0,a.useRouter)().query;return(0,i.jsx)(r.Z,{fitParentHeight:!0,open:!0,title:"Compliances",children:(0,i.jsxs)(c.Z,{children:[(0,i.jsx)("div",{active:"expired"===e.tab||!e.tab,label:"Expired",children:(0,i.jsx)(C,{entity:n,mode:"expired"})}),(0,i.jsx)("div",{active:"upcoming"===e.tab,label:"Upcoming",children:(0,i.jsx)(C,{entity:n,mode:"upcoming"})})]})})};C.propTypes={entity:o.string};var A=I},43235:function(t,n,e){e.d(n,{r:function(){return o}});var i=e(29383),o=function(t){return(0,i.Z)(new Date(t),new Date)}},5054:function(t,n,e){e.d(n,{O:function(){return i}});var i=function(t){return t?new Date(t):new Date}},30430:function(t,n,e){e.d(n,{Bo:function(){return h},CV:function(){return f},FT:function(){return w},JB:function(){return y},iU:function(){return g},kW:function(){return v}});var i=e(7297),o=e(85893),a=e(10367),r=e(11587),c=e(51466),u=e(26186),s=e(43235),d=e(5054);function l(){var t=(0,i.Z)(["\n  margin: 0;\n"]);return l=function(){return t},t}function m(){var t=(0,i.Z)(["\n  align-items: center;\n  display: flex;\n"]);return m=function(){return t},t}function p(){var t=(0,i.Z)(["\n  flex-direction: column;\n  margin-left: 1rem;\n"]);return p=function(){return t},t}var f=function(t){var n=(0,d.O)();return parseInt(t.filter(function(t){return(0,d.O)(t.expiryAt)>=n}).length/t.length*100)},g=function(t){if(!t||0===t.length)return null;var n=(0,d.O)();return parseInt(t.filter(function(t){return(0,d.O)(t.expiryAt)>=n}).length/t.length*100)||null};(0,a.ZP)(r.Z).withConfig({displayName:"helper__StyledBadge",componentId:"sc-ee567c94-0"})(l()),a.ZP.div.withConfig({displayName:"helper__Wrapper",componentId:"sc-ee567c94-1"})(m()),a.ZP.div.withConfig({displayName:"helper__Next",componentId:"sc-ee567c94-2"})(p());var y=function(t){return t.filter(function(t){return 0>(0,s.r)(t.expiryAt)}).length},h=function(t){if(!t||0===t.length||!t.nodes||t.nodes&&(null===(n=t.nodes)||void 0===n?void 0:n.length)===0)return{content:"No locations",context:"secondary"};var n,e=[];(t.nodes||t).forEach(function(t){var n,i;((null===(n=t.location)||void 0===n?void 0:n.compliance)||t.compliances)&&e.push(f((null===(i=t.location)||void 0===i?void 0:i.compliance)||t.compliances))});var i=Math.round(e.reduce(function(t,n){return isNaN(n)&&(n=0),t+n},0)/e.length);return{content:"Score: ".concat(i||0," %"),context:v(i)}},v=function(t){return t>79?"success":t>49?"info":"danger"},x=function(t){var n=(0,s.r)(t);return n>14?"success":n>=0?"info":"danger"},w=function(t){var n=t.row;if(n.expiryAt)return(0,o.jsx)(c.Z,{content:(0,u.Z)(n.expiryAt),context:x(n.expiryAt),size:"sm"})}},35418:function(t,n,e){e.d(n,{G:function(){return k}});var i=e(26042),o=e(69396),a=e(7297),r=e(85893),c=e(67294),u=e(45697),s=e(6388),d=e(52824),l=e(10367),m=e(78289),p=e(41564),f=e(34953),g=e(62466),y=e(68956),h=e(73373),v=e(11585),x=e(28733),w=e(55377),b=e(16551),C=e(77439),I=e(74297),A=e(23892),Z=e(39087),j=e(76256),S=e(75795),_=e(91272),N=e(20705),P=e(2845);function z(){var t=(0,a.Z)(["\n  width: 24px;\n"]);return z=function(){return t},t}function E(){var t=(0,a.Z)(["\n  border: 1px solid #eee;\n"]);return E=function(){return t},t}var k=function(t){var n=t.carousel,e=t.category,a=t.children,u=t.data,l=(t.details,t.entity),z=t.entityId,E=t.filters,k=(t.limit,t.listView),R=t.mediaMeta,$=t.onMediaAdd,O=t.onMediaRemove,q=(t.pagination,t.showActionButtons),L=t.showEntityColumn,T=t.showItemActions,B=t.summary,F=t.type,U=(0,N.x)({filters:E}),H=U.initialData,V=U.ref,G=(0,P.x)(),W=G.hasRole,J=G.user,K=(0,c.useContext)(m.Z),Q=(0,s.aM)(d.t,{variables:(0,o.Z)((0,i.Z)({},H),{entity:l,entityId:z,category:e,adminId:J.adminId,meta:R})}),X=Q.data,Y=void 0===X?{items:[],meta:{aggregate:{totalCount:0}}}:X,tt=Y.items,tn=Y.meta,te=Q.loading,ti=Q.refetch,to=function(t){K.close(),u.length||ti(),$&&$(t)},ta=function(t){K.close(),u.length||ti(),O&&O(t)},tr=function(t){t.stopPropagation(),K.show({content:(0,r.jsx)(j.z,{accept:"image/*",adminId:J.adminId,category:e,entity:l,entityId:z,expiryShow:!1,mediaMeta:R,multiple:!0,onSuccess:to,type:"image"}),title:"Upload Photos"})},tc=function(t){t.stopPropagation(),K.show({content:(0,r.jsx)(j.z,{accept:".pdf, .doc, .docx, .xlsx",adminId:J.adminId,category:e,entity:l,entityId:z,expiryShow:!1,mediaMeta:R,onSuccess:to,type:"document"}),title:"Upload Documents"})},tu=function(t){K.show({content:(0,r.jsx)(A.d,{mediaId:t.data.id,onSuccess:ta}),submit:!1,title:"Delete Media"})},ts=function(t){K.show({content:(0,r.jsx)(Z.z,{media:t.data,toggleShow:K.close}),submit:!1,title:"Media Details",width:"50%"})},td=[{context:"primary",icon:["fas","info-circle"],onClick:function(t,n){return ts(n)},tooltip:"Details"}];W("admin")&&td.push({context:"danger",icon:["fas","trash"],onClick:function(t,n){return tu(n)},tooltip:"Delete"});var tl=[{hidden:!0},{hidden:!0},{hidden:!0,text:"Caption"},{hidden:!1,text:"File"},{hidden:!L,text:"Entity"},{formatter:function(t){var n,e=t.row;return(0,r.jsx)(D,{children:(null==e?void 0:null===(n=e.authority)||void 0===n?void 0:n.adminOnly)&&(0,r.jsx)(p.Z,{content:"Admin user only",children:(0,r.jsx)(f.Z,{alt:"Admin Only",src:"/messaging/admin-only.svg"})})})},text:"",tooltip:"Only Admin can see"},{formatter:(0,g.Z)("/dashboard/users/view","userId","uploaded"),text:"Uploaded by"},{hidden:!k,text:"Thumbnails"},{hidden:!T,formatter:y.Z,formatterData:td,text:"Actions"}],tm=function(t,n){t.preventDefault(),window.open("".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(n))},tp=[],tf=tt.map(function(t){var n=t.entity,e=t.entityId,i=t.id,o=t.item,a=o.caption,c=o.filename,u=o.meta,s=o.name,d=o.type,l=o.user;return{data:o,id:i,userId:null==l?void 0:l.id,file:function(){return(0,r.jsx)(h.Z,{onClick:function(t){return tm(t,c)},children:a||s||c})},entity:n&&"".concat(n,"#").concat(e),authority:u,uploaded:"".concat(null==l?void 0:l.nameFirst," ").concat(null==l?void 0:l.nameLast),thumbnails:(0,S.S)(d,u),actions:""}}),tg=(tt.forEach(function(t){var n=t.item,e=n.caption,i=n.filename;"image"===n.type&&tp.push({caption:e,filename:i})}),tp),ty=tg.length;return(0,r.jsxs)(v.Z,{fitParentHeight:!0,open:!0,title:B,children:[a,n&&ty>0&&(0,r.jsx)(M,{children:(0,r.jsx)(x.Z,{fullWidth:!0,height:"200px",numberOfItems:1,showNavs:!1,showPagination:!0,slides:tg.map(function(t){var n=t.caption,e=t.filename;return{node:(0,r.jsx)(f.Z,{alt:n,src:"".concat("https://cleverly-staging-media.s3.eu-west-2.amazonaws.com","/").concat(e)}),text:" "}})})}),(0,r.jsx)(_.t,{columns:tl,loading:te,fullHeight:!0,paginationSize:!1,meta:tn,ref:V,refetch:ti,rows:tf}),q&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(w.Z,{size:"sm"}),(0,r.jsxs)(b.Z,{align:"flex-end",children:[(!F||"document"===F)&&!W("supplier")&&(0,r.jsx)(C.Z,{content:"Add Document",context:"secondary",onClick:tc,size:"sm"}),(!F||"image"===F||"avatar"===F)&&!W("supplier")&&(0,r.jsx)(C.Z,{content:"Add ".concat((0,I.Z)(F||"Image")),context:"secondary",onClick:tr,size:"sm"})]})]})]})},D=l.ZP.div.withConfig({displayName:"table__StyledIcon",componentId:"sc-9d92024f-0"})(z()),M=l.ZP.div.withConfig({displayName:"table__StyledCarousel",componentId:"sc-9d92024f-1"})(E());k.propTypes={carousel:u.bool,category:u.string,children:u.node,data:u.array,details:u.bool,entity:u.string,entityId:u.number,filters:u.object,limit:u.number,listView:u.bool,mediaMeta:u.object,onMediaAdd:u.func,onMediaRemove:u.func,pagination:u.object,showActionButtons:u.bool,showEntityColumn:u.bool,showItemActions:u.bool,summary:u.string,type:u.string},k.defaultProps={carousel:!0,category:null,data:[],details:!1,filters:{},limit:20,listView:!1,mediaMeta:null,showActionButtons:!0,showEntityColumn:!1,showItemActions:!0,summary:"Media",type:null}},91272:function(t,n,e){e.d(n,{t:function(){return s}});var i=e(85893),o=e(67294),a=e(45697),r=e(11163),c=e(46003),u=e(8500),s=(0,o.forwardRef)(function(t,n){var e=t.columns,a=t.history,s=t.initialSort,d=t.loading,l=t.meta,m=t.paginationSize,p=t.refetch,f=t.submissionsRefetch,g=t.rowClick,y=t.rows,h=t.xeroPageSize,v=(0,r.useRouter)(),x=v.query,w=void 0===x?{}:x,b=(0,o.useState)(parseInt(null==w?void 0:w.page,10)||1),C=b[0],I=b[1],A=(0,o.useState)(h||c.C1.paginationSize),Z=A[0],j=A[1];s||(s={item:"createdAt",order:"desc"});var S=(0,o.useState)({item:s.item,order:s.order}),_=S[0],N=S[1],P=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=v.query,e=void 0===n?{}:n;if(t>1?e.page=t:delete e.page,!(Object.keys(e).length>0))return{};var i=Object.keys(e).map(function(n){return"page"===n?"".concat(n,"=").concat(t):"".concat(n,"=").concat(e[n])}).join("&");return"?".concat(i)},z=function(){N({item:s.item,order:s.order}),I(1);var t=P();v.push(t),j(h||c.C1.paginationSize)};(0,o.useImperativeHandle)(n,function(){return{currentPage:C,pageSize:Z,sort:_,resetPagination:function(){z()}}});var E=function(t){var n=P(t);a&&v.push(n),I(t),!a&&p&&p()&&f&&f()},k=function(t){t!==c.C1.paginationSize&&(j(t),p&&p()&&f&&f())},D=function(t){var n;N({item:t.item,order:t.order}),p&&p()&&f&&f()};return(0,i.jsx)(u.Z,{columns:e,loading:d,paginationSize:m,pagination:l&&!0,paginationProps:l&&{currentPage:C,onPageChange:E,onPageSizeChange:k,pageCount:Math.ceil(l.aggregate.totalCount/Z),perPage:Z},rowClick:g,rows:y,sort:_,setSort:D})});s.propTypes={columns:a.array.isRequired,history:a.bool,initialSort:a.object,loading:a.bool,meta:a.object,refetch:a.func,submissionsRefetch:a.func,rowClick:a.func,rows:a.array.isRequired},s.defaultProps={history:!0,loading:!0,paginationSize:!1}}}]);