"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5469],{12872:function(n,e,t){t.d(e,{Au:function(){return g},FD:function(){return l},YW:function(){return m},dG:function(){return f},kU:function(){return p},tC:function(){return v}});var i=t(7297),o=t(75063);function r(){var n=(0,i.Z)(["\n  mutation AddComplianceEntity($objects: [Compliance_Entity_insert_input!]!) {\n    insert_Compliance_Entity(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return r=function(){return n},n}function a(){var n=(0,i.Z)(["\n  mutation UpdateComplianceEntity($id: Int!, $changes: Compliance_Entity_set_input) {\n    update_Compliance_Entity_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return a=function(){return n},n}function s(){var n=(0,i.Z)(['\n  query GetCompliancesForSelect($adminId: Int!, $type: String) {\n    compliances: Compliance(where: { adminId: { _eq: $adminId }, type: { _eq: $type } }) {\n      value: id\n      label: name\n      url\n      governingBody\n      regNumExample\n      expectCertificate\n      hasInsuranceAmount\n      type\n      questions: Taxonomies(where: { entity: { _eq: "Compliance" } }) {\n        id\n        name\n        meta\n      }\n      category: Category {\n        id\n        name\n      }\n    }\n  }\n']);return s=function(){return n},n}function c(){var n=(0,i.Z)(["\n  mutation DeleteComplianceEntity($id: Int!) {\n    delete_Compliance_Entity_by_pk(id: $id) {\n      id\n    }\n  }\n"]);return c=function(){return n},n}function u(){var n=(0,i.Z)(['\n  query getComplianceTiles(\n    $customerId: Int\n    $locationId: Int\n    $nowNew: timestamptz\n    $now: date\n    $nextMonth: date\n    $nextWeek: timestamptz\n  ) {\n    overdue: Compliance_Entity_aggregate(\n      where: {\n        expiryAt: { _lt: $now }\n        entity: { _eq: "Location" }\n        entityId: { _eq: $locationId }\n        Location: { Account_Locations: { accountId: { _eq: $customerId } } }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    upComing: Compliance_Entity_aggregate(\n      where: {\n        _and: [{ expiryAt: { _gt: $now } }, { expiryAt: { _lt: $nextMonth } }]\n        entity: { _eq: "Location" }\n        entityId: { _eq: $locationId }\n        Location: { Account_Locations: { accountId: { _eq: $customerId } } }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n\n    jobs: Compliance_Entity(\n      where: {\n        entity: { _eq: "Job" }\n        Job: { locationId: { _eq: $locationId }, customerId: { _eq: $customerId } }\n      }\n      order_by: { Job: { timingStart: asc } }\n    ) {\n      entityId\n      job: Job {\n        amount\n        supplierId\n        scheduledAt\n        timingStart\n      }\n    }\n    openCPPM: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          status: { _neq: "closed" }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    openCPPMToday: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          status: { _neq: "closed" }\n          _and: { timingStart: { _gte: $nowNew, _lte: $nowNew } }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    openCPPMNextWeek: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          status: { _neq: "closed" }\n          _and: { timingStart: { _gte: $nowNew, _lte: $nextWeek } }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    CPPMDocOutstanding: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          JobTimings: { status: { _in: ["complianceRequestedDocumentation"] } }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    unsatisfactoryCPPM: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          JobTimings: { status: { _in: ["complianceRejected"] } }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n\n    waitingCustomerSingOff: Compliance_Entity_aggregate(\n      where: {\n        entity: { _eq: "Job" }\n        Media: { entity: { _eq: "Compliance_Entity" } }\n        Job: {\n          locationId: { _eq: $locationId }\n          customerId: { _eq: $customerId }\n          JobTimings: {\n            _and: [\n              { status: { _in: ["complianceRequestedDocumentation"] } }\n              { status: { _nin: ["complianceApproved", "complianceRejected"] } }\n            ]\n          }\n        }\n      }\n    ) {\n      aggregate {\n        count\n      }\n    }\n    CPPMSpendAmount: Job_aggregate(\n      where: {\n        Compliances: { entity: { _eq: "Job" } }\n        locationId: { _eq: $locationId }\n        customerId: { _eq: $customerId }\n      }\n    ) {\n      aggregate {\n        sum {\n          amount\n        }\n      }\n    }\n  }\n']);return u=function(){return n},n}function d(){var n=(0,i.Z)(['\n  query getCompliance_Entity($entity: String, $entityId: Int) {\n    compliances: Compliance_Entity(\n      where: { entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n      order_by: { expiryAt: asc }\n    ) {\n      id\n      createdAt\n      entity\n      entityId\n      expiryAt\n      insuranceAmount\n      regNum\n      meta\n      compliance: Compliance {\n        id\n        type\n        name\n        status\n        hasInsuranceAmount\n        questions: Taxonomies(where: { entity: { _eq: "Compliance" } }) {\n          id\n          name\n          meta\n        }\n      }\n    }\n  }\n']);return d=function(){return n},n}var l=(0,o.Ps)(r()),m=(0,o.Ps)(a()),p=(0,o.Ps)(s()),v=(0,o.Ps)(c()),f=(0,o.Ps)(u()),g=(0,o.Ps)(d())},36769:function(n,e,t){t.d(e,{p:function(){return h}});var i=t(85893),o=t(45697),r=t(6388),a=t(12872),s=t(11640),c=t(63500),u=t(73303),d=t.n(u),l=t(11587),m=t(26186),p=t(11082),v=new Date,f=(0,s.Z)(v,1),g=(0,c.Z)(v,1),x=(0,s.Z)(v,-12),h=function(n){var e,t=n.customerId,o=n.locationId,s=n.hideFinance,c=(0,r.aM)(a.dG,{variables:{customerId:t,locationId:o,now:v,nowNew:v,nextMonth:f,nextWeek:g}}),u=c.loading,h=c.data,b=void 0===h?{JobSchedule:[]}:h,y=b.CPPMDocOutstanding,I=b.CPPMSpendAmount,_=b.jobs,j=b.openCPPM,Z=b.openCPPMNextWeek,$=b.openCPPMToday,C=b.overdue,S=b.unsatisfactoryCPPM,q=b.upComing,w=d()(null==_?void 0:_.filter(function(n){return new Date(n.job.timingStart)>x&&new Date(n.job.timingStart)<v}),function(n){return Number(n.job.amount)}),N=null===(e=null==_?void 0:_.find(function(n){return new Date(null==n?void 0:n.job.timingStart)>v}))||void 0===e?void 0:e.job;return!u&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Overdue: ",(0,i.jsx)("b",{children:null==C?void 0:C.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Upcoming: ",(0,i.jsx)("b",{children:null==q?void 0:q.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Unconfirmed: ",(0,i.jsx)("b",{children:_.filter(function(n){return!n.job.scheduledAt}).length})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Next Visit: ",(0,i.jsx)("b",{children:N?(0,m.Z)(null==N?void 0:N.timingStart):"-"})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Work Orders: ",(0,i.jsx)("b",{children:_.length})]}),context:"secondary",shape:"round",size:"sm"}),!s&&(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Compliance Spent (12M): ",(0,i.jsx)("b",{children:(0,p.Z)(w)})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Open CPPMs: ",(0,i.jsx)("b",{children:null==j?void 0:j.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["CPPMs due today: ",(0,i.jsx)("b",{children:null==$?void 0:$.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["CPPMs due this week: ",(0,i.jsx)("b",{children:null==Z?void 0:Z.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["CPPM Docs Outstanding: ",(0,i.jsx)("b",{children:null==y?void 0:y.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["Unsatisfactory CPPM: ",(0,i.jsx)("b",{children:null==S?void 0:S.aggregate.count})]}),context:"secondary",shape:"round",size:"sm"}),!s&&(0,i.jsx)(l.Z,{content:(0,i.jsxs)(i.Fragment,{children:["CPPM Spend YDT: ",(0,i.jsx)("b",{children:(0,p.Z)(null==I?void 0:I.aggregate.sum.amount)})]}),context:"secondary",shape:"round",size:"sm"})]})};h.propTypes={customerId:o.number,locationId:o.number,hideFinance:o.bool}},45154:function(n,e,t){t.d(e,{c:function(){return r}});var i=t(26186),o=t(11082),r=function(n,e,t){var r=t.numberPrefix,a=void 0===r?"":r,s=t.numberSuffix,c=void 0===s?"":s,u="customer"===e,d="supplier"===e;return n.map(function(n){var e,t,r,s,l,m,p,v,f,g,x,h,b,y,I,_,j,Z,$,C=n.manager?"".concat(n.manager.nameFirst," ").concat(n.manager.nameLast):"Unassigned",S=n.scheduledAt?(0,i.Z)(n.scheduledAt,!0):n.timingStart?(0,i.Z)(n.timingStart,!0):"-",q=n.customerRebateAmount>0?n.customerVatTotal-n.customerRebateAmount-n.supplierTotal:n.customerTotal-n.supplierTotal;return d?{id:"".concat(a," ").concat(n.number," ").concat(c),type:n.type,invoiceNumber:(null===(e=n.invoices)||void 0===e?void 0:null===(t=e[0])||void 0===t?void 0:t.invoiceNumber)||"-",priority:(null===(r=n.sla)||void 0===r?void 0:r.name)||"-",service:(null===(s=n.service)||void 0===s?void 0:s.name)||"-",description:n.description||"-",location:(null===(l=n.location)||void 0===l?void 0:l.name)||"-",sublocation:(null===(m=n.sublocation)||void 0===m?void 0:m.name)||"-",scheduleDate:S,created:(0,i.Z)(n.createdAt),status:n.status}:u?{id:"".concat(a," ").concat(n.number," ").concat(c),type:n.type,invoiceNumber:(null===(p=n.invoices)||void 0===p?void 0:null===(v=p[0])||void 0===v?void 0:v.invoiceNumber)||"-",ref:n.reference,jobTotal:(0,o.Z)(n.customerVatTotal)||0,expensesAmountCustomer:(0,o.Z)(n.customerExpensesTotal)||0,priority:(null===(f=n.sla)||void 0===f?void 0:f.name)||"-",service:(null===(g=n.service)||void 0===g?void 0:g.name)||"-",description:n.description||"-",manager:C,location:(null===(x=n.location)||void 0===x?void 0:x.name)||"-",sublocation:(null===(h=n.sublocation)||void 0===h?void 0:h.name)||"-",scheduleDate:S,created:(0,i.Z)(n.createdAt),status:n.status}:{id:"".concat(a," ").concat(n.number," ").concat(c),type:n.type,invoiceNumber:(null===(b=n.invoices)||void 0===b?void 0:null===(y=b[0])||void 0===y?void 0:y.invoiceNumber)||"-",ref:n.reference,jobTotal:(0,o.Z)(n.customerVatTotal)||0,expensesAmountCustomer:(0,o.Z)(n.customerExpensesTotal)||0,supplierAmount:(0,o.Z)(n.supplierVatTotal)||0,expensesAmountSupplier:(0,o.Z)(n.supplierExpensesTotal)||0,revenue:(0,o.Z)(q)||0,priority:(null===(I=n.sla)||void 0===I?void 0:I.name)||"-",service:(null===(_=n.service)||void 0===_?void 0:_.name)||"-",description:n.description||"-",manager:C,location:(null===(j=n.location)||void 0===j?void 0:j.name)||"-",sublocation:(null===(Z=n.sublocation)||void 0===Z?void 0:Z.name)||"-",supplier:(null===($=n.supplier)||void 0===$?void 0:$.name)||"-",scheduleDate:S,created:(0,i.Z)(n.createdAt),status:n.status}})}},43235:function(n,e,t){t.d(e,{r:function(){return o}});var i=t(29383),o=function(n){return(0,i.Z)(new Date(n),new Date)}},5054:function(n,e,t){t.d(e,{O:function(){return i}});var i=function(n){return n?new Date(n):new Date}},67259:function(n,e,t){t.d(e,{A:function(){return z}});var i=t(26042),o=t(69396),r=t(828),a=t(85893),s=t(67294),c=t(30381),u=t.n(c),d=t(45697),l=t(11163),m=t.n(l),p=t(57460),v=t.n(p),f=t(96486),g=t(11057),x=t(90629),h=t(51233),b=t(15861),y=t(98456),I=t(81261),_=t(63855),j=t(93884),Z=t(15033),$=t(75759),C=t(5336),S=t(45416),q=t(6388),w=t(73359),N=t(7297),A=t(75063);function P(){var n=(0,N.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n    $sublocationId: Int\n    $userId: Int\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n        sublocationId: { _eq: $sublocationId }\n        _or: [{ customerUserId: { _eq: $userId } }, { supplierUserId: { _eq: $userId } }]\n        ','\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n      slaId\n      tags: Taxonomy(\n        where: {\n          entity: { _eq: "Job" }\n          Taxonomy: { status: { _eq: "active" }, type: { _eq: "tags" } }\n        }\n      ) {\n        id\n        tag: Taxonomy {\n          id\n          name\n          meta\n          type\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n        outstandingAmounts: AccountEntry {\n          amount: outstandingAmount\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n        sublocationId: { _eq: $sublocationId }\n        _or: [{ customerUserId: { _eq: $userId } }, { supplierUserId: { _eq: $userId } }]\n        ',"\n\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"]);return P=function(){return n},n}var T=function(n){var e=n.tagsWhere,t=void 0===e?"":e;return(0,A.Ps)(P(),t,t)},D=t(9492),F=t(50459),k=t(45154),E=t(2845),R=t(18586),M=t(63139),J=t(20705),W=t(12547),L=t(48381),O=t(66137),z=function(n){var e,t,c,d,p,N,A=n.initialFilters,P=n.entityRelationToFetch,z=n.filtersVisibilityModel,U=n.columnVisibilityModel,B=(0,E.x)(),Y=B.user,G=B.hasRole,H=(0,R.q)(),K=null===(e=H.admin.jobSetting)||void 0===e?void 0:e.jobNumberPrefix,Q=null===(t=H.admin.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,X=(0,l.useRouter)().pathname,nn=(0,s.useState)(!1),ne=nn[0],nt=nn[1],ni=(0,s.useState)((0,i.Z)({},A)),no=ni[0],nr=ni[1],na=(0,M.s)(),ns=(0,J.x)({filters:no}),nc=ns.initialData,nu=ns.ref,nd=(0,q.aM)(T({tagsWhere:(0,O.Y)(nc.tags)}),{variables:(0,o.Z)((0,i.Z)({},nc,P),{number:nc.id?String(nc.id):null,startDate:nc.startDate,endDate:nc.endDate,adminId:Y.adminId})}),nl=nd.data,nm=void 0===nl?{jobs:[],meta:{aggregate:{totalCount:0}}}:nl,np=nm.jobs,nv=nm.meta,nf=nd.loading,ng=nd.refetch,nx=nc.customerId,nh=nc.endDate,nb=nc.locationId,ny=nc.orderBy,nI=nc.startDate,n_=nc.status,nj=nc.supplierId,nZ=(0,r.Z)((0,w.t)(T({tagsWhere:(0,O.Y)(nc.tags)}),{variables:{adminId:Y.adminId,customerId:nx,endDate:nh,locationId:nb,orderBy:ny,startDate:nI,status:n_,supplierId:nj},onCompleted:function(n){var e,t=(0,k.c)(n.jobs,Y.accountType,{numberPrefix:K,numberSuffix:Q}),i=(null===(e=n.jobs[0])||void 0===e?void 0:e.id)||"New-report",o=v().unparse(t),r="data:application/octet-stream,"+encodeURIComponent(o);(0,D.S)(r,"".concat(i,"-work-orders.csv"))}}),2),n$=nZ[0],nC=nZ[1].loading,nS=function(n){m().push("".concat("/dashboard/issues/","manage?id=").concat(n.number))},nq=function(n){m().push("/dashboard/issues/view?id=".concat(n.number))},nw=function(n){return u()(n).format("YYYY-MM-DD")},nN=function(n){var e=[{context:"secondary",icon:"info",onClick:function(e){return nq(n)},tooltip:"Info"}];return G("admin")&&e.unshift({context:"secondary",icon:"edit",onClick:function(e){return nS(n)},tooltip:"Edit"}),e},nA=[{headerName:"Job ID",field:"jobId",sortable:!1,flex:1,minWidth:100,renderCell:function(n){var e=n.row;return(0,a.jsx)(S.D,{id:e.id,number:e.number,openCanvas:!0,type:e.type,numberPrefix:K,numberSuffix:Q})}},{headerName:"Invoice number",field:"invoiceNumber",sortable:!1,flex:1,minWidth:100},{headerName:"Reference",field:"ref",sortable:!1,flex:1,minWidth:100},{minWidth:300,field:"tags",headerName:"Tags",sortable:!1,renderCell:function(n){var e=n.row;return(0,a.jsx)(L.K,{row:e,refetchQueries:["GetFinancialJob"],entity:"Job"})}},{headerName:"Service",field:"service",sortName:'{"Service": {"name": "ORDER"}}',flex:1,minWidth:100},{headerName:"Priority",field:"priority",sortName:'{"SLA": {"name": "ORDER"}}',flex:1,minWidth:100},{headerName:"Customer",field:"customer",minWidth:200,flex:1,renderCell:function(n){var e,t,i=n.row;return(0,a.jsx)(W.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(null===(e=i.customer)||void 0===e?void 0:e.id),noWrap:!i.customer,children:(null===(t=i.customer)||void 0===t?void 0:t.name)||"-"})}},{headerName:"Location",field:"location",minWidth:300,flex:1,renderCell:function(n){var e,t,i=n.row;return(0,a.jsx)(W.r,{color:"secondary",href:"/dashboard/properties/view?id=".concat(null===(e=i.location)||void 0===e?void 0:e.id),noWrap:!i.location||G(["supplier","tenant"]),children:(null===(t=i.location)||void 0===t?void 0:t.name)||"-"})}},{headerName:"Customer (NET)",field:"customerNet",minWidth:150,sortable:!1,flex:1,valueFormatter:function(n){var e=n.value;return"\xa3".concat((c=+e).toFixed(2))}},{headerName:"Amount Outstanding",field:"amountOutstanding",sortable:!1,minWidth:150,flex:1,valueFormatter:function(n){var e=n.value;return"\xa3".concat((d=+e).toFixed(2))}},{headerName:"Supplier (NET)",field:"supplierNet",minWidth:150,sortable:!1,flex:1,valueFormatter:function(n){var e=n.value;return"\xa3".concat((p=+e).toFixed(2))}},{headerName:G("admin")?"Net Revenue":"Revenue",field:"revenue",minWidth:150,sortable:!1,flex:1,valueFormatter:function(n){var e=n.value;return"\xa3".concat((N=+e).toFixed(2))}},{headerName:"Scheduled",field:"scheduleDate",minWidth:130,flex:1},{headerName:"Created",field:"date",flex:1,minWidth:100},{headerName:"Supplier",field:"supplier",sortName:'{"Supplier": {"name": "ORDER"}}',flex:1,minWidth:140,renderCell:function(n){var e,t,i=n.row;return(0,a.jsx)(W.r,{color:"secondary",noWrap:!G("admin")||!i.supplier,href:"/dashboard/suppliers/view?id=".concat(null===(e=i.supplier)||void 0===e?void 0:e.id),children:(null===(t=i.supplier)||void 0===t?void 0:t.name)||""})}},{headerName:"Status",field:"status",flex:1,minWidth:100,renderCell:function(n){var e=n.row;return(0,a.jsx)($.B,{value:e.status})}},{headerName:"Actions",field:"actions",sortable:!1,minWidth:130,flex:1,renderCell:function(n){var e=n.row;return(0,a.jsx)(C.C,{actionsData:nN,row:e})}}],nP=(0,s.useMemo)(function(){return null==np?void 0:np.map(function(n){var e,t,i,o,r,a=n.scheduledAt?nw(n.scheduledAt,!0):n.timingStart?nw(n.timingStart,!0):"-",s=n.customerRebateAmount>0?n.customerVatTotal-n.customerRebateAmount-n.supplierTotal:n.customerTotal-n.supplierTotal;return{id:n.id,jobId:"J ".concat(n.number," "),type:n.type,number:n.number,invoiceNumber:(null===(e=n.invoices)||void 0===e?void 0:null===(t=e[0])||void 0===t?void 0:t.invoiceNumber)||"-",amountOutstanding:null==n?void 0:null===(i=n.invoices)||void 0===i?void 0:i.reduce(function(n,e){var t;return n+((null==e?void 0:null===(t=e.outstandingAmounts)||void 0===t?void 0:t.amount)||0)},0),ref:n.reference||"-",description:n.description||"-",service:(null===(o=n.service)||void 0===o?void 0:o.name)||"-",priority:(null===(r=n.sla)||void 0===r?void 0:r.name)||"-",location:n.location,customerNet:null==n?void 0:n.customerTotal,supplierNet:null==n?void 0:n.supplierTotal,supplier:null==n?void 0:n.supplier,tags:n.tags,revenue:s||0,scheduleDate:a,customer:null==n?void 0:n.customer,date:nw(n.createdAt),status:n.status}})},[np]),nT=(0,s.useCallback)(function(n){n.stopPropagation();var e=(0,F.Uu)(no);m().push("/dashboard/issues/manage".concat(e))},[no]),nD=(0,s.useMemo)(function(){var n={};return nP.length||f.isEqual(no,A)?{title:"No work orders",subtitleFirstLine:"You currently have no work orders set up in the system",subtitleSecondLine:"Click create work orders to get started building.",buttonText:"Create work orders",onAction:nT}:{title:"No results",subtitleFirstLine:"The filters you have applied have returned no results",subtitleSecondLine:"Please amend and try again if necessary."}},[no,nT,A,nP]),nF=(0,i.Z)({ref:G(["admin","customer"]),service:G(["admin","customer"]),customerNet:G(["admin","customer"]),amountOutstanding:G(["admin","customer"]),supplierNet:G(["admin","supplier"]),revenue:G("admin"),supplier:G("admin"),tags:G("admin"),customer:X.includes("suppliers")&&G("admin")},U);return(0,a.jsxs)(a.Fragment,{children:[ne&&(0,a.jsx)(_.h,{initialFilters:A,open:ne,setFilters:nr,setOpen:nt,filtersVisibilityModel:z}),(0,a.jsxs)(h.Z,{spacing:2,sx:V.header,children:[(0,a.jsxs)(h.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,a.jsx)(g.Z,{variant:"contained",startIcon:(0,a.jsx)(I.Z,{}),onClick:function(){return nt(!0)},children:"Filters"}),(0,a.jsxs)(h.Z,{direction:"row",spacing:2,children:[!G(["supplier","tenant"])&&(0,a.jsx)(g.Z,{variant:"contained",color:"secondary",onClick:nT,children:"Create Work Order"}),!na&&(0,a.jsx)(g.Z,{startIcon:!nC&&(0,a.jsx)("img",{src:"/static/icons/csv.svg"}),disabled:nC,variant:"contained",color:"success",onClick:function(n){n.stopPropagation(),n$()},children:nC?(0,a.jsx)(y.Z,{size:20,color:"secondary"}):"Export"})]})]}),(0,a.jsxs)(x.Z,{sx:V.tableContainer,children:[(0,a.jsx)(b.Z,{ml:2,variant:"h5",sx:V.title,children:"Work Orders"}),(null==nP?void 0:nP.length)?(0,a.jsx)(Z.i,{ref:nu,loading:nf,columns:nA,rows:nP,columnVisibilityModel:nF,meta:nv,refetch:ng,autoHeight:!1,onRowClick:nq,containerHeight:"calc(100% - 52px)"}):!nf&&(0,a.jsx)(j.C,(0,i.Z)({imageSrc:"/static/icons/no_locations_found.svg"},nD))]})]})]})},V={header:{width:"100%",height:"100%"},tableContainer:{padding:"16px 0px",height:"calc(80vh - 22px)"},title:{fontWeight:600,marginBottom:"15px"}};z.propTypes={filters:d.object},z.defaultProps={filters:{assetId:null,managerId:null},columnVisibilityModel:{}}},30430:function(n,e,t){t.d(e,{Bo:function(){return x},CV:function(){return v},FT:function(){return y},JB:function(){return g},iU:function(){return f},kW:function(){return h}});var i=t(7297),o=t(85893),r=t(10367),a=t(11587),s=t(51466),c=t(26186),u=t(43235),d=t(5054);function l(){var n=(0,i.Z)(["\n  margin: 0;\n"]);return l=function(){return n},n}function m(){var n=(0,i.Z)(["\n  align-items: center;\n  display: flex;\n"]);return m=function(){return n},n}function p(){var n=(0,i.Z)(["\n  flex-direction: column;\n  margin-left: 1rem;\n"]);return p=function(){return n},n}var v=function(n){var e=(0,d.O)();return parseInt(n.filter(function(n){return(0,d.O)(n.expiryAt)>=e}).length/n.length*100)},f=function(n){if(!n||0===n.length)return null;var e=(0,d.O)();return parseInt(n.filter(function(n){return(0,d.O)(n.expiryAt)>=e}).length/n.length*100)||null};(0,r.ZP)(a.Z).withConfig({displayName:"helper__StyledBadge",componentId:"sc-ee567c94-0"})(l()),r.ZP.div.withConfig({displayName:"helper__Wrapper",componentId:"sc-ee567c94-1"})(m()),r.ZP.div.withConfig({displayName:"helper__Next",componentId:"sc-ee567c94-2"})(p());var g=function(n){return n.filter(function(n){return 0>(0,u.r)(n.expiryAt)}).length},x=function(n){if(!n||0===n.length||!n.nodes||n.nodes&&(null===(e=n.nodes)||void 0===e?void 0:e.length)===0)return{content:"No locations",context:"secondary"};var e,t=[];(n.nodes||n).forEach(function(n){var e,i;((null===(e=n.location)||void 0===e?void 0:e.compliance)||n.compliances)&&t.push(v((null===(i=n.location)||void 0===i?void 0:i.compliance)||n.compliances))});var i=Math.round(t.reduce(function(n,e){return isNaN(e)&&(e=0),n+e},0)/t.length);return{content:"Score: ".concat(i||0," %"),context:h(i)}},h=function(n){return n>79?"success":n>49?"info":"danger"},b=function(n){var e=(0,u.r)(n);return e>14?"success":e>=0?"info":"danger"},y=function(n){var e=n.row;if(e.expiryAt)return(0,o.jsx)(s.Z,{content:(0,c.Z)(e.expiryAt),context:b(e.expiryAt),size:"sm"})}},67427:function(n,e,t){t.d(e,{u:function(){return q}});var i=t(47568),o=t(26042),r=t(69396),a=t(828),s=t(29815),c=t(97582),u=t(85893),d=t(45697),l=t(50319),m=t(6388),p=t(26695),v=t(26186),f=t(11082),g=t(15214),x=t(11585),h=t(86036),b=t(55843),y=t(8500),I=t(45416),_=t(25742),j=t(2845),Z=t(13077),$=t(98552),C=t(6538),S=t(913),q=function(n){var e,t=n.type,d=n.accountEntryType,q=n.data,w=(n.refetch,n.toggleShow),N=n.numberPrefix,A=n.numberSuffix,P=(0,j.x)().hasRole,T=(0,a.Z)((0,l.D)(p.zn,{refetchQueries:function(){return["GetAccountEntries"]}}),1)[0],D=(0,a.Z)((0,l.D)(S.qD),1)[0],F=(0,m.aM)(p.to,{variables:{accountEntryId:q.id,skip:"paymentReceipt"!==d&&"creditNote"!==d}}).data,k=(void 0===F?{reconciliations:[]}:F).reconciliations,E=(0,m.aM)(p.yz,{variables:{accountEntryId:q.id,skip:"ppmInvoice"!==d}}).data,R=(void 0===E?{invoices:[]}:E).invoices,M=(e=(0,i.Z)(function(){var n;return(0,c.__generator)(this,function(e){switch(e.label){case 0:var a;return[4,Promise.all((n=k.reduce(function(n,e){var i,a;return(0,s.Z)(n).concat((0,s.Z)(null==e?void 0:null===(i=e.accountEntryInvoice)||void 0===i?void 0:null===(a=i.invoices)||void 0===a?void 0:a.map(function(n){var e;return(0,r.Z)((0,o.Z)({},n.job),{status:null===(e=(0,C.e)(n.job,["".concat(t,"Paid")]))||void 0===e?void 0:e.status})})))},[])).map((a=(0,i.Z)(function(n){return(0,c.__generator)(this,function(e){switch(e.label){case 0:return[4,D({variables:{id:n.id,changes:{status:n.status}}})];case 1:return e.sent(),[2]}})}),function(n){return a.apply(this,arguments)})))];case 1:return e.sent(),[4,T({variables:{jobIds:n.map(function(n){return n.id}),timingStatuses:"".concat(t,"Paid"),paymentId:q.id}})];case 2:return e.sent(),w(),[2]}})}),function(){return e.apply(this,arguments)});return(0,u.jsxs)(u.Fragment,{children:[(0,u.jsxs)(x.Z,{open:!0,title:"Details",children:[(0,u.jsx)(h.Z,{content:"Date",text:q.date}),(0,u.jsx)(h.Z,{content:"Type",text:q.itemType}),q.reference&&(0,u.jsx)(h.Z,{content:"Reference",text:q.reference}),q.comment&&(0,u.jsx)(h.Z,{content:"Comment",text:q.comment}),(0,u.jsx)(h.Z,{content:"Debit",text:(0,f.Z)(q.debit)}),(0,u.jsx)(h.Z,{content:"Credit",text:(0,f.Z)(q.credit)})]}),["paymentReceipt","creditNote"].includes(d)&&(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(b.Z,{}),(0,u.jsx)(x.Z,{open:!0,title:"Related Invoices",children:(0,u.jsx)(y.Z,{columns:[{hidden:!0},{text:"Number",formatter:function(n){var e=n.row;return $.YK.includes(e.invoiceType)?"PM ".concat(e.invoiceNumber):(0,u.jsx)(I.D,{id:e.id,number:e.number,invoiceNumber:e.invoiceNumber,numberPrefix:N,numberSuffix:A,openCanvas:!0,type:e.jobType})}},{hidden:!0},{hidden:!0},{text:"Date"},{text:"Reconciled Amount"},{hidden:!0}],rows:k.map(function(n){var e,t,i,o,r,a=null===(e=n.accountEntryInvoice)||void 0===e?void 0:null===(t=e.invoices)||void 0===t?void 0:t[0];return $.YK.includes(null==a?void 0:a.invoiceType)?{id:null,number:null,invoiceNumber:null==a?void 0:a.invoiceNumber,invoiceType:null==a?void 0:a.invoiceType,date:(0,v.Z)(n.createdAt),reconciledAmount:(0,f.Z)(n.amount),jobType:"ppm"}:{id:null==a?void 0:null===(i=a.job)||void 0===i?void 0:i.id,number:null==a?void 0:null===(o=a.job)||void 0===o?void 0:o.number,invoiceNumber:null==a?void 0:a.invoiceNumber,invoiceType:null==a?void 0:a.invoiceType,date:(0,v.Z)(n.createdAt),reconciledAmount:(0,f.Z)(n.amount),jobType:null==a?void 0:null===(r=a.job)||void 0===r?void 0:r.type}})})}),P(["admin","superadmin"])?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(_.H,{content:"Delete",context:"danger",handleClick:M}),k.length>0&&(0,u.jsx)(g.Z,{content:"Deleting this receipt will potentially remove other reconciled entries.",context:"info"})]}):null]}),["ppmInvoice"].includes(d)&&(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(b.Z,{}),(0,u.jsx)(x.Z,{open:!0,title:"Related Jobs",children:(0,u.jsx)(y.Z,{columns:[{hidden:!0},{text:"Number",formatter:function(n){var e=n.row;return(0,u.jsx)(I.D,{id:e.id,number:e.number,invoiceNumber:e.invoiceNumber,numberPrefix:N,numberSuffix:A,openCanvas:!0,type:e.jobType,toggleShow:function(){w&&w()}})}},{text:"Status",formatter:function(n){var e=n.row;return e.status?(0,u.jsx)(Z.B,{value:e.status}):""}},{hidden:!0},{hidden:!0}],rows:R.map(function(n){var e,t,i,o;return{id:null==n?void 0:null===(e=n.Job)||void 0===e?void 0:e.id,number:null==n?void 0:null===(t=n.Job)||void 0===t?void 0:t.number,status:null==n?void 0:null===(i=n.Job)||void 0===i?void 0:i.status,invoiceNumber:null==n?void 0:n.invoiceNumber,jobType:null==n?void 0:null===(o=n.Job)||void 0===o?void 0:o.type}})})})]})]})};q.propTypes={type:(0,d.oneOf)(["customer","supplier"]).isRequired,accountEntryType:(0,d.oneOf)(["creditNote","paymentReceipt","proformaInvoice","ppmInvoice","invoice"]).isRequired,data:d.object.isRequired,refetch:d.func,toggleShow:d.func,numberPrefix:d.string,numberSuffix:d.string},q.defaultProps={numberPrefix:"",numberSuffix:""}},93884:function(n,e,t){t.d(e,{C:function(){return p}});var i=t(26042),o=t(69396),r=t(85893);t(67294);var a=t(45697),s=t(90948),c=t(15861),u=t(51233),d=t(11057),l=t(61730),m=(0,s.ZP)("img")({width:"300px",height:"250px"}),p=function(n){var e=n.imageSrc,t=n.sx,a=n.imageSx,s=n.title,p=n.titleSx,v=n.subtitleFirstLine,f=n.subtitleFirstLineSx,g=n.subtitleSecondLine,x=n.subtitleSecondLineSx,h=n.buttonText,b=n.onAction,y=(0,l.Z)("(max-width: 400px)");return(0,r.jsxs)(u.Z,{sx:(0,o.Z)((0,i.Z)({},t),{width:"100%",height:"100%"}),justifyContent:"center",alignItems:"center",spacing:2,color:"#757575",children:[(0,r.jsx)(m,{src:e,sx:(0,o.Z)((0,i.Z)({},a),{width:y?"250px":"300px"})}),(0,r.jsx)(c.Z,{typography:"h5",sx:(0,i.Z)({},p),children:s}),(0,r.jsxs)(u.Z,{alignItems:"center",sx:{padding:"0px 10px",textAlign:"center"},children:[(0,r.jsx)(c.Z,{sx:(0,i.Z)({},f),children:v}),(0,r.jsx)(c.Z,{sx:(0,i.Z)({},x),children:g})]}),h&&b&&(0,r.jsx)(d.Z,{variant:"contained",color:"secondary",onClick:b,children:h})]})};p.propTypes={imageSrc:a.string,title:a.string,subtitleFirstLine:a.string,subtitleSecondLine:a.string,onAction:a.func,sx:a.object,imageSx:a.object,titleSx:a.object,subtitleFirstLineSx:a.object,subtitleSecondLineSx:a.object},p.defaultProps={title:"",subtitleFirstLine:"",subtitleSecondLine:"",sx:{},imageSx:{},titleSx:{},subtitleFirstLineSx:{},subtitleSecondLineSx:{},onAction:null}},30016:function(n,e,t){t.d(e,{E:function(){return O}});var i=t(47568),o=t(26042),r=t(828),a=t(97582),s=t(85893),c=t(67294),u=t(45697),d=t(6388),l=t(50319),m=t(7297),p=t(75063);function v(){var n=(0,m.Z)(["\n  query GetNote($entityId: Int!) {\n    note: Note(where: { entityId: { _eq: $entityId } }, order_by: { createdAt: desc }) {\n      accountId\n      comments\n      createdAt\n      id\n      userId\n      user: User {\n        nameFirst\n        nameLast\n      }\n    }\n  }\n"]);return v=function(){return n},n}function f(){var n=(0,m.Z)(["\n  mutation AddNote(\n    $accountId: Int\n    $comments: String\n    $entity: String\n    $entityId: Int\n    $userId: Int\n  ) {\n    insert_Note(\n      objects: {\n        accountId: $accountId\n        comments: $comments\n        entity: $entity\n        entityId: $entityId\n        userId: $userId\n      }\n    ) {\n      returning {\n        id\n        comments\n      }\n    }\n  }\n"]);return f=function(){return n},n}function g(){var n=(0,m.Z)(["\n  mutation UpdateNote($id: Int!, $change: Note_set_input) {\n    update_Note_by_pk(pk_columns: { id: $id }, _set: $change) {\n      id\n      comments\n    }\n  }\n"]);return g=function(){return n},n}var x=(0,p.Ps)(v()),h=(0,p.Ps)(f()),b=(0,p.Ps)(g()),y=t(78289),I=t(16551),_=t(77439),j=t(11585),Z=t(86036),$=t(69396),C=t(42283),S=t(79665),q=t(76600),w=t(9270),N=t(62140),A=t(49501),P=t(6710),T=t(55563),D=t(74231),F=(0,D.Ry)().shape({comments:(0,D.Z_)().required()}),k=function(n){var e=n.defaultValues,t=n.onSubmit,i=(0,C.cI)({defaultValues:(0,o.Z)({},e),resolver:(0,S.S)(F)}),r=i.control,a=i.errors,c=i.handleSubmit,u={control:r,errors:a,register:i.register};return(0,s.jsxs)(q.Z,{id:"offCanvasForm",handleSubmit:c(t),children:[(0,s.jsx)(w.Z,{children:(0,s.jsx)(N.Z,{md:12,children:(0,s.jsx)(A.Z,{label:"Title",children:(0,s.jsx)(P.Z,(0,$.Z)((0,o.Z)({},u),{name:"comments",rows:4}))})})}),e.id&&(0,s.jsx)(T.Z,(0,$.Z)((0,o.Z)({},u),{name:"id",type:"hidden"}))]})};k.propTypes={defaultValues:u.object,onSubmit:u.func.isRequired};var E=t(68956),R=t(26186),M=t(55843),J=t(8500),W=function(n){var e=n.note,t=n.loading,i=n.handleClick,o=n.userId,r=[{hidden:!0},{hidden:!0},{text:"Title"},{text:"By"},{text:"Created"},{formatter:E.Z,formatterData:function(n){return[{context:"secondary",disabled:o!==n.userId,icon:["fas","edit"],onClick:function(n,e){return i(n,e)},tooltip:"Edit"}]},text:"Actions"}];return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(M.Z,{marginBottom:"xs"}),(0,s.jsx)(J.Z,{columns:r,loading:t,rows:e.map(function(n){var e,t;return{id:n.id,userId:n.userId,comments:n.comments,user:"".concat(null===(e=n.user)||void 0===e?void 0:e.nameFirst," ").concat(null===(t=n.user)||void 0===t?void 0:t.nameLast),date:(0,R.Z)(n.createdAt),actions:""}})})]})};W.propTypes={userId:u.number.isRequired,note:u.array.isRequired,loading:u.bool.isRequired,handleClick:u.func.isRequired},W.defaultProps={note:[]};var L=t(2845),O=function(n){var e,t=n.entity,u=n.entityId,m=(n.open,n.title),p=n.single,v=(0,c.useContext)(y.Z),f=(0,L.x)().user,g=(0,d.aM)(x,{variables:{entity:t,entityId:u}}),$=g.loading,C=g.data,S=(void 0===C?{note:[]}:C).note,q=g.refetch,w=(0,r.Z)((0,l.D)(h,{onCompleted:function(){v.close(),q()}}),1)[0],N=(0,r.Z)((0,l.D)(b,{onCompleted:function(){v.close(),q()}}),1)[0],A=(e=(0,i.Z)(function(n){return(0,a.__generator)(this,function(e){switch(e.label){case 0:if(!n.id)return[3,2];return[4,N({variables:{id:n.id,change:n}})];case 1:return e.sent(),[3,4];case 2:return n.accountId=f.accountId,n.entity=t,n.entityId=u,n.userId=f.id,[4,w({variables:n})];case 3:e.sent(),e.label=4;case 4:return[2]}})}),function(n){return e.apply(this,arguments)}),P=function(n,e){n.preventDefault(),n.stopPropagation();var t=(0,o.Z)({},e);v.show({content:(0,s.jsx)(k,{defaultValues:t,onCancel:T,onSubmit:A}),title:e?"Edit note":"Add note"})},T=function(){v.close()},D=function(){return(0,s.jsx)(I.Z,{children:p&&S.length?(0,s.jsx)(_.Z,{context:"secondary",content:"Edit",onClick:function(n){return P(n,S[0])},size:"sm"}):(0,s.jsx)(_.Z,{context:"secondary",content:"Add new",onClick:P,size:"sm"})})};return(0,s.jsxs)(j.Z,{fitParentHeight:!0,title:m,toolbar:(0,s.jsx)(D,{}),children:[p&&S.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(Z.Z,{text:S[0].comments}),(0,s.jsx)(Z.Z,{content:"By",text:"".concat(S[0].user.nameFirst," ").concat(S[0].user.nameLast)})]}),!p&&(0,s.jsx)(W,{entity:t,entityId:u,note:S,loading:$,refetch:q,handleClick:P,userId:f.id})]})};O.propTypes={entity:u.string.isRequired,entityId:u.number.isRequired,single:u.bool,title:u.string},O.defaultProps={open:!0,single:!1,title:"Note"}},21789:function(n,e,t){t.d(e,{bg:function(){return i}});var i=[{text:"Status",value:""},{text:"Active",value:"active"},{text:"Inactive",value:"inactive"}]}}]);